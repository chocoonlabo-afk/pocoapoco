import {
  formatDate,
  getTaskTitle,
  getSongTitle,
  renderChildNameFromId,
} from "./historyUtils";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  CartesianGrid,
} from "recharts";

export function HistoryHeader({ role }) {
  return (
    <header style={{ marginBottom: "16px" }}>
      {role === "child" && (
        <p style={{ fontSize: "11px", color: "#c06", marginTop: "4px" }}>
          â€» ã„ã¾ã¯ã€Œå­ãƒ¢ãƒ¼ãƒ‰ã€ã§ã™ã€‚ç·¨é›†ã¯ã§ãã¾ã›ã‚“ã€‚
        </p>
      )}
    </header>
  );
}

export function HistoryChildSelector({
  role,
  childrenList,
  currentChildId,
  setCurrentChildId,
}) {
  if (!childrenList || childrenList.length === 0) return null;

  return (
    <div
      style={{
        marginBottom: "10px",
        display: "flex",
        gap: "6px",
        flexWrap: "wrap",
      }}
    >
      {role !== "child" ? (
        <>
          <button
            onClick={() => setCurrentChildId("all")}
            style={{
              border:
                currentChildId === "all"
                  ? "1px solid #6a1b9a"
                  : "1px solid #ccc",
              background: "#fff",
              borderRadius: "999px",
              padding: "4px 10px",
              fontSize: "12px",
              color: currentChildId === "all" ? "#6a1b9a" : "#555",
            }}
          >
            ãœã‚“ã„ã‚“
          </button>
          {childrenList.map((ch) => (
            <button
              key={ch.id}
              onClick={() => setCurrentChildId(ch.id)}
              style={{
                border:
                  currentChildId === ch.id
                    ? "1px solid #6a1b9a"
                    : "1px solid #ccc",
                background: "#fff",
                borderRadius: "999px",
                padding: "4px 10px",
                fontSize: "12px",
                color: currentChildId === ch.id ? "#6a1b9a" : "#555",
              }}
            >
              {ch.name}
            </button>
          ))}
        </>
      ) : (
        // å­ãƒ¢ãƒ¼ãƒ‰ï¼šè‡ªåˆ†ã ã‘è¡¨ç¤ºï¼ˆã‚¯ãƒªãƒƒã‚¯ä¸å¯ï¼‰
        childrenList
          .filter((ch) => String(ch.id) === String(currentChildId))
          .map((ch) => (
            <span
              key={ch.id}
              style={{
                border: "1px solid #6a1b9a",
                color: "#6a1b9a",
                backgroundColor: "#fff",
                borderRadius: "999px",
                padding: "4px 10px",
                fontSize: "12px",
              }}
            >
              {ch.name}
            </span>
          ))
      )}
    </div>
  );
}

export function HistoryFilterSection({
  selectedTaskIds,
  availableTasks,
  setIsTaskSelectorOpen,
  handleExportCsv,
  handleImportClick,
  periodType,
  setPeriodType,
}) {
  return (
    <section
      style={{
        borderRadius: "12px",
        background: "#faf5ff",
        border: "1px solid #e0ccff",
        padding: "10px 12px",
        marginBottom: "16px",
        display: "flex",
        flexDirection: "column",
        gap: "8px",
      }}
    >
      {/* ä¸Šæ®µï¼šã‚¿ã‚¹ã‚¯é¸æŠï¼‹CSV */}
      <div
        style={{
          display: "flex",
          gap: "8px",
          alignItems: "center",
        }}
      >
        <button
          onClick={() => setIsTaskSelectorOpen(true)}
          style={{
            flex: 1,
            borderRadius: "999px",
            border: "1px solid #6a1b9a",
            padding: "4px 10px",
            fontSize: "13px",
            background: "#fff",
            textAlign: "left",
          }}
        >
          {selectedTaskIds.length === 0 ||
          selectedTaskIds.length === availableTasks.length
            ? "ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯"
            : `${selectedTaskIds.length} ä»¶ã®ã‚¿ã‚¹ã‚¯`}
        </button>

        <div
          style={{
            display: "flex",
            gap: "4px",
            flexShrink: 0,
          }}
        >
          <button
            onClick={handleExportCsv}
            style={{
              borderRadius: "999px",
              border: "1px solid #bbb",
              padding: "4px 8px",
              fontSize: "11px",
              background: "#fff",
            }}
          >
            CSVå‡ºåŠ›
          </button>
          <button
            onClick={handleImportClick}
            style={{
              borderRadius: "999px",
              border: "1px solid #bbb",
              padding: "4px 8px",
              fontSize: "11px",
              background: "#fff",
            }}
          >
            CSVå–è¾¼
          </button>
        </div>
      </div>

      {/* ä¸‹æ®µï¼šæœŸé–“ãƒœã‚¿ãƒ³ */}
      <div
        style={{
          display: "flex",
          gap: "6px",
          flexWrap: "wrap",
        }}
      >
        {[
          { id: "day", label: "æ—¥" },
          { id: "week", label: "é€±" },
          { id: "month", label: "æœˆ" },
          { id: "all", label: "ã™ã¹ã¦" },
        ].map((p) => (
          <button
            key={p.id}
            onClick={() => setPeriodType(p.id)}
            style={{
              borderRadius: "999px",
              padding: "4px 10px",
              fontSize: "12px",
              border:
                periodType === p.id
                  ? "1px solid #6a1b9a"
                  : "1px solid #ccc",
              background:
                periodType === p.id ? "rgba(106,27,154,0.08)" : "#fff",
            }}
          >
            {p.label}
          </button>
        ))}
      </div>
    </section>
  );
}

export function HistoryGraphCard({ chartData }) {
  return (
    <section
      style={{
        borderRadius: "12px",
        background: "#fff",
        border: "1px solid #eee",
        boxShadow: "0 2px 4px rgba(0,0,0,0.04)",
        padding: "10px 12px 4px",
        marginBottom: "20px",
      }}
    >
      <h3
        style={{
          fontSize: "14px",
          marginBottom: "4px",
          color: "#6a1b9a",
        }}
      >
        ã‚°ãƒ©ãƒ•
      </h3>
      <p style={{ fontSize: "11px", color: "#777", marginBottom: "8px" }}>
        ä¸Šã®ã‚¿ã‚¹ã‚¯ã¨æœŸé–“ã‚’ãˆã‚‰ã¶ã¨ã€åˆè¨ˆç·´ç¿’æ™‚é–“ã®ã‚°ãƒ©ãƒ•ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚
      </p>
      <div style={{ width: "100%", height: 180 }}>
        {chartData.length === 0 ? (
          <div
            style={{
              fontSize: "12px",
              color: "#999",
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
              height: "100%",
            }}
          >
            ã¾ã ã‚°ãƒ©ãƒ•ã«ã§ãã‚‹ ãã‚ããŒã‚ã‚Šã¾ã›ã‚“ã€‚
          </div>
        ) : (
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={chartData}>
              {/* ç´«ç³»ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */}
              <defs>
                <linearGradient
                  id="minutesPurple"
                  x1="0"
                  y1="0"
                  x2="0"
                  y2="1"
                >
                  <stop offset="0%" stopColor="#ce93d8" />
                  <stop offset="100%" stopColor="#6a1b9a" />
                </linearGradient>
              </defs>

              <CartesianGrid strokeDasharray="3 3" vertical={false} />
              <XAxis
                dataKey="label"
                tick={{ fontSize: 10 }}
                interval={0}
                height={30}
              />
              <YAxis
                tick={{ fontSize: 10 }}
                width={32}
                tickFormatter={(v) => `${v}åˆ†`}
              />
              <Tooltip
                formatter={(value) => [`${value} åˆ†`, "åˆè¨ˆæ™‚é–“"]}
                labelFormatter={(label) => label}
              />
              <Bar
                dataKey="minutes"
                fill="url(#minutesPurple)"
                radius={[4, 4, 0, 0]}
              />
            </BarChart>
          </ResponsiveContainer>
        )}
      </div>
    </section>
  );
}

export function HistorySummaryCard({ summary }) {
  return (
    <section
      style={{
        background:
          "linear-gradient(135deg, rgba(240,230,255,0.9), rgba(230,245,255,0.8))",
        border: "1px solid #e0ccff",
        borderRadius: "12px",
        boxShadow: "0 2px 4px rgba(0,0,0,0.06)",
        padding: "16px",
        marginBottom: "20px",
      }}
    >
      <h3
        style={{
          fontSize: "16px",
          marginBottom: "8px",
          color: "#6a1b9a",
        }}
      >
        ãã‚‡ã†ã®ã¾ã¨ã‚
      </h3>
      <p style={{ fontSize: "14px", margin: "4px 0", color: "#333" }}>
        åˆè¨ˆæ™‚é–“ï¼š<strong>{summary.totalMinutes}</strong>åˆ†
      </p>
      <p style={{ fontSize: "14px", margin: "4px 0", color: "#333" }}>
        åˆè¨ˆå›æ•°ï¼š<strong>{summary.totalCount}</strong>å›
      </p>
      <p style={{ fontSize: "14px", margin: "4px 0", color: "#333" }}>
        ã‘ã‚“ã™ã†ï¼š<strong>{summary.todayCount}</strong>ä»¶
      </p>
    </section>
  );
}

export function HistoryListSection({
  role,
  currentChildId,
  childrenList,
  decoratedList,
  taskDict,
  songsDict,
  onEditClick,
}) {
  return (
    <section>
      <h3
        style={{
          fontSize: "16px",
          marginBottom: "12px",
          color: "#6a1b9a",
        }}
      >
        {role === "child"
          ? "ã˜ã¶ã‚“ã®ãã‚ã"
          : currentChildId === "all"
          ? "ãœã‚“ãŸã„ã®ãã‚ã"
          : "ã“ã®å­ã®ãã‚ã"}
      </h3>

      {decoratedList.length === 0 ? (
        <p style={{ fontSize: "14px", color: "#777" }}>
          ã¾ã ãã‚ããŒã‚ã‚Šã¾ã›ã‚“ã€‚
        </p>
      ) : (
        <div
          style={{
            display: "flex",
            flexDirection: "column",
            gap: "12px",
          }}
        >
          {decoratedList.map(({ absoluteIndex, record }) => {
            const taskTitle = getTaskTitle(record, taskDict);
            const songTitle = getSongTitle(record, songsDict);
            const minutes = Math.floor((record.seconds || 0) / 60);

            return (
              <div
                key={absoluteIndex}
                style={{
                  border: "1px solid #ddd",
                  borderRadius: "10px",
                  backgroundColor: "#fff",
                  padding: "12px",
                  boxShadow: "0 2px 4px rgba(0,0,0,0.05)",
                  display: "grid",
                  gridTemplateColumns: "1fr auto",
                  columnGap: "8px",
                }}
              >
                {/* å·¦å´ï¼šå†…å®¹ */}
                <div
                  style={{
                    fontSize: "13px",
                    lineHeight: 1.4,
                    color: "#333",
                    wordBreak: "break-word",
                  }}
                >
                  <div
                    style={{
                      fontSize: "13px",
                      color: "#999",
                      marginBottom: "4px",
                    }}
                  >
                    {formatDate(record.startedAt)}
                  </div>

                  {role !== "child" &&
                    currentChildId === "all" &&
                    record.child_id && (
                      <div
                        style={{
                          fontSize: "11px",
                          color: "#6a1b9a",
                          marginBottom: "2px",
                        }}
                      >
                        {renderChildNameFromId(
                          record.child_id,
                          childrenList
                        )}
                      </div>
                    )}

                  {songTitle && (
                    <div
                      style={{
                        fontSize: "13px",
                        color: "#555",
                        marginBottom: "2px",
                      }}
                    >
                      â™ª {songTitle}
                    </div>
                  )}

                  <div
                    style={{
                      fontSize: "15px",
                      fontWeight: "600",
                      color: "#4a148c",
                    }}
                  >
                    {taskTitle}
                  </div>

                  <div
                    style={{
                      fontSize: "14px",
                      color: "#333",
                    }}
                  >
                    â± {minutes}åˆ† ï¼ ğŸ¯ {record.count || 0}å›
                  </div>

                  {record.memo && (
                    <div
                      style={{
                        marginTop: "6px",
                        fontSize: "13px",
                        color: "#555",
                        background: "#fafafa",
                        borderRadius: "6px",
                        padding: "6px 8px",
                        whiteSpace: "pre-wrap",
                      }}
                    >
                      ğŸ“ {record.memo}
                    </div>
                  )}
                </div>

                {/* å³å´ï¼šç·¨é›†ãƒœã‚¿ãƒ³ï¼ˆè¦ªã ã‘ï¼‰ */}
                <div
                  style={{
                    display: "flex",
                    flexDirection: "column",
                    justifyContent: "flex-start",
                    alignItems: "flex-end",
                  }}
                >
                  {role === "parent" && (
                    <button
                      onClick={() => onEditClick(absoluteIndex)}
                      style={{
                        backgroundColor: "#6a1b9a",
                        color: "#fff",
                        border: "none",
                        borderRadius: "8px",
                        padding: "8px 10px",
                        fontSize: "12px",
                        fontWeight: "600",
                        lineHeight: 1.2,
                        minWidth: "60px",
                        boxShadow: "0 2px 4px rgba(0,0,0,0.15)",
                      }}
                    >
                      ç·¨é›†
                    </button>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      )}
    </section>
  );
}

export function BackToHomeButton() {
  return (
    <div style={{ marginTop: "24px", textAlign: "center" }}>
      <button
        onClick={() => (window.location.href = "/")}
        style={{
          backgroundColor: "#6a1b9a",
          color: "#fff",
          border: "none",
          borderRadius: "8px",
          fontSize: "15px",
          fontWeight: "600",
          padding: "10px 20px",
        }}
      >
        ãƒ›ãƒ¼ãƒ ã«ã‚‚ã©ã‚‹
      </button>
    </div>
  );
}

export function CsvHiddenInput({ fileInputRef, handleImportChange }) {
  return (
    <input
      ref={fileInputRef}
      type="file"
      accept=".csv,text/csv"
      style={{ display: "none" }}
      onChange={handleImportChange}
    />
  );
}

export function TaskSelectorModal({
  isOpen,
  onClose,
  availableTasks,
  selectedTaskIds,
  setSelectedTaskIds,
}) {
  if (!isOpen) return null;

  const allSelected =
    selectedTaskIds.length === availableTasks.length ||
    selectedTaskIds.length === 0;

  return (
    <div
      onClick={onClose}
      style={{
        position: "fixed",
        inset: 0,
        background: "rgba(0,0,0,0.35)",
        display: "flex",
        justifyContent: "center",
        alignItems: "center",
        zIndex: 50,
      }}
    >
      <div
        onClick={(e) => e.stopPropagation()}
        style={{
          width: "90%",
          maxWidth: "420px",
          maxHeight: "70vh",
          background: "#fff",
          borderRadius: "12px",
          padding: "14px 16px",
          boxShadow: "0 4px 12px rgba(0,0,0,0.25)",
          display: "flex",
          flexDirection: "column",
          gap: "8px",
        }}
      >
        <h4
          style={{
            fontSize: "15px",
            marginBottom: "4px",
            color: "#4a148c",
          }}
        >
          ã‚¿ã‚¹ã‚¯ã‚’ãˆã‚‰ã¶
        </h4>
        <p style={{ fontSize: "12px", color: "#777" }}>
          ã¿ãŸã„ã‚¿ã‚¹ã‚¯ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ï¼ˆè¤‡æ•°é¸æŠã§ãã¾ã™ï¼‰ã€‚
        </p>

        <div
          style={{
            flex: 1,
            overflowY: "auto",
            marginTop: "4px",
            paddingRight: "4px",
          }}
        >
          <label
            style={{
              display: "flex",
              alignItems: "center",
              gap: "8px",
              fontSize: "13px",
              padding: "4px 0",
            }}
          >
            <input
              type="checkbox"
              checked={allSelected}
              onChange={(e) => {
                if (e.target.checked) {
                  setSelectedTaskIds(availableTasks.map((t) => t.id));
                } else {
                  setSelectedTaskIds([]);
                }
              }}
            />
            <span>ã™ã¹ã¦é¸æŠ / è§£é™¤</span>
          </label>
          <hr style={{ border: "none", borderTop: "1px solid #eee" }} />
          {availableTasks.map((t) => (
            <label
              key={t.id}
              style={{
                display: "flex",
                alignItems: "center",
                gap: "8px",
                fontSize: "13px",
                padding: "4px 0",
              }}
            >
              <input
                type="checkbox"
                checked={
                  selectedTaskIds.length === 0 ||
                  selectedTaskIds.includes(t.id)
                }
                onChange={(e) => {
                  if (e.target.checked) {
                    setSelectedTaskIds((prev) =>
                      prev.includes(t.id) ? prev : [...prev, t.id]
                    );
                  } else {
                    setSelectedTaskIds((prev) =>
                      prev.filter((id) => id !== t.id)
                    );
                  }
                }}
              />
              <span>{t.label}</span>
            </label>
          ))}
        </div>

        <div
          style={{
            display: "flex",
            justifyContent: "flex-end",
            gap: "8px",
            marginTop: "8px",
          }}
        >
          <button
            onClick={onClose}
            style={{
              borderRadius: "8px",
              border: "1px solid #ccc",
              padding: "6px 12px",
              fontSize: "13px",
              background: "#fff",
            }}
          >
            ã¨ã˜ã‚‹
          </button>
        </div>
      </div>
    </div>
  );
}
