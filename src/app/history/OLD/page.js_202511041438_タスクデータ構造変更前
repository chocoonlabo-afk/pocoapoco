"use client";

import { useEffect, useState } from "react";

export default function HistoryPage() {
  const [records, setRecords] = useState([]);
  const [summary, setSummary] = useState({
    totalMinutes: 0,
    totalCount: 0,
    todayCount: 0,
  });

  useEffect(() => {
    loadHistory();
  }, []);

  // localStorage ã‹ã‚‰å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
  function loadHistory() {
    try {
      const raw = localStorage.getItem("pocopoco_history");
      if (!raw) return;
      const data = JSON.parse(raw);
      if (!Array.isArray(data)) return;
      setRecords(data);
      setSummary(calculateSummary(data));
    } catch (e) {
      console.error("failed to load history", e);
    }
  }

  // åˆè¨ˆæ™‚é–“ãƒ»å›æ•°ã‚’é›†è¨ˆï¼ˆãã‚‡ã†åˆ†ã®ã¿ï¼‰
  function calculateSummary(records) {
    const today = new Date().toISOString().slice(0, 10); // "2025-10-29"
    const todayRecords = records.filter((r) =>
      r.startedAt?.startsWith(today)
    );

    const totalSeconds = todayRecords.reduce(
      (sum, r) => sum + (r.seconds || 0),
      0
    );
    const totalCount = todayRecords.reduce(
      (sum, r) => sum + (r.count || 0),
      0
    );

    return {
      totalMinutes: Math.floor(totalSeconds / 60),
      totalCount,
      todayCount: todayRecords.length,
    };
  }

  // æ—¥ä»˜ã‚’ãã‚Œã„ã«è¡¨ç¤º
  function formatDate(dateStr) {
    if (!dateStr) return "";
    try {
      const d = new Date(dateStr);
      return d.toLocaleString("ja-JP", {
        month: "long",
        day: "numeric",
        weekday: "short",
        hour: "2-digit",
        minute: "2-digit",
      });
    } catch {
        return dateStr;
    }
  }

  // è¡¨ç¤ºç”¨ã« reverse ã™ã‚‹ã‘ã©ã€ã‚‚ã¨ã‚‚ã¨ã® index ã‚‚è¦šãˆã¦ãŠããŸã„ã®ã§
  // [{ originalIndex, record }, ...] ã«ã—ã¦ä¸¦ã¹æ›¿ãˆã‚‹
  const decoratedList = records.map((r, originalIndex) => ({
    originalIndex,
    record: r,
  })).reverse();

  return (
    <main
      style={{
        fontFamily: "system-ui, sans-serif",
        padding: "24px 16px 80px",
        maxWidth: "500px",
        margin: "0 auto",
      }}
    >
      <header style={{ marginBottom: "24px" }}>
        <h2 style={{ fontSize: "20px", marginBottom: "8px", color: "#4a148c" }}>
          ç·´ç¿’ã®ãã‚ã
        </h2>
        <p style={{ fontSize: "13px", color: "#777" }}>
          ã»ãã‚“ã•ã‚ŒãŸ ã‚Œã‚“ã—ã‚…ã†ã® ãã‚ãã§ã™
        </p>
      </header>

      {/* ä»Šæ—¥ã®ã‚µãƒãƒªãƒ¼ */}
      <section
        style={{
          background:
            "linear-gradient(135deg, rgba(240,230,255,0.9), rgba(230,245,255,0.8))",
          border: "1px solid #e0ccff",
          borderRadius: "12px",
          boxShadow: "0 2px 4px rgba(0,0,0,0.06)",
          padding: "16px",
          marginBottom: "20px",
        }}
      >
        <h3
          style={{
            fontSize: "16px",
            marginBottom: "8px",
            color: "#6a1b9a",
          }}
        >
          ãã‚‡ã†ã®ã¾ã¨ã‚
        </h3>
        <p style={{ fontSize: "14px", margin: "4px 0", color: "#333" }}>
          åˆè¨ˆæ™‚é–“ï¼š<strong>{summary.totalMinutes}</strong>åˆ†
        </p>
        <p style={{ fontSize: "14px", margin: "4px 0", color: "#333" }}>
          åˆè¨ˆå›æ•°ï¼š<strong>{summary.totalCount}</strong>å›
        </p>
        <p style={{ fontSize: "14px", margin: "4px 0", color: "#333" }}>
          ã‘ã‚“ã™ã†ï¼š<strong>{summary.todayCount}</strong>ä»¶
        </p>
      </section>

      {/* å±¥æ­´ä¸€è¦§ */}
      <section>
        <h3
          style={{
            fontSize: "16px",
            marginBottom: "12px",
            color: "#6a1b9a",
          }}
        >
          ãœã‚“ãŸã„ã®ãã‚ã
        </h3>

        {decoratedList.length === 0 ? (
          <p style={{ fontSize: "14px", color: "#777" }}>
            ã¾ã ãã‚ããŒã‚ã‚Šã¾ã›ã‚“ã€‚
          </p>
        ) : (
          <div
            style={{
              display: "flex",
              flexDirection: "column",
              gap: "12px",
            }}
          >
            {decoratedList.map(({ originalIndex, record }) => {
              return (
                <div
                  key={originalIndex}
                  style={{
                    border: "1px solid #ddd",
                    borderRadius: "10px",
                    backgroundColor: "#fff",
                    padding: "12px",
                    boxShadow: "0 2px 4px rgba(0,0,0,0.05)",
                    display: "grid",
                    gridTemplateColumns: "1fr auto",
                    columnGap: "8px",
                  }}
                >
                  {/* å·¦å´ï¼šå†…å®¹ */}
                  <div
                    style={{
                      fontSize: "13px",
                      lineHeight: 1.4,
                      color: "#333",
                      wordBreak: "break-word",
                    }}
                  >
                    <div
                      style={{
                        fontSize: "13px",
                        color: "#999",
                        marginBottom: "4px",
                      }}
                    >
                      {formatDate(record.startedAt)}
                    </div>

                    <div
                      style={{
                        fontSize: "15px",
                        fontWeight: "600",
                        color: "#4a148c",
                      }}
                    >
                      {record.task || "ã‚¿ã‚¹ã‚¯ä¸æ˜"}
                    </div>

                    <div
                      style={{
                        fontSize: "14px",
                        color: "#333",
                      }}
                    >
                      â± {Math.floor((record.seconds || 0) / 60)}åˆ† ï¼ ğŸ¯{" "}
                      {record.count || 0}å›
                    </div>

                    {record.memo && (
                      <div
                        style={{
                          marginTop: "6px",
                          fontSize: "13px",
                          color: "#555",
                          background: "#fafafa",
                          borderRadius: "6px",
                          padding: "6px 8px",
                          whiteSpace: "pre-wrap",
                        }}
                      >
                        ğŸ“ {record.memo}
                      </div>
                    )}
                  </div>

                  {/* å³å´ï¼šç·¨é›†ãƒœã‚¿ãƒ³ */}
                  <div
                    style={{
                      display: "flex",
                      flexDirection: "column",
                      justifyContent: "flex-start",
                      alignItems: "flex-end",
                    }}
                  >
                    <button
                      onClick={() => {
                        window.location.href = `/history/edit?id=${originalIndex}`;
                      }}
                      style={{
                        backgroundColor: "#6a1b9a",
                        color: "#fff",
                        border: "none",
                        borderRadius: "8px",
                        padding: "8px 10px",
                        fontSize: "12px",
                        fontWeight: "600",
                        lineHeight: 1.2,
                        minWidth: "60px",
                        boxShadow: "0 2px 4px rgba(0,0,0,0.15)",
                      }}
                    >
                      ç·¨é›†
                    </button>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </section>

      {/* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */}
      <div style={{ marginTop: "24px", textAlign: "center" }}>
        <button
          onClick={() => (window.location.href = "/")}
          style={{
            backgroundColor: "#6a1b9a",
            color: "#fff",
            border: "none",
            borderRadius: "8px",
            fontSize: "15px",
            fontWeight: "600",
            padding: "10px 20px",
          }}
        >
          ãƒ›ãƒ¼ãƒ ã«ã‚‚ã©ã‚‹
        </button>
      </div>
    </main>
  );
}
