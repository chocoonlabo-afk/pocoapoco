"use client";

import { useEffect, useState } from "react";

export default function HistoryPage() {
  const [records, setRecords] = useState([]);
  const [summary, setSummary] = useState({
    totalMinutes: 0,
    totalCount: 0,
    todayCount: 0,
  });

  useEffect(() => {
    loadHistory();
  }, []);

  // localStorage ã‹ã‚‰å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
  function loadHistory() {
    try {
      const raw = localStorage.getItem("pocopoco_history");
      if (!raw) return;
      const data = JSON.parse(raw);
      if (!Array.isArray(data)) return;
      setRecords(data);
      setSummary(calculateSummary(data));
    } catch (e) {
      console.error("failed to load history", e);
    }
  }

  // åˆè¨ˆæ™‚é–“ãƒ»å›æ•°ã‚’é›†è¨ˆ
  function calculateSummary(records) {
    const today = new Date().toISOString().slice(0, 10);
    const todayRecords = records.filter((r) => r.startedAt?.startsWith(today));

    const totalSeconds = todayRecords.reduce(
      (sum, r) => sum + (r.seconds || 0),
      0
    );
    const totalCount = todayRecords.reduce(
      (sum, r) => sum + (r.count || 0),
      0
    );

    return {
      totalMinutes: Math.floor(totalSeconds / 60),
      totalCount,
      todayCount: todayRecords.length,
    };
  }

  // æ—¥ä»˜ã‚’ãã‚Œã„ã«è¡¨ç¤º
  function formatDate(dateStr) {
    if (!dateStr) return "";
    try {
      const d = new Date(dateStr);
      return d.toLocaleString("ja-JP", {
        month: "long",
        day: "numeric",
        weekday: "short",
        hour: "2-digit",
        minute: "2-digit",
      });
    } catch {
      return dateStr;
    }
  }

  return (
    <main
      style={{
        fontFamily: "system-ui, sans-serif",
        padding: "24px 16px 80px",
        maxWidth: "500px",
        margin: "0 auto",
      }}
    >
      <header style={{ marginBottom: "24px" }}>
        <h2 style={{ fontSize: "20px", marginBottom: "8px", color: "#4a148c" }}>
          ç·´ç¿’ã®ãã‚ã
        </h2>
        <p style={{ fontSize: "13px", color: "#777" }}>
          ä¿å­˜ã•ã‚ŒãŸç·´ç¿’ã®å±¥æ­´ã‚’ã²ã‚‡ã†ã˜ã—ã¾ã™
        </p>
      </header>

      {/* ä»Šæ—¥ã®ã‚µãƒãƒªãƒ¼ */}
      <section
        style={{
          background:
            "linear-gradient(135deg, rgba(240,230,255,0.9), rgba(230,245,255,0.8))",
          border: "1px solid #e0ccff",
          borderRadius: "12px",
          boxShadow: "0 2px 4px rgba(0,0,0,0.06)",
          padding: "16px",
          marginBottom: "20px",
        }}
      >
        <h3
          style={{
            fontSize: "16px",
            marginBottom: "8px",
            color: "#6a1b9a",
          }}
        >
          ãã‚‡ã†ã®ã¾ã¨ã‚
        </h3>
        <p style={{ fontSize: "14px", margin: "4px 0", color: "#333" }}>
          åˆè¨ˆæ™‚é–“ï¼š<strong>{summary.totalMinutes}</strong>åˆ†
        </p>
        <p style={{ fontSize: "14px", margin: "4px 0", color: "#333" }}>
          åˆè¨ˆå›æ•°ï¼š<strong>{summary.totalCount}</strong>å›
        </p>
        <p style={{ fontSize: "14px", margin: "4px 0", color: "#333" }}>
          ä»¶æ•°ï¼š<strong>{summary.todayCount}</strong>ä»¶
        </p>
      </section>

      {/* å±¥æ­´ä¸€è¦§ */}
      <section>
        <h3
          style={{
            fontSize: "16px",
            marginBottom: "12px",
            color: "#6a1b9a",
          }}
        >
          ãœã‚“ãŸã„ã®ãã‚ã
        </h3>

        {records.length === 0 ? (
          <p style={{ fontSize: "14px", color: "#777" }}>
            ã¾ã ãã‚ããŒã‚ã‚Šã¾ã›ã‚“ã€‚
          </p>
        ) : (
          <div style={{ display: "flex", flexDirection: "column", gap: "12px" }}>
            {[...records]
              .reverse()
              .map((r, idx) => (
                <div
                  key={idx}
                  style={{
                    border: "1px solid #ddd",
                    borderRadius: "10px",
                    backgroundColor: "#fff",
                    padding: "12px",
                    boxShadow: "0 2px 4px rgba(0,0,0,0.05)",
                  }}
                >
                  <div
                    style={{
                      fontSize: "13px",
                      color: "#999",
                      marginBottom: "4px",
                    }}
                  >
                    {formatDate(r.startedAt)}
                  </div>
                  <div
                    style={{
                      fontSize: "15px",
                      fontWeight: "600",
                      color: "#4a148c",
                    }}
                  >
                    {r.task || "ã‚¿ã‚¹ã‚¯ä¸æ˜"}
                  </div>
                  <div style={{ fontSize: "14px", color: "#333" }}>
                    â± {Math.floor((r.seconds || 0) / 60)}åˆ† ï¼ ğŸ¯{" "}
                    {r.count || 0}å›
                  </div>
                  {r.memo && (
                    <div
                      style={{
                        marginTop: "6px",
                        fontSize: "13px",
                        color: "#555",
                        background: "#fafafa",
                        borderRadius: "6px",
                        padding: "6px 8px",
                      }}
                    >
                      ğŸ“ {r.memo}
                    </div>
                  )}
                </div>
              ))}
          </div>
        )}
      </section>

      {/* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */}
      <div style={{ marginTop: "24px", textAlign: "center" }}>
        <button
          onClick={() => (window.location.href = "/")}
          style={{
            backgroundColor: "#6a1b9a",
            color: "#fff",
            border: "none",
            borderRadius: "8px",
            fontSize: "15px",
            fontWeight: "600",
            padding: "10px 20px",
          }}
        >
          ãƒ›ãƒ¼ãƒ ã«ã‚‚ã©ã‚‹
        </button>
      </div>
    </main>
  );
}
