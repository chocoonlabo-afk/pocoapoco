"use client";

import { useEffect, useRef, useState, useMemo } from "react";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  CartesianGrid,
} from "recharts";

export default function HistoryPage() {
  const [records, setRecords] = useState([]);
  const [summary, setSummary] = useState({
    totalMinutes: 0,
    totalCount: 0,
    todayCount: 0,
  });
  const [taskDict, setTaskDict] = useState({}); // task_id -> label

  // å­ã©ã‚‚ä¸€è¦§ã¨ã€è¡¨ç¤ºä¸­ã®å­
  const [children, setChildren] = useState([]);
  const [currentChildId, setCurrentChildId] = useState("all");

  // ãƒ­ãƒ¼ãƒ«ï¼ˆè¦ª / å­ï¼‰
  const [role, setRole] = useState("parent");

  // ã‚¿ã‚¹ã‚¯ãƒ•ã‚£ãƒ«ã‚¿ç”¨
  const [availableTasks, setAvailableTasks] = useState([]); // {id,label}[]
  const [selectedTaskIds, setSelectedTaskIds] = useState([]); // key[]
  const [isTaskSelectorOpen, setIsTaskSelectorOpen] = useState(false);

  // æœŸé–“ï¼ˆæ—¥/é€±/æœˆ/ã™ã¹ã¦ï¼‰
  const [periodType, setPeriodType] = useState("month"); // "day" | "week" | "month" | "all"

  // CSVå…¥å‡ºåŠ›
  const fileInputRef = useRef(null);

  // åˆæœŸèª­ã¿è¾¼ã¿
  useEffect(() => {
    if (typeof window === "undefined") return;

    loadTasksForNameResolve();

    // å­ã©ã‚‚ä¸€è¦§
    let loadedChildren = [];
    try {
      const rawChildren = localStorage.getItem("pocopoco_children");
      if (rawChildren) {
        const arr = JSON.parse(rawChildren);
        if (Array.isArray(arr)) {
          loadedChildren = arr;
          setChildren(arr);
        }
      }
    } catch (e) {
      console.warn("failed to load children", e);
    }

    // ãƒ­ãƒ¼ãƒ«
    let detectedRole = "parent";
    try {
      const savedRole = localStorage.getItem("pocopoco_role");
      if (savedRole === "child" || savedRole === "parent") {
        detectedRole = savedRole;
      }
      setRole(detectedRole);
    } catch (e) {
      console.warn("failed to load role", e);
    }

    // ç¾åœ¨ã®å­IDï¼ˆå¤ã„ã‚­ãƒ¼ã¨æ–°ã—ã„ã‚­ãƒ¼ä¸¡æ–¹ã‚’è¦‹ã‚‹ï¼‰
    let savedCurrentChild =
      localStorage.getItem("pocopoco_current_child_id") ||
      localStorage.getItem("pocopoco_currentChildId") ||
      "";

    if (detectedRole === "child") {
      // å­ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ã€Œè‡ªåˆ†ã€ã€‚"all" ã¯ç„¡åŠ¹ã¨ã—ã¦æ‰±ã„ã€ä¿å­˜ãŒãªã‘ã‚Œã°æœ€åˆã®å­
      if (
        (!savedCurrentChild || savedCurrentChild === "all") &&
        loadedChildren.length > 0
      ) {
        savedCurrentChild = loadedChildren[0].id;
      }
      setCurrentChildId(savedCurrentChild || "");
    } else {
      // è¦ªãƒ¢ãƒ¼ãƒ‰ãªã‚‰ã€Œä¿å­˜ã•ã‚Œã¦ã„ã‚‹å€¤ã€ã‚’å„ªå…ˆã—ã€ãªã‘ã‚Œã° all
      setCurrentChildId(savedCurrentChild || "all");
    }

    loadHistory(savedCurrentChild || "all", detectedRole);
  }, []);

  // â€» å±¥æ­´ç”»é¢ã§ã¯ currentChildId ã‚’ localStorage ã«ä¿å­˜ã—ãªã„
  //   â†’ è¨­å®šç”»é¢/ãƒ›ãƒ¼ãƒ å´ã®ã€Œã“ã®å­ã‚’è¡¨ç¤ºã€ã‚’ä¸Šæ›¸ãã—ãªã„ãŸã‚

  // å­ or records ãŒå¤‰ã‚ã£ãŸã‚‰ä»Šæ—¥ã®ã‚µãƒãƒªãƒ¼ã‚’å†è¨ˆç®—
  useEffect(() => {
    recalcSummaryForCurrentChild(records, currentChildId, role);
  }, [records, currentChildId, role]);

  // records or taskDict ãŒå¤‰ã‚ã£ãŸã‚‰ã€ã‚¿ã‚¹ã‚¯å€™è£œã‚’æ›´æ–°
  useEffect(() => {
    const { tasks } = collectAvailableTasks(records, taskDict);
    setAvailableTasks(tasks);
    if (selectedTaskIds.length === 0 && tasks.length > 0) {
      // åˆæœŸã¯ã€Œã™ã¹ã¦é¸æŠã€
      setSelectedTaskIds(tasks.map((t) => t.id));
    }
  }, [records, taskDict]);

  // è¨­å®šç”»é¢ã§ä¿å­˜ã—ã¦ã‚ã‚‹ã‚¿ã‚¹ã‚¯ã‚’èª­ã‚€ï¼ˆidâ†’labelï¼‰
  function loadTasksForNameResolve() {
    try {
      const raw = localStorage.getItem("pocopoco_tasks");
      if (!raw) return;
      const list = JSON.parse(raw);
      if (!Array.isArray(list)) return;
      const dict = {};
      list.forEach((t) => {
        if (t.id) {
          dict[t.id] = t.label || t.name || t.id;
        }
      });
      setTaskDict(dict);
    } catch (e) {
      console.warn("failed to load tasks for history name mapping", e);
    }
  }

  // localStorage ã‹ã‚‰å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
  function loadHistory(initialChildId, detectedRole) {
    try {
      const raw = localStorage.getItem("pocopoco_history");
      if (!raw) return;
      const data = JSON.parse(raw);
      if (!Array.isArray(data)) return;
      setRecords(data);
      recalcSummaryForCurrentChild(
        data,
        initialChildId || currentChildId,
        detectedRole || role
      );
    } catch (e) {
      console.error("failed to load history", e);
    }
  }

  // å­ã©ã‚‚ã§çµã‚Šè¾¼ã‚“ã§åˆè¨ˆæ™‚é–“ãƒ»å›æ•°ã‚’é›†è¨ˆï¼ˆä»Šæ—¥åˆ†ã®ã¿ï¼‰
  function recalcSummaryForCurrentChild(allRecords, targetChildId, currentRole) {
    const today = new Date().toISOString().slice(0, 10);
    const target = String(targetChildId ?? "");
    const isChildRole = currentRole === "child";

    const todayRecords = allRecords.filter((r) => {
      const started = r.startedAt || "";
      if (!started.startsWith(today)) return false;

      const recordChildId = String(r.child_id ?? "");

      // å­ãƒ¢ãƒ¼ãƒ‰ãªã‚‰å¸¸ã«è‡ªåˆ†
      if (isChildRole) {
        if (!target || target === "all") return false;
        return recordChildId === target;
      }

      // è¦ªãƒ¢ãƒ¼ãƒ‰
      if (target === "all" || !target) return true;
      return recordChildId === target;
    });

    const totalSeconds = todayRecords.reduce(
      (sum, r) => sum + (r.seconds || 0),
      0
    );
    const totalCount = todayRecords.reduce(
      (sum, r) => sum + (r.count || 0),
      0
    );

    setSummary({
      totalMinutes: Math.floor(totalSeconds / 60),
      totalCount,
      todayCount: todayRecords.length,
    });
  }

  // æ—¥ä»˜ã‚’ãã‚Œã„ã«è¡¨ç¤º
  function formatDate(dateStr) {
    if (!dateStr) return "";
    try {
      const d = new Date(dateStr);
      return d.toLocaleString("ja-JP", {
        month: "long",
        day: "numeric",
        weekday: "short",
        hour: "2-digit",
        minute: "2-digit",
      });
    } catch {
      return dateStr;
    }
  }

  // ã‚¿ã‚¹ã‚¯åã‚’è¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰å–ã‚‹
  function getTaskTitle(record) {
    if (record.task_title) return record.task_title; // æ–°
    if (record.task) return record.task; // æ—§
    if (record.task_id && taskDict[record.task_id]) {
      return taskDict[record.task_id];
    }
    return "ã‚¿ã‚¹ã‚¯ä¸æ˜";
  }

  // ã‚¿ã‚¹ã‚¯ã‚­ãƒ¼ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ç”¨ã€ä¸€æ„ã«ã™ã‚‹ï¼‰
  function getTaskKey(record) {
    if (record.task_id) return `id:${record.task_id}`;
    if (record.task_title) return `title:${record.task_title}`;
    if (record.task) return `name:${record.task}`;
    return "unknown";
  }

  // availableTasks ã‚’ä½œã‚‹
  function collectAvailableTasks(allRecords, dict) {
    const map = new Map(); // key -> label
    allRecords.forEach((r) => {
      const key = getTaskKey(r);
      const label =
        r.task_title || r.task || (r.task_id && dict[r.task_id]) || "ã‚¿ã‚¹ã‚¯ä¸æ˜";
      if (!map.has(key)) {
        map.set(key, label);
      }
    });
    const tasks = Array.from(map.entries()).map(([id, label]) => ({
      id,
      label,
    }));
    return { tasks };
  }

  // è¦ªãªã‚‰ç·¨é›†ã¸ã€å­ãªã‚‰ã‚¢ãƒ©ãƒ¼ãƒˆã ã‘
  function handleEditClick(absoluteIndex) {
    if (role !== "parent") {
      alert("ã“ã®ãã‚ãã®ç·¨é›†ã¯ ãŠã¨ãªã ã‘ãŒã§ãã¾ã™ã€‚");
      return;
    }
    if (absoluteIndex == null || absoluteIndex < 0) return;
    window.location.href = `/history/edit?id=${absoluteIndex}`;
  }

  // ä»Šé¸æŠã—ã¦ã‚‹å­ã©ã‚‚ã§çµã£ãŸå±¥æ­´ï¼ˆãƒ­ãƒ¼ãƒ«åˆ¥ï¼‰
  const recordsByChild = useMemo(() => {
    const current = String(currentChildId ?? "");
    if (role === "child") {
      if (!current || current === "all") return [];
      return records.filter((r) => String(r.child_id ?? "") === current);
    }
    if (current === "all" || !current) return records;
    return records.filter((r) => String(r.child_id ?? "") === current);
  }, [records, currentChildId, role]);

  // ã‚¿ã‚¹ã‚¯ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
  const filteredRecords =
    selectedTaskIds.length === 0
      ? recordsByChild
      : recordsByChild.filter((r) => selectedTaskIds.includes(getTaskKey(r)));

  // è¡¨ç¤ºç”¨ï¼ˆæ–°ã—ã„é †ï¼‰ï¼‹å…ƒé…åˆ—ã®çµ¶å¯¾ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿æŒ
  const decoratedList = useMemo(() => {
    const tmp = filteredRecords
      .map((r) => {
        const idx = records.indexOf(r);
        return { absoluteIndex: idx, record: r };
      })
      .filter((item) => item.absoluteIndex !== -1)
      .reverse();
    return tmp;
  }, [filteredRecords, records]);

  // ã‚°ãƒ©ãƒ•ç”¨ãƒ‡ãƒ¼ã‚¿
  const chartData = useMemo(
    () => buildChartData(filteredRecords, periodType),
    [filteredRecords, periodType]
  );

  // CSVå‡ºåŠ›
  function handleExportCsv() {
    if (records.length === 0) {
      alert("ã¾ã ãã‚ããŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    const header = [
      "startedAt",
      "child_id",
      "task_id",
      "task_title",
      "seconds",
      "count",
      "memo",
    ];
    const lines = [header.join(",")];

    records.forEach((r) => {
      const row = [
        r.startedAt || "",
        r.child_id || "",
        r.task_id || "",
        (r.task_title || r.task || "").replace(/,/g, " "),
        String(r.seconds || 0),
        String(r.count || 0),
        (r.memo || "").replace(/[\r\n,]/g, " "),
      ];
      lines.push(row.join(","));
    });

    const csv = lines.join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "pocopoco_history.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  // CSVå–è¾¼
  function handleImportClick() {
    if (fileInputRef.current) {
      fileInputRef.current.value = "";
      fileInputRef.current.click();
    }
  }

  function handleImportChange(e) {
    const file = e.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      const text = event.target?.result;
      if (typeof text !== "string") return;

      const imported = parseCsvToRecords(text);
      if (imported.length === 0) {
        alert("èª­ã¿è¾¼ã¿ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
        return;
      }

      const merged = [...records, ...imported];
      merged.sort((a, b) => {
        const da = new Date(a.startedAt || 0).getTime();
        const db = new Date(b.startedAt || 0).getTime();
        return da - db;
      });

      setRecords(merged);
      try {
        localStorage.setItem("pocopoco_history", JSON.stringify(merged));
      } catch (err) {
        console.error("failed to save imported history", err);
      }

      alert(`ãã‚ãã‚’ ${imported.length} ä»¶ ã¤ã„ã‹ã—ã¾ã—ãŸã€‚`);
    };
    reader.readAsText(file, "utf-8");
  }

  // å­ã©ã‚‚IDã‹ã‚‰åå‰ã‚’å¼•ãå°ã•ã„ãƒ˜ãƒ«ãƒ‘
  function renderChildNameFromId(childId, childrenList) {
    const found = childrenList.find((c) => c.id === childId);
    return found ? found.name : childId;
  }

  return (
    <main
      style={{
        fontFamily:
          'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
        padding: "24px 16px 80px",
        maxWidth: "500px",
        margin: "0 auto",
        backgroundColor: "#f7f0ff",
        minHeight: "100vh",
        boxSizing: "border-box",
      }}
    >
      <header style={{ marginBottom: "16px" }}>
        <h2 style={{ fontSize: "20px", marginBottom: "4px", color: "#4a148c" }}>
          ç·´ç¿’ã®ãã‚ã
        </h2>
        <p style={{ fontSize: "13px", color: "#777" }}>
          ã»ãã‚“ã•ã‚ŒãŸ ã‚Œã‚“ã—ã‚…ã†ã® ãã‚ãã§ã™
        </p>
        {role === "child" && (
          <p style={{ fontSize: "11px", color: "#c06", marginTop: "4px" }}>
            â€» ã„ã¾ã¯ã€Œå­ãƒ¢ãƒ¼ãƒ‰ã€ã§ã™ã€‚ç·¨é›†ã¯ã§ãã¾ã›ã‚“ã€‚
          </p>
        )}
      </header>

      {/* å­ã©ã‚‚åˆ‡æ›¿ */}
      {children.length > 0 && (
        <div
          style={{
            marginBottom: "10px",
            display: "flex",
            gap: "6px",
            flexWrap: "wrap",
          }}
        >
          {role !== "child" ? (
            <>
              <button
                onClick={() => setCurrentChildId("all")}
                style={{
                  border:
                    currentChildId === "all"
                      ? "1px solid #6a1b9a"
                      : "1px solid #ccc",
                  background: "#fff",
                  borderRadius: "999px",
                  padding: "4px 10px",
                  fontSize: "12px",
                  color: currentChildId === "all" ? "#6a1b9a" : "#555",
                }}
              >
                ãœã‚“ã„ã‚“
              </button>
              {children.map((ch) => (
                <button
                  key={ch.id}
                  onClick={() => setCurrentChildId(ch.id)}
                  style={{
                    border:
                      currentChildId === ch.id
                        ? "1px solid #6a1b9a"
                        : "1px solid #ccc",
                    background: "#fff",
                    borderRadius: "999px",
                    padding: "4px 10px",
                    fontSize: "12px",
                    color: currentChildId === ch.id ? "#6a1b9a" : "#555",
                  }}
                >
                  {ch.name}
                </button>
              ))}
            </>
          ) : (
            // å­ãƒ¢ãƒ¼ãƒ‰ï¼šè‡ªåˆ†ã ã‘è¡¨ç¤ºï¼ˆã‚¯ãƒªãƒƒã‚¯ä¸å¯ï¼‰
            children
              .filter((ch) => String(ch.id) === String(currentChildId))
              .map((ch) => (
                <span
                  key={ch.id}
                  style={{
                    border: "1px solid #6a1b9a",
                    color: "#6a1b9a",
                    backgroundColor: "#fff",
                    borderRadius: "999px",
                    padding: "4px 10px",
                    fontSize: "12px",
                  }}
                >
                  {ch.name}
                </span>
              ))
          )}
        </div>
      )}

      {/* ãƒ•ã‚£ãƒ«ã‚¿ + CSV */}
      <section
        style={{
          borderRadius: "12px",
          background: "#faf5ff",
          border: "1px solid #e0ccff",
          padding: "10px 12px",
          marginBottom: "16px",
          display: "flex",
          flexDirection: "column",
          gap: "8px",
        }}
      >
        {/* ä¸Šæ®µï¼šã‚¿ã‚¹ã‚¯é¸æŠï¼‹CSV */}
        <div
          style={{
            display: "flex",
            gap: "8px",
            alignItems: "center",
          }}
        >
          <button
            onClick={() => setIsTaskSelectorOpen(true)}
            style={{
              flex: 1,
              borderRadius: "999px",
              border: "1px solid #6a1b9a",
              padding: "4px 10px",
              fontSize: "13px",
              background: "#fff",
              textAlign: "left",
            }}
          >
            {selectedTaskIds.length === 0 ||
            selectedTaskIds.length === availableTasks.length
              ? "ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯"
              : `${selectedTaskIds.length} ä»¶ã®ã‚¿ã‚¹ã‚¯`}
          </button>

          <div
            style={{
              display: "flex",
              gap: "4px",
              flexShrink: 0,
            }}
          >
            <button
              onClick={handleExportCsv}
              style={{
                borderRadius: "999px",
                border: "1px solid #bbb",
                padding: "4px 8px",
                fontSize: "11px",
                background: "#fff",
              }}
            >
              CSVå‡ºåŠ›
            </button>
            <button
              onClick={handleImportClick}
              style={{
                borderRadius: "999px",
                border: "1px solid #bbb",
                padding: "4px 8px",
                fontSize: "11px",
                background: "#fff",
              }}
            >
              CSVå–è¾¼
            </button>
          </div>
        </div>

        {/* ä¸‹æ®µï¼šæœŸé–“ãƒœã‚¿ãƒ³ */}
        <div
          style={{
            display: "flex",
            gap: "6px",
            flexWrap: "wrap",
          }}
        >
          {[
            { id: "day", label: "æ—¥" },
            { id: "week", label: "é€±" },
            { id: "month", label: "æœˆ" },
            { id: "all", label: "ã™ã¹ã¦" },
          ].map((p) => (
            <button
              key={p.id}
              onClick={() => setPeriodType(p.id)}
              style={{
                borderRadius: "999px",
                padding: "4px 10px",
                fontSize: "12px",
                border:
                  periodType === p.id
                    ? "1px solid #6a1b9a"
                    : "1px solid #ccc",
                background:
                  periodType === p.id ? "rgba(106,27,154,0.08)" : "#fff",
              }}
            >
              {p.label}
            </button>
          ))}
        </div>
      </section>

      {/* ã‚°ãƒ©ãƒ•ã‚«ãƒ¼ãƒ‰ï¼ˆç¸¦æ£’ï¼‰ */}
      <section
        style={{
          borderRadius: "12px",
          background: "#fff",
          border: "1px solid #eee",
          boxShadow: "0 2px 4px rgba(0,0,0,0.04)",
          padding: "10px 12px 4px",
          marginBottom: "20px",
        }}
      >
        <h3
          style={{
            fontSize: "14px",
            marginBottom: "4px",
            color: "#6a1b9a",
          }}
        >
          ã‚°ãƒ©ãƒ•
        </h3>
        <p style={{ fontSize: "11px", color: "#777", marginBottom: "8px" }}>
          ä¸Šã®ã‚¿ã‚¹ã‚¯ã¨æœŸé–“ã‚’ãˆã‚‰ã¶ã¨ã€åˆè¨ˆç·´ç¿’æ™‚é–“ã®ã‚°ãƒ©ãƒ•ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚
        </p>
        <div style={{ width: "100%", height: 180 }}>
          {chartData.length === 0 ? (
            <div
              style={{
                fontSize: "12px",
                color: "#999",
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
                height: "100%",
              }}
            >
              ã¾ã ã‚°ãƒ©ãƒ•ã«ã§ãã‚‹ ãã‚ããŒã‚ã‚Šã¾ã›ã‚“ã€‚
            </div>
          ) : (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={chartData}>
                {/* ç´«ç³»ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */}
                <defs>
                  <linearGradient
                    id="minutesPurple"
                    x1="0"
                    y1="0"
                    x2="0"
                    y2="1"
                  >
                    <stop offset="0%" stopColor="#ce93d8" />
                    <stop offset="100%" stopColor="#6a1b9a" />
                  </linearGradient>
                </defs>

                <CartesianGrid strokeDasharray="3 3" vertical={false} />
                <XAxis
                  dataKey="label"
                  tick={{ fontSize: 10 }}
                  interval={0}
                  height={30}
                />
                <YAxis
                  tick={{ fontSize: 10 }}
                  width={32}
                  tickFormatter={(v) => `${v}åˆ†`}
                />
                <Tooltip
                  formatter={(value) => [`${value} åˆ†`, "åˆè¨ˆæ™‚é–“"]}
                  labelFormatter={(label) => label}
                />
                <Bar
                  dataKey="minutes"
                  fill="url(#minutesPurple)"
                  radius={[4, 4, 0, 0]}
                />
              </BarChart>
            </ResponsiveContainer>
          )}
        </div>
      </section>

      {/* ä»Šæ—¥ã®ã‚µãƒãƒªãƒ¼ */}
      <section
        style={{
          background:
            "linear-gradient(135deg, rgba(240,230,255,0.9), rgba(230,245,255,0.8))",
          border: "1px solid #e0ccff",
          borderRadius: "12px",
          boxShadow: "0 2px 4px rgba(0,0,0,0.06)",
          padding: "16px",
          marginBottom: "20px",
        }}
      >
        <h3
          style={{
            fontSize: "16px",
            marginBottom: "8px",
            color: "#6a1b9a",
          }}
        >
          ãã‚‡ã†ã®ã¾ã¨ã‚
        </h3>
        <p style={{ fontSize: "14px", margin: "4px 0", color: "#333" }}>
          åˆè¨ˆæ™‚é–“ï¼š<strong>{summary.totalMinutes}</strong>åˆ†
        </p>
        <p style={{ fontSize: "14px", margin: "4px 0", color: "#333" }}>
          åˆè¨ˆå›æ•°ï¼š<strong>{summary.totalCount}</strong>å›
        </p>
        <p style={{ fontSize: "14px", margin: "4px 0", color: "#333" }}>
          ã‘ã‚“ã™ã†ï¼š<strong>{summary.todayCount}</strong>ä»¶
        </p>
      </section>

      {/* å±¥æ­´ä¸€è¦§ */}
      <section>
        <h3
          style={{
            fontSize: "16px",
            marginBottom: "12px",
            color: "#6a1b9a",
          }}
        >
          {role === "child"
            ? "ã˜ã¶ã‚“ã®ãã‚ã"
            : currentChildId === "all"
            ? "ãœã‚“ãŸã„ã®ãã‚ã"
            : "ã“ã®å­ã®ãã‚ã"}
        </h3>

        {decoratedList.length === 0 ? (
          <p style={{ fontSize: "14px", color: "#777" }}>
            ã¾ã ãã‚ããŒã‚ã‚Šã¾ã›ã‚“ã€‚
          </p>
        ) : (
          <div
            style={{
              display: "flex",
              flexDirection: "column",
              gap: "12px",
            }}
          >
            {decoratedList.map(({ absoluteIndex, record }) => {
              const taskTitle = getTaskTitle(record);
              const minutes = Math.floor((record.seconds || 0) / 60);

              return (
                <div
                  key={absoluteIndex}
                  style={{
                    border: "1px solid #ddd",
                    borderRadius: "10px",
                    backgroundColor: "#fff",
                    padding: "12px",
                    boxShadow: "0 2px 4px rgba(0,0,0,0.05)",
                    display: "grid",
                    gridTemplateColumns: "1fr auto",
                    columnGap: "8px",
                  }}
                >
                  {/* å·¦å´ï¼šå†…å®¹ */}
                  <div
                    style={{
                      fontSize: "13px",
                      lineHeight: 1.4,
                      color: "#333",
                      wordBreak: "break-word",
                    }}
                  >
                    <div
                      style={{
                        fontSize: "13px",
                        color: "#999",
                        marginBottom: "4px",
                      }}
                    >
                      {formatDate(record.startedAt)}
                    </div>

                    {role !== "child" &&
                      currentChildId === "all" &&
                      record.child_id && (
                        <div
                          style={{
                            fontSize: "11px",
                            color: "#6a1b9a",
                            marginBottom: "2px",
                          }}
                        >
                          {renderChildNameFromId(record.child_id, children)}
                        </div>
                      )}

                    <div
                      style={{
                        fontSize: "15px",
                        fontWeight: "600",
                        color: "#4a148c",
                      }}
                    >
                      {taskTitle}
                    </div>

                    <div
                      style={{
                        fontSize: "14px",
                        color: "#333",
                      }}
                    >
                      â± {minutes}åˆ† ï¼ ğŸ¯ {record.count || 0}å›
                    </div>

                    {record.memo && (
                      <div
                        style={{
                          marginTop: "6px",
                          fontSize: "13px",
                          color: "#555",
                          background: "#fafafa",
                          borderRadius: "6px",
                          padding: "6px 8px",
                          whiteSpace: "pre-wrap",
                        }}
                      >
                        ğŸ“ {record.memo}
                      </div>
                    )}
                  </div>

                  {/* å³å´ï¼šç·¨é›†ãƒœã‚¿ãƒ³ï¼ˆè¦ªã ã‘ï¼‰ */}
                  <div
                    style={{
                      display: "flex",
                      flexDirection: "column",
                      justifyContent: "flex-start",
                      alignItems: "flex-end",
                    }}
                  >
                    {role === "parent" && (
                      <button
                        onClick={() => handleEditClick(absoluteIndex)}
                        style={{
                          backgroundColor: "#6a1b9a",
                          color: "#fff",
                          border: "none",
                          borderRadius: "8px",
                          padding: "8px 10px",
                          fontSize: "12px",
                          fontWeight: "600",
                          lineHeight: 1.2,
                          minWidth: "60px",
                          boxShadow: "0 2px 4px rgba(0,0,0,0.15)",
                        }}
                      >
                        ç·¨é›†
                      </button>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </section>

      {/* æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆå…±é€šã§è¡¨ç¤ºï¼‰ */}
      <div style={{ marginTop: "24px", textAlign: "center" }}>
        <button
          onClick={() => (window.location.href = "/")}
          style={{
            backgroundColor: "#6a1b9a",
            color: "#fff",
            border: "none",
            borderRadius: "8px",
            fontSize: "15px",
            fontWeight: "600",
            padding: "10px 20px",
          }}
        >
          ãƒ›ãƒ¼ãƒ ã«ã‚‚ã©ã‚‹
        </button>
      </div>

      {/* CSVå…¥åŠ›ç”¨ hidden input */}
      <input
        ref={fileInputRef}
        type="file"
        accept=".csv,text/csv"
        style={{ display: "none" }}
        onChange={handleImportChange}
      />

      {/* ã‚¿ã‚¹ã‚¯é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {isTaskSelectorOpen && (
        <div
          onClick={() => setIsTaskSelectorOpen(false)}
          style={{
            position: "fixed",
            inset: 0,
            background: "rgba(0,0,0,0.35)",
            display: "flex",
            justifyContent: "center",
            alignItems: "center",
            zIndex: 50,
          }}
        >
          <div
            onClick={(e) => e.stopPropagation()}
            style={{
              width: "90%",
              maxWidth: "420px",
              maxHeight: "70vh",
              background: "#fff",
              borderRadius: "12px",
              padding: "14px 16px",
              boxShadow: "0 4px 12px rgba(0,0,0,0.25)",
              display: "flex",
              flexDirection: "column",
              gap: "8px",
            }}
          >
            <h4
              style={{
                fontSize: "15px",
                marginBottom: "4px",
                color: "#4a148c",
              }}
            >
              ã‚¿ã‚¹ã‚¯ã‚’ãˆã‚‰ã¶
            </h4>
            <p style={{ fontSize: "12px", color: "#777" }}>
              ã¿ãŸã„ã‚¿ã‚¹ã‚¯ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ï¼ˆè¤‡æ•°é¸æŠã§ãã¾ã™ï¼‰ã€‚
            </p>

            <div
              style={{
                flex: 1,
                overflowY: "auto",
                marginTop: "4px",
                paddingRight: "4px",
              }}
            >
              <label
                style={{
                  display: "flex",
                  alignItems: "center",
                  gap: "8px",
                  fontSize: "13px",
                  padding: "4px 0",
                }}
              >
                <input
                  type="checkbox"
                  checked={
                    selectedTaskIds.length === availableTasks.length ||
                    selectedTaskIds.length === 0
                  }
                  onChange={(e) => {
                    if (e.target.checked) {
                      setSelectedTaskIds(availableTasks.map((t) => t.id));
                    } else {
                      setSelectedTaskIds([]);
                    }
                  }}
                />
                <span>ã™ã¹ã¦é¸æŠ / è§£é™¤</span>
              </label>
              <hr style={{ border: "none", borderTop: "1px solid #eee" }} />
              {availableTasks.map((t) => (
                <label
                  key={t.id}
                  style={{
                    display: "flex",
                    alignItems: "center",
                    gap: "8px",
                    fontSize: "13px",
                    padding: "4px 0",
                  }}
                >
                  <input
                    type="checkbox"
                    checked={
                      selectedTaskIds.length === 0 ||
                      selectedTaskIds.includes(t.id)
                    }
                    onChange={(e) => {
                      if (e.target.checked) {
                        setSelectedTaskIds((prev) =>
                          prev.includes(t.id) ? prev : [...prev, t.id]
                        );
                      } else {
                        setSelectedTaskIds((prev) =>
                          prev.filter((id) => id !== t.id)
                        );
                      }
                    }}
                  />
                  <span>{t.label}</span>
                </label>
              ))}
            </div>

            <div
              style={{
                display: "flex",
                justifyContent: "flex-end",
                gap: "8px",
                marginTop: "8px",
              }}
            >
              <button
                onClick={() => setIsTaskSelectorOpen(false)}
                style={{
                  borderRadius: "8px",
                  border: "1px solid #ccc",
                  padding: "6px 12px",
                  fontSize: "13px",
                  background: "#fff",
                }}
              >
                ã¨ã˜ã‚‹
              </button>
            </div>
          </div>
        </div>
      )}
    </main>
  );
}

// ã‚°ãƒ©ãƒ•ç”¨ãƒ‡ãƒ¼ã‚¿ä½œæˆ
function buildChartData(records, periodType) {
  if (!Array.isArray(records) || records.length === 0) return [];

  const map = new Map(); // key -> { label, seconds }

  records.forEach((r) => {
    if (!r.startedAt) return;
    const d = new Date(r.startedAt);
    if (Number.isNaN(d.getTime())) return;

    let key = "";
    let label = "";

    const yyyy = d.getFullYear();
    const mm = d.getMonth() + 1;
    const dd = d.getDate();

    if (periodType === "day") {
      key = d.toISOString().slice(0, 10); // YYYY-MM-DD
      label = `${mm}/${dd}`;
    } else if (periodType === "week") {
      const weekStart = getMonday(d);
      const wmm = weekStart.getMonth() + 1;
      const wdd = weekStart.getDate();
      key = `W-${weekStart.toISOString().slice(0, 10)}`;
      label = `${wmm}/${wdd}é€±`;
    } else {
      // "month" or "all"
      key = `${yyyy}-${String(mm).padStart(2, "0")}`;
      label = `${yyyy}/${mm}`;
    }

    const before = map.get(key) || { label, seconds: 0 };
    before.seconds += r.seconds || 0;
    map.set(key, before);
  });

  return Array.from(map.entries())
    .sort((a, b) => (a[0] < b[0] ? -1 : 1))
    .map(([_, v]) => ({
      label: v.label,
      minutes: Math.round(v.seconds / 60),
    }));
}

// ãã®é€±ã®æœˆæ›œæ—¥ï¼ˆé€±é›†è¨ˆç”¨ï¼‰
function getMonday(date) {
  const d = new Date(date);
  const day = d.getDay(); // 0:æ—¥
  const diff = (day + 6) % 7; // æœˆæ›œ=0
  d.setDate(d.getDate() - diff);
  d.setHours(0, 0, 0, 0);
  return d;
}

// CSV â†’ record[]
function parseCsvToRecords(text) {
  const lines = text.split(/\r?\n/).filter((l) => l.trim() !== "");
  if (lines.length === 0) return [];

  const [headerLine, ...dataLines] = lines;
  const headers = headerLine.split(",").map((h) => h.trim());

  const idxStartedAt = headers.indexOf("startedAt");
  const idxChildId = headers.indexOf("child_id");
  const idxTaskId = headers.indexOf("task_id");
  const idxTaskTitle = headers.indexOf("task_title");
  const idxSeconds = headers.indexOf("seconds");
  const idxCount = headers.indexOf("count");
  const idxMemo = headers.indexOf("memo");

  if (idxStartedAt === -1) {
    // ãƒ˜ãƒƒãƒ€ãªã—ã¨ã—ã¦å…¨è¡Œã‚’ãƒ‡ãƒ¼ã‚¿æ‰±ã„ï¼ˆç°¡æ˜“ï¼‰
    return dataLines.map((line) => {
      const cols = line.split(",");
      return {
        startedAt: cols[0] || "",
        child_id: cols[1] || "",
        task_id: cols[2] || "",
        task_title: cols[3] || "",
        seconds: Number(cols[4] || "0") || 0,
        count: Number(cols[5] || "0") || 0,
        memo: cols[6] || "",
      };
    });
  }

  return dataLines.map((line) => {
    const cols = line.split(",");
    return {
      startedAt: cols[idxStartedAt] || "",
      child_id: idxChildId >= 0 ? cols[idxChildId] || "" : "",
      task_id: idxTaskId >= 0 ? cols[idxTaskId] || "" : "",
      task_title: idxTaskTitle >= 0 ? cols[idxTaskTitle] || "" : "",
      seconds:
        idxSeconds >= 0 ? Number(cols[idxSeconds] || "0") || 0 : 0,
      count: idxCount >= 0 ? Number(cols[idxCount] || "0") || 0 : 0,
      memo: idxMemo >= 0 ? cols[idxMemo] || "" : "",
    };
  });
}
