"use client";

import { useEffect, useState } from "react";

export default function HistoryPage() {
  const [records, setRecords] = useState([]);
  const [summary, setSummary] = useState({
    totalMinutes: 0,
    totalCount: 0,
    todayCount: 0,
  });
  const [taskDict, setTaskDict] = useState({}); // task_id -> label ç”¨

  // â˜… A-6: å­ã©ã‚‚ä¸€è¦§ã¨ã€è¡¨ç¤ºä¸­ã®å­
  const [children, setChildren] = useState([]);
  const [currentChildId, setCurrentChildId] = useState("all");

  // â˜… ãƒ­ãƒ¼ãƒ«ï¼ˆè¦ª / å­ï¼‰
  const [role, setRole] = useState("parent");

  useEffect(() => {
    // ã‚¿ã‚¹ã‚¯åè§£æ±ºç”¨
    loadTasksForNameResolve();

    // å­ã©ã‚‚ä¸€è¦§ã¨è¡¨ç¤ºä¸­ã®å­ã‚’èª­ã‚€
    try {
      const rawChildren = localStorage.getItem("pocopoco_children");
      if (rawChildren) {
        const arr = JSON.parse(rawChildren);
        if (Array.isArray(arr)) {
          setChildren(arr);
        }
      }
      const savedCurrentChild = localStorage.getItem("pocopoco_current_child_id");
      if (savedCurrentChild) {
        setCurrentChildId(savedCurrentChild); // åˆæœŸè¡¨ç¤ºã¯ã€Œè¨­å®šã§ä»Šè¦‹ã¦ã‚‹å­ã€
      }
    } catch (e) {
      console.warn("failed to load children", e);
    }

    // ãƒ­ãƒ¼ãƒ«ã‚’èª­ã‚€
    try {
      const savedRole = localStorage.getItem("pocopoco_role");
      if (savedRole === "child" || savedRole === "parent") {
        setRole(savedRole);
      }
    } catch (e) {
      console.warn("failed to load role", e);
    }

    // å±¥æ­´ã‚’èª­ã‚€
    loadHistory();
  }, []);

  // å­ã©ã‚‚ã‚’åˆ‡ã‚Šæ›¿ãˆãŸã‚‰ã‚µãƒãƒªãƒ¼ã‚’å†è¨ˆç®—
  useEffect(() => {
    recalcSummaryForCurrentChild(records, currentChildId);
  }, [currentChildId, records]);

  // è¨­å®šç”»é¢ã§ä¿å­˜ã—ã¦ã‚ã‚‹ã‚¿ã‚¹ã‚¯ã‚’èª­ã‚€ï¼ˆidâ†’labelã®è¾æ›¸ã‚’ä½œã‚‹ï¼‰
  function loadTasksForNameResolve() {
    try {
      const raw = localStorage.getItem("pocopoco_tasks");
      if (!raw) return;
      const list = JSON.parse(raw);
      if (!Array.isArray(list)) return;
      const dict = {};
      list.forEach((t) => {
        if (t.id) {
          dict[t.id] = t.label || t.name || t.id;
        }
      });
      setTaskDict(dict);
    } catch (e) {
      console.warn("failed to load tasks for history name mapping", e);
    }
  }

  // localStorage ã‹ã‚‰å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
  function loadHistory() {
    try {
      const raw = localStorage.getItem("pocopoco_history");
      if (!raw) return;
      const data = JSON.parse(raw);
      if (!Array.isArray(data)) return;
      setRecords(data);
      // èª­ã¿è¾¼ã‚“ã æ™‚ç‚¹ã§ã„ã¾ã®å­ã§ã‚µãƒãƒªãƒ¼ã‚’è¨ˆç®—
      recalcSummaryForCurrentChild(data, currentChildId);
    } catch (e) {
      console.error("failed to load history", e);
    }
  }

  // å­ã©ã‚‚ã§çµã‚Šè¾¼ã‚“ã§åˆè¨ˆæ™‚é–“ãƒ»å›æ•°ã‚’é›†è¨ˆï¼ˆãã‚‡ã†åˆ†ã®ã¿ï¼‰
  function recalcSummaryForCurrentChild(allRecords, targetChildId) {
    const today = new Date().toISOString().slice(0, 10);
    const todayRecords = allRecords.filter((r) => {
      if (!r.startedAt?.startsWith(today)) return false;
      // "all" ã‹ã€ã‚‚ã—ãã¯ child_id ãŒä¸€è‡´ã™ã‚‹ã‚‚ã®ã ã‘
      if (targetChildId === "all") return true;
      return (r.child_id || "") === targetChildId;
    });

    const totalSeconds = todayRecords.reduce(
      (sum, r) => sum + (r.seconds || 0),
      0
    );
    const totalCount = todayRecords.reduce(
      (sum, r) => sum + (r.count || 0),
      0
    );

    setSummary({
      totalMinutes: Math.floor(totalSeconds / 60),
      totalCount,
      todayCount: todayRecords.length,
    });
  }

  // æ—¥ä»˜ã‚’ãã‚Œã„ã«è¡¨ç¤º
  function formatDate(dateStr) {
    if (!dateStr) return "";
    try {
      const d = new Date(dateStr);
      return d.toLocaleString("ja-JP", {
        month: "long",
        day: "numeric",
        weekday: "short",
        hour: "2-digit",
        minute: "2-digit",
      });
    } catch {
      return dateStr;
    }
  }

  // ã‚¿ã‚¹ã‚¯åã‚’è¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰å–ã‚‹
  function getTaskTitle(record) {
    // æ–°: task_title ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
    if (record.task_title) return record.task_title;
    // æ—§: task ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
    if (record.task) return record.task;
    // task_id ãŒã‚ã£ã¦ã€è¾æ›¸ã«ã‚ã‚‹ãªã‚‰æ‹¾ã†
    if (record.task_id && taskDict[record.task_id]) {
      return taskDict[record.task_id];
    }
    // ä½•ã‚‚ãªã‘ã‚Œã°ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€
    return "ã‚¿ã‚¹ã‚¯ä¸æ˜";
  }

  // è¦ªãªã‚‰ç·¨é›†ã¸ã€å­ãªã‚‰ä½•ã‚‚ã—ãªã„ï¼ˆã‚‚ã—ãã¯ã‚¢ãƒ©ãƒ¼ãƒˆã ã‘ï¼‰
  function handleEditClick(originalIndex) {
    if (role !== "parent") {
      alert("ã“ã®ãã‚ãã®ç·¨é›†ã¯ ãŠã¨ãªã ã‘ãŒã§ãã¾ã™ã€‚");
      return;
    }
    // è¦ªã‚³ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å®¶åº­ãªã‚‰ã“ã“ã§ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚‚ã„ã„ã‘ã©ã€
    // ä»Šå›ã¯ç”»é¢é·ç§»ã®ã¿
    window.location.href = `/history/edit?id=${originalIndex}`;
  }

  // ä»Šé¸æŠã—ã¦ã‚‹å­ã©ã‚‚ã§çµã£ãŸå±¥æ­´
  const filteredRecords =
    currentChildId === "all"
      ? records
      : records.filter((r) => (r.child_id || "") === currentChildId);

  // è¡¨ç¤ºç”¨ã« reverse ã—ã¦æ–°ã—ã„é †ã«ã™ã‚‹
  const decoratedList = filteredRecords
    .map((r, originalIndex) => ({
      originalIndex,
      record: r,
    }))
    .reverse();

  return (
    <main
      style={{
        fontFamily: "system-ui, sans-serif",
        padding: "24px 16px 80px",
        maxWidth: "500px",
        margin: "0 auto",
      }}
    >
      <header style={{ marginBottom: "16px" }}>
        <h2 style={{ fontSize: "20px", marginBottom: "4px", color: "#4a148c" }}>
          ç·´ç¿’ã®ãã‚ã
        </h2>
        <p style={{ fontSize: "13px", color: "#777" }}>
          ã»ãã‚“ã•ã‚ŒãŸ ã‚Œã‚“ã—ã‚…ã†ã® ãã‚ãã§ã™
        </p>
        {role === "child" && (
          <p style={{ fontSize: "11px", color: "#c06", marginTop: "4px" }}>
            â€» ã„ã¾ã¯ã€Œå­ãƒ¢ãƒ¼ãƒ‰ã€ã§ã™ã€‚ç·¨é›†ã¯ã§ãã¾ã›ã‚“ã€‚
          </p>
        )}
      </header>

      {/* å­ã©ã‚‚åˆ‡æ›¿ */}
      {children.length > 0 && (
        <div
          style={{
            marginBottom: "14px",
            display: "flex",
            gap: "6px",
            flexWrap: "wrap",
          }}
        >
          <button
            onClick={() => setCurrentChildId("all")}
            style={{
              border:
                currentChildId === "all" ? "1px solid #6a1b9a" : "1px solid #ccc",
              background: "#fff",
              borderRadius: "999px",
              padding: "4px 10px",
              fontSize: "12px",
            }}
          >
            ãœã‚“ã„ã‚“
          </button>
          {children.map((ch) => (
            <button
              key={ch.id}
              onClick={() => setCurrentChildId(ch.id)}
              style={{
                border:
                  currentChildId === ch.id
                    ? "1px solid #6a1b9a"
                    : "1px solid #ccc",
                background: "#fff",
                borderRadius: "999px",
                padding: "4px 10px",
                fontSize: "12px",
              }}
            >
              {ch.name}
            </button>
          ))}
        </div>
      )}

      {/* ä»Šæ—¥ã®ã‚µãƒãƒªãƒ¼ */}
      <section
        style={{
          background:
            "linear-gradient(135deg, rgba(240,230,255,0.9), rgba(230,245,255,0.8))",
          border: "1px solid #e0ccff",
          borderRadius: "12px",
          boxShadow: "0 2px 4px rgba(0,0,0,0.06)",
          padding: "16px",
          marginBottom: "20px",
        }}
      >
        <h3
          style={{
            fontSize: "16px",
            marginBottom: "8px",
            color: "#6a1b9a",
          }}
        >
          ãã‚‡ã†ã®ã¾ã¨ã‚
        </h3>
        <p style={{ fontSize: "14px", margin: "4px 0", color: "#333" }}>
          åˆè¨ˆæ™‚é–“ï¼š<strong>{summary.totalMinutes}</strong>åˆ†
        </p>
        <p style={{ fontSize: "14px", margin: "4px 0", color: "#333" }}>
          åˆè¨ˆå›æ•°ï¼š<strong>{summary.totalCount}</strong>å›
        </p>
        <p style={{ fontSize: "14px", margin: "4px 0", color: "#333" }}>
          ã‘ã‚“ã™ã†ï¼š<strong>{summary.todayCount}</strong>ä»¶
        </p>
      </section>

      {/* å±¥æ­´ä¸€è¦§ */}
      <section>
        <h3
          style={{
            fontSize: "16px",
            marginBottom: "12px",
            color: "#6a1b9a",
          }}
        >
          {currentChildId === "all" ? "ãœã‚“ãŸã„ã®ãã‚ã" : "ã“ã®å­ã®ãã‚ã"}
        </h3>

        {decoratedList.length === 0 ? (
          <p style={{ fontSize: "14px", color: "#777" }}>
            ã¾ã ãã‚ããŒã‚ã‚Šã¾ã›ã‚“ã€‚
          </p>
        ) : (
          <div
            style={{
              display: "flex",
              flexDirection: "column",
              gap: "12px",
            }}
          >
            {decoratedList.map(({ originalIndex, record }) => {
              const taskTitle = getTaskTitle(record);
              const minutes = Math.floor((record.seconds || 0) / 60);

              return (
                <div
                    key={originalIndex}
                    style={{
                      border: "1px solid #ddd",
                      borderRadius: "10px",
                      backgroundColor: "#fff",
                      padding: "12px",
                      boxShadow: "0 2px 4px rgba(0,0,0,0.05)",
                      display: "grid",
                      gridTemplateColumns: "1fr auto",
                      columnGap: "8px",
                    }}
                  >
                  {/* å·¦å´ï¼šå†…å®¹ */}
                  <div
                    style={{
                      fontSize: "13px",
                      lineHeight: 1.4,
                      color: "#333",
                      wordBreak: "break-word",
                    }}
                  >
                    <div
                      style={{
                        fontSize: "13px",
                        color: "#999",
                        marginBottom: "4px",
                      }}
                    >
                      {formatDate(record.startedAt)}
                    </div>

                    {/* å­ã©ã‚‚åã‚‚è¡¨ç¤ºã—ã¦ãŠãã¨ã‚ã‹ã‚Šã‚„ã™ã„ */}
                    {currentChildId === "all" && record.child_id && (
                      <div
                        style={{
                          fontSize: "11px",
                          color: "#6a1b9a",
                          marginBottom: "2px",
                        }}
                      >
                        {renderChildNameFromId(record.child_id, children)}
                      </div>
                    )}

                    <div
                      style={{
                        fontSize: "15px",
                        fontWeight: "600",
                        color: "#4a148c",
                      }}
                    >
                      {taskTitle}
                    </div>

                    <div
                      style={{
                        fontSize: "14px",
                        color: "#333",
                      }}
                    >
                      â± {minutes}åˆ† ï¼ ğŸ¯ {record.count || 0}å›
                    </div>

                    {record.memo && (
                      <div
                        style={{
                          marginTop: "6px",
                          fontSize: "13px",
                          color: "#555",
                          background: "#fafafa",
                          borderRadius: "6px",
                          padding: "6px 8px",
                          whiteSpace: "pre-wrap",
                        }}
                      >
                        ğŸ“ {record.memo}
                      </div>
                    )}
                  </div>

                  {/* å³å´ï¼šç·¨é›†ãƒœã‚¿ãƒ³ï¼ˆè¦ªã ã‘ï¼‰ */}
                  <div
                    style={{
                      display: "flex",
                      flexDirection: "column",
                      justifyContent: "flex-start",
                      alignItems: "flex-end",
                    }}
                  >
                    {role === "parent" && (
                      <button
                        onClick={() => handleEditClick(originalIndex)}
                        style={{
                          backgroundColor: "#6a1b9a",
                          color: "#fff",
                          border: "none",
                          borderRadius: "8px",
                          padding: "8px 10px",
                          fontSize: "12px",
                          fontWeight: "600",
                          lineHeight: 1.2,
                          minWidth: "60px",
                          boxShadow: "0 2px 4px rgba(0,0,0,0.15)",
                        }}
                      >
                        ç·¨é›†
                      </button>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </section>

      {/* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */}
      <div style={{ marginTop: "24px", textAlign: "center" }}>
        <button
          onClick={() => (window.location.href = "/")}
          style={{
            backgroundColor: "#6a1b9a",
            color: "#fff",
            border: "none",
            borderRadius: "8px",
            fontSize: "15px",
            fontWeight: "600",
            padding: "10px 20px",
          }}
        >
          ãƒ›ãƒ¼ãƒ ã«ã‚‚ã©ã‚‹
        </button>
      </div>
    </main>
  );
}

// å­ã©ã‚‚IDã‹ã‚‰åå‰ã‚’å¼•ãå°ã•ã„ãƒ˜ãƒ«ãƒ‘
function renderChildNameFromId(childId, children) {
  const found = children.find((c) => c.id === childId);
  return found ? found.name : childId;
}
