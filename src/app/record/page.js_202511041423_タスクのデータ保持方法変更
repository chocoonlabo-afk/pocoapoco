"use client";

import { useEffect, useState, useRef } from "react";
import { useSearchParams } from "next/navigation";
import { getLangFromStorage, t } from "../../lib/i18n";

export default function RecordPage() {
  const searchParams = useSearchParams();
  const taskFromQuery = searchParams.get("task") || "";
  const [lang, setLang] = useState("jp");
  const [isRunning, setIsRunning] = useState(false);
  const [isFinished, setIsFinished] = useState(false);
  const [elapsedSec, setElapsedSec] = useState(0);
  const [count, setCount] = useState(0);
  const [memo, setMemo] = useState("");
  const [startedAt, setStartedAt] = useState("");
  const [taskName, setTaskName] = useState(taskFromQuery);
  const intervalRef = useRef(null);

  useEffect(() => {
    const currentLang = getLangFromStorage();
    setLang(currentLang);
    if (!taskFromQuery && !taskName) setTaskName("ãƒã‚¤ã‚ªãƒªãƒ³");
  }, [taskFromQuery, taskName]);

  function getTodayCount() {
    try {
      const raw = localStorage.getItem("pocopoco_history");
      if (!raw) return 0;
      const data = JSON.parse(raw);
      const today = new Date().toISOString().slice(0, 10);
      return data.filter((r) => r.startedAt?.startsWith(today)).length;
    } catch {
      return 0;
    }
  }

  function handleStart() {
    if (isRunning || isFinished) return;

    const todayCount = getTodayCount();
    if (todayCount >= 20) {
      alert("ãã‚‡ã†ã¯ 20ä»¶ ã¾ã§ã§ã™ã€‚ã‚ã—ãŸã¾ãŸãŒã‚“ã°ã‚ã†ï¼");
      return;
    }

    setIsRunning(true);
    setElapsedSec(0);
    setCount(0);
    setMemo("");
    setIsFinished(false);
    setStartedAt(new Date().toISOString());

    intervalRef.current = setInterval(() => {
      setElapsedSec((prev) => prev + 1);
    }, 1000);
  }

  function handleIncrementCount() {
    if (isRunning) setCount((c) => c + 1);
  }

  function handleStop() {
    if (!isRunning) return;
    clearInterval(intervalRef.current);
    intervalRef.current = null;
    setIsRunning(false);
    setIsFinished(true);
  }

  function handleSave() {
    if (!isFinished) return;
    saveSessionToLocalHistory({
      task: taskName,
      seconds: elapsedSec,
      count,
      memo,
      startedAt,
    });
    alert("ãã‚ãã—ã¾ã—ãŸã€‚ãŠã¤ã‹ã‚Œã•ã¾ï¼");
    window.location.href = "/";
  }

  useEffect(() => {
    return () => clearInterval(intervalRef.current);
  }, []);

  function saveSessionToLocalHistory(newRecord) {
    try {
      const raw = localStorage.getItem("pocopoco_history");
      let arr = [];
      if (raw) {
        arr = JSON.parse(raw);
        if (!Array.isArray(arr)) arr = [];
      }
      arr.push(newRecord);
      localStorage.setItem("pocopoco_history", JSON.stringify(arr));
    } catch (e) {
      console.error("failed to save history", e);
    }
  }

  const elapsedMinutes = Math.floor(elapsedSec / 60);
  const elapsedSecondsOnly = elapsedSec % 60;

  return (
    <main
      style={{
        fontFamily: "system-ui, sans-serif",
        padding: "24px 16px 80px",
        maxWidth: "480px",
        margin: "0 auto",
      }}
    >
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <header style={{ marginBottom: "16px" }}>
        <div style={{ fontSize: "14px", color: "#666", marginBottom: "4px" }}>
          {taskName || "ã‚Œã‚“ã—ã‚…ã†"}
        </div>
        <div style={{ fontSize: "13px", color: "#999" }}>
          {new Date().toLocaleDateString("ja-JP", {
            month: "long",
            day: "numeric",
            weekday: "short",
          })}
        </div>
      </header>

      {/* çµŒéæ™‚é–“ï¼‹å›æ•° */}
      <section
        style={{
          border: "1px solid #e0ccff",
          background:
            "linear-gradient(135deg, rgba(255,240,255,0.9), rgba(245,230,255,0.8))",
          borderRadius: "12px",
          boxShadow: "0 2px 4px rgba(0,0,0,0.06)",
          padding: "16px",
          marginBottom: "16px",
        }}
      >
        <div
          style={{
            display: "flex",
            justifyContent: "space-between",
            alignItems: "flex-end",
            marginBottom: "12px",
            flexWrap: "wrap",
            rowGap: "12px",
          }}
        >
          {/* æ™‚é–“ */}
          <div style={{ flex: "1 1 45%" }}>
            <div
              style={{
                fontSize: "12px",
                color: "#6a1b9a",
                marginBottom: "4px",
              }}
            >
              æ™‚é–“
            </div>
            <div
              style={{
                fontSize: "24px",
                fontWeight: "700",
                color: "#6a1b9a",
              }}
            >
              {elapsedMinutes}:{String(elapsedSecondsOnly).padStart(2, "0")}
            </div>
          </div>

          {/* å›æ•° */}
          <div style={{ flex: "1 1 45%", textAlign: "right" }}>
            <div
              style={{
                fontSize: "12px",
                color: "#6a1b9a",
                marginBottom: "4px",
              }}
            >
              å›æ•°
            </div>
            <div
              style={{
                fontSize: "24px",
                fontWeight: "700",
                color: "#6a1b9a",
              }}
            >
              {count}
            </div>
            <button
              onClick={handleIncrementCount}
              disabled={!isRunning}
              style={{
                marginTop: "6px",
                backgroundColor: isRunning ? "#6a1b9a" : "#bbb",
                color: "#fff",
                border: "none",
                borderRadius: "8px",
                fontSize: "13px",
                padding: "6px 10px",
              }}
            >
              +1 ã‹ããˆã‚‹
            </button>
          </div>
        </div>

        {/* ãƒœã‚¿ãƒ³ç¾¤ */}
        <div style={{ display: "flex", gap: "12px", flexWrap: "wrap" }}>
          {!isRunning && !isFinished && (
            <button
              onClick={handleStart}
              style={{
                flex: "1",
                background:
                  "linear-gradient(90deg, rgb(204,0,255), rgb(255,102,153))",
                color: "#fff",
                border: "none",
                borderRadius: "10px",
                fontSize: "16px",
                fontWeight: "600",
                padding: "12px",
              }}
            >
              ç·´ç¿’é–‹å§‹ â–¶
            </button>
          )}

          {isRunning && (
            <button
              onClick={handleStop}
              style={{
                flex: "1",
                backgroundColor: "#ff5757",
                color: "#fff",
                border: "none",
                borderRadius: "10px",
                fontSize: "16px",
                fontWeight: "600",
                padding: "12px",
              }}
            >
              ç·´ç¿’ãŠã‚ã‚Š âœ‹
            </button>
          )}

          {isFinished && (
            <button
              onClick={handleSave}
              style={{
                flex: "1",
                backgroundColor: "#6a1b9a",
                color: "#fff",
                border: "none",
                borderRadius: "10px",
                fontSize: "16px",
                fontWeight: "600",
                padding: "12px",
              }}
            >
              ã“ã®ãã‚ãã‚’ã»ãã‚“ ğŸ’¾
            </button>
          )}

          <button
            onClick={() => (window.location.href = "/")}
            style={{
              flex: "1",
              backgroundColor: "#aaa",
              color: "#fff",
              border: "none",
              borderRadius: "10px",
              fontSize: "14px",
              fontWeight: "600",
              padding: "12px",
            }}
          >
            ã‚‚ã©ã‚‹
          </button>
        </div>
      </section>

      {/* ãƒ¡ãƒ¢æ¬„ */}
      <section
        style={{
          border: "1px solid #ddd",
          borderRadius: "12px",
          backgroundColor: "#fff",
          padding: "16px",
        }}
      >
        <label
          style={{
            display: "block",
            fontSize: "14px",
            fontWeight: "600",
            marginBottom: "8px",
          }}
        >
          ãƒ¡ãƒ¢
        </label>
        <textarea
          rows={3}
          value={memo}
          onChange={(e) => setMemo(e.target.value)}
          placeholder="ãªã«ã‚’ ãŒã‚“ã°ã£ãŸï¼Ÿ"
          style={{
            width: "100%",
            border: "1px solid #bbb",
            borderRadius: "8px",
            fontSize: "14px",
            padding: "10px 12px",
            lineHeight: 1.4,
            resize: "vertical",
          }}
        />
      </section>
    </main>
  );
}
