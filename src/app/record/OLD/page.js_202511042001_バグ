"use client";

import { useEffect, useState, useRef } from "react";
import { useSearchParams } from "next/navigation";
import { getLangFromStorage } from "../../lib/i18n";

const DEFAULT_TASKS = [
  {
    id: "task_violin_scale",
    title: "éŸ³éš",
    type: "normal",
    target_time_min: 5,
    done_log: [],
    phrase_id: null,
  },
  {
    id: "task_sevcik",
    title: "ã‚»ãƒ–ã‚·ãƒƒã‚¯",
    type: "normal",
    target_time_min: 10,
    done_log: [],
    phrase_id: null,
  },
  {
    id: "task_zaitsu_12_15",
    title: "ã‚¶ã‚¤ãƒ„ 12-15å°ç¯€",
    type: "phrase",
    target_time_min: 7,
    done_log: [],
    phrase_id: null,
  },
];

export default function RecordPage() {
  const searchParams = useSearchParams();

  const taskIdFromQuery = searchParams.get("taskId");
  const taskFromQueryLegacy = searchParams.get("task") || "";
  const childIdFromQuery = searchParams.get("childId");

  const [lang, setLang] = useState("jp");
  const [isRunning, setIsRunning] = useState(false);
  const [isFinished, setIsFinished] = useState(false);
  const [elapsedSec, setElapsedSec] = useState(0);
  const [count, setCount] = useState(0);
  const [memo, setMemo] = useState("");
  const [startedAt, setStartedAt] = useState("");
  const [selectedTask, setSelectedTask] = useState(null);

  // â˜… è¿½åŠ ï¼šå­ã©ã‚‚ä¸€è¦§ï¼†ã„ã¾ä¿å­˜ã™ã‚‹å­ID
  const [children, setChildren] = useState([]);
  const [currentChildId, setCurrentChildId] = useState("");

  const intervalRef = useRef(null);

  useEffect(() => {
    const currentLang = getLangFromStorage();
    setLang(currentLang);

    // å­ã©ã‚‚ä¸€è¦§ã‚’èª­ã‚€
    try {
      const rawChildren = localStorage.getItem("pocopoco_children");
      if (rawChildren) {
        const arr = JSON.parse(rawChildren);
        if (Array.isArray(arr)) {
          setChildren(arr);
        }
      }
    } catch (e) {
      console.warn("record: children load error", e);
    }

    // ã“ã®è¨˜éŒ²ã‚’ã©ã®å­ã«ç´ã¥ã‘ã‚‹ã‹
    if (childIdFromQuery) {
      setCurrentChildId(childIdFromQuery);
    } else {
      const savedChild = localStorage.getItem("pocopoco_current_child_id");
      if (savedChild) {
        setCurrentChildId(savedChild);
      }
    }

    // ã‚¿ã‚¹ã‚¯é¸æŠ
    if (taskIdFromQuery) {
      const found = DEFAULT_TASKS.find((t) => t.id === taskIdFromQuery);
      if (found) {
        setSelectedTask(found);
        return;
      }
    }

    if (taskFromQueryLegacy) {
      setSelectedTask({
        id: "task_custom_" + taskFromQueryLegacy,
        title: taskFromQueryLegacy,
        type: "normal",
        target_time_min: 5,
        done_log: [],
        phrase_id: null,
      });
      return;
    }

    setSelectedTask(
      DEFAULT_TASKS[0] || {
        id: "task_default",
        title: "ãƒã‚¤ã‚ªãƒªãƒ³",
        type: "normal",
        target_time_min: 5,
        done_log: [],
        phrase_id: null,
      }
    );
  }, [taskIdFromQuery, taskFromQueryLegacy, childIdFromQuery]);

  // child_id â†’ åå‰
  function getCurrentChildName() {
    if (!currentChildId) return "";
    const found = children.find((c) => c.id === currentChildId);
    return found ? found.name : "";
  }

  function getTodayCountForChild(targetChildId) {
    try {
      const raw = localStorage.getItem("pocopoco_history");
      if (!raw) return 0;
      const data = JSON.parse(raw);
      const todayIso = new Date().toISOString().slice(0, 10);
      return data.filter((r) => {
        if (!r.startedAt?.startsWith(todayIso)) return false;
        if (!targetChildId) return true;
        return (r.child_id || "") === targetChildId;
      }).length;
    } catch {
      return 0;
    }
  }

  function handleStart() {
    if (!selectedTask) return;
    if (isRunning || isFinished) return;

    const todayCount = getTodayCountForChild(currentChildId);
    if (todayCount >= 20) {
      alert("ãã‚‡ã†ã¯ã“ã®ã“ã®ãã‚ããŒ 20ä»¶ã«ãªã‚Šã¾ã—ãŸã€‚ã‚ã—ãŸã¾ãŸã­ï¼");
      return;
    }

    setIsRunning(true);
    setElapsedSec(0);
    setCount(0);
    setMemo("");
    setIsFinished(false);
    setStartedAt(new Date().toISOString());

    intervalRef.current = setInterval(() => {
      setElapsedSec((prev) => prev + 1);
    }, 1000);
  }

  function handleIncrementCount() {
    if (isRunning) setCount((c) => c + 1);
  }

  function handleStop() {
    if (!isRunning) return;
    clearInterval(intervalRef.current);
    intervalRef.current = null;
    setIsRunning(false);
    setIsFinished(true);
  }

  function handleSave() {
    if (!isFinished || !selectedTask) return;

    const childIdToSave =
      childIdFromQuery ||
      currentChildId ||
      localStorage.getItem("pocopoco_current_child_id") ||
      "";

    saveSessionToLocalHistory({
      task_id: selectedTask.id,
      task_title: selectedTask.title,
      seconds: elapsedSec,
      count,
      memo,
      startedAt,
      child_id: childIdToSave,
    });

    alert("ãã‚ãã—ã¾ã—ãŸã€‚ãŠã¤ã‹ã‚Œã•ã¾ï¼");
    window.location.href = "/";
  }

  useEffect(() => {
    return () => clearInterval(intervalRef.current);
  }, []);

  function saveSessionToLocalHistory(newRecord) {
    try {
      const raw = localStorage.getItem("pocopoco_history");
      let arr = [];
      if (raw) {
        arr = JSON.parse(raw);
        if (!Array.isArray(arr)) arr = [];
      }
      arr.push(newRecord);
      localStorage.setItem("pocopoco_history", JSON.stringify(arr));
    } catch (e) {
      console.error("failed to save history", e);
    }
  }

  const elapsedMinutes = Math.floor(elapsedSec / 60);
  const elapsedSecondsOnly = elapsedSec % 60;
  const taskTitle = selectedTask ? selectedTask.title : "ã‚Œã‚“ã—ã‚…ã†";
  const childName = getCurrentChildName();

  return (
    <main
      style={{
        fontFamily: "system-ui, sans-serif",
        padding: "24px 16px 80px",
        maxWidth: "480px",
        margin: "0 auto",
      }}
    >
      <header style={{ marginBottom: "16px" }}>
        <div style={{ fontSize: "14px", color: "#666", marginBottom: "4px" }}>
          {taskTitle}
        </div>
        <div style={{ fontSize: "13px", color: "#999" }}>
          {new Date().toLocaleDateString("ja-JP", {
            month: "long",
            day: "numeric",
            weekday: "short",
          })}
        </div>
        {/* å­ã©ã‚‚åã®è¡¨ç¤ºã‚’è¿½åŠ  */}
        <div style={{ fontSize: "11px", color: "#6a1b9a", marginTop: "4px" }}>
          {childName
            ? `ã“ã®ãã‚ãã¯ï¼š${childName} ã«ä¿å­˜ã—ã¾ã™`
            : currentChildId
            ? `ã“ã®ãã‚ãã¯ï¼š${currentChildId} ã«ä¿å­˜ã—ã¾ã™`
            : "ã“ã®ãã‚ãã¯ï¼šã“ã©ã‚‚æœªé¸æŠã§ä¿å­˜ã—ã¾ã™"}
        </div>
      </header>

      <section
        style={{
          border: "1px solid #e0ccff",
          background:
            "linear-gradient(135deg, rgba(255,240,255,0.9), rgba(245,230,255,0.8))",
          borderRadius: "12px",
          boxShadow: "0 2px 4px rgba(0,0,0,0.06)",
          padding: "16px",
          marginBottom: "16px",
        }}
      >
        <div
          style={{
            display: "flex",
            justifyContent: "space-between",
            alignItems: "flex-end",
            marginBottom: "12px",
            flexWrap: "wrap",
            rowGap: "12px",
          }}
        >
          <div style={{ flex: "1 1 45%" }}>
            <div style={{ fontSize: "12px", color: "#6a1b9a", marginBottom: "4px" }}>
              æ™‚é–“
            </div>
            <div style={{ fontSize: "24px", fontWeight: "700", color: "#6a1b9a" }}>
              {elapsedMinutes}:{String(elapsedSecondsOnly).padStart(2, "0")}
            </div>
          </div>

          <div style={{ flex: "1 1 45%", textAlign: "right" }}>
            <div style={{ fontSize: "12px", color: "#6a1b9a", marginBottom: "4px" }}>
              å›æ•°
            </div>
            <div style={{ fontSize: "24px", fontWeight: "700", color: "#6a1b9a" }}>
              {count}
            </div>
            <button
              onClick={handleIncrementCount}
              disabled={!isRunning}
              style={{
                marginTop: "6px",
                backgroundColor: isRunning ? "#6a1b9a" : "#bbb",
                color: "#fff",
                border: "none",
                borderRadius: "8px",
                fontSize: "13px",
                padding: "6px 10px",
              }}
            >
              +1 ã‹ããˆã‚‹
            </button>
          </div>
        </div>

        <div style={{ display: "flex", gap: "12px", flexWrap: "wrap" }}>
          {!isRunning && !isFinished && (
            <button
              onClick={handleStart}
              style={{
                flex: "1",
                background:
                  "linear-gradient(90deg, rgb(204,0,255), rgb(255,102,153))",
                color: "#fff",
                border: "none",
                borderRadius: "10px",
                fontSize: "16px",
                fontWeight: "600",
                padding: "12px",
              }}
            >
              ç·´ç¿’é–‹å§‹ â–¶
            </button>
          )}

          {isRunning && (
            <button
              onClick={handleStop}
              style={{
                flex: "1",
                backgroundColor: "#ff5757",
                color: "#fff",
                border: "none",
                borderRadius: "10px",
                fontSize: "16px",
                fontWeight: "600",
                padding: "12px",
              }}
            >
              ç·´ç¿’ãŠã‚ã‚Š âœ‹
            </button>
          )}

          {isFinished && (
            <button
              onClick={handleSave}
              style={{
                flex: "1",
                backgroundColor: "#6a1b9a",
                color: "#fff",
                border: "none",
                borderRadius: "10px",
                fontSize: "16px",
                fontWeight: "600",
                padding: "12px",
              }}
            >
              ã“ã®ãã‚ãã‚’ã»ãã‚“ ğŸ’¾
            </button>
          )}

          <button
            onClick={() => (window.location.href = "/")}
            style={{
              flex: "1",
              backgroundColor: "#aaa",
              color: "#fff",
              border: "none",
              borderRadius: "10px",
              fontSize: "14px",
              fontWeight: "600",
              padding: "12px",
            }}
          >
            ã‚‚ã©ã‚‹
          </button>
        </div>
      </section>

      <section
        style={{
          border: "1px solid #ddd",
          borderRadius: "12px",
          backgroundColor: "#fff",
          padding: "16px",
        }}
      >
        <label
          style={{
            display: "block",
            fontSize: "14px",
            fontWeight: "600",
            marginBottom: "8px",
          }}
        >
          ãƒ¡ãƒ¢
        </label>
        <textarea
          rows={3}
          value={memo}
          onChange={(e) => setMemo(e.target.value)}
          placeholder="ãªã«ã‚’ ãŒã‚“ã°ã£ãŸï¼Ÿ"
          style={{
            width: "100%",
            border: "1px solid #bbb",
            borderRadius: "8px",
            fontSize: "14px",
            padding: "10px 12px",
            lineHeight: 1.4,
            resize: "vertical",
          }}
        />
      </section>
    </main>
  );
}
