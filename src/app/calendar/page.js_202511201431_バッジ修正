// src/app/calendar/page.js
"use client";

import { useEffect, useState } from "react";

// YYYY-MM-DD ã«ã™ã‚‹
function toDayKey(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚»ãƒ«ã‚’ä½œã‚‹
function buildCalendarCells(year, month) {
  const first = new Date(year, month, 1);
  const startWeekday = first.getDay();
  const lastDate = new Date(year, month + 1, 0).getDate();
  const cells = [];
  for (let i = 0; i < startWeekday; i++) cells.push(null);
  for (let d = 1; d <= lastDate; d++) {
    cells.push(new Date(year, month, d));
  }
  return cells;
}

// åˆ†æ•°ã«å¿œã˜ã¦è‰²ã‚’æ±ºã‚ã‚‹
function getBadge(minutes) {
  if (minutes >= 60)
    return {
      bg: "#ffe7e7",
      border: "#ff9f9f",
      text: "#a00000",
      label: "ğŸ¥‡",
    };
  if (minutes >= 30)
    return {
      bg: "#fff4d9",
      border: "#ffcd73",
      text: "#6d4c00",
      label: "ğŸ¥ˆ",
    };
  if (minutes >= 15)
    return {
      bg: "#e9ffe9",
      border: "#a8e4a8",
      text: "#045704",
      label: "ğŸ¥‰",
    };
  if (minutes > 0)
    return {
      bg: "#eef4ff",
      border: "#aac0ff",
      text: "#001a66",
      label: "â­",
    };
  return {
    bg: "#fff",
    border: "#ddd",
    text: "#999",
    label: "",
  };
}

// è¤‡æ•°ã‚¤ãƒ™ãƒ³ãƒˆã‚’èª­ã‚€ï¼ˆæ—§ã‚­ãƒ¼ã‚‚å¸ã„è¾¼ã‚€ï¼‰
function loadEvents() {
  // æ–°
  try {
    const raw = localStorage.getItem("pocopoco_events");
    if (raw) {
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) return arr.filter((ev) => ev.date);
    }
  } catch {}
  // æ—§
  try {
    const raw1 = localStorage.getItem("pocopoco_event");
    if (raw1) {
      const ev = JSON.parse(raw1);
      if (ev?.date) {
        return [
          {
            id: "legacy",
            title: ev.title || "ã‚¤ãƒ™ãƒ³ãƒˆ",
            date: ev.date,
            mark: ev.mark || "EV",
            child_id: "all",
          },
        ];
      }
    }
  } catch {}
  return [];
}

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«åæ˜ ã™ã‚‹ã‚¿ã‚¹ã‚¯IDã®é…åˆ—
function loadCalendarTaskFilter() {
  try {
    const raw = localStorage.getItem("pocopoco_calendar_task_filter");
    if (!raw) return null;
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : null;
  } catch {
    return null;
  }
}

// ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’èª­ã‚€ï¼ˆåå‰ã‹ã‚‰idæ¨æ¸¬ç”¨ï¼‰
function loadTasksDict() {
  try {
    const raw = localStorage.getItem("pocopoco_tasks");
    if (!raw) return { byId: {}, byLabel: {} };
    const arr = JSON.parse(raw);
    if (!Array.isArray(arr)) return { byId: {}, byLabel: {} };
    const byId = {};
    const byLabel = {};
    arr.forEach((t) => {
      if (t.id) byId[t.id] = t;
      if (t.label) byLabel[t.label.trim().toLowerCase()] = t;
    });
    return { byId, byLabel };
  } catch {
    return { byId: {}, byLabel: {} };
  }
}

// èª•ç”Ÿæ—¥
function loadBirthday() {
  return localStorage.getItem("pocopoco_birthday") || "";
}
function isBirthdayDay(date, birthdayStr) {
  if (!birthdayStr) return false;
  const [, m, d] = birthdayStr.split("-");
  if (!m || !d) return false;
  return date.getMonth() + 1 === Number(m) && date.getDate() === Number(d);
}

// å±¥æ­´ã‹ã‚‰æ—¥ã”ã¨ã®åˆè¨ˆã‚’ä½œã‚‹ï¼ˆã‚¿ã‚¹ã‚¯ï¼†å­ã©ã‚‚ã§çµã‚‹ï¼‰
function buildDailyMinutesFromHistory(
  historyArr,
  filterIds,
  tasksById,
  tasksByLabel,
  targetChildId
) {
  const map = {};
  const hasFilter = Array.isArray(filterIds) && filterIds.length > 0;
  const hasChildFilter = targetChildId && targetChildId !== "all";

  for (const rec of historyArr) {
    if (!rec.startedAt) continue;

    // å­ã©ã‚‚ã§çµã‚‹
    if (hasChildFilter) {
      if ((rec.child_id || "") !== targetChildId) continue;
    }

    const dayKey = toDayKey(new Date(rec.startedAt));
    const sec = rec.seconds || 0;

    // ã‚¿ã‚¹ã‚¯ãƒ•ã‚£ãƒ«ã‚¿ãªã—
    if (!hasFilter) {
      map[dayKey] = (map[dayKey] || 0) + Math.floor(sec / 60);
      continue;
    }

    // task_id ã§ä¸€è‡´
    if (rec.task_id && filterIds.includes(rec.task_id)) {
      map[dayKey] = (map[dayKey] || 0) + Math.floor(sec / 60);
      continue;
    }

    // task_title ã‹ã‚‰idã‚’æ¨æ¸¬
    if (rec.task_title) {
      const lc = rec.task_title.trim().toLowerCase();
      const t = tasksByLabel[lc];
      if (t && filterIds.includes(t.id)) {
        map[dayKey] = (map[dayKey] || 0) + Math.floor(sec / 60);
        continue;
      }
    }

    // å¤ã„å½¢å¼ task ã‹ã‚‰idã‚’æ¨æ¸¬
    if (rec.task) {
      const lc = rec.task.trim().toLowerCase();
      const t = tasksByLabel[lc];
      if (t && filterIds.includes(t.id)) {
        map[dayKey] = (map[dayKey] || 0) + Math.floor(sec / 60);
        continue;
      }
    }
  }

  return map;
}

export default function CalendarPage() {
  const [year, setYear] = useState(() => new Date().getFullYear());
  const [month, setMonth] = useState(() => new Date().getMonth());
  const [dailyMinutes, setDailyMinutes] = useState({});
  const [events, setEvents] = useState([]);
  const [birthday, setBirthday] = useState("");
  const [calendarTaskFilter, setCalendarTaskFilter] = useState(null);
  const [tasksDict, setTasksDict] = useState({ byId: {}, byLabel: {} });
  const [children, setChildren] = useState([]);
  const [selectedChildId, setSelectedChildId] = useState("all");
  const [history, setHistory] = useState([]);

  useEffect(() => {
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒ»ã‚¿ã‚¹ã‚¯ãƒ»èª•ç”Ÿæ—¥
    const evs = loadEvents();
    setEvents(evs);

    const filter = loadCalendarTaskFilter();
    setCalendarTaskFilter(filter);

    const dict = loadTasksDict();
    setTasksDict(dict);

    setBirthday(loadBirthday());

    // å­ã©ã‚‚
    const rawChildren = localStorage.getItem("pocopoco_children");
    if (rawChildren) {
      try {
        const arr = JSON.parse(rawChildren);
        if (Array.isArray(arr)) setChildren(arr);
      } catch {}
    }
    const savedChild = localStorage.getItem("pocopoco_current_child_id");
    if (savedChild) setSelectedChildId(savedChild);

    // å±¥æ­´
    const rawHistory = localStorage.getItem("pocopoco_history");
    if (rawHistory) {
      try {
        const arr = JSON.parse(rawHistory);
        if (Array.isArray(arr)) {
          setHistory(arr);
          const mins = buildDailyMinutesFromHistory(
            arr,
            filter,
            dict.byId,
            dict.byLabel,
            savedChild || "all"
          );
          setDailyMinutes(mins);
        }
      } catch (e) {
        console.warn("calendar history load error", e);
      }
    }
  }, []);

  // å­ã©ã‚‚ãŒå¤‰ã‚ã£ãŸã‚Šã€ã‚¿ã‚¹ã‚¯ãƒ•ã‚£ãƒ«ã‚¿ãŒå¤‰ã‚ã£ãŸã‚‰å†é›†è¨ˆ
  useEffect(() => {
    if (!Array.isArray(history)) return;
    const mins = buildDailyMinutesFromHistory(
      history,
      calendarTaskFilter,
      tasksDict.byId,
      tasksDict.byLabel,
      selectedChildId
    );
    setDailyMinutes(mins);
  }, [history, calendarTaskFilter, tasksDict, selectedChildId]);

  const todayKey = toDayKey(new Date());
  const cells = buildCalendarCells(year, month);
  const monthStr = `${year}-${String(month + 1).padStart(2, "0")}`;

  // ã“ã®æœˆã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆé¸æŠä¸­ã®å­ã«è¦‹ãˆã‚‹ã‚‚ã®ã ã‘ï¼‰
  const eventsThisMonth = events.filter((ev) => {
    if (!ev.date || !ev.date.startsWith(monthStr)) return false;
    return isEventVisibleForChild(ev, selectedChildId);
  });

  function goPrevMonth() {
    const d = new Date(year, month, 1);
    d.setMonth(d.getMonth() - 1);
    setYear(d.getFullYear());
    setMonth(d.getMonth());
  }

  function goNextMonth() {
    const d = new Date(year, month, 1);
    d.setMonth(d.getMonth() + 1);
    setYear(d.getFullYear());
    setMonth(d.getMonth());
  }

  // ãã®æ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå­ã©ã‚‚ã§çµã‚‹ï¼‰
  function getEventsForDay(dayKey) {
    return events.filter(
      (ev) => ev.date === dayKey && isEventVisibleForChild(ev, selectedChildId)
    );
  }

  return (
    <main
      style={{
        padding: "24px 16px 80px",
        maxWidth: "480px",
        margin: "0 auto",
        fontFamily: "system-ui, sans-serif",
      }}
    >
      <header
        style={{
          display: "flex",
          alignItems: "center",
          justifyContent: "space-between",
          marginBottom: "12px",
        }}
      >
        <button onClick={goPrevMonth} style={navBtnStyle}>
          â†
        </button>
        <div style={{ textAlign: "center" }}>
          <div
            style={{ fontSize: "18px", fontWeight: "600", color: "#4a148c" }}
          >
            {year}å¹´ {month + 1}æœˆ
          </div>
          <div style={{ fontSize: "11px", color: "#777" }}>
            ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«åæ˜ ã™ã‚‹ã‚¿ã‚¹ã‚¯ã ã‘åˆè¨ˆã—ã¾ã™
          </div>
        </div>
        <button onClick={goNextMonth} style={navBtnStyle}>
          â†’
        </button>
      </header>

      {/* å­ã©ã‚‚åˆ‡æ›¿ */}
      {children.length > 0 && (
        <div
          style={{
            marginBottom: "12px",
            display: "flex",
            gap: "6px",
            flexWrap: "wrap",
          }}
        >
          <button
            onClick={() => setSelectedChildId("all")}
            style={{
              border:
                selectedChildId === "all"
                  ? "1px solid #6a1b9a"
                  : "1px solid #ccc",
              background: "#fff",
              borderRadius: "999px",
              padding: "4px 10px",
              fontSize: "12px",
            }}
          >
            ãœã‚“ã„ã‚“
          </button>
          {children.map((c) => (
            <button
              key={c.id}
              onClick={() => setSelectedChildId(c.id)}
              style={{
                border:
                  selectedChildId === c.id
                    ? "1px solid #6a1b9a"
                    : "1px solid #ccc",
                background: "#fff",
                borderRadius: "999px",
                padding: "4px 10px",
                fontSize: "12px",
              }}
            >
              {c.name}
            </button>
          ))}
        </div>
      )}

      {/* ä»Šæœˆã®ã‚¤ãƒ™ãƒ³ãƒˆ */}
      {eventsThisMonth.length > 0 && (
        <div
          style={{
            border: "1px solid #ffe0a1",
            background:
              "linear-gradient(135deg, rgba(255,251,235,0.95), rgba(255,245,200,0.8))",
            borderRadius: "10px",
            padding: "10px 12px",
            marginBottom: "12px",
          }}
        >
          <div
            style={{ fontSize: "13px", color: "#a15a00", marginBottom: "6px" }}
          >
            ğŸ“£ ä»Šæœˆã®ã‚¤ãƒ™ãƒ³ãƒˆ
          </div>
          {eventsThisMonth.map((ev) => (
            <div
              key={ev.id || ev.date}
              style={{ display: "flex", alignItems: "center", gap: "6px" }}
            >
              <div style={{ fontSize: "16px" }}>{ev.mark || "ğŸ“Œ"}</div>
              <div>
                <div style={{ fontSize: "14px", fontWeight: "600" }}>
                  {ev.title || "(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)"}
                </div>
                <div style={{ fontSize: "12px", color: "#6d4c00" }}>
                  {ev.date}
                  {ev.child_id && ev.child_id !== "all"
                    ? " / ã“ã®å­ã ã‘"
                    : ""}
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div
        style={{
          display: "grid",
          gridTemplateColumns: "repeat(7, 1fr)",
          textAlign: "center",
          marginBottom: "6px",
          fontSize: "12px",
          fontWeight: "600",
          color: "#555",
        }}
      >
        {["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"].map((w) => (
          <div key={w}>{w}</div>
        ))}
      </div>

      {/* æœ¬ä½“ */}
      <div
        style={{
          display: "grid",
          gridTemplateColumns: "repeat(7, 1fr)",
          gap: "6px",
        }}
      >
        {cells.map((c, idx) => {
          if (c === null) {
            return <div key={idx} style={{ minHeight: "70px" }} />;
          }
          const dayKey = toDayKey(c);
          const minutes = dailyMinutes[dayKey] || 0;
          const badge = getBadge(minutes);
          const isToday = dayKey === todayKey;
          const dayEvents = getEventsForDay(dayKey);
          const isBday = isBirthdayDay(c, birthday);

          return (
            <div
              key={idx}
              style={{
                minHeight: "70px",
                borderRadius: "10px",
                border: `1px solid ${badge.border}`,
                backgroundColor: badge.bg,
                padding: "4px 4px 6px",
                display: "flex",
                flexDirection: "column",
                gap: "2px",
                boxShadow: isToday
                  ? "0 0 0 2px rgba(106,27,154,0.35)"
                  : "none",
              }}
            >
              <div
                style={{
                  display: "flex",
                  justifyContent: "space-between",
                  gap: "4px",
                }}
              >
                <span
                  style={{
                    fontSize: "13px",
                    fontWeight: "600",
                    color: isToday ? "#6a1b9a" : "#333",
                  }}
                >
                  {c.getDate()}
                </span>
                <div
                  style={{
                    display: "flex",
                    gap: "2px",
                    flexWrap: "wrap",
                    justifyContent: "flex-end",
                  }}
                >
                  {dayEvents.map((ev) => (
                    <span
                      key={ev.id || ev.title}
                      title={ev.title}
                      style={{
                        fontSize: "11px",
                        backgroundColor: "#ff9800",
                        color: "#fff",
                        borderRadius: "999px",
                        padding: "1px 5px",
                      }}
                    >
                      {ev.mark || "EV"}
                    </span>
                  ))}
                  {isBday && (
                    <span
                      style={{
                        fontSize: "11px",
                        backgroundColor: "#ff80ab",
                        color: "#fff",
                        borderRadius: "999px",
                        padding: "1px 5px",
                      }}
                    >
                      ğŸ‚
                    </span>
                  )}
                </div>
              </div>
              <div
                style={{
                  marginTop: "auto",
                  textAlign: "right",
                  fontSize: "11px",
                  color: badge.text,
                }}
              >
                {minutes > 0 ? `${minutes}åˆ† ${badge.label}` : "ãƒ»"}
              </div>
            </div>
          );
        })}
      </div>

      <div
        style={{
          fontSize: "11px",
          textAlign: "center",
          color: "#777",
          marginTop: "14px",
          lineHeight: 1.5,
        }}
      >
        â€» è¨­å®šã§ã€Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«åæ˜ ã™ã‚‹ã‚¿ã‚¹ã‚¯ã€ã‚’ãˆã‚‰ã¶ã¨ã€ã“ã“ã§åˆè¨ˆã•ã‚Œã¾ã™ã€‚<br />
        â€» ä¸Šã®ãƒœã‚¿ãƒ³ã§å­ã©ã‚‚ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨ã€ãã®å­å‘ã‘ã®ã‚¤ãƒ™ãƒ³ãƒˆã¨åˆè¨ˆã ã‘è¡¨ç¤ºã—ã¾ã™ã€‚
      </div>

      <div style={{ textAlign: "center", marginTop: "18px" }}>
        <button
          onClick={() => (window.location.href = "/")}
          style={{
            backgroundColor: "#6a1b9a",
            color: "#fff",
            border: "none",
            borderRadius: "8px",
            padding: "8px 18px",
            fontWeight: "600",
          }}
        >
          ãƒ›ãƒ¼ãƒ ã«ã‚‚ã©ã‚‹
        </button>
      </div>
    </main>
  );
}

// å­ã©ã‚‚IDã«è¦‹ãˆã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‹ã©ã†ã‹
function isEventVisibleForChild(ev, childId) {
  // ã‚¤ãƒ™ãƒ³ãƒˆã«å­æŒ‡å®šãŒãªã„ or "all" â†’ å…¨å“¡ã«è¦‹ãˆã‚‹
  if (!ev.child_id || ev.child_id === "all") return true;
  // å­ã©ã‚‚ã‚’é¸ã‚“ã§ãªã„ï¼ˆallè¡¨ç¤ºï¼‰â†’å…¨å“¡å‘ã‘ã ã‘
  if (childId === "all") return ev.child_id === "all";
  // å­ã©ã‚‚ãŒä¸€è‡´ã—ã¦ã„ã‚‹æ™‚ã ã‘
  return ev.child_id === childId;
}

const navBtnStyle = {
  border: "1px solid #ccc",
  background: "#fff",
  borderRadius: "8px",
  padding: "6px 10px",
  fontSize: "14px",
  minWidth: "44px",
};
