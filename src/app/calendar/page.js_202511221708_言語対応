"use client";

import { useEffect, useState } from "react";
import {
  LS_CHILDREN,
  LS_CURRENT_CHILD_ID,
  LS_HISTORY,
  LS_ROLE,
  ROUTE_CALENDAR_SETTINGS,
} from "@/app/constants";
import {
  toDayKey,
  buildCalendarCells,
  DEFAULT_BADGES,
  loadCalendarSettingsFromStorage,
  getBadgeFromSettings,
  loadEvents,
  loadCalendarTaskFilter,
  loadTasksDict,
  loadBirthday,
  isBirthdayDay,
  filterEventsForChild,
  calcDailyMinutes,
} from "@/app/lib/calendarUtils";
import {
  navBtnStyle,
  settingsButtonStyle,
} from "@/app/lib/calendarStyles";

// ========================
// ã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
// ========================

function CalendarHeader({ monthLabel, onPrevMonth, onNextMonth }) {
  return (
    <header
      style={{
        display: "flex",
        alignItems: "center",
        justifyContent: "space-between",
        marginBottom: "12px",
      }}
    >
      <button onClick={onPrevMonth} style={navBtnStyle}>
        â†
      </button>
      <div
        style={{
          fontSize: "16px",
          fontWeight: 600,
        }}
      >
        {monthLabel}
      </div>
      <button onClick={onNextMonth} style={navBtnStyle}>
        â†’
      </button>
    </header>
  );
}

function CalendarFilters({
  childrenList,
  role,
  selectedChildId,
  onChangeChildId,
  calendarTaskFilter,
  tasksDict,
  calendarBadges,
  onClickSettings,
}) {
  return (
    <>
      {/* å­ã©ã‚‚ã‚»ãƒ¬ã‚¯ãƒˆï¼ˆå­ãƒ¢ãƒ¼ãƒ‰ã§ã¯éè¡¨ç¤ºï¼‰ */}
      {childrenList.length > 0 && role !== "child" && (
        <section
          style={{
            marginBottom: "12px",
          }}
        >
          <select
            value={selectedChildId}
            onChange={(e) => onChangeChildId(e.target.value)}
            style={{
              width: "100%",
              padding: "6px 8px",
              borderRadius: "8px",
              border: "1px solid #cccccc",
              fontSize: "13px",
            }}
          >
            <option value="all">ğŸ‘ª ã¿ã‚“ãªã¾ã¨ã‚ã¦</option>
            {childrenList.map((ch) => (
              <option key={ch.id} value={ch.id}>
                ğŸ‘¶ {ch.name}
              </option>
            ))}
          </select>
        </section>
      )}

      {/* ã‚¿ã‚¹ã‚¯ãƒ•ã‚£ãƒ«ã‚¿ + ãƒãƒƒã‚¸ã®æ„å‘³ + è¨­å®šã‚¢ã‚¤ã‚³ãƒ³ */}
      <section
        style={{
          marginBottom: "12px",
          fontSize: "12px",
          color: "#555555",
        }}
      >
        {/* è¦‹å‡ºã—ï¼ˆã‚¿ã‚¹ã‚¯å´ã®ã¿ï¼‰ */}
        <div
          style={{
            display: "flex",
            justifyContent: "flex-start",
            alignItems: "center",
            marginBottom: "4px",
          }}
        >
          <div
            style={{
              fontWeight: 600,
            }}
          >
            ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«åæ˜ ã™ã‚‹ã‚¿ã‚¹ã‚¯
          </div>
        </div>

        <div
          style={{
            display: "flex",
            gap: "8px",
            alignItems: "flex-start",
            flexWrap: "wrap",
          }}
        >
          {/* ã‚¿ã‚¹ã‚¯ãƒ•ã‚£ãƒ«ã‚¿è¡¨ç¤ºï¼ˆå·¦å´ï¼‰ */}
          <div
            style={{
              flex: "1 1 55%",
            }}
          >
            {calendarTaskFilter && calendarTaskFilter.length > 0 ? (
              <ul
                style={{
                  listStyle: "none",
                  padding: 0,
                  margin: 0,
                  display: "flex",
                  flexWrap: "wrap",
                  gap: "4px",
                }}
              >
                {calendarTaskFilter.map((id) => {
                  const t = tasksDict.byId[id];
                  if (!t) return null;
                  return (
                    <li
                      key={id}
                      style={{
                        background: "#f3e5f5",
                        borderRadius: "999px",
                        padding: "2px 8px",
                      }}
                    >
                      {t.icon || "ğŸµ"} {t.label}
                    </li>
                  );
                })}
              </ul>
            ) : (
              <div>ï¼ˆä»Šã®ã¨ã“ã‚ã€å…¨éƒ¨ã®ã‚¿ã‚¹ã‚¯ã‚’åˆè¨ˆã—ã¦ã„ã¾ã™ï¼‰</div>
            )}
          </div>

          {/* ãƒãƒƒã‚¸ã®æ„å‘³ï¼ˆå³å´ï¼šæ¨ªä¸¦ã³ & è¡Œæœ«ã«è¨­å®šã‚¢ã‚¤ã‚³ãƒ³ï¼‰ */}
          <div
            style={{
              flex: "0 0 40%",
              borderRadius: "12px",
              background: "#ffffff",
              padding: "8px 10px",
              border: "1px solid #eeeeee",
              boxSizing: "border-box",
            }}
          >
            <div
              style={{
                display: "flex",
                alignItems: "center",
                flexWrap: "wrap",
                gap: "6px",
                fontSize: "12px",
              }}
            >
              {calendarBadges.map((b) => (
                <span
                  key={b.id}
                  style={{
                    whiteSpace: "nowrap",
                  }}
                >
                  {b.icon} â€¦ {b.minMinutes}åˆ†ï½
                </span>
              ))}

              <button
                type="button"
                aria-label="ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ãƒãƒƒã‚¸è¨­å®šã¸"
                onClick={onClickSettings}
                style={settingsButtonStyle}
              >
                âš™ï¸
              </button>
            </div>
          </div>
        </div>
      </section>
    </>
  );
}

function CalendarGrid({
  cells,
  todayKey,
  dailyMinutes,
  calendarBadges,
  birthday,
  events,
  selectedChildId,
}) {
  const visibleEvents = filterEventsForChild(events, selectedChildId);

  function getEventsForDay(dayKey) {
    return visibleEvents.filter((ev) => ev.date === dayKey);
  }

  return (
    <section
      style={{
        borderRadius: "12px",
        background: "#ffffff",
        boxShadow: "0 1px 3px rgba(0,0,0,0.08)",
        padding: "8px 8px 10px",
        marginBottom: "12px",
      }}
    >
      <div
        style={{
          display: "grid",
          gridTemplateColumns: "repeat(7, 1fr)",
          fontSize: "11px",
          textAlign: "center",
          marginBottom: "4px",
          color: "#666666",
        }}
      >
        <div>æ—¥</div>
        <div>æœˆ</div>
        <div>ç«</div>
        <div>æ°´</div>
        <div>æœ¨</div>
        <div>é‡‘</div>
        <div>åœŸ</div>
      </div>

      <div
        style={{
          display: "grid",
          gridTemplateColumns: "repeat(7, 1fr)",
          gap: "4px",
          fontSize: "11px",
        }}
      >
        {cells.map((c, idx) => {
          if (!c) {
            return <div key={idx} style={{ minHeight: "52px" }} />;
          }
          const dayKey = toDayKey(c);
          const minutes = dailyMinutes[dayKey] || 0;
          const badge = getBadgeFromSettings(minutes, calendarBadges);
          const isToday = dayKey === todayKey;
          const dayEvents = getEventsForDay(dayKey);
          const isBday = isBirthdayDay(c, birthday);

          return (
            <div
              key={idx}
              style={{
                minHeight: "52px",
                borderRadius: "10px",
                border: `1px solid ${badge.border}`,
                background: badge.bg,
                padding: "4px 3px",
                position: "relative",
                boxSizing: "border-box",
              }}
            >
              <div
                style={{
                  display: "flex",
                  justifyContent: "space-between",
                  alignItems: "center",
                  marginBottom: "2px",
                }}
              >
                <div
                  style={{
                    fontWeight: isToday ? 700 : 500,
                    color: isToday ? "#d32f2f" : "#333333",
                    fontSize: "12px",
                  }}
                >
                  {c.getDate()}
                </div>
                {isBday && (
                  <span
                    style={{
                      fontSize: "11px",
                      color: "#e91e63",
                    }}
                  >
                    ğŸ‚
                  </span>
                )}
              </div>

              {badge.label && (
                <div
                  style={{
                    fontSize: "16px",
                    textAlign: "center",
                    lineHeight: 1,
                    marginBottom: "2px",
                  }}
                >
                  {badge.label}
                </div>
              )}

              {minutes > 0 && (
                <div
                  style={{
                    fontSize: "10px",
                    color: badge.text,
                    textAlign: "center",
                  }}
                >
                  {minutes}åˆ†
                </div>
              )}

              {dayEvents.length > 0 && (
                <div
                  style={{
                    position: "absolute",
                    left: "3px",
                    bottom: "2px",
                    fontSize: "10px",
                  }}
                >
                  {dayEvents.slice(0, 2).map((ev) => (
                    <span key={ev.id} style={{ marginRight: "2px" }}>
                      {ev.mark || "ğŸ“…"}
                    </span>
                  ))}
                  {dayEvents.length > 2 && (
                    <span style={{ fontSize: "9px" }}>
                      +{dayEvents.length - 2}
                    </span>
                  )}
                </div>
              )}
            </div>
          );
        })}
      </div>
    </section>
  );
}

// ========================
// ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæœ¬ä½“
// ========================

export default function CalendarPage() {
  const [year, setYear] = useState(() => new Date().getFullYear());
  const [month, setMonth] = useState(() => new Date().getMonth());
  const [dailyMinutes, setDailyMinutes] = useState({});
  const [events, setEvents] = useState([]);
  const [birthday, setBirthday] = useState("");
  const [calendarTaskFilter, setCalendarTaskFilter] = useState(null);
  const [tasksDict, setTasksDict] = useState({ byId: {}, byLabel: {} });
  const [children, setChildren] = useState([]);
  const [selectedChildId, setSelectedChildId] = useState("all");
  const [history, setHistory] = useState([]);
  const [calendarBadges, setCalendarBadges] = useState(DEFAULT_BADGES);
  const [role, setRole] = useState("parent");

  const todayKey = toDayKey(new Date());
  const cells = buildCalendarCells(year, month);
  const monthLabel = `${year}å¹´ ${month + 1}æœˆ`;

  // åˆæœŸãƒ­ãƒ¼ãƒ‰
  useEffect(() => {
    if (typeof window === "undefined") return;

    // ã‚¤ãƒ™ãƒ³ãƒˆ
    const evs = loadEvents();
    setEvents(evs);

    // ã‚¿ã‚¹ã‚¯ãƒ•ã‚£ãƒ«ã‚¿
    const filter = loadCalendarTaskFilter();
    setCalendarTaskFilter(filter);

    // ã‚¿ã‚¹ã‚¯è¾æ›¸
    const dict = loadTasksDict();
    setTasksDict(dict);

    // èª•ç”Ÿæ—¥
    setBirthday(loadBirthday());

    // å­ã©ã‚‚
    try {
      const rawChildren = window.localStorage.getItem(LS_CHILDREN);
      if (rawChildren) {
        const arr = JSON.parse(rawChildren);
        if (Array.isArray(arr)) setChildren(arr);
      }
    } catch (e) {
      console.warn("calendar children load error", e);
    }

    // é¸æŠä¸­ã®å­
    const savedChild = window.localStorage.getItem(LS_CURRENT_CHILD_ID);
    if (savedChild) setSelectedChildId(savedChild);

    // ãƒ­ãƒ¼ãƒ«ï¼ˆparent / childï¼‰
    try {
      const savedRole = window.localStorage.getItem(LS_ROLE);
      if (savedRole) setRole(savedRole);
    } catch (e) {
      console.warn("calendar role load error", e);
    }

    // å±¥æ­´
    try {
      const rawHistory = window.localStorage.getItem(LS_HISTORY);
      if (rawHistory) {
        const arr = JSON.parse(rawHistory);
        if (Array.isArray(arr)) {
          setHistory(arr);
          const mins = calcDailyMinutes(
            arr,
            filter,
            dict.byLabel,
            savedChild || "all"
          );
          setDailyMinutes(mins);
        }
      }
    } catch (e) {
      console.warn("calendar history load error", e);
    }

    // ãƒãƒƒã‚¸è¨­å®š
    const badges = loadCalendarSettingsFromStorage();
    setCalendarBadges(badges);
  }, []);

  // ãƒ•ã‚£ãƒ«ã‚¿ã‚„å­ã©ã‚‚å¤‰æ›´æ™‚ã®å†è¨ˆç®—
  useEffect(() => {
    if (!history || history.length === 0) return;
    const mins = calcDailyMinutes(
      history,
      calendarTaskFilter,
      tasksDict.byLabel,
      selectedChildId
    );
    setDailyMinutes(mins);
  }, [history, calendarTaskFilter, tasksDict, selectedChildId]);

  function goPrevMonth() {
    setMonth((m) => {
      const newM = m - 1;
      if (newM < 0) {
        setYear((y) => y - 1);
        return 11;
      }
      return newM;
    });
  }

  function goNextMonth() {
    setMonth((m) => {
      const newM = m + 1;
      if (newM > 11) {
        setYear((y) => y + 1);
        return 0;
      }
      return newM;
    });
  }

  function handleClickSettings() {
    if (typeof window === "undefined") return;
    window.location.href = ROUTE_CALENDAR_SETTINGS;
  }

  return (
    <main
      style={{
        padding: "16px 12px 80px",
        maxWidth: "520px",
        margin: "0 auto",
        fontFamily: "system-ui, sans-serif",
      }}
    >
      <CalendarHeader
        monthLabel={monthLabel}
        onPrevMonth={goPrevMonth}
        onNextMonth={goNextMonth}
      />

      <CalendarFilters
        childrenList={children}
        role={role}
        selectedChildId={selectedChildId}
        onChangeChildId={setSelectedChildId}
        calendarTaskFilter={calendarTaskFilter}
        tasksDict={tasksDict}
        calendarBadges={calendarBadges}
        onClickSettings={handleClickSettings}
      />

      <CalendarGrid
        cells={cells}
        todayKey={todayKey}
        dailyMinutes={dailyMinutes}
        calendarBadges={calendarBadges}
        birthday={birthday}
        events={events}
        selectedChildId={selectedChildId}
      />
    </main>
  );
}
