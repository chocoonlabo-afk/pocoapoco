"use client";

import { useEffect, useState } from "react";

/** æ—¥ä»˜â†’ "YYYY-MM-DD" */
function dateKeyFromDate(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

/** æœˆã”ã¨ã®é€±é…åˆ—ã‚’ã¤ãã‚‹ */
function buildCalendarWeeks(targetDate) {
  const year = targetDate.getFullYear();
  const month = targetDate.getMonth();
  const firstDay = new Date(year, month, 1);
  const firstWeekday = firstDay.getDay();
  const lastDay = new Date(year, month + 1, 0);
  const lastDateNum = lastDay.getDate();
  const cells = [];

  // å‰ã®æœˆã®ç©ºç™½
  for (let i = 0; i < firstWeekday; i++) cells.push(null);
  // å½“æœˆã®æ—¥ä»˜
  for (let d = 1; d <= lastDateNum; d++) cells.push(new Date(year, month, d));

  // 7ã¤ãšã¤ã«åˆ†å‰²
  const weeks = [];
  for (let i = 0; i < cells.length; i += 7) {
    weeks.push(cells.slice(i, i + 7));
  }
  return weeks;
}

/** åˆ†æ•°â†’è‰²ãƒ¬ãƒ™ãƒ« */
function getBadgeInfo(minutes) {
  if (minutes >= 60)
    return {
      bgColor: "#ffe0e0",
      borderColor: "#ff8080",
      textColor: "#a00000",
      level: "gold",
    };
  if (minutes >= 30)
    return {
      bgColor: "#fff3cc",
      borderColor: "#ffd24d",
      textColor: "#6d4c00",
      level: "silver",
    };
  if (minutes >= 15)
    return {
      bgColor: "#eaffea",
      borderColor: "#9de09d",
      textColor: "#064e00",
      level: "bronze",
    };
  if (minutes > 0)
    return {
      bgColor: "#eef4ff",
      borderColor: "#aac0ff",
      textColor: "#001a66",
      level: "light",
    };
  return {
    bgColor: "#fff",
    borderColor: "#ddd",
    textColor: "#999",
    level: "none",
  };
}

/** èª•ç”Ÿæ—¥åˆ¤å®š ("YYYY-MM-DD" ã¨æœˆæ—¥ãŒä¸€è‡´ã™ã‚‹ã‹) */
function isSameMonthDay(date, birthdayStr) {
  if (!birthdayStr) return false;
  const [, m, d] = birthdayStr.split("-");
  if (!m || !d) return false;
  return (
    date.getMonth() + 1 === parseInt(m, 10) &&
    date.getDate() === parseInt(d, 10)
  );
}

/** ã‚¤ãƒ™ãƒ³ãƒˆé…åˆ—ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ï¼ˆè¤‡æ•°å¯¾å¿œï¼‹å¾Œæ–¹äº’æ›ï¼‰ */
function loadEvents() {
  // æ–°ï¼šé…åˆ—
  try {
    const rawList = localStorage.getItem("pocopoco_events");
    if (rawList) {
      const arr = JSON.parse(rawList);
      if (Array.isArray(arr)) {
        // date ãŒã‚ã‚‹ã‚‚ã®ã ã‘
        return arr.filter((ev) => ev && ev.date);
      }
    }
  } catch {
    /* noop */
  }

  // æ—§ï¼š1ä»¶ã ã‘
  try {
    const rawSingle = localStorage.getItem("pocopoco_event");
    if (rawSingle) {
      const obj = JSON.parse(rawSingle);
      if (obj?.date) {
        return [
          {
            id: "legacy",
            title: obj.title || "ã‚¤ãƒ™ãƒ³ãƒˆ",
            date: obj.date,
            mark: obj.mark || "EV",
          },
        ];
      }
    }
  } catch {
    /* noop */
  }

  return [];
}

/** ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«åæ˜ ã™ã‚‹ã‚¿ã‚¹ã‚¯IDã®ãƒªã‚¹ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ */
function loadCalendarTaskFilter() {
  try {
    const raw = localStorage.getItem("pocopoco_calendar_task_filter");
    if (!raw) return null; // è¨­å®šãŒãªã‘ã‚Œã°å…¨ã‚¿ã‚¹ã‚¯é›†è¨ˆ
    const arr = JSON.parse(raw);
    if (Array.isArray(arr)) return arr;
  } catch {
    /* noop */
  }
  return null;
}

export default function CalendarPage() {
  const [currentMonthDate, setCurrentMonthDate] = useState(() => new Date());
  // { "YYYY-MM-DD": { totalMin, sessions } }
  const [dailySummary, setDailySummary] = useState({});
  // è¤‡æ•°ã‚¤ãƒ™ãƒ³ãƒˆ
  const [events, setEvents] = useState([]);
  // èª•ç”Ÿæ—¥
  const [birthdayStr, setBirthdayStr] = useState("");
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«å‡ºã™ã‚¿ã‚¹ã‚¯IDãƒ•ã‚£ãƒ«ã‚¿
  const [calendarTaskFilter, setCalendarTaskFilter] = useState(null);

  useEffect(() => {
    try {
      // 1) ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè¤‡æ•°ï¼‰
      const evts = loadEvents();
      setEvents(evts);

      // 2) ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¿ã‚¹ã‚¯ãƒ•ã‚£ãƒ«ã‚¿
      const filter = loadCalendarTaskFilter();
      setCalendarTaskFilter(filter);

      // 3) ç·´ç¿’å±¥æ­´ã‚’èª­ã¿è¾¼ã‚“ã§æ—¥ä»˜ã”ã¨ã«é›†è¨ˆ
      const raw = localStorage.getItem("pocopoco_history");
      if (raw) {
        const all = JSON.parse(raw);
        const summary = {};
        for (const s of all) {
          if (!s.startedAt) continue;

          // ã‚¿ã‚¹ã‚¯ã®ãƒ•ã‚£ãƒ«ã‚¿ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€è©²å½“ã—ãªã„ã‚¿ã‚¹ã‚¯ã¯é£›ã°ã™
          if (
            filter &&
            filter.length > 0 &&
            s.task_id &&
            !filter.includes(s.task_id)
          ) {
            continue;
          }

          const key = dateKeyFromDate(new Date(s.startedAt));
          summary[key] = summary[key] || { totalSec: 0, sessions: 0 };
          summary[key].totalSec += s.seconds || 0;
          summary[key].sessions++;
        }
        const mins = {};
        for (const k in summary) {
          mins[k] = {
            totalMin: Math.floor(summary[k].totalSec / 60),
            sessions: summary[k].sessions,
          };
        }
        setDailySummary(mins);
      }

      // 4) èª•ç”Ÿæ—¥
      const bd = localStorage.getItem("pocopoco_birthday");
      if (bd) setBirthdayStr(bd);
    } catch (e) {
      console.error("ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
    }
  }, []);

  const todayKey = dateKeyFromDate(new Date());
  const titleYear = currentMonthDate.getFullYear();
  const titleMonth = currentMonthDate.getMonth() + 1;
  const weeks = buildCalendarWeeks(currentMonthDate);

  function goPrevMonth() {
    setCurrentMonthDate(
      (prev) => new Date(prev.getFullYear(), prev.getMonth() - 1, 1)
    );
  }
  function goNextMonth() {
    setCurrentMonthDate(
      (prev) => new Date(prev.getFullYear(), prev.getMonth() + 1, 1)
    );
  }

  // ä»Šæœˆã®ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ï¼ˆä¸Šã«å‡ºã™ç”¨ï¼‰
  const currentMonthStr = `${titleYear}-${String(titleMonth).padStart(2, "0")}`;
  const eventsThisMonth = events.filter(
    (ev) => ev.date && ev.date.startsWith(currentMonthStr)
  );

  return (
    <main
      style={{
        padding: "24px 16px 80px",
        fontFamily: "system-ui, sans-serif",
        maxWidth: "480px",
        margin: "0 auto",
      }}
    >
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <header
        style={{
          display: "flex",
          alignItems: "center",
          justifyContent: "space-between",
          marginBottom: "16px",
        }}
      >
        <button onClick={goPrevMonth} style={navBtnStyle}>
          â†
        </button>
        <div style={{ textAlign: "center", lineHeight: 1.3 }}>
          <div style={{ fontSize: "16px", fontWeight: "600" }}>
            {titleYear}å¹´ {titleMonth}æœˆ
          </div>
          <div style={{ fontSize: "12px", color: "#666" }}>
            ãˆã‚‰ã‚“ã ã‚¿ã‚¹ã‚¯ã ã‘ãŒ ã¯ã„ã‘ã„ã«è‰²ãŒã¤ãã¾ã™
          </div>
        </div>
        <button onClick={goNextMonth} style={navBtnStyle}>
          â†’
        </button>
      </header>

      {/* ä»Šæœˆã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè¤‡æ•°ï¼‰ */}
      {eventsThisMonth.length > 0 && (
        <div
          style={{
            border: "1px solid #ffe0a1",
            background:
              "linear-gradient(135deg, rgba(255,251,235,0.95), rgba(255,245,200,0.8))",
            borderRadius: "10px",
            padding: "10px 12px",
            marginBottom: "12px",
          }}
        >
          <div
            style={{ fontSize: "13px", color: "#a15a00", marginBottom: "6px" }}
          >
            ğŸ“£ ä»Šæœˆã®ã‚¤ãƒ™ãƒ³ãƒˆ
          </div>
          {eventsThisMonth.map((ev) => (
            <div
              key={ev.id || ev.date}
              style={{ display: "flex", gap: "8px", alignItems: "center" }}
            >
              <div style={{ fontSize: "16px" }}>{ev.mark || "ğŸ“Œ"}</div>
              <div>
                <div
                  style={{
                    fontSize: "14px",
                    fontWeight: "600",
                    color: "#6d4c00",
                  }}
                >
                  {ev.title || "(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)"}
                </div>
                <div style={{ fontSize: "12px", color: "#6d4c00" }}>
                  {ev.date}
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* æ›œæ—¥ */}
      <div style={weekdayRowStyle}>
        {["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"].map((d) => (
          <div key={d}>{d}</div>
        ))}
      </div>

      {/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */}
      <div style={{ display: "grid", rowGap: "8px" }}>
        {weeks.map((week, wIdx) => (
          <div
            key={wIdx}
            style={{
              display: "grid",
              gridTemplateColumns: "repeat(7, 1fr)",
              columnGap: "8px",
            }}
          >
            {week.map((cellDate, cIdx) => {
              if (!cellDate) {
                return <div key={cIdx} style={emptyCellStyle} />;
              }

              const key = dateKeyFromDate(cellDate);
              const info = dailySummary[key];
              const minutes = info ? info.totalMin : 0;
              const { bgColor, borderColor, textColor, level } =
                getBadgeInfo(minutes);

              const isToday = key === todayKey;
              const outline = isToday ? "0 0 0 2px rgba(138,43,226,0.6)" : "none";

              // ã“ã®æ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè¤‡æ•°ã‚ã‚Šãˆã‚‹ï¼‰
              const dayEvents = events.filter((ev) => ev.date === key);

              // èª•ç”Ÿæ—¥ï¼Ÿ
              const isBirthday = isSameMonthDay(cellDate, birthdayStr);

              return (
                <div
                  key={cIdx}
                  style={{
                    minHeight: "68px",
                    borderRadius: "8px",
                    border: `1px solid ${borderColor}`,
                    background: bgColor,
                    fontSize: "12px",
                    padding: "6px",
                    lineHeight: 1.4,
                    display: "flex",
                    flexDirection: "column",
                    justifyContent: "space-between",
                    color: textColor,
                    boxShadow: outline,
                    position: "relative",
                  }}
                >
                  {/* æ—¥ä»˜ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ¼ã‚¯(ä¸Šéƒ¨) */}
                  <div
                    style={{
                      display: "flex",
                      justifyContent: "space-between",
                      gap: "4px",
                    }}
                  >
                    <div
                      style={{
                        fontWeight: "600",
                        textAlign: "left",
                        fontSize: "12px",
                        wordBreak: "keep-all",
                      }}
                    >
                      {cellDate.getDate()}
                    </div>
                    <div
                      style={{
                        display: "flex",
                        gap: "2px",
                        flexWrap: "wrap",
                        justifyContent: "flex-end",
                      }}
                    >
                      {dayEvents.map((ev) => (
                        <span
                          key={ev.id || ev.title}
                          title={ev.title}
                          style={{
                            fontSize: "11px",
                            backgroundColor: "#ff9800",
                            color: "#fff",
                            borderRadius: "999px",
                            padding: "1px 5px",
                            lineHeight: 1.1,
                          }}
                        >
                          {ev.mark || "EV"}
                        </span>
                      ))}
                      {isBirthday && (
                        <span
                          style={{
                            fontSize: "11px",
                            backgroundColor: "#ff80ab",
                            color: "#fff",
                            borderRadius: "999px",
                            padding: "1px 5px",
                          }}
                        >
                          ğŸ‚
                        </span>
                      )}
                    </div>
                  </div>

                  {/* ä¸‹éƒ¨å³å¯„ã› */}
                  <div style={{ textAlign: "right", fontSize: "11px" }}>
                    {minutes > 0
                      ? `${minutes}åˆ†${
                          level === "gold"
                            ? "ğŸ¥‡"
                            : level === "silver"
                            ? "ğŸ¥ˆ"
                            : level === "bronze"
                            ? "ğŸ¥‰"
                            : "â­"
                        }`
                      : "ãƒ»"}
                  </div>
                </div>
              );
            })}
          </div>
        ))}
      </div>

      {/* å‡¡ä¾‹ */}
      <div
        style={{
          fontSize: "11px",
          color: "#777",
          marginTop: "16px",
          lineHeight: 1.5,
          textAlign: "center",
        }}
      >
        ğŸ¥‰15åˆ†ã€œ / ğŸ¥ˆ30åˆ†ã€œ / ğŸ¥‡60åˆ†ã€œ
        <br />
        ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒãƒ¼ã‚¯ã¯è¨­å®šã§æ±ºã‚ãŸã‚‚ã®ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
        <br />
        ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é›†è¨ˆã‚¿ã‚¹ã‚¯ã‚’è¨­å®šã—ã¦ã„ãªã„å ´åˆã¯ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ã‚’åˆè¨ˆã—ã¾ã™
      </div>
    </main>
  );
}

/* ---------- ã‚¹ã‚¿ã‚¤ãƒ« ---------- */
const navBtnStyle = {
  border: "1px solid #ccc",
  background: "#fff",
  borderRadius: "8px",
  padding: "6px 10px",
  fontSize: "14px",
  cursor: "pointer",
  minWidth: "44px",
};
const weekdayRowStyle = {
  display: "grid",
  gridTemplateColumns: "repeat(7, 1fr)",
  textAlign: "center",
  fontSize: "12px",
  fontWeight: "600",
  color: "#666",
  marginBottom: "8px",
};
const emptyCellStyle = {
  minHeight: "60px",
  borderRadius: "8px",
  background: "#f4f4f4",
  border: "1px solid #ddd",
};
