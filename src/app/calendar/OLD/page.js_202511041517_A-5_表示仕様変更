"use client";

import { useEffect, useState } from "react";

/** æ—¥ä»˜â†’ "YYYY-MM-DD" */
function dateKeyFromDate(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

/** æœˆã”ã¨ã®é€±é…åˆ— */
function buildCalendarWeeks(targetDate) {
  const year = targetDate.getFullYear();
  const month = targetDate.getMonth();
  const firstDay = new Date(year, month, 1);
  const firstWeekday = firstDay.getDay();
  const lastDay = new Date(year, month + 1, 0);
  const lastDateNum = lastDay.getDate();
  const cells = [];

  for (let i = 0; i < firstWeekday; i++) cells.push(null);
  for (let d = 1; d <= lastDateNum; d++) cells.push(new Date(year, month, d));

  const weeks = [];
  for (let i = 0; i < cells.length; i += 7) {
    weeks.push(cells.slice(i, i + 7));
  }
  return weeks;
}

/** åˆ†æ•°â†’è‰²ãƒ¬ãƒ™ãƒ« */
function getBadgeInfo(minutes) {
  if (minutes >= 60)
    return { bgColor: "#ffe0e0", borderColor: "#ff8080", textColor: "#a00000", level: "gold" };
  if (minutes >= 30)
    return { bgColor: "#fff3cc", borderColor: "#ffd24d", textColor: "#6d4c00", level: "silver" };
  if (minutes >= 15)
    return { bgColor: "#eaffea", borderColor: "#9de09d", textColor: "#064e00", level: "bronze" };
  if (minutes > 0)
    return { bgColor: "#eef4ff", borderColor: "#aac0ff", textColor: "#001a66", level: "light" };
  return { bgColor: "#fff", borderColor: "#ddd", textColor: "#999", level: "none" };
}

/** èª•ç”Ÿæ—¥åˆ¤å®š */
function isSameMonthDay(date, birthdayStr) {
  if (!birthdayStr) return false;
  const [y, m, d] = birthdayStr.split("-");
  if (!m || !d) return false;
  return date.getMonth() + 1 === parseInt(m, 10) && date.getDate() === parseInt(d, 10);
}

export default function CalendarPage() {
  const [currentMonthDate, setCurrentMonthDate] = useState(() => new Date());
  const [dailySummary, setDailySummary] = useState({});
  const [eventInfo, setEventInfo] = useState(null);
  const [birthdayStr, setBirthdayStr] = useState("");

  useEffect(() => {
    try {
      // ç·´ç¿’å±¥æ­´é›†è¨ˆ
      const raw = localStorage.getItem("pocopoco_history");
      if (raw) {
        const all = JSON.parse(raw);
        const summary = {};
        for (const s of all) {
          if (!s.startedAt) continue;
          const key = dateKeyFromDate(new Date(s.startedAt));
          summary[key] = summary[key] || { totalSec: 0, sessions: 0 };
          summary[key].totalSec += s.seconds || 0;
          summary[key].sessions++;
        }
        const mins = {};
        for (const k in summary)
          mins[k] = { totalMin: Math.floor(summary[k].totalSec / 60), sessions: summary[k].sessions };
        setDailySummary(mins);
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç™ºè¡¨ä¼šãªã©ï¼‰
      const rawEvent = localStorage.getItem("pocopoco_event");
      if (rawEvent) {
        const evt = JSON.parse(rawEvent);
        if (evt?.date && evt?.title) setEventInfo(evt);
      }

      // èª•ç”Ÿæ—¥
      const bd = localStorage.getItem("pocopoco_birthday");
      if (bd) setBirthdayStr(bd);
    } catch (e) {
      console.error("ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼", e);
    }
  }, []);

  const todayKey = dateKeyFromDate(new Date());
  const titleYear = currentMonthDate.getFullYear();
  const titleMonth = currentMonthDate.getMonth() + 1;
  const weeks = buildCalendarWeeks(currentMonthDate);

  function goPrevMonth() {
    setCurrentMonthDate((prev) => new Date(prev.getFullYear(), prev.getMonth() - 1, 1));
  }
  function goNextMonth() {
    setCurrentMonthDate((prev) => new Date(prev.getFullYear(), prev.getMonth() + 1, 1));
  }

  return (
    <main
      style={{
        padding: "24px 16px 80px",
        fontFamily: "system-ui, sans-serif",
        maxWidth: "480px",
        margin: "0 auto",
      }}
    >
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <header
        style={{
          display: "flex",
          alignItems: "center",
          justifyContent: "space-between",
          marginBottom: "16px",
        }}
      >
        <button onClick={goPrevMonth} style={navBtnStyle}>â†</button>
        <div style={{ textAlign: "center", lineHeight: 1.3 }}>
          <div style={{ fontSize: "16px", fontWeight: "600" }}>
            {titleYear}å¹´ {titleMonth}æœˆ
          </div>
          <div style={{ fontSize: "12px", color: "#666" }}>ãŒã‚“ã°ã£ãŸæ—¥ã«è‰²ãŒã¤ãã‚ˆ</div>
        </div>
        <button onClick={goNextMonth} style={navBtnStyle}>â†’</button>
      </header>

      {/* æ›œæ—¥ */}
      <div style={weekdayRowStyle}>
        {["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"].map((d) => (
          <div key={d}>{d}</div>
        ))}
      </div>

      {/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */}
      <div style={{ display: "grid", rowGap: "8px" }}>
        {weeks.map((week, wIdx) => (
          <div key={wIdx} style={{ display: "grid", gridTemplateColumns: "repeat(7, 1fr)", columnGap: "8px" }}>
            {week.map((cellDate, cIdx) => {
              if (!cellDate)
                return <div key={cIdx} style={emptyCellStyle} />;

              const key = dateKeyFromDate(cellDate);
              const info = dailySummary[key];
              const minutes = info ? info.totalMin : 0;
              const { bgColor, borderColor, textColor, level } = getBadgeInfo(minutes);

              const isToday = key === todayKey;
              const outline = isToday ? "0 0 0 2px rgba(138,43,226,0.6)" : "none";

              // ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ï¼Ÿ
              const isEvent =
                eventInfo &&
                eventInfo.date &&
                dateKeyFromDate(new Date(eventInfo.date)) === key;

              // èª•ç”Ÿæ—¥ï¼Ÿ
              const isBirthday = isSameMonthDay(cellDate, birthdayStr);

              return (
                <div
                  key={cIdx}
                  style={{
                    minHeight: "60px",
                    borderRadius: "8px",
                    border: `1px solid ${borderColor}`,
                    background: bgColor,
                    fontSize: "12px",
                    padding: "6px",
                    lineHeight: 1.4,
                    display: "flex",
                    flexDirection: "column",
                    justifyContent: "space-between",
                    color: textColor,
                    boxShadow: outline,
                    position: "relative",
                  }}
                >
                  {/* æ—¥ä»˜ */}
                  <div style={{ fontWeight: "600", textAlign: "left", fontSize: "12px" }}>
                    {cellDate.getDate()}
                  </div>

                  {/* ä¸‹éƒ¨å³å¯„ã› */}
                  <div style={{ textAlign: "right", fontSize: "11px" }}>
                    {minutes > 0
                      ? `${minutes}åˆ†${
                          level === "gold"
                            ? "ğŸ¥‡"
                            : level === "silver"
                            ? "ğŸ¥ˆ"
                            : level === "bronze"
                            ? "ğŸ¥‰"
                            : "â­"
                        }`
                      : "ãƒ»"}
                    {isEvent && " ğŸ€"}
                    {isBirthday && " ğŸ‚"}
                  </div>
                </div>
              );
            })}
          </div>
        ))}
      </div>

      {/* å‡¡ä¾‹ */}
      <div
        style={{
          fontSize: "11px",
          color: "#777",
          marginTop: "16px",
          lineHeight: 1.5,
          textAlign: "center",
        }}
      >
        ğŸ¥‰15åˆ†ã€œ / ğŸ¥ˆ30åˆ†ã€œ / ğŸ¥‡60åˆ†ã€œ  
        <br />
        ğŸ€ã‚¤ãƒ™ãƒ³ãƒˆ / ğŸ‚ãŸã‚“ã˜ã‚‡ã†ã³  
        <br />
        ä»Šæ—¥ã¯ã‚€ã‚‰ã•ãã®æ ã§è¡¨ç¤ºã•ã‚Œã¾ã™
      </div>
    </main>
  );
}

/* ---------- ã‚¹ã‚¿ã‚¤ãƒ« ---------- */
const navBtnStyle = {
  border: "1px solid #ccc",
  background: "#fff",
  borderRadius: "8px",
  padding: "6px 10px",
  fontSize: "14px",
  cursor: "pointer",
  minWidth: "44px",
};
const weekdayRowStyle = {
  display: "grid",
  gridTemplateColumns: "repeat(7, 1fr)",
  textAlign: "center",
  fontSize: "12px",
  fontWeight: "600",
  color: "#666",
  marginBottom: "8px",
};
const emptyCellStyle = {
  minHeight: "60px",
  borderRadius: "8px",
  background: "#f4f4f4",
  border: "1px solid #ddd",
};
