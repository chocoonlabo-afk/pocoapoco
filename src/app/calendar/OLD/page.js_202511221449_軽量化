"use client";

import { useEffect, useState } from "react";
import {
  LS_CALENDAR_SETTINGS,
  LS_EVENTS,
  LS_EVENT_LEGACY,
  LS_CALENDAR_TASK_FILTER,
  LS_TASKS,
  LS_CHILDREN,
  LS_CURRENT_CHILD_ID,
  LS_HISTORY,
  LS_BIRTHDAY,
  LS_ROLE,
  ROUTE_CALENDAR_SETTINGS,
} from "@/app/constants";

// ========================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ========================

// YYYY-MM-DD æ–‡å­—åˆ—ã«å¤‰æ›
function toDayKey(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚»ãƒ«ã‚’ä½œã‚‹ï¼ˆå‰ã®ç©ºç™½ + 1ã€œæœ«æ—¥ï¼‰
function buildCalendarCells(year, month) {
  const first = new Date(year, month, 1);
  const startWeekday = first.getDay();
  const lastDate = new Date(year, month + 1, 0).getDate();
  const cells = [];
  for (let i = 0; i < startWeekday; i++) cells.push(null);
  for (let d = 1; d <= lastDate; d++) {
    cells.push(new Date(year, month, d));
  }
  return cells;
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒƒã‚¸å®šç¾©
const DEFAULT_BADGES = [
  { id: "level1", name: "å°‘ã—ã§ã‚‚ç·´ç¿’ã—ãŸæ—¥", minMinutes: 1, icon: "ğŸŒ¸" },
  { id: "level2", name: "ãŸãã•ã‚“ç·´ç¿’ï¼ˆéŠ…ï¼‰", minMinutes: 30, icon: "ğŸ¥‰" },
  { id: "level3", name: "ã‚‚ã£ã¨ãŸãã•ã‚“ï¼ˆéŠ€ï¼‰", minMinutes: 60, icon: "ğŸ¥ˆ" },
  { id: "level4", name: "ã™ã”ããŒã‚“ã°ã£ãŸï¼ˆé‡‘ï¼‰", minMinutes: 90, icon: "ğŸ¥‡" },
];

// localStorage ã‹ã‚‰ãƒãƒƒã‚¸è¨­å®šã‚’èª­ã‚€
function loadCalendarSettingsFromStorage() {
  if (typeof window === "undefined") return DEFAULT_BADGES;
  let badges = DEFAULT_BADGES;
  try {
    const raw = window.localStorage.getItem(LS_CALENDAR_SETTINGS);
    if (raw) {
      const data = JSON.parse(raw);
      if (data && Array.isArray(data.badges) && data.badges.length > 0) {
        badges = DEFAULT_BADGES.map((def) => {
          const found = data.badges.find((b) => b.id === def.id);
          return found ? { ...def, ...found } : def;
        });
      }
    }
  } catch (e) {
    console.warn("calendar settings parse error", e);
  }
  return badges;
}

// åˆ†æ•°ã«å¿œã˜ã¦è‰²ãƒ»ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ±ºã‚ã‚‹
function getBadgeFromSettings(minutes, badges) {
  if (!minutes || minutes <= 0) {
    return {
      bg: "#ffffff",
      border: "#dddddd",
      text: "#999999",
      label: "",
    };
  }

  const sorted = [...badges].sort(
    (a, b) => Number(a.minMinutes || 0) - Number(b.minMinutes || 0)
  );
  let levelIndex = -1;
  let label = "";

  sorted.forEach((b, idx) => {
    const threshold = Number(b.minMinutes || 0);
    if (minutes >= threshold) {
      levelIndex = idx;
      label = b.icon || "";
    }
  });

  const colorLevels = [
    { bg: "#eef4ff", border: "#aac0ff", text: "#001a66" },
    { bg: "#e9ffe9", border: "#a8e4a8", text: "#045704" },
    { bg: "#fff4d9", border: "#ffcd73", text: "#6d4c00" },
    { bg: "#ffe7e7", border: "#ff9f9f", text: "#a00000" },
  ];

  if (levelIndex < 0) {
    return {
      bg: "#eef4ff",
      border: "#aac0ff",
      text: "#001a66",
      label,
    };
  }

  const color =
    colorLevels[Math.min(levelIndex, colorLevels.length - 1)] || colorLevels[0];

  return {
    ...color,
    label,
  };
}

// ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‚’èª­ã‚€ï¼ˆæ–° old ä¸¡å¯¾å¿œï¼‰
function loadEvents() {
  if (typeof window === "undefined") return [];
  // æ–°ä»•æ§˜
  try {
    const raw = window.localStorage.getItem(LS_EVENTS);
    if (raw) {
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) return arr;
    }
  } catch (e) {
    console.warn("pocopoco_events parse error", e);
  }

  // æ—§ä»•æ§˜ï¼ˆå˜ä¸€ã‚¤ãƒ™ãƒ³ãƒˆï¼‰
  try {
    const rawSingle = window.localStorage.getItem(LS_EVENT_LEGACY);
    if (rawSingle) {
      const s = JSON.parse(rawSingle);
      if (s && (s.title || s.date)) {
        return [
          {
            id: "legacy_single",
            title: s.title || "ã‚¤ãƒ™ãƒ³ãƒˆ",
            date: s.date || "",
            mark: "â˜…",
            home: true,
            child_id: "all",
          },
        ];
      }
    }
  } catch (e) {
    console.warn("pocopoco_event parse error", e);
  }

  return [];
}

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§åˆè¨ˆå¯¾è±¡ã«ã™ã‚‹ã‚¿ã‚¹ã‚¯IDãƒªã‚¹ãƒˆ
function loadCalendarTaskFilter() {
  if (typeof window === "undefined") return null;
  try {
    const raw = window.localStorage.getItem(LS_CALENDAR_TASK_FILTER);
    if (!raw) return null;
    const arr = JSON.parse(raw);
    if (!Array.isArray(arr)) return null;
    return arr;
  } catch {
    return null;
  }
}

// ã‚¿ã‚¹ã‚¯ä¸€è¦§ï¼ˆid/labelè¾æ›¸ï¼‰
function loadTasksDict() {
  if (typeof window === "undefined") return { byId: {}, byLabel: {} };
  try {
    const raw = window.localStorage.getItem(LS_TASKS);
    if (!raw) return { byId: {}, byLabel: {} };
    const arr = JSON.parse(raw);
    if (!Array.isArray(arr)) return { byId: {}, byLabel: {} };
    const byId = {};
    const byLabel = {};
    arr.forEach((t) => {
      if (t.id) byId[t.id] = t;
      const label = (t.label || "").trim().toLowerCase();
      if (label) byLabel[label] = t;
    });
    return { byId, byLabel };
  } catch {
    return { byId: {}, byLabel: {} };
  }
}

// èª•ç”Ÿæ—¥ã‚’èª­ã‚€
function loadBirthday() {
  if (typeof window === "undefined") return "";
  try {
    const raw = window.localStorage.getItem(LS_BIRTHDAY);
    if (!raw) return "";
    return raw;
  } catch {
    return "";
  }
}

// ãã®æ—¥ãŒèª•ç”Ÿæ—¥ã‹ï¼Ÿ
function isBirthdayDay(dateObj, birthdayStr) {
  if (!birthdayStr) return false;
  const parts = birthdayStr.split("-");
  if (parts.length < 3) return false;
  const m = parts[1];
  const d = parts[2];
  const mm = String(dateObj.getMonth() + 1).padStart(2, "0");
  const dd = String(dateObj.getDate()).padStart(2, "0");
  return mm === m && dd === d;
}

// å­ã©ã‚‚ã”ã¨ã®è¡¨ç¤ºå¯å¦
function isEventVisibleForChild(ev, childId) {
  if (!ev.child_id || ev.child_id === "all") return true;
  if (childId === "all") return ev.child_id === "all";
  return ev.child_id === childId;
}

function filterEventsForChild(events, childId) {
  return events.filter((ev) => isEventVisibleForChild(ev, childId));
}

// æ—¥åˆ¥ã®ç·´ç¿’åˆè¨ˆåˆ†
function calcDailyMinutes(historyArr, filterIds, tasksByLabel, childId) {
  const map = {};

  const hasFilter = Array.isArray(filterIds) && filterIds.length > 0;
  const hasChildFilter = !!childId && childId !== "all";

  for (const rec of historyArr) {
    if (hasChildFilter && rec.child_id && rec.child_id !== childId) continue;

    const dayKey = rec.startedAt ? rec.startedAt.slice(0, 10) : rec.date;
    if (!dayKey) continue;
    const sec = rec.seconds ?? rec.duration ?? 0;

    if (!hasFilter) {
      map[dayKey] = (map[dayKey] || 0) + Math.floor(sec / 60);
      continue;
    }

    // task_id ã§ãƒãƒƒãƒ
    if (rec.task_id && filterIds.includes(rec.task_id)) {
      map[dayKey] = (map[dayKey] || 0) + Math.floor(sec / 60);
      continue;
    }

    // label ã‹ã‚‰æ¨æ¸¬
    const labels = [rec.task_title, rec.task].filter(Boolean);
    for (const label of labels) {
      const lc = label.trim().toLowerCase();
      const t = tasksByLabel[lc];
      if (t && filterIds.includes(t.id)) {
        map[dayKey] = (map[dayKey] || 0) + Math.floor(sec / 60);
        break;
      }
    }
  }

  return map;
}

// ========================
// ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæœ¬ä½“
// ========================

export default function CalendarPage() {
  const [year, setYear] = useState(() => new Date().getFullYear());
  const [month, setMonth] = useState(() => new Date().getMonth());
  const [dailyMinutes, setDailyMinutes] = useState({});
  const [events, setEvents] = useState([]);
  const [birthday, setBirthday] = useState("");
  const [calendarTaskFilter, setCalendarTaskFilter] = useState(null);
  const [tasksDict, setTasksDict] = useState({ byId: {}, byLabel: {} });
  const [children, setChildren] = useState([]);
  const [selectedChildId, setSelectedChildId] = useState("all");
  const [history, setHistory] = useState([]);
  const [calendarBadges, setCalendarBadges] = useState(DEFAULT_BADGES);
  const [role, setRole] = useState("parent");

  const todayKey = toDayKey(new Date());
  const cells = buildCalendarCells(year, month);
  const monthLabel = `${year}å¹´ ${month + 1}æœˆ`;

  // åˆæœŸãƒ­ãƒ¼ãƒ‰
  useEffect(() => {
    if (typeof window === "undefined") return;

    const evs = loadEvents();
    setEvents(evs);

    const filter = loadCalendarTaskFilter();
    setCalendarTaskFilter(filter);

    const dict = loadTasksDict();
    setTasksDict(dict);

    setBirthday(loadBirthday());

    // å­ã©ã‚‚
    try {
      const rawChildren = window.localStorage.getItem(LS_CHILDREN);
      if (rawChildren) {
        const arr = JSON.parse(rawChildren);
        if (Array.isArray(arr)) setChildren(arr);
      }
    } catch (e) {
      console.warn("calendar children load error", e);
    }

    const savedChild = window.localStorage.getItem(LS_CURRENT_CHILD_ID);
    if (savedChild) setSelectedChildId(savedChild);

    // ãƒ­ãƒ¼ãƒ«ï¼ˆparent / childï¼‰
    try {
      const savedRole = window.localStorage.getItem(LS_ROLE);
      if (savedRole) setRole(savedRole);
    } catch (e) {
      console.warn("calendar role load error", e);
    }

    // å±¥æ­´
    try {
      const rawHistory = window.localStorage.getItem(LS_HISTORY);
      if (rawHistory) {
        const arr = JSON.parse(rawHistory);
        if (Array.isArray(arr)) {
          setHistory(arr);
          const mins = calcDailyMinutes(
            arr,
            filter,
            dict.byLabel,
            savedChild || "all"
          );
          setDailyMinutes(mins);
        }
      }
    } catch (e) {
      console.warn("calendar history load error", e);
    }

    const badges = loadCalendarSettingsFromStorage();
    setCalendarBadges(badges);
  }, []);

  // ãƒ•ã‚£ãƒ«ã‚¿ã‚„å­ã©ã‚‚å¤‰æ›´æ™‚ã®å†è¨ˆç®—
  useEffect(() => {
    if (!history || history.length === 0) return;
    const mins = calcDailyMinutes(
      history,
      calendarTaskFilter,
      tasksDict.byLabel,
      selectedChildId
    );
    setDailyMinutes(mins);
  }, [history, calendarTaskFilter, tasksDict, selectedChildId]);

  function goPrevMonth() {
    setMonth((m) => {
      const newM = m - 1;
      if (newM < 0) {
        setYear((y) => y - 1);
        return 11;
      }
      return newM;
    });
  }

  function goNextMonth() {
    setMonth((m) => {
      const newM = m + 1;
      if (newM > 11) {
        setYear((y) => y + 1);
        return 0;
      }
      return newM;
    });
  }

  function getEventsForDay(dayKey) {
    const visibleEvents = filterEventsForChild(events, selectedChildId);
    return visibleEvents.filter((ev) => ev.date === dayKey);
  }

  const navBtnStyle = {
    border: "1px solid #cccccc",
    background: "#ffffff",
    borderRadius: "8px",
    padding: "6px 10px",
    fontSize: "14px",
    minWidth: "44px",
    cursor: "pointer",
  };

  const settingsButtonStyle = {
    border: "none",
    background: "transparent",
    padding: "4px",
    borderRadius: "999px",
    cursor: "pointer",
    fontSize: "16px",
    lineHeight: 1,
  };

  return (
    <main
      style={{
        padding: "16px 12px 80px",
        maxWidth: "520px",
        margin: "0 auto",
        fontFamily: "system-ui, sans-serif",
      }}
    >
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæœˆç§»å‹•ï¼‰ */}
      <header
        style={{
          display: "flex",
          alignItems: "center",
          justifyContent: "space-between",
          marginBottom: "12px",
        }}
      >
        <button onClick={goPrevMonth} style={navBtnStyle}>
          â†
        </button>
        <div
          style={{
            fontSize: "16px",
            fontWeight: 600,
          }}
        >
          {monthLabel}
        </div>
        <button onClick={goNextMonth} style={navBtnStyle}>
          â†’
        </button>
      </header>

      {/* å­ã©ã‚‚ã‚»ãƒ¬ã‚¯ãƒˆï¼ˆå­ãƒ¢ãƒ¼ãƒ‰ã§ã¯éè¡¨ç¤ºï¼‰ */}
      {children.length > 0 && role !== "child" && (
        <section
          style={{
            marginBottom: "12px",
          }}
        >
          <select
            value={selectedChildId}
            onChange={(e) => setSelectedChildId(e.target.value)}
            style={{
              width: "100%",
              padding: "6px 8px",
              borderRadius: "8px",
              border: "1px solid #cccccc",
              fontSize: "13px",
            }}
          >
            <option value="all">ğŸ‘ª ã¿ã‚“ãªã¾ã¨ã‚ã¦</option>
            {children.map((ch) => (
              <option key={ch.id} value={ch.id}>
                ğŸ‘¶ {ch.name}
              </option>
            ))}
          </select>
        </section>
      )}

      {/* ã‚¿ã‚¹ã‚¯ãƒ•ã‚£ãƒ«ã‚¿ + ãƒãƒƒã‚¸ã®æ„å‘³ + è¨­å®šã‚¢ã‚¤ã‚³ãƒ³ */}
            {/* ã‚¿ã‚¹ã‚¯ãƒ•ã‚£ãƒ«ã‚¿ + ãƒãƒƒã‚¸ã®æ„å‘³ + è¨­å®šã‚¢ã‚¤ã‚³ãƒ³ */}
      <section
        style={{
          marginBottom: "12px",
          fontSize: "12px",
          color: "#555555",
        }}
      >
        {/* è¦‹å‡ºã—ï¼ˆã‚¿ã‚¹ã‚¯å´ã®ã¿ï¼‰ */}
        <div
          style={{
            display: "flex",
            justifyContent: "flex-start",
            alignItems: "center",
            marginBottom: "4px",
          }}
        >
          <div
            style={{
              fontWeight: 600,
            }}
          >
            ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«åæ˜ ã™ã‚‹ã‚¿ã‚¹ã‚¯
          </div>
        </div>

        <div
          style={{
            display: "flex",
            gap: "8px",
            alignItems: "flex-start",
            flexWrap: "wrap",
          }}
        >
          {/* ã‚¿ã‚¹ã‚¯ãƒ•ã‚£ãƒ«ã‚¿è¡¨ç¤ºï¼ˆå·¦å´ï¼‰ */}
          <div
            style={{
              flex: "1 1 55%",
            }}
          >
            {calendarTaskFilter && calendarTaskFilter.length > 0 ? (
              <ul
                style={{
                  listStyle: "none",
                  padding: 0,
                  margin: 0,
                  display: "flex",
                  flexWrap: "wrap",
                  gap: "4px",
                }}
              >
                {calendarTaskFilter.map((id) => {
                  const t = tasksDict.byId[id];
                  if (!t) return null;
                  return (
                    <li
                      key={id}
                      style={{
                        background: "#f3e5f5",
                        borderRadius: "999px",
                        padding: "2px 8px",
                      }}
                    >
                      {t.icon || "ğŸµ"} {t.label}
                    </li>
                  );
                })}
              </ul>
            ) : (
              <div>ï¼ˆä»Šã®ã¨ã“ã‚ã€å…¨éƒ¨ã®ã‚¿ã‚¹ã‚¯ã‚’åˆè¨ˆã—ã¦ã„ã¾ã™ï¼‰</div>
            )}
          </div>

          {/* ãƒãƒƒã‚¸ã®æ„å‘³ï¼ˆå³å´ï¼šæ¨ªä¸¦ã³ & è¡Œæœ«ã«è¨­å®šã‚¢ã‚¤ã‚³ãƒ³ï¼‰ */}
          <div
            style={{
              flex: "0 0 40%",
              borderRadius: "12px",
              background: "#ffffff",
              padding: "8px 10px",
              border: "1px solid #eeeeee",
              boxSizing: "border-box",
            }}
          >
            <div
              style={{
                display: "flex",
                alignItems: "center",
                flexWrap: "wrap",
                gap: "6px",
                fontSize: "12px",
              }}
            >
              {calendarBadges.map((b) => (
                <span
                  key={b.id}
                  style={{
                    whiteSpace: "nowrap",
                  }}
                >
                  {b.icon} â€¦ {b.minMinutes}åˆ†ï½
                </span>
              ))}

              <button
                type="button"
                aria-label="ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ãƒãƒƒã‚¸è¨­å®šã¸"
                onClick={() => {
                  window.location.href = ROUTE_CALENDAR_SETTINGS;
                }}
                style={settingsButtonStyle}
              >
                âš™ï¸
              </button>
            </div>
          </div>
        </div>
      </section>


      {/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æœ¬ä½“ */}
      <section
        style={{
          borderRadius: "12px",
          background: "#ffffff",
          boxShadow: "0 1px 3px rgba(0,0,0,0.08)",
          padding: "8px 8px 10px",
          marginBottom: "12px",
        }}
      >
        <div
          style={{
            display: "grid",
            gridTemplateColumns: "repeat(7, 1fr)",
            fontSize: "11px",
            textAlign: "center",
            marginBottom: "4px",
            color: "#666666",
          }}
        >
          <div>æ—¥</div>
          <div>æœˆ</div>
          <div>ç«</div>
          <div>æ°´</div>
          <div>æœ¨</div>
          <div>é‡‘</div>
          <div>åœŸ</div>
        </div>

        <div
          style={{
            display: "grid",
            gridTemplateColumns: "repeat(7, 1fr)",
            gap: "4px",
            fontSize: "11px",
          }}
        >
          {cells.map((c, idx) => {
            if (!c) {
              return <div key={idx} style={{ minHeight: "52px" }} />;
            }
            const dayKey = toDayKey(c);
            const minutes = dailyMinutes[dayKey] || 0;
            const badge = getBadgeFromSettings(minutes, calendarBadges);
            const isToday = dayKey === todayKey;
            const dayEvents = getEventsForDay(dayKey);
            const isBday = isBirthdayDay(c, birthday);

            return (
              <div
                key={idx}
                style={{
                  minHeight: "52px",
                  borderRadius: "10px",
                  border: `1px solid ${badge.border}`,
                  background: badge.bg,
                  padding: "4px 3px",
                  position: "relative",
                  boxSizing: "border-box",
                }}
              >
                <div
                  style={{
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                    marginBottom: "2px",
                  }}
                >
                  <div
                    style={{
                      fontWeight: isToday ? 700 : 500,
                      color: isToday ? "#d32f2f" : "#333333",
                      fontSize: "12px",
                    }}
                  >
                    {c.getDate()}
                  </div>
                  {isBday && (
                    <span
                      style={{
                        fontSize: "11px",
                        color: "#e91e63",
                      }}
                    >
                      ğŸ‚
                    </span>
                  )}
                </div>

                {badge.label && (
                  <div
                    style={{
                      fontSize: "16px",
                      textAlign: "center",
                      lineHeight: 1,
                      marginBottom: "2px",
                    }}
                  >
                    {badge.label}
                  </div>
                )}

                {minutes > 0 && (
                  <div
                    style={{
                      fontSize: "10px",
                      color: badge.text,
                      textAlign: "center",
                    }}
                  >
                    {minutes}åˆ†
                  </div>
                )}

                {dayEvents.length > 0 && (
                  <div
                    style={{
                      position: "absolute",
                      left: "3px",
                      bottom: "2px",
                      fontSize: "10px",
                    }}
                  >
                    {dayEvents.slice(0, 2).map((ev) => (
                      <span key={ev.id} style={{ marginRight: "2px" }}>
                        {ev.mark || "ğŸ“…"}
                      </span>
                    ))}
                    {dayEvents.length > 2 && (
                      <span style={{ fontSize: "9px" }}>
                        +{dayEvents.length - 2}
                      </span>
                    )}
                  </div>
                )}
              </div>
            );
          })}
        </div>
      </section>
    </main>
  );
}
