"use client";

import { useEffect, useState } from "react";
import { getLangFromStorage, t } from "../lib/i18n";

// â˜… A-1å¯¾å¿œç‰ˆï¼šæœ€åˆã‹ã‚‰idã‚’æŒã£ãŸã‚¿ã‚¹ã‚¯ã«ã—ã¦ãŠã
const DEFAULT_TASKS = [
  { id: "task_violin", label: "ãƒã‚¤ã‚ªãƒªãƒ³", icon: "ğŸ»" },
  { id: "task_piano", label: "ãƒ”ã‚¢ãƒ", icon: "ğŸ¹" },
  { id: "task_solfege", label: "ã‚½ãƒ«ãƒ•ã‚§ãƒ¼ã‚¸ãƒ¥", icon: "ğŸ“" },
  { id: "task_japanese", label: "å›½èª", icon: "ğŸ“–" },
  { id: "task_math", label: "ç®—æ•°", icon: "ğŸ”¢" },
  { id: "task_english", label: "è‹±èª", icon: "ğŸ‡¬ğŸ‡§" },
  { id: "task_science", label: "ç†ç§‘", icon: "ğŸ”¬" },
  { id: "task_social", label: "ç¤¾ä¼š", icon: "ğŸŒ" },
];

// æ—§ãƒ‡ãƒ¼ã‚¿ï¼ˆidãªã—ï¼‰ã‚’èª­ã‚“ã ã¨ãã«idã‚’ä»˜ã‘ã‚‹ãŸã‚ã®è£œåŠ©
function normalizeTasks(tasksLike) {
  if (!Array.isArray(tasksLike)) return [];

  return tasksLike.map((t, index) => {
    // ã™ã§ã«idãŒã‚ã‚Œã°ãã®ã¾ã¾
    if (t.id) return t;
    // ãªã‘ã‚Œã° label ã‹ã‚‰ãã‚Œã£ã½ã„idã‚’ä½œã‚‹
    const base =
      typeof t.label === "string" && t.label.length > 0
        ? t.label
        : `task_${index}`;
    const normalizedId =
      "task_" +
      base
        .toString()
        .trim()
        .replace(/\s+/g, "_")
        .replace(/[^\w_ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¥]/g, "") +
      "_" +
      index;
    return {
      id: normalizedId,
      label: t.label ?? `ã‚¿ã‚¹ã‚¯${index + 1}`,
      icon: t.icon ?? "ğŸµ",
    };
  });
}

export default function HomePage() {
  // è¨€èª
  const [lang, setLang] = useState("jp");

  // ä»Šæ—¥ã®é›†è¨ˆ
  const [todayMinutes, setTodayMinutes] = useState(0);
  const [todaySessions, setTodaySessions] = useState(0);

  // ãƒãƒƒã‚¸
  const [badge, setBadge] = useState("none");

  // ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè¨­å®šç”»é¢ã§ä¿å­˜ã—ãŸã‚„ã¤ï¼‰
  const [nextEventName, setNextEventName] = useState("");
  const [daysLeft, setDaysLeft] = useState(null);

  // èª•ç”Ÿæ—¥ï¼ˆä»Šæ—¥ãªã‚‰ãŠç¥ã„è¡¨ç¤ºï¼‰
  const [isBirthdayToday, setIsBirthdayToday] = useState(false);

  // ã‚¿ã‚¹ã‚¯ä¸€è¦§ï¼ˆè¦ªãŒè¨­å®šï¼‰â€»A-1ã§idä»˜ãã«ã™ã‚‹
  const [tasks, setTasks] = useState(DEFAULT_TASKS);

  useEffect(() => {
    // è¨€èª
    const currentLang = getLangFromStorage();
    setLang(currentLang);

    // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’localStorageã‹ã‚‰èª­ã¿è¾¼ã¿
    try {
      const rawTasks = window.localStorage.getItem("pocopoco_tasks");
      if (rawTasks) {
        const parsedTasks = JSON.parse(rawTasks);
        // ã“ã“ã§idãŒãªã‘ã‚Œã°ä»˜ã‘ã‚‹
        const normalized = normalizeTasks(parsedTasks);
        setTasks(normalized);
        // æ­£è¦åŒ–ã—ãŸã‚‚ã®ã‚’ä¿å­˜ã—ç›´ã—ã¦ãŠãã¨ä»–ç”»é¢ã‚‚æƒã†
        window.localStorage.setItem("pocopoco_tasks", JSON.stringify(normalized));
      } else {
        // åˆå›ãªã‚‰åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        window.localStorage.setItem(
          "pocopoco_tasks",
          JSON.stringify(DEFAULT_TASKS)
        );
        setTasks(DEFAULT_TASKS);
      }
    } catch (e) {
      console.error("tasks load error", e);
      setTasks(DEFAULT_TASKS);
    }

    // ä»Šæ—¥ã®ç·´ç¿’ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
    const raw = window.localStorage.getItem("pocopoco_history");
    if (raw) {
      try {
        const all = JSON.parse(raw); // [{task_id, task_title, seconds, ...}]
        const todayKey = makeDayKey(new Date());
        const todays = all.filter((s) => {
          if (!s.startedAt) return false;
          const d = new Date(s.startedAt);
          return makeDayKey(d) === todayKey;
        });

        const totalSeconds = todays.reduce(
          (acc, s) => acc + (s.seconds || 0),
          0
        );
        const mins = Math.floor(totalSeconds / 60);

        setTodayMinutes(mins);
        setTodaySessions(todays.length);

        if (mins >= 60) {
          setBadge("gold");
        } else if (mins >= 30) {
          setBadge("silver");
        } else if (mins >= 15) {
          setBadge("bronze");
        } else {
          setBadge("none");
        }
      } catch (e) {
        console.error("parse error home", e);
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±
    try {
      const rawEvent = window.localStorage.getItem("pocopoco_event");
      if (rawEvent) {
        const parsed = JSON.parse(rawEvent);
        if (parsed && typeof parsed === "object") {
          if (parsed.title) {
            setNextEventName(parsed.title);
          }
          if (parsed.date) {
            const left = calcDaysLeft(parsed.date);
            setDaysLeft(left);
          }
        }
      }
    } catch (e) {
      console.error("event load error", e);
    }

    // èª•ç”Ÿæ—¥
    try {
      const bdayStr = window.localStorage.getItem("pocopoco_birthday");
      if (bdayStr && checkBirthdayToday(bdayStr)) {
        setIsBirthdayToday(true);
      }
    } catch (e) {
      console.error("birthday load error", e);
    }
  }, []);

  // "YYYY/MM/DD"
  function makeDayKey(d) {
    return [
      d.getFullYear(),
      String(d.getMonth() + 1).padStart(2, "0"),
      String(d.getDate()).padStart(2, "0"),
    ].join("/");
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆã¾ã§ã®æ®‹ã‚Šæ—¥æ•°ï¼ˆåˆ‡ã‚Šä¸Šã’ï¼‰
  function calcDaysLeft(dateStr) {
    const today = new Date();
    const target = new Date(dateStr + "T00:00:00");
    const diffMs = target.getTime() - today.getTime();
    const diffDaysFloat = diffMs / (1000 * 60 * 60 * 24);
    return Math.ceil(diffDaysFloat);
  }

  // èª•ç”Ÿæ—¥ã® "æœˆæ—¥" ãŒä»Šæ—¥ã¨ä¸€è‡´ã™ã‚‹ã‹
  function checkBirthdayToday(bdayStr) {
    const [y, m, d] = bdayStr.split("-");
    if (!m || !d) return false;
    const mm = parseInt(m, 10);
    const dd = parseInt(d, 10);

    const now = new Date();
    return now.getMonth() + 1 === mm && now.getDate() === dd;
  }

  // â˜… A-1å¯¾å¿œç‰ˆï¼štaskIdã‚’æ¸¡ã™
  function goRecordByTask(task) {
    if (!task) return;
    // æ–°ï¼štaskId ã§æ¸¡ã™
    const base = `/record?taskId=${encodeURIComponent(task.id)}`;
    // æ—§ï¼štask= ã‚‚ä¸€å¿œã¤ã‘ã¦ãŠãã¨å®‰å…¨ï¼ˆå¤ã„recordã§ã‚‚èª­ã‚ã‚‹ï¼‰
    const legacy = `&task=${encodeURIComponent(task.label)}`;
    window.location.href = base + legacy;
  }

  function goHistory() {
    window.location.href = "/history";
  }
  function goCalendar() {
    window.location.href = "/calendar";
  }
  function goSettings() {
    window.location.href = "/settings";
  }

  function renderBadge() {
    if (badge === "none") return null;

    let textKey = "";
    let bg = "";
    let color = "#fff";

    if (badge === "bronze") {
      textKey = "badgeBronze";
      bg = "linear-gradient(135deg,#d6843a,#b86a2e)";
    } else if (badge === "silver") {
      textKey = "badgeSilver";
      bg = "linear-gradient(135deg,#cfd3d7,#9ea3a8)";
    } else if (badge === "gold") {
      textKey = "badgeGold";
      bg = "linear-gradient(135deg,#ffd95e,#e0a800)";
    }

    return (
      <div
        style={{
          display: "inline-block",
          padding: "4px 8px",
          borderRadius: "999px",
          fontSize: "12px",
          fontWeight: 600,
          color,
          background: bg,
          lineHeight: 1.2,
          boxShadow: "0 2px 4px rgba(0,0,0,0.2)",
          marginTop: "4px",
        }}
      >
        {t(textKey, lang)}
      </div>
    );
  }

  function renderEventCardBody() {
    const daysOk = daysLeft !== null && !isNaN(daysLeft);

    if (!nextEventName && !daysOk) {
      return (
        <>
          <div
            style={{
              fontSize: "13px",
              fontWeight: "500",
              color: "#6d4c00",
              lineHeight: 1.4,
              marginBottom: "8px",
            }}
          >
            {t("noEventYetTitle", lang)}
          </div>
          <div
            style={{
              fontSize: "12px",
              color: "#8b6b00",
              lineHeight: 1.4,
              whiteSpace: "pre-wrap",
            }}
          >
            {t("noEventYetHint", lang)}
          </div>
        </>
      );
    }

    if (nextEventName && !daysOk) {
      return (
        <>
          <div
            style={{
              fontSize: "15px",
              fontWeight: "600",
              color: "#6d4c00",
              lineHeight: 1.4,
              marginBottom: "8px",
              wordBreak: "break-word",
            }}
          >
            {nextEventName}
          </div>

          <div
            style={{
              fontSize: "12px",
              color: "#8b6b00",
              lineHeight: 1.4,
            }}
          >
            æ—¥ã«ã¡ãŒ ã›ã£ã¦ã„ã•ã‚Œã¦ã„ã¾ã›ã‚“
          </div>
        </>
      );
    }

    return (
      <>
        <div
          style={{
            fontSize: "15px",
            fontWeight: "600",
            color: "#6d4c00",
            lineHeight: 1.4,
            marginBottom: "8px",
            wordBreak: "break-word",
          }}
        >
          {nextEventName || "ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆåï¼‰"}
        </div>

        {daysLeft >= 0 ? (
          <div
            style={{
              fontSize: "13px",
              color: "#6d4c00",
              display: "flex",
              flexWrap: "wrap",
              gap: "6px",
              alignItems: "baseline",
            }}
          >
            <div
              style={{
                fontSize: "24px",
                fontWeight: "700",
              }}
            >
              {daysLeft}
            </div>
            <div style={{ fontSize: "14px" }}>
              {lang === "en" ? "" : t("daysLeftSuffix", lang).split(" ")[0]}
            </div>
            <div
              style={{
                fontSize: "12px",
                color: "#8b6b00",
              }}
            >
              {lang === "en"
                ? t("daysLeftSuffix", lang)
                : t("daysLeftSuffix", lang).split(" ").slice(1).join(" ")}
            </div>
          </div>
        ) : (
          <div
            style={{
              fontSize: "12px",
              color: "#8b6b00",
              lineHeight: 1.4,
            }}
          >
            ãŠã¤ã‹ã‚Œã•ã¾ï¼ã‚‚ã†æœ¬ç•ªã¯ãŠã‚ã£ãŸã‚ˆğŸ€
          </div>
        )}
      </>
    );
  }

  function renderBirthdayCard() {
    if (!isBirthdayToday) return null;

    return (
      <section
        style={{
          border: "2px solid #ffd1e8",
          background:
            "linear-gradient(135deg, rgba(255,240,250,0.95), rgba(255,225,240,0.9))",
          borderRadius: "14px",
          padding: "16px",
          marginBottom: "16px",
          boxShadow: "0 4px 8px rgba(0,0,0,0.08)",
          textAlign: "center",
        }}
      >
        <div
          style={{
            fontSize: "16px",
            fontWeight: "700",
            color: "#d81b60",
            marginBottom: "8px",
          }}
        >
          ğŸ‚ ãŠãŸã‚“ã˜ã‚‡ã†ã³ ãŠã‚ã§ã¨ã†ï¼
        </div>
        <div
          style={{
            fontSize: "13px",
            color: "#555",
            lineHeight: 1.4,
          }}
        >
          ãã‚‡ã†ã¯ ã¨ãã¹ã¤ãªæ—¥ï¼
        </div>
      </section>
    );
  }

  return (
    <main
      style={{
        fontFamily: "system-ui, sans-serif",
        padding: "24px 16px 80px",
        maxWidth: "480px",
        margin: "0 auto",
      }}
    >
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <header style={{ marginBottom: "16px" }}>
        <div
          style={{
            fontSize: "14px",
            color: "#666",
            marginBottom: "4px",
            wordBreak: "break-word",
          }}
        >
          {t("appTitleChildName", lang)}
        </div>
        <div style={{ fontSize: "13px", color: "#999" }}>
          {new Date().toLocaleDateString(
            lang === "en" ? "en-US" : "ja-JP",
            {
              month: "long",
              day: "numeric",
              weekday: "short",
            }
          )}
        </div>
      </header>

      {/* èª•ç”Ÿæ—¥ã‚«ãƒ¼ãƒ‰ */}
      {renderBirthdayCard()}

      {/* ä¸Šæ®µã‚«ãƒ¼ãƒ‰ï¼ˆä»Šæ—¥ã®ã‚Œã‚“ã—ã‚…ã†ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆï¼‰ */}
      <section
        style={{
          display: "grid",
          gridTemplateColumns: "1fr 1fr",
          gap: "16px",
          marginBottom: "24px",
        }}
      >
        {/* ä»Šæ—¥ã®ç·´ç¿’ã‚«ãƒ¼ãƒ‰ */}
        <div
          style={{
            borderRadius: "12px",
            border: "1px solid #e0ccff",
            background:
              "linear-gradient(135deg, rgba(255,240,255,0.9), rgba(245,230,255,0.8))",
            boxShadow: "0 2px 4px rgba(0,0,0,0.06)",
            padding: "16px",
          }}
        >
          <div
            style={{
              fontSize: "14px",
              fontWeight: "600",
              color: "#4a148c",
              marginBottom: "4px",
              display: "flex",
              alignItems: "center",
              gap: "6px",
              flexWrap: "wrap",
            }}
          >
            <span role="img" aria-label="clock">
              â°
            </span>
            <span>{t("todayLabel", lang)}</span>
          </div>

          <div
            style={{
              fontSize: "32px",
              fontWeight: "700",
              color: "#6a1b9a",
              lineHeight: 1.2,
            }}
          >
            {todayMinutes}
          </div>
          <div
            style={{
              fontSize: "14px",
              color: "#6a1b9a",
              marginBottom: "8px",
            }}
          >
            {t("minutesSuffix", lang)}
          </div>

          {renderBadge()}

          <div
            style={{
              fontSize: "12px",
              color: "#555",
              backgroundColor: "#fff",
              borderRadius: "8px",
              border: "1px solid #ddd",
              padding: "6px 8px",
              display: "inline-block",
              marginTop: "8px",
              lineHeight: 1.4,
            }}
          >
            {t("sessionsCount", lang)} {todaySessions}
            {t("limitPerDay", lang)}
          </div>
        </div>

        {/* ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ */}
        <div
          style={{
            borderRadius: "12px",
            border: "1px solid #ffe0a1",
            background:
              "linear-gradient(135deg, rgba(255,251,235,0.95), rgba(255,245,200,0.8))",
            boxShadow: "0 2px 4px rgba(0,0,0,0.06)",
            padding: "16px",
          }}
        >
          <div
            style={{
              fontSize: "14px",
              fontWeight: "600",
              color: "#a15a00",
              marginBottom: "4px",
              display: "flex",
              alignItems: "center",
              gap: "6px",
              flexWrap: "wrap",
            }}
          >
            <span role="img" aria-label="star">
              â­
            </span>
            <span>{t("nextEventCardTitle", lang)}</span>
          </div>

          {renderEventCardBody()}
        </div>
      </section>

      {/* ç·´ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆã‚¿ã‚¹ã‚¯ä¸€è¦§ï¼‰ */}
      <section style={{ marginBottom: "32px" }}>
        <h2
          style={{
            fontSize: "16px",
            fontWeight: "600",
            marginBottom: "12px",
            wordBreak: "break-word",
          }}
        >
          {t("practiceMenuTitle", lang)}
        </h2>

        <div
          style={{
            display: "grid",
            gridTemplateColumns: "repeat(auto-fit, minmax(120px, 1fr))",
            gap: "12px",
          }}
        >
          {tasks.map((tItem) => (
            <button
              key={tItem.id}
              onClick={() => goRecordByTask(tItem)}
              style={{
                borderRadius: "12px",
                border: "1px solid #ddd",
                backgroundColor: "#fff",
                boxShadow: "0 2px 4px rgba(0,0,0,0.05)",
                padding: "16px 12px",
                textAlign: "center",
              }}
            >
              <div
                style={{
                  fontSize: "28px",
                  lineHeight: 1.2,
                  marginBottom: "8px",
                }}
              >
                {tItem.icon || "ğŸµ"}
              </div>
              <div
                style={{
                  fontSize: "14px",
                  fontWeight: "600",
                  color: "#333",
                }}
              >
                {tItem.label || "ï¼ˆãªã¾ãˆï¼‰"}
              </div>
              <div
                style={{
                  fontSize: "12px",
                  color: "#666",
                  marginTop: "4px",
                  lineHeight: 1.3,
                  wordBreak: "break-word",
                }}
              >
                {t("tapToRecord", lang)}
              </div>
            </button>
          ))}
        </div>
      </section>

      {/* ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ */}
      <nav
        style={{
          display: "grid",
          gridTemplateColumns: "repeat(4, 1fr)",
          gap: "8px",
          borderTop: "1px solid #ddd",
          paddingTop: "16px",
          fontSize: "13px",
          color: "#444",
        }}
      >
        <button
          onClick={() => {
            window.location.href = "/";
          }}
          style={navBtnStyle}
        >
          <div style={{ fontSize: "18px" }}>ğŸ </div>
          <div>{t("navHome", lang)}</div>
        </button>

        <button onClick={goCalendar} style={navBtnStyle}>
          <div style={{ fontSize: "18px" }}>ğŸ“…</div>
          <div>{t("navCalendar", lang)}</div>
        </button>

        <button onClick={goHistory} style={navBtnStyle}>
          <div style={{ fontSize: "18px" }}>ğŸ“</div>
          <div>{t("navHistory", lang)}</div>
        </button>

        <button onClick={goSettings} style={navBtnStyle}>
          <div style={{ fontSize: "18px" }}>âš™ï¸</div>
          <div>{t("navSettings", lang)}</div>
        </button>
      </nav>
    </main>
  );
}

const navBtnStyle = {
  background: "none",
  border: "none",
  textAlign: "center",
  lineHeight: 1.4,
  wordBreak: "break-word",
};
