"use client";

import { useEffect, useState } from "react";
import { getLangFromStorage, t } from "../lib/i18n";

export default function HomePage() {
  // è¨€èª
  const [lang, setLang] = useState("jp");

  // ä»Šæ—¥ã®é›†è¨ˆ
  const [todayMinutes, setTodayMinutes] = useState(0);
  const [todaySessions, setTodaySessions] = useState(0);

  // ãƒãƒƒã‚¸ã®ç¨®é¡ï¼ˆ"none" | "bronze" | "silver" | "gold"ï¼‰
  const [badge, setBadge] = useState("none");

  // ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ï¼ˆè¨­å®šç”»é¢ã§ä¿å­˜ã—ãŸã‚„ã¤ï¼‰
  const [nextEventName, setNextEventName] = useState("");
  const [daysLeft, setDaysLeft] = useState(null);

  // ã‚¿ã‚¹ã‚¯ä¸€è¦§ï¼ˆã¨ã‚Šã‚ãˆãšå›ºå®šï¼‰
  const tasks = [
    { label: "ãƒã‚¤ã‚ªãƒªãƒ³", icon: "ğŸ»" },
    { label: "ãƒ”ã‚¢ãƒ", icon: "ğŸ¹" },
    { label: "ã‚½ãƒ«ãƒ•ã‚§ãƒ¼ã‚¸ãƒ¥", icon: "ğŸ“" },
  ];

  useEffect(() => {
    // è¨€èªã‚’èª­ã¿è¾¼ã‚€
    const currentLang = getLangFromStorage();
    setLang(currentLang);

    // ä»Šæ—¥ã®ç·´ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
    const raw = window.localStorage.getItem("pocopoco_history");
    if (raw) {
      try {
        const all = JSON.parse(raw); // [{task, seconds, count, memo, startedAt},...]

        const todayKey = makeDayKey(new Date());
        const todays = all.filter((s) => {
          const d = new Date(s.startedAt);
          return makeDayKey(d) === todayKey;
        });

        const totalSeconds = todays.reduce(
          (acc, s) => acc + (s.seconds || 0),
          0
        );
        const mins = Math.floor(totalSeconds / 60);

        setTodayMinutes(mins);
        setTodaySessions(todays.length);

        if (mins >= 60) {
          setBadge("gold");
        } else if (mins >= 30) {
          setBadge("silver");
        } else if (mins >= 15) {
          setBadge("bronze");
        } else {
          setBadge("none");
        }
      } catch (e) {
        console.error("parse error home", e);
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆåå‰ã¨æ—¥ä»˜ï¼‰ã‚’èª­ã¿è¾¼ã‚“ã§æ®‹ã‚Šæ—¥æ•°è¨ˆç®—
    try {
      const rawEvent = window.localStorage.getItem("pocopoco_eventInfo");
      if (rawEvent) {
        const parsed = JSON.parse(rawEvent);
        if (parsed.name) {
          setNextEventName(parsed.name);
        }
        if (parsed.date) {
          const left = calcDaysLeft(parsed.date);
          setDaysLeft(left);
        }
      }
    } catch (e) {
      console.error("event load error", e);
    }
  }, []);

  function makeDayKey(d) {
    return [
      d.getFullYear(),
      String(d.getMonth() + 1).padStart(2, "0"),
      String(d.getDate()).padStart(2, "0"),
    ].join("/");
  }

  function calcDaysLeft(dateStr) {
    const today = new Date();
    const target = new Date(dateStr + "T00:00:00");
    const diffMs = target.getTime() - today.getTime();
    const diffDaysFloat = diffMs / (1000 * 60 * 60 * 24);
    // ã€Œã‚ã¨â—¯æ—¥ï¼ã€ã£ã¦å‰æ—¥ã«ã¯è¨€ã„ãŸã„ã®ã§Ceilã§
    return Math.ceil(diffDaysFloat);
  }

  function goRecord(taskName) {
    window.location.href = `/record?task=${encodeURIComponent(taskName)}`;
  }
  function goHistory() {
    window.location.href = "/history";
  }
  function goCalendar() {
    window.location.href = "/calendar";
  }
  function goSettings() {
    window.location.href = "/settings";
  }

  function renderBadge() {
    if (badge === "none") return null;

    let textKey = "";
    let bg = "";
    let color = "#fff";

    if (badge === "bronze") {
      textKey = "badgeBronze";
      bg = "linear-gradient(135deg,#d6843a,#b86a2e)";
    } else if (badge === "silver") {
      textKey = "badgeSilver";
      bg = "linear-gradient(135deg,#cfd3d7,#9ea3a8)";
    } else if (badge === "gold") {
      textKey = "badgeGold";
      bg = "linear-gradient(135deg,#ffd95e,#e0a800)";
    }

    return (
      <div
        style={{
          display: "inline-block",
          padding: "4px 8px",
          borderRadius: "999px",
          fontSize: "12px",
          fontWeight: 600,
          color,
          background: bg,
          lineHeight: 1.2,
          boxShadow: "0 2px 4px rgba(0,0,0,0.2)",
          marginTop: "4px",
        }}
      >
        {t(textKey, lang)}
      </div>
    );
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ã®å†…å®¹
  function renderEventCardBody() {
    // ã‚¤ãƒ™ãƒ³ãƒˆåã‚‚æ—¥ä»˜ã‚‚ãªã„å ´åˆ
    if (!nextEventName && (daysLeft === null || isNaN(daysLeft))) {
      return (
        <>
          <div
            style={{
              fontSize: "13px",
              fontWeight: "500",
              color: "#6d4c00",
              lineHeight: 1.4,
              marginBottom: "8px",
            }}
          >
            {t("noEventYetTitle", lang)}
          </div>
          <div
            style={{
              fontSize: "12px",
              color: "#8b6b00",
              lineHeight: 1.4,
              whiteSpace: "pre-wrap",
            }}
          >
            {t("noEventYetHint", lang)}
          </div>
        </>
      );
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šãŒã‚ã‚‹ã¨ã
    return (
      <>
        <div
          style={{
            fontSize: "15px",
            fontWeight: "600",
            color: "#6d4c00",
            lineHeight: 1.4,
            marginBottom: "8px",
            wordBreak: "break-word",
          }}
        >
          {nextEventName || "ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆåï¼‰"}
        </div>

        {daysLeft !== null && !isNaN(daysLeft) ? (
          <div
            style={{
              fontSize: "13px",
              color: "#6d4c00",
              display: "flex",
              flexWrap: "wrap",
              gap: "6px",
              alignItems: "baseline",
            }}
          >
            <div
              style={{
                fontSize: "24px",
                fontWeight: "700",
              }}
            >
              {daysLeft}
            </div>
            <div style={{ fontSize: "14px" }}>
              {lang === "en" ? "" : t("daysLeftSuffix", lang).split(" ")[0]}
            </div>
            <div
              style={{
                fontSize: "12px",
                color: "#8b6b00",
              }}
            >
              {lang === "en"
                ? t("daysLeftSuffix", lang)
                : t("daysLeftSuffix", lang).split(" ").slice(1).join(" ")}
            </div>
          </div>
        ) : (
          <div
            style={{
              fontSize: "12px",
              color: "#8b6b00",
              lineHeight: 1.4,
            }}
          >
            æ—¥ã«ã¡ãŒ ã›ã£ã¦ã„ã•ã‚Œã¦ã„ã¾ã›ã‚“
          </div>
        )}
      </>
    );
  }

  return (
    <main
      style={{
        fontFamily: "system-ui, sans-serif",
        padding: "24px 16px 80px",
        maxWidth: "480px",
        margin: "0 auto",
      }}
    >
      {/* ã‚¿ã‚¤ãƒˆãƒ«ã‚¨ãƒªã‚¢ */}
      <header style={{ marginBottom: "16px" }}>
        <div
          style={{
            fontSize: "14px",
            color: "#666",
            marginBottom: "4px",
            wordBreak: "break-word",
          }}
        >
          {t("appTitleChildName", lang)}
        </div>
        <div style={{ fontSize: "13px", color: "#999" }}>
          {new Date().toLocaleDateString(
            lang === "en" ? "en-US" : "ja-JP",
            {
              month: "long",
              day: "numeric",
              weekday: "short",
            }
          )}
        </div>
      </header>

      {/* ä¸Šæ®µã‚«ãƒ¼ãƒ‰ï¼šãã‚‡ã†ã®ã‚Œã‚“ã—ã‚…ã† + ã‚¤ãƒ™ãƒ³ãƒˆ */}
      <section
        style={{
          display: "grid",
          gridTemplateColumns: "1fr 1fr",
          gap: "16px",
          marginBottom: "24px",
        }}
      >
        {/* ä»Šæ—¥ã®ç·´ç¿’ã‚«ãƒ¼ãƒ‰ */}
        <div
          style={{
            borderRadius: "12px",
            border: "1px solid #e0ccff",
            background:
              "linear-gradient(135deg, rgba(255,240,255,0.9), rgba(245,230,255,0.8))",
            boxShadow: "0 2px 4px rgba(0,0,0,0.06)",
            padding: "16px",
          }}
        >
          <div
            style={{
              fontSize: "14px",
              fontWeight: "600",
              color: "#4a148c",
              marginBottom: "4px",
              display: "flex",
              alignItems: "center",
              gap: "6px",
              flexWrap: "wrap",
            }}
          >
            <span role="img" aria-label="clock">
              â°
            </span>
            <span>{t("todayLabel", lang)}</span>
          </div>

          <div
            style={{
              fontSize: "32px",
              fontWeight: "700",
              color: "#6a1b9a",
              lineHeight: 1.2,
            }}
          >
            {todayMinutes}
          </div>
          <div
            style={{
              fontSize: "14px",
              color: "#6a1b9a",
              marginBottom: "8px",
            }}
          >
            {t("minutesSuffix", lang)}
          </div>

          {renderBadge()}

          <div
            style={{
              fontSize: "12px",
              color: "#555",
              backgroundColor: "#fff",
              borderRadius: "8px",
              border: "1px solid #ddd",
              padding: "6px 8px",
              display: "inline-block",
              marginTop: "8px",
              lineHeight: 1.4,
            }}
          >
            {t("sessionsCount", lang)} {todaySessions}
            {t("limitPerDay", lang)}
          </div>
        </div>

        {/* ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ */}
        <div
          style={{
            borderRadius: "12px",
            border: "1px solid #ffe0a1",
            background:
              "linear-gradient(135deg, rgba(255,251,235,0.95), rgba(255,245,200,0.8))",
            boxShadow: "0 2px 4px rgba(0,0,0,0.06)",
            padding: "16px",
          }}
        >
          <div
            style={{
              fontSize: "14px",
              fontWeight: "600",
              color: "#a15a00",
              marginBottom: "4px",
              display: "flex",
              alignItems: "center",
              gap: "6px",
              flexWrap: "wrap",
            }}
          >
            <span role="img" aria-label="star">
              â­
            </span>
            <span>{t("nextEventCardTitle", lang)}</span>
          </div>

          {renderEventCardBody()}
        </div>
      </section>

      {/* ç·´ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */}
      <section style={{ marginBottom: "32px" }}>
        <h2
          style={{
            fontSize: "16px",
            fontWeight: "600",
            marginBottom: "12px",
            wordBreak: "break-word",
          }}
        >
          {t("practiceMenuTitle", lang)}
        </h2>

        <div
          style={{
            display: "grid",
            gridTemplateColumns:
              "repeat(auto-fit, minmax(120px, 1fr))",
            gap: "12px",
          }}
        >
          {tasks.map((tItem) => (
            <button
              key={tItem.label}
              onClick={() => goRecord(tItem.label)}
              style={{
                borderRadius: "12px",
                border: "1px solid #ddd",
                backgroundColor: "#fff",
                boxShadow: "0 2px 4px rgba(0,0,0,0.05)",
                padding: "16px 12px",
                textAlign: "center",
              }}
            >
              <div
                style={{
                  fontSize: "28px",
                  lineHeight: 1.2,
                  marginBottom: "8px",
                }}
              >
                {tItem.icon}
              </div>
              <div
                style={{
                  fontSize: "14px",
                  fontWeight: "600",
                  color: "#333",
                }}
              >
                {tItem.label}
              </div>
              <div
                style={{
                  fontSize: "12px",
                  color: "#666",
                  marginTop: "4px",
                  lineHeight: 1.3,
                  wordBreak: "break-word",
                }}
              >
                {t("tapToRecord", lang)}
              </div>
            </button>
          ))}
        </div>
      </section>

      {/* ã‹ã‚“ãŸã‚“ãƒŠãƒ“ */}
      <nav
        style={{
          display: "grid",
          gridTemplateColumns: "repeat(4, 1fr)",
          gap: "8px",
          borderTop: "1px solid #ddd",
          paddingTop: "16px",
          fontSize: "13px",
          color: "#444",
        }}
      >
        <button
          onClick={() => {
            window.location.href = "/";
          }}
          style={{
            background: "none",
            border: "none",
            textAlign: "center",
            lineHeight: 1.4,
            wordBreak: "break-word",
          }}
        >
          <div style={{ fontSize: "18px" }}>ğŸ </div>
          <div>{t("navHome", lang)}</div>
        </button>

        <button
          onClick={goCalendar}
          style={{
            background: "none",
            border: "none",
            textAlign: "center",
            lineHeight: 1.4,
            wordBreak: "break-word",
          }}
        >
          <div style={{ fontSize: "18px" }}>ğŸ“…</div>
          <div>{t("navCalendar", lang)}</div>
        </button>

        <button
          onClick={goHistory}
          style={{
            background: "none",
            border: "none",
            textAlign: "center",
            lineHeight: 1.4,
            wordBreak: "break-word",
          }}
        >
          <div style={{ fontSize: "18px" }}>ğŸ“</div>
          <div>{t("navHistory", lang)}</div>
        </button>

        <button
          onClick={goSettings}
          style={{
            background: "none",
            border: "none",
            textAlign: "center",
            lineHeight: 1.4,
            wordBreak: "break-word",
          }}
        >
          <div style={{ fontSize: "18px" }}>âš™ï¸</div>
          <div>{t("navSettings", lang)}</div>
        </button>
      </nav>
    </main>
  );
}
