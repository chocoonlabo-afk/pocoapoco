"use client";

import { useEffect, useState } from "react";
import { getLangFromStorage, t } from "../lib/i18n";

// â˜… A-1æ™‚ç‚¹ã¨åŒã˜åˆæœŸã‚¿ã‚¹ã‚¯
const DEFAULT_TASKS = [
  { id: "task_violin", label: "ãƒã‚¤ã‚ªãƒªãƒ³", icon: "ğŸ»" },
  { id: "task_piano", label: "ãƒ”ã‚¢ãƒ", icon: "ğŸ¹" },
  { id: "task_solfege", label: "ã‚½ãƒ«ãƒ•ã‚§ãƒ¼ã‚¸ãƒ¥", icon: "ğŸ“" },
  { id: "task_japanese", label: "å›½èª", icon: "ğŸ“–" },
  { id: "task_math", label: "ç®—æ•°", icon: "ğŸ”¢" },
  { id: "task_english", label: "è‹±èª", icon: "ğŸ‡¬ğŸ‡§" },
  { id: "task_science", label: "ç†ç§‘", icon: "ğŸ”¬" },
  { id: "task_social", label: "ç¤¾ä¼š", icon: "ğŸŒ" },
];

// æ—§ãƒ‡ãƒ¼ã‚¿ï¼ˆidãªã—ï¼‰ã®ã¨ãã«idã‚’ã¤ã‘ã‚‹
function normalizeTasks(tasksLike) {
  if (!Array.isArray(tasksLike)) return [];
  return tasksLike.map((t, index) => {
    if (t.id) return t;
    const base =
      typeof t.label === "string" && t.label.length > 0
        ? t.label
        : `task_${index}`;
    const normalizedId =
      "task_" +
      base
        .toString()
        .trim()
        .replace(/\s+/g, "_")
        .replace(/[^\w_ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¥]/g, "") +
      "_" +
      index;
    return {
      id: normalizedId,
      label: t.label ?? `ã‚¿ã‚¹ã‚¯${index + 1}`,
      icon: t.icon ?? "ğŸµ",
    };
  });
}

// æ—¥ä»˜ã‚­ãƒ¼ "YYYY/MM/DD"
function makeDayKey(d) {
  return [
    d.getFullYear(),
    String(d.getMonth() + 1).padStart(2, "0"),
    String(d.getDate()).padStart(2, "0"),
  ].join("/");
}

// ã‚¤ãƒ™ãƒ³ãƒˆã¾ã§ã®æ®‹ã‚Šæ—¥æ•°
function calcDaysLeft(dateStr) {
  const today = new Date();
  const target = new Date(dateStr + "T00:00:00");
  const diffMs = target.getTime() - today.getTime();
  const diffDaysFloat = diffMs / (1000 * 60 * 60 * 24);
  return Math.ceil(diffDaysFloat);
}

// èª•ç”Ÿæ—¥ãŒä»Šæ—¥ã‹ã©ã†ã‹
function checkBirthdayToday(bdayStr) {
  const [y, m, d] = bdayStr.split("-");
  if (!m || !d) return false;
  const mm = parseInt(m, 10);
  const dd = parseInt(d, 10);
  const now = new Date();
  return now.getMonth() + 1 === mm && now.getDate() === dd;
}

export default function HomePage() {
  const [lang, setLang] = useState("jp");

  // ä»Šæ—¥ã®é›†è¨ˆï¼ˆé¸æŠä¸­ã®å­ã©ã‚‚ã§ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿ï¼‰
  const [todayMinutes, setTodayMinutes] = useState(0);
  const [todaySessions, setTodaySessions] = useState(0);
  const [badge, setBadge] = useState("none");

  // ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆ1ä»¶ã ã‘ã®ã€ãƒ›ãƒ¼ãƒ ç”¨ï¼‰
  const [nextEventName, setNextEventName] = useState("");
  const [daysLeft, setDaysLeft] = useState(null);

  // èª•ç”Ÿæ—¥
  const [isBirthdayToday, setIsBirthdayToday] = useState(false);

  // ã‚¿ã‚¹ã‚¯ä¸€è¦§
  const [tasks, setTasks] = useState(DEFAULT_TASKS);

  // å­ã©ã‚‚ä¸€è¦§ã¨ç¾åœ¨é¸æŠã—ã¦ã„ã‚‹å­ã©ã‚‚
  const [children, setChildren] = useState([]);
  const [currentChildId, setCurrentChildId] = useState("");

  useEffect(() => {
    // è¨€èª
    const currentLang = getLangFromStorage();
    setLang(currentLang);

    // å­ã©ã‚‚ä¸€è¦§
    try {
      const rawChildren = localStorage.getItem("pocopoco_children");
      if (rawChildren) {
        const arr = JSON.parse(rawChildren);
        if (Array.isArray(arr)) {
          setChildren(arr);
        }
      }
      const savedCurrent = localStorage.getItem("pocopoco_current_child_id");
      if (savedCurrent) {
        setCurrentChildId(savedCurrent);
      }
    } catch (e) {
      console.warn("children load error", e);
    }

    // ã‚¿ã‚¹ã‚¯ä¸€è¦§
    try {
      const rawTasks = window.localStorage.getItem("pocopoco_tasks");
      if (rawTasks) {
        const parsedTasks = JSON.parse(rawTasks);
        const normalized = normalizeTasks(parsedTasks);
        setTasks(normalized);
        window.localStorage.setItem("pocopoco_tasks", JSON.stringify(normalized));
      } else {
        window.localStorage.setItem("pocopoco_tasks", JSON.stringify(DEFAULT_TASKS));
        setTasks(DEFAULT_TASKS);
      }
    } catch (e) {
      console.error("tasks load error", e);
      setTasks(DEFAULT_TASKS);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ï¼ˆãƒ›ãƒ¼ãƒ ç”¨1ä»¶ï¼‰
    try {
      const rawEvent = window.localStorage.getItem("pocopoco_event");
      if (rawEvent) {
        const parsed = JSON.parse(rawEvent);
        if (parsed && typeof parsed === "object") {
          if (parsed.title) setNextEventName(parsed.title);
          if (parsed.date) setDaysLeft(calcDaysLeft(parsed.date));
        }
      }
    } catch (e) {
      console.error("event load error", e);
    }

    // èª•ç”Ÿæ—¥
    try {
      const bdayStr = window.localStorage.getItem("pocopoco_birthday");
      if (bdayStr && checkBirthdayToday(bdayStr)) {
        setIsBirthdayToday(true);
      }
    } catch (e) {
      console.error("birthday load error", e);
    }
  }, []);

  // å­ã©ã‚‚èª­ã¿è¾¼ã¿å¾Œã«ä»Šæ—¥ã®é›†è¨ˆã‚’ã™ã‚‹
  useEffect(() => {
    try {
      const raw = window.localStorage.getItem("pocopoco_history");
      if (!raw) return;

      const all = JSON.parse(raw);
      const todayKey = makeDayKey(new Date());
      const filtered = all.filter((s) => {
        if (!s.startedAt) return false;
        const d = new Date(s.startedAt);
        const isToday = makeDayKey(d) === todayKey;

        if (currentChildId && s.child_id && currentChildId !== s.child_id) {
          return false;
        }
        return isToday;
      });

      const totalSeconds = filtered.reduce((acc, s) => acc + (s.seconds || 0), 0);
      const mins = Math.floor(totalSeconds / 60);

      setTodayMinutes(mins);
      setTodaySessions(filtered.length);

      if (mins >= 60) setBadge("gold");
      else if (mins >= 30) setBadge("silver");
      else if (mins >= 15) setBadge("bronze");
      else setBadge("none");
    } catch (e) {
      console.error("home today calc error", e);
    }
  }, [currentChildId]);

  function getCurrentChildName() {
    if (!currentChildId) return "";
    const found = children.find((c) => c.id === currentChildId);
    return found ? found.name : "";
  }

  function switchChild(childId) {
    setCurrentChildId(childId);
    if (childId) {
      localStorage.setItem("pocopoco_current_child_id", childId);
    } else {
      localStorage.removeItem("pocopoco_current_child_id");
    }
  }

  function goRecordByTask(task) {
    if (!task) return;
    const params = new URLSearchParams();
    params.set("taskId", task.id);
    params.set("task", task.label);
    if (currentChildId) {
      params.set("childId", currentChildId);
    }
    window.location.href = `/record?${params.toString()}`;
  }

  function renderBadge() {
    if (badge === "none") return null;
    let textKey = "";
    let bg = "";
    let color = "#fff";

    if (badge === "bronze") {
      textKey = "badgeBronze";
      bg = "linear-gradient(135deg,#d6843a,#b86a2e)";
    } else if (badge === "silver") {
      textKey = "badgeSilver";
      bg = "linear-gradient(135deg,#cfd3d7,#9ea3a8)";
    } else if (badge === "gold") {
      textKey = "badgeGold";
      bg = "linear-gradient(135deg,#ffd95e,#e0a800)";
    }

    return (
      <div
        style={{
          display: "inline-block",
          padding: "4px 8px",
          borderRadius: "999px",
          fontSize: "12px",
          fontWeight: 600,
          color,
          background: bg,
          lineHeight: 1.2,
          boxShadow: "0 2px 4px rgba(0,0,0,0.2)",
          marginTop: "4px",
        }}
      >
        {t(textKey, lang)}
      </div>
    );
  }

  function renderEventCardBody() {
    const daysOk = daysLeft !== null && !isNaN(daysLeft);

    if (!nextEventName && !daysOk) {
      return (
        <>
          <div
            style={{
              fontSize: "13px",
              fontWeight: "500",
              color: "#6d4c00",
              lineHeight: 1.4,
              marginBottom: "8px",
            }}
          >
            {t("noEventYetTitle", lang)}
          </div>
          <div
            style={{
              fontSize: "12px",
              color: "#8b6b00",
              lineHeight: 1.4,
              whiteSpace: "pre-wrap",
            }}
          >
            {t("noEventYetHint", lang)}
          </div>
        </>
      );
    }

    if (nextEventName && !daysOk) {
      return (
        <>
          <div
            style={{
              fontSize: "15px",
              fontWeight: "600",
              color: "#6d4c00",
              lineHeight: 1.4,
              marginBottom: "8px",
              wordBreak: "break-word",
            }}
          >
            {nextEventName}
          </div>
          <div style={{ fontSize: "12px", color: "#8b6b00" }}>
            æ—¥ã«ã¡ãŒ ã›ã£ã¦ã„ã•ã‚Œã¦ã„ã¾ã›ã‚“
          </div>
        </>
      );
    }

    return (
      <>
        <div
          style={{
            fontSize: "15px",
            fontWeight: "600",
            color: "#6d4c00",
            lineHeight: 1.4,
            marginBottom: "8px",
            wordBreak: "break-word",
          }}
        >
          {nextEventName || "ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆåï¼‰"}
        </div>

        {daysLeft >= 0 ? (
          <div
            style={{
              fontSize: "13px",
              color: "#6d4c00",
              display: "flex",
              flexWrap: "wrap",
              gap: "6px",
              alignItems: "baseline",
            }}
          >
            <div style={{ fontSize: "24px", fontWeight: "700" }}>{daysLeft}</div>
            <div style={{ fontSize: "14px" }}>
              {lang === "en" ? "" : t("daysLeftSuffix", lang).split(" ")[0]}
            </div>
            <div style={{ fontSize: "12px", color: "#8b6b00" }}>
              {lang === "en"
                ? t("daysLeftSuffix", lang)
                : t("daysLeftSuffix", lang).split(" ").slice(1).join(" ")}
            </div>
          </div>
        ) : (
          <div style={{ fontSize: "12px", color: "#8b6b00" }}>
            ãŠã¤ã‹ã‚Œã•ã¾ï¼ã‚‚ã†æœ¬ç•ªã¯ãŠã‚ã£ãŸã‚ˆğŸ€
          </div>
        )}
      </>
    );
  }

  function renderBirthdayCard() {
    if (!isBirthdayToday) return null;
    return (
      <section
        style={{
          border: "2px solid #ffd1e8",
          background:
            "linear-gradient(135deg, rgba(255,240,250,0.95), rgba(255,225,240,0.9))",
          borderRadius: "14px",
          padding: "16px",
          marginBottom: "16px",
          boxShadow: "0 4px 8px rgba(0,0,0,0.08)",
          textAlign: "center",
        }}
      >
        <div
          style={{
            fontSize: "16px",
            fontWeight: "700",
            color: "#d81b60",
            marginBottom: "8px",
          }}
        >
          ğŸ‚ ãŠãŸã‚“ã˜ã‚‡ã†ã³ ãŠã‚ã§ã¨ã†ï¼
        </div>
        <div style={{ fontSize: "13px", color: "#555", lineHeight: 1.4 }}>
          ãã‚‡ã†ã¯ ã¨ãã¹ã¤ãªæ—¥ï¼
        </div>
      </section>
    );
  }

  return (
    <main
      style={{
        fontFamily: "system-ui, sans-serif",
        padding: "16px 16px 80px",
        maxWidth: "480px",
        margin: "0 auto",
      }}
    >
      {/* æ—¥ä»˜ã ã‘æ®‹ã™ï¼ˆã€ŒãŸã‚ã†ã®ã€œã€ã¯å‰Šé™¤ï¼‰ */}
      <header style={{ marginBottom: "10px" }}>
        <div style={{ fontSize: "13px", color: "#999" }}>
          {new Date().toLocaleDateString(lang === "en" ? "en-US" : "ja-JP", {
            month: "long",
            day: "numeric",
            weekday: "short",
          })}
        </div>
      </header>

      {/* å­ã©ã‚‚åˆ‡æ›¿ */}
      <section
        style={{
          background: "#f5ecff",
          border: "1px solid #e0ccff",
          borderRadius: "10px",
          padding: "10px 12px",
          marginBottom: "14px",
        }}
      >
        <div style={{ fontSize: "12px", color: "#666", marginBottom: "4px" }}>
          ã„ã¾è¡¨ç¤ºã—ã¦ã„ã‚‹ ã“ã©ã‚‚
        </div>
        <div style={{ fontSize: "15px", fontWeight: 600, marginBottom: "6px" }}>
          {getCurrentChildName() || "ï¼ˆã¾ã ãˆã‚‰ã°ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰"}
        </div>
        {children.length > 1 && (
          <div style={{ display: "flex", gap: "6px", flexWrap: "wrap" }}>
            <button
              onClick={() => switchChild("")}
              style={{
                border: currentChildId === "" ? "1px solid #6a1b9a" : "1px solid #ccc",
                backgroundColor: "#fff",
                borderRadius: "999px",
                padding: "3px 10px",
                fontSize: "12px",
              }}
            >
              ã™ã¹ã¦
            </button>
            {children.map((c) => (
              <button
                key={c.id}
                onClick={() => switchChild(c.id)}
                style={{
                  border:
                    currentChildId === c.id ? "1px solid #6a1b9a" : "1px solid #ccc",
                  backgroundColor: "#fff",
                  borderRadius: "999px",
                  padding: "3px 10px",
                  fontSize: "12px",
                }}
              >
                {c.name}
              </button>
            ))}
          </div>
        )}
      </section>

      {/* èª•ç”Ÿæ—¥ã‚«ãƒ¼ãƒ‰ */}
      {renderBirthdayCard()}

      {/* ä¸Šæ®µã‚«ãƒ¼ãƒ‰ï¼šä»Šæ—¥ã®ç·´ç¿’ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ */}
      <section
        style={{
          display: "grid",
          gridTemplateColumns: "1fr 1fr",
          gap: "16px",
          marginBottom: "24px",
        }}
      >
        {/* ä»Šæ—¥ã®ç·´ç¿’ */}
        <div
          style={{
            borderRadius: "12px",
            border: "1px solid #e0ccff",
            background:
              "linear-gradient(135deg, rgba(255,240,255,0.9), rgba(245,230,255,0.8))",
            boxShadow: "0 2px 4px rgba(0,0,0,0.06)",
            padding: "16px",
          }}
        >
          <div
            style={{
              fontSize: "14px",
              fontWeight: "600",
              color: "#4a148c",
              marginBottom: "4px",
              display: "flex",
              alignItems: "center",
              gap: "6px",
            }}
          >
            <span>â°</span>
            <span>{t("todayLabel", lang)}</span>
          </div>
          <div
            style={{
              fontSize: "32px",
              fontWeight: "700",
              color: "#6a1b9a",
              lineHeight: 1.2,
            }}
          >
            {todayMinutes}
          </div>
          <div style={{ fontSize: "14px", color: "#6a1b9a", marginBottom: "8px" }}>
            {t("minutesSuffix", lang)}
          </div>
            {renderBadge()}
          <div
            style={{
              fontSize: "12px",
              color: "#555",
              backgroundColor: "#fff",
              borderRadius: "8px",
              border: "1px solid #ddd",
              padding: "6px 8px",
              display: "inline-block",
              marginTop: "8px",
            }}
          >
            {t("sessionsCount", lang)} {todaySessions}
            {t("limitPerDay", lang)}
          </div>
        </div>

        {/* ã‚¤ãƒ™ãƒ³ãƒˆ */}
        <div
          style={{
            borderRadius: "12px",
            border: "1px solid #ffe0a1",
            background:
              "linear-gradient(135deg, rgba(255,251,235,0.95), rgba(255,245,200,0.8))",
            boxShadow: "0 2px 4px rgba(0,0,0,0.06)",
            padding: "16px",
          }}
        >
          <div
            style={{
              fontSize: "14px",
              fontWeight: "600",
              color: "#a15a00",
              marginBottom: "4px",
              display: "flex",
              alignItems: "center",
              gap: "6px",
            }}
          >
            <span>â­</span>
            <span>{t("nextEventCardTitle", lang)}</span>
          </div>
          {renderEventCardBody()}
        </div>
      </section>

      {/* ã‚¿ã‚¹ã‚¯ä¸€è¦§ */}
      <section style={{ marginBottom: "32px" }}>
        <h2 style={{ fontSize: "16px", fontWeight: "600", marginBottom: "12px" }}>
          {t("practiceMenuTitle", lang)}
        </h2>
        <div
          style={{
            display: "grid",
            gridTemplateColumns: "repeat(auto-fit, minmax(120px, 1fr))",
            gap: "12px",
          }}
        >
          {tasks.map((task) => (
            <button
              key={task.id}
              onClick={() => goRecordByTask(task)}
              style={{
                borderRadius: "12px",
                border: "1px solid #ddd",
                backgroundColor: "#fff",
                boxShadow: "0 2px 4px rgba(0,0,0,0.05)",
                padding: "16px 12px",
                textAlign: "center",
              }}
            >
              <div style={{ fontSize: "28px", marginBottom: "8px" }}>
                {task.icon || "ğŸµ"}
              </div>
              <div style={{ fontSize: "14px", fontWeight: "600", color: "#333" }}>
                {task.label || "ï¼ˆãªã¾ãˆï¼‰"}
              </div>
              <div style={{ fontSize: "12px", color: "#666", marginTop: "4px" }}>
                {t("tapToRecord", lang)}
              </div>
            </button>
          ))}
        </div>
      </section>

      {/* â† ä¸‹ã®ã‚¿ãƒ–ã¯ layout.js å´ã«ä»»ã›ã‚‹ã®ã§ã“ã“ã§ã¯æç”»ã—ãªã„ */}
    </main>
  );
}
