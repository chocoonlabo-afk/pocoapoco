// src/app/page.js
"use client";

import { useEffect, useState } from "react";
import { t, getLangFromStorage } from "./lib/i18n";

const DEFAULT_TASKS = [
  { id: "task_violin", label: "ãƒã‚¤ã‚ªãƒªãƒ³", icon: "ğŸ»" },
  { id: "task_piano", label: "ãƒ”ã‚¢ãƒ", icon: "ğŸ¹" },
  { id: "task_solfege", label: "ã‚½ãƒ«ãƒ•ã‚§ãƒ¼ã‚¸ãƒ¥", icon: "ğŸ“" },
  { id: "task_japanese", label: "å›½èª", icon: "ğŸ“–" },
  { id: "task_math", label: "ç®—æ•°", icon: "ğŸ”¢" },
  { id: "task_english", label: "è‹±èª", icon: "GB" },
];

const WEEKLY_STORAGE_KEY = "pocoapoco_timetable_by_child";
const PERIOD_COUNT = 15;
const DAY_KEYS = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ãƒãƒƒã‚¸ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
const DEFAULT_BADGES = [
  { id: "level1", name: "å°‘ã—ã§ã‚‚ç·´ç¿’ã—ãŸæ—¥", minMinutes: 1, icon: "ğŸŒ¸" },
  { id: "level2", name: "ãŸãã•ã‚“ç·´ç¿’ï¼ˆéŠ…ï¼‰", minMinutes: 30, icon: "ğŸ¥‰" },
  { id: "level3", name: "ã‚‚ã£ã¨ãŸãã•ã‚“ï¼ˆéŠ€ï¼‰", minMinutes: 60, icon: "ğŸ¥ˆ" },
  { id: "level4", name: "ã™ã”ããŒã‚“ã°ã£ãŸï¼ˆé‡‘ï¼‰", minMinutes: 90, icon: "ğŸ¥‡" },
];

function loadCalendarSettingsFromStorage() {
  let firstDayOfWeek = "sun";
  let badges = DEFAULT_BADGES;

  try {
    const raw = localStorage.getItem("pocoapoco_calendar_settings");
    if (raw) {
      const data = JSON.parse(raw);
      if (data && typeof data === "object") {
        if (data.firstDayOfWeek === "mon") firstDayOfWeek = "mon";

        if (Array.isArray(data.badges) && data.badges.length > 0) {
          badges = DEFAULT_BADGES.map((def) => {
            const found = data.badges.find((b) => b.id === def.id);
            return found ? { ...def, ...found } : def;
          });
        }
      }
    }
  } catch (e) {
    console.warn("calendar settings parse error", e);
  }
  return { firstDayOfWeek, badges };
}

function pickBadgeIcon(totalMinutes, badges) {
  if (totalMinutes <= 0) return "";
  const sorted = [...badges].sort((a, b) => a.minMinutes - b.minMinutes);
  let chosen = null;
  for (const b of sorted) {
    if (totalMinutes >= b.minMinutes) {
      chosen = b;
    }
  }
  return chosen ? chosen.icon : "";
}

export default function HomePage() {
  const [lang, setLang] = useState("jp");
  const [children, setChildren] = useState([]);
  const [currentChildId, setCurrentChildId] = useState("");
  const [tasks, setTasks] = useState(DEFAULT_TASKS);
  const [eventData, setEventData] = useState(null);

  const [todayTotalSec, setTodayTotalSec] = useState(0);
  const [todayTotalCount, setTodayTotalCount] = useState(0);
  const [todayTaskSeconds, setTodayTaskSeconds] = useState({});
  const [totalTaskSeconds, setTotalTaskSeconds] = useState({});
  const [dailySeconds, setDailySeconds] = useState({}); // æ—¥ä»˜ã”ã¨ã®åˆè¨ˆç§’æ•°

  const [todaySlots, setTodaySlots] = useState(Array(PERIOD_COUNT).fill(""));

  const todayDate = new Date();
  const [calendarYear] = useState(todayDate.getFullYear());
  const [calendarMonth] = useState(todayDate.getMonth() + 1);

  const [calendarSettings, setCalendarSettings] = useState({
    firstDayOfWeek: "sun",
    badges: DEFAULT_BADGES,
  });

  // åˆæœŸèª­ã¿è¾¼ã¿
  useEffect(() => {
    const savedLang = getLangFromStorage();
    setLang(savedLang);

    // å­ã©ã‚‚ä¸€è¦§
    const rawChildren = localStorage.getItem("pocopoco_children");
    let loadedChildren = [];
    if (rawChildren) {
      try {
        const arr = JSON.parse(rawChildren);
        if (Array.isArray(arr)) {
          loadedChildren = arr;
          setChildren(arr);
        }
      } catch (e) {
        console.warn("children parse error", e);
      }
    }

    // ç¾åœ¨ã®å­
    let childId =
      localStorage.getItem("pocopoco_current_child_id") ||
      (loadedChildren[0]?.id || "");
    setCurrentChildId(childId);

    // ã‚¿ã‚¹ã‚¯
    const rawTasks = localStorage.getItem("pocopoco_tasks");
    if (rawTasks) {
      try {
        const arr = JSON.parse(rawTasks);
        if (Array.isArray(arr) && arr.length > 0) setTasks(arr);
      } catch (e) {
        console.warn("tasks parse error", e);
      }
    }

    // åˆè¨ˆãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ãƒ‡ãƒ¼ã‚¿
    calcTotals(childId);
    loadHomeEvent(childId);
    loadTodayTimetable(childId);

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨­å®š
    setCalendarSettings(loadCalendarSettingsFromStorage());
  }, []);

  // åˆè¨ˆãƒ»ã‚¿ã‚¹ã‚¯åˆ¥ãƒ»æ—¥åˆ¥ï¼ˆãã®å­ï¼‰
  function calcTotals(childId) {
    const rawHistory = localStorage.getItem("pocopoco_history");
    const todayStr = new Date().toISOString().slice(0, 10);

    if (!rawHistory) {
      setTodayTotalSec(0);
      setTodayTotalCount(0);
      setTodayTaskSeconds({});
      setTotalTaskSeconds({});
      setDailySeconds({});
      return;
    }

    try {
      const arr = JSON.parse(rawHistory);
      if (!Array.isArray(arr)) return;

      let todaySecSum = 0;
      let todayCountSum = 0;
      const todayPerTask = {};
      const totalPerTask = {};
      const daily = {};

      for (const r of arr) {
        const startedAt =
          r.startedAt || r.start || r.dateTime || r.datetime || r.date || "";
        if (!startedAt || !startedAt.slice) continue;
        const d = startedAt.slice(0, 10);

        const recChild =
          r.child_id || r.childId || r.child || r.kidId || r.kid_id || "";
        if (childId && recChild && recChild !== childId) continue;

        const sec = Number(
          r.seconds ??
            r.durationSec ??
            r.duration ??
            r.timeSec ??
            r.time ??
            0
        );
        const count = Number(r.count ?? r.times ?? r.reps ?? 0);
        const key =
          r.task_id ||
          r.taskId ||
          r.task_title ||
          r.taskTitle ||
          r.task_name ||
          r.taskName ||
          r.task ||
          r.title ||
          "";
        if (!key) continue;

        totalPerTask[key] = (totalPerTask[key] || 0) + sec;
        daily[d] = (daily[d] || 0) + sec;

        if (d === todayStr) {
          todaySecSum += sec;
          todayCountSum += count;
          todayPerTask[key] = (todayPerTask[key] || 0) + sec;
        }
      }

      setTodayTotalSec(todaySecSum);
      setTodayTotalCount(todayCountSum);
      setTodayTaskSeconds(todayPerTask);
      setTotalTaskSeconds(totalPerTask);
      setDailySeconds(daily);
    } catch (e) {
      console.warn("history parse error", e);
    }
  }

  // æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  function loadHomeEvent(childId) {
    const rawEvents = localStorage.getItem("pocopoco_events");
    if (rawEvents) {
      try {
        const arr = JSON.parse(rawEvents);
        if (Array.isArray(arr) && arr.length > 0) {
          const childKey = childId || "all";

          let homeEv =
            arr.find(
              (e) =>
                e.home === true &&
                (e.child_id === childKey ||
                  (childKey === "all" &&
                    (!e.child_id || e.child_id === "all")))
            ) || null;

          if (!homeEv) {
            homeEv =
              arr.find(
                (e) =>
                  e.child_id === childKey ||
                  (childKey === "all" &&
                    (!e.child_id || e.child_id === "all"))
              ) || null;
          }

          if (!homeEv) {
            homeEv =
              arr.find((e) => !e.child_id || e.child_id === "all") || arr[0];
          }

          if (homeEv) {
            setEventData({
              title: homeEv.title || homeEv.name || "",
              date: homeEv.date || homeEv.day || "",
            });
            return;
          }
        }
      } catch (e) {
        console.warn("events parse error", e);
      }
    }

    const rawOld = localStorage.getItem("pocopoco_event");
    if (rawOld) {
      try {
        const evt = JSON.parse(rawOld);
        setEventData(evt);
      } catch (e) {
        console.warn("old event parse error", e);
      }
    }
  }

  // é€±é–“ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã€ä»Šæ—¥ã®ç¸¦1åˆ—ã‚’å–å¾—
  function loadTodayTimetable(childId) {
    const raw = localStorage.getItem(WEEKLY_STORAGE_KEY);
    if (!raw) {
      setTodaySlots(Array(PERIOD_COUNT).fill(""));
      return;
    }

    try {
      const data = JSON.parse(raw);
      if (!data || typeof data !== "object") {
        setTodaySlots(Array(PERIOD_COUNT).fill(""));
        return;
      }

      let cfg = childId && data[childId] ? data[childId] : null;
      if (!cfg) {
        const keys = Object.keys(data);
        if (keys.length > 0) cfg = data[keys[0]];
      }

      if (!cfg || !cfg.cells) {
        setTodaySlots(Array(PERIOD_COUNT).fill(""));
        return;
      }

      const jsDay = new Date().getDay();
      const dayKey = DAY_KEYS[jsDay];
      const col = cfg.cells[dayKey] || [];

      const slots = Array.from({ length: PERIOD_COUNT }).map(
        (_, i) => col[i] || ""
      );
      setTodaySlots(slots);
    } catch (e) {
      console.warn("weekly timetable parse error", e);
      setTodaySlots(Array(PERIOD_COUNT).fill(""));
    }
  }

  const currentChildName =
    children.find((c) => c.id === currentChildId)?.name || "";

  const todayMinutes = Math.floor(todayTotalSec / 60);
  const todaySeconds = todayTotalSec % 60;
  const todayLabel = lang === "en" ? "Today" : "ä»Šæ—¥";

  const today = new Date();
  const isCurrentMonth =
    today.getFullYear() === calendarYear &&
    today.getMonth() + 1 === calendarMonth;

  const firstDay = new Date(calendarYear, calendarMonth - 1, 1);
  const firstWeekday = firstDay.getDay(); // 0=Sun

  const firstDayOfWeek = calendarSettings.firstDayOfWeek; // 'sun' | 'mon'
  const badges = calendarSettings.badges;

  const headersSun = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
  const headersMon = ["æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ", "æ—¥"];
  const headerLabels = firstDayOfWeek === "mon" ? headersMon : headersSun;

  // 1è¡Œç›®ã®æœ€åˆã®ã‚»ãƒ«ã«1æ—¥ãŒæ¥ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
  const startIndex =
    firstDayOfWeek === "sun" ? firstWeekday : (firstWeekday + 6) % 7;

  const lastDay = new Date(calendarYear, calendarMonth, 0).getDate();

  const weeks = [];
  let currentDay = 1 - startIndex;
  while (currentDay <= lastDay) {
    const week = [];
    for (let i = 0; i < 7; i++) {
      if (currentDay < 1 || currentDay > lastDay) {
        week.push(null);
      } else {
        week.push(currentDay);
      }
      currentDay++;
    }
    weeks.push(week);
  }

  const monthLabel =
    lang === "en"
      ? `${calendarYear}/${calendarMonth}`
      : `${calendarYear}å¹´${calendarMonth}æœˆ`;

  const childLabel = currentChildName || "pocoapoco";

  return (
    <main
      style={{
        padding: "20px 16px 80px",
        maxWidth: "520px",
        margin: "0 auto",
        fontFamily: "system-ui, sans-serif",
      }}
    >
      {/* å­ã©ã‚‚ã®åå‰ */}
      <header style={{ marginBottom: "16px" }}>
        <h1 style={{ fontSize: "20px", fontWeight: 600, marginBottom: "4px" }}>
          {childLabel}
        </h1>
      </header>

      {/* ä¸Šæ®µï¼šä»Šæ—¥ã®åˆè¨ˆï¼‹ã‚¤ãƒ™ãƒ³ãƒˆï¼‹ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ä»Šæ—¥ã®é€±é–“ãƒœãƒ¼ãƒ‰ */}
      <section
        style={{
          display: "flex",
          gap: "12px",
          alignItems: "stretch",
          marginBottom: "20px",
          flexWrap: "wrap",
        }}
      >
        {/* å·¦ã‚«ãƒ©ãƒ  */}
        <div
          style={{
            display: "flex",
            flexDirection: "column",
            gap: "10px",
            flex: "0 0 220px",
            maxWidth: "100%",
          }}
        >
          {/* ä»Šæ—¥ã®åˆè¨ˆ */}
          <section
            style={{
              background: "#f7f1ff",
              border: "1px solid #e1d1ff",
              borderRadius: "14px",
              padding: "14px 14px 8px",
            }}
          >
            <div style={{ fontSize: "13px", marginBottom: "6px" }}>
              {t("todayPractice", lang)}
            </div>
            <div
              style={{ display: "flex", alignItems: "baseline", gap: "12px" }}
            >
              <div style={{ fontSize: "30px", fontWeight: 700 }}>
                {todayMinutes}:{todaySeconds.toString().padStart(2, "0")}
              </div>
              <div style={{ fontSize: "12px", color: "#666" }}>
                {t("sessionsCount", lang)}
                {todayTotalCount}
              </div>
            </div>
          </section>

          {/* ã‚¤ãƒ™ãƒ³ãƒˆï¼‹ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */}
          <section
            style={{
              background: "#fffaf3",
              border: "1px solid #ffe0b2",
              borderRadius: "14px",
              padding: "10px 10px 8px",
              display: "flex",
              flexDirection: "column",
              flexGrow: 1,
            }}
          >
            {/* nextEvent */}
            {eventData && eventData.title ? (
              <>
                <div
                  style={{
                    fontSize: "12px",
                    color: "#f57c00",
                    marginBottom: "4px",
                  }}
                >
                  {t("nextEvent", lang)}
                </div>
                <div style={{ fontSize: "14px", fontWeight: 600 }}>
                  {eventData.title}
                </div>
                {eventData.date && (
                  <div style={{ fontSize: "12px", marginBottom: "6px" }}>
                    {eventData.date}
                  </div>
                )}
              </>
            ) : (
              <>
                <div style={{ fontSize: "12px", marginBottom: "4px" }}>
                  {t("noEventYetTitle", lang)}
                </div>
                <div
                  style={{
                    fontSize: "11px",
                    color: "#777",
                    marginBottom: "6px",
                  }}
                >
                  {t("noEventYetHint", lang)}
                </div>
              </>
            )}

            {/* ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”»é¢ã¸ï¼‰ */}
            <div
              onClick={() => {
                window.location.href = "/calendar";
              }}
              style={{
                marginTop: "4px",
                paddingTop: "6px",
                borderTop: "1px solid #ffe0b2",
                fontSize: "11px",
                flexGrow: 1,
                display: "flex",
                flexDirection: "column",
                cursor: "pointer",
              }}
            >
              <div
                style={{
                  display: "flex",
                  justifyContent: "space-between",
                  alignItems: "center",
                  marginBottom: "4px",
                }}
              >
                <span>{monthLabel}</span>
                <span style={{ fontSize: "10px", color: "#888" }}>
                  ï¼ˆã‚¿ãƒƒãƒ—ã§ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¸ï¼‰
                </span>
              </div>
              <table
                style={{
                  width: "100%",
                  borderCollapse: "collapse",
                  tableLayout: "fixed",
                  flexGrow: 1,
                }}
              >
                <thead>
                  <tr>
                    {headerLabels.map((d) => (
                      <th
                        key={d}
                        style={{
                          fontWeight: 500,
                          fontSize: "10px",
                          paddingBottom: "2px",
                          color:
                            d === "æ—¥"
                              ? "#f44336"
                              : d === "åœŸ"
                              ? "#3f51b5"
                              : "#555",
                        }}
                      >
                        {d}
                      </th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {weeks.map((week, wi) => (
                    <tr key={wi}>
                      {week.map((day, di) => {
                        if (!day) {
                          return (
                            <td
                              key={di}
                              style={{
                                textAlign: "center",
                                padding: "1px 0",
                                fontSize: "10px",
                                height: "18px",
                              }}
                            />
                          );
                        }

                        const dateKey = `${calendarYear}-${String(
                          calendarMonth
                        ).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
                        const secs = dailySeconds[dateKey] || 0;
                        const mins = Math.floor(secs / 60);
                        const icon = pickBadgeIcon(mins, badges);

                        const isTodayCell =
                          isCurrentMonth && day === today.getDate();

                        return (
                          <td
                            key={di}
                            style={{
                              textAlign: "center",
                              padding: "1px 0",
                              fontSize: "10px",
                              height: "18px",
                            }}
                          >
                            <div
                              style={{
                                position: "relative",
                                display: "inline-block",
                                minWidth: "18px",
                              }}
                            >
                              <div
                                style={{
                                  fontSize: "10px",
                                  padding: "1px 0",
                                  borderRadius: "999px",
                                  minWidth: "16px",
                                  color: isTodayCell ? "#fff" : "#555",
                                  backgroundColor: isTodayCell
                                    ? "#ff80ab"
                                    : "transparent",
                                }}
                              >
                                {day}
                              </div>
                              {icon && (
                                <div
                                  style={{
                                    position: "absolute",
                                    top: "-3px",
                                    right: "-6px",
                                    fontSize: "10px",
                                    opacity: 0.8,
                                  }}
                                >
                                  {icon}
                                </div>
                              )}
                            </div>
                          </td>
                        );
                      })}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </section>
        </div>

        {/* å³ã‚«ãƒ©ãƒ ï¼šä»Šæ—¥ã®é€±é–“ãƒœãƒ¼ãƒ‰ */}
        <div
          style={{
            flex: "1 1 0",
            minWidth: "180px",
            backgroundColor: "#ffffff",
            borderRadius: "14px",
            padding: "12px 14px",
            boxShadow: "0 4px 10px rgba(0,0,0,0.03)",
            border: "1px solid #f3e8ff",
          }}
        >
          <button
            type="button"
            onClick={() => {
              window.location.href = "/weeklyboard";
            }}
            style={{
              border: "none",
              background: "none",
              padding: 0,
              margin: 0,
              fontSize: "13px",
              fontWeight: 600,
              textAlign: "left",
              cursor: "pointer",
              marginBottom: "4px",
            }}
          >
            {lang === "en" ? "Todayâ€™s WeeklyBoard" : "ä»Šæ—¥ã®é€±é–“ãƒœãƒ¼ãƒ‰"}
          </button>
          <div
            style={{
              fontSize: "11px",
              color: "#888",
              marginBottom: "6px",
            }}
          >
            {todayLabel}ã®äºˆå®šã§ã™ï¼ˆé€±é–“ãƒœãƒ¼ãƒ‰ã‹ã‚‰ç·¨é›†ã§ãã¾ã™ï¼‰
          </div>
          <div
            style={{
              maxHeight: "260px",
              overflowY: "auto",
              paddingRight: "4px",
            }}
          >
            {todaySlots.every((s) => !s) ? (
              <div
                style={{
                  fontSize: "11px",
                  color: "#aaa",
                  padding: "4px 0",
                }}
              >
                ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚é€±é–“ãƒœãƒ¼ãƒ‰ã§æ™‚é–“å‰²ã‚„ToDoã‚’è¿½åŠ ã§ãã¾ã™ã€‚
              </div>
            ) : (
              <ul style={{ listStyle: "none", padding: 0, margin: 0 }}>
                {todaySlots.map((slot, idx) => (
                  <li
                    key={idx}
                    style={{
                      fontSize: "12px",
                      padding: "3px 0",
                      borderBottom: "1px solid #f3f4f6",
                      minHeight: "18px",
                    }}
                  >
                    {slot || "ã€€"}
                  </li>
                ))}
              </ul>
            )}
          </div>
        </div>
      </section>

      {/* ã‚¿ã‚¹ã‚¯ä¸€è¦§ */}
      <section style={{ marginBottom: "20px" }}>
        <h2 style={{ fontSize: "14px", fontWeight: 600, marginBottom: "8px" }}>
          ã‚¿ã‚¹ã‚¯
        </h2>
        <div
          style={{
            display: "grid",
            gridTemplateColumns: "repeat(auto-fit, minmax(120px, 1fr))",
            gap: "10px",
          }}
        >
          {tasks.map((task) => {
            const todaySec =
              todayTaskSeconds[task.id] ?? todayTaskSeconds[task.label] ?? 0;
            const totalSec =
              totalTaskSeconds[task.id] ?? totalTaskSeconds[task.label] ?? 0;

            const tmm = Math.floor(todaySec / 60);
            const tss = todaySec % 60;

            const amm = Math.floor(totalSec / 60);
            const ass = totalSec % 60;

            return (
              <a
                key={task.id}
                href={`/record?task=${encodeURIComponent(
                  task.label
                )}&childId=${encodeURIComponent(
                  currentChildId || ""
                )}&autoStart=1`}
                style={{
                  display: "block",
                  background: "#fff",
                  border: "1px solid #eee",
                  borderRadius: "12px",
                  padding: "12px 10px",
                  textDecoration: "none",
                  color: "#333",
                  boxShadow: "0 1px 2px rgba(0,0,0,0.03)",
                }}
              >
                <div style={{ fontSize: "20px", marginBottom: "4px" }}>
                  {task.icon || "ğŸµ"}
                </div>
                <div style={{ fontSize: "13px", fontWeight: 600 }}>
                  {task.label}
                </div>
                <div
                  style={{
                    fontSize: "11px",
                    color: "#777",
                    marginTop: "6px",
                    display: "flex",
                    justifyContent: "space-between",
                  }}
                >
                  <span>
                    {todayLabel} {tmm}:{tss.toString().padStart(2, "0")}
                  </span>
                  <span>
                    ç·åˆè¨ˆ {amm}:{ass.toString().padStart(2, "0")}
                  </span>
                </div>
              </a>
            );
          })}
        </div>
      </section>
    </main>
  );
}
