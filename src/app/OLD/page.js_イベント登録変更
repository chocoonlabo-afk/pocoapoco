// src/app/page.js
"use client";

import { useEffect, useState } from "react";
import { t, getLangFromStorage } from "./lib/i18n"; // â† ã“ã“ãŒä»Šå›ã®è‚ï¼

// è¨­å®šã§ä½¿ã£ã¦ã„ã‚‹åˆæœŸã‚¿ã‚¹ã‚¯ã¨ãã‚ãˆã‚‹
const DEFAULT_TASKS = [
  { id: "task_violin", label: "ãƒã‚¤ã‚ªãƒªãƒ³", icon: "ğŸ»" },
  { id: "task_piano", label: "ãƒ”ã‚¢ãƒ", icon: "ğŸ¹" },
  { id: "task_solfege", label: "ã‚½ãƒ«ãƒ•ã‚§ãƒ¼ã‚¸ãƒ¥", icon: "ğŸ“" },
  { id: "task_japanese", label: "å›½èª", icon: "ğŸ“–" },
  { id: "task_math", label: "ç®—æ•°", icon: "ğŸ”¢" },
  { id: "task_english", label: "è‹±èª", icon: "ğŸ‡¬ğŸ‡§" },
];

export default function HomePage() {
  const [lang, setLang] = useState("jp");
  const [role, setRole] = useState("parent");
  const [children, setChildren] = useState([]);
  const [currentChildId, setCurrentChildId] = useState("");
  const [tasks, setTasks] = useState(DEFAULT_TASKS);
  const [eventData, setEventData] = useState(null);
  const [todayTotalSec, setTodayTotalSec] = useState(0);
  const [todayTotalCount, setTodayTotalCount] = useState(0);

  useEffect(() => {
    // è¨€èª
    const savedLang = getLangFromStorage();
    setLang(savedLang);

    // è¦ª/å­ãƒ¢ãƒ¼ãƒ‰
    const savedRole = typeof window !== "undefined"
      ? window.localStorage.getItem("pocopoco_role")
      : null;
    if (savedRole === "child") setRole("child");

    // å­ã©ã‚‚ä¸€è¦§
    const rawChildren = localStorage.getItem("pocopoco_children");
    if (rawChildren) {
      try {
        const arr = JSON.parse(rawChildren);
        if (Array.isArray(arr)) setChildren(arr);
      } catch (e) {
        console.warn("children parse error", e);
      }
    }

    // è¡¨ç¤ºä¸­ã®å­
    const savedCurrent = localStorage.getItem("pocopoco_current_child_id");
    if (savedCurrent) {
      setCurrentChildId(savedCurrent);
    }

    // ã‚¿ã‚¹ã‚¯
    const rawTasks = localStorage.getItem("pocopoco_tasks");
    if (rawTasks) {
      try {
        const arr = JSON.parse(rawTasks);
        if (Array.isArray(arr) && arr.length > 0) {
          setTasks(arr);
        }
      } catch (e) {
        console.warn("tasks parse error", e);
      }
    }

    // ãƒ›ãƒ¼ãƒ ã«1ã¤å‡ºã™ã‚¤ãƒ™ãƒ³ãƒˆ
    const rawEvent = localStorage.getItem("pocopoco_event");
    if (rawEvent) {
      try {
        const evt = JSON.parse(rawEvent);
        setEventData(evt);
      } catch (e) {
        console.warn("event parse error", e);
      }
    }

    // ãã‚‡ã†ã®åˆè¨ˆ
    calcTodayTotals(savedCurrent);
  }, []);

  // ãã‚‡ã†ã®åˆè¨ˆã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
  function calcTodayTotals(childId) {
    const rawHistory = localStorage.getItem("pocopoco_history");
    const todayStr = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
    if (!rawHistory) {
      setTodayTotalSec(0);
      setTodayTotalCount(0);
      return;
    }
    try {
      const arr = JSON.parse(rawHistory);
      if (!Array.isArray(arr)) return;
      let secSum = 0;
      let countSum = 0;
      for (const r of arr) {
        if (!r.startedAt) continue;
        const d = r.startedAt.slice(0, 10);
        if (d !== todayStr) continue;
        // å­æŒ‡å®šãŒã‚ã‚‹å ´åˆã¯ä¸€è‡´ã™ã‚‹ã‚‚ã®ã ã‘
        if (childId && r.child_id && r.child_id !== childId) continue;
        secSum += Number(r.seconds || 0);
        countSum += Number(r.count || 0);
      }
      setTodayTotalSec(secSum);
      setTodayTotalCount(countSum);
    } catch (e) {
      console.warn("history parse error", e);
    }
  }

  // è¡¨ç¤ºã™ã‚‹å­ã©ã‚‚ã®åå‰
  const currentChildName =
    children.find((c) => c.id === currentChildId)?.name || "";

  const todayMinutes = Math.floor(todayTotalSec / 60);
  const todaySeconds = todayTotalSec % 60;

  return (
    <main
      style={{
        padding: "20px 16px 80px",
        maxWidth: "520px",
        margin: "0 auto",
        fontFamily: "system-ui, sans-serif",
      }}
    >
      {/* ã‚¿ã‚¤ãƒˆãƒ«ã¨å­ã©ã‚‚è¡¨ç¤º */}
      <header style={{ marginBottom: "16px" }}>
        <h1 style={{ fontSize: "20px", fontWeight: 600, marginBottom: "4px" }}>
          {t("homeTitle", lang)}
        </h1>
        {currentChildName ? (
          <p style={{ fontSize: "13px", color: "#555" }}>
            ã„ã¾è¡¨ç¤ºã—ã¦ã„ã‚‹ã“ã©ã‚‚ï¼š <strong>{currentChildName}</strong>
          </p>
        ) : (
          <p style={{ fontSize: "12px", color: "#999" }}>
            ï¼ˆã“ã©ã‚‚ãŒæœªé¸æŠã§ã™ã€‚è¨­å®šã§é¸ã¶ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰
          </p>
        )}
      </header>

      {/* ä»Šæ—¥ã®åˆè¨ˆ */}
      <section
        style={{
          background: "#f7f1ff",
          border: "1px solid #e1d1ff",
          borderRadius: "14px",
          padding: "14px 14px 8px",
          marginBottom: "16px",
        }}
      >
        <div style={{ fontSize: "13px", marginBottom: "6px" }}>
          {t("todayPractice", lang)}
        </div>
        <div
          style={{ display: "flex", alignItems: "baseline", gap: "12px" }}
        >
          <div style={{ fontSize: "30px", fontWeight: 700 }}>
            {todayMinutes}:{todaySeconds.toString().padStart(2, "0")}
          </div>
          <div style={{ fontSize: "12px", color: "#666" }}>
            {t("sessionsCount", lang)}
            {todayTotalCount}
          </div>
        </div>
      </section>

      {/* ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ï¼ˆè¨­å®šã§1å€‹ã ã‘å…¥ã‚Œã‚‹ã‚„ã¤ï¼‰ */}
      {eventData && eventData.title ? (
        <section
          style={{
            background: "#fff3e0",
            border: "1px solid #ffe0b2",
            borderRadius: "14px",
            padding: "12px 14px",
            marginBottom: "16px",
          }}
        >
          <div style={{ fontSize: "12px", color: "#f57c00", marginBottom: "4px" }}>
            {t("nextEvent", lang)}
          </div>
          <div style={{ fontSize: "14px", fontWeight: 600 }}>
            {eventData.title}
          </div>
          {eventData.date && (
            <div style={{ fontSize: "12px", marginTop: "4px" }}>
              {eventData.date}
            </div>
          )}
        </section>
      ) : (
        <section
          style={{
            background: "#f5f5f5",
            borderRadius: "14px",
            padding: "12px 14px",
            marginBottom: "16px",
          }}
        >
          <div style={{ fontSize: "12px", marginBottom: "4px" }}>
            {t("noEventYetTitle", lang)}
          </div>
          <div style={{ fontSize: "11px", color: "#777" }}>
            {t("noEventYetHint", lang)}
          </div>
        </section>
      )}

      {/* ã‚¿ã‚¹ã‚¯ä¸€è¦§ï¼ˆã“ã“ã‹ã‚‰è¨˜éŒ²ç”»é¢ã¸è¡Œãï¼‰ */}
      <section style={{ marginBottom: "20px" }}>
        <h2 style={{ fontSize: "14px", fontWeight: 600, marginBottom: "8px" }}>
          {t("practiceMenuTitle", lang)}
        </h2>
        <div
          style={{
            display: "grid",
            gridTemplateColumns: "repeat(auto-fit, minmax(120px, 1fr))",
            gap: "10px",
          }}
        >
          {tasks.map((task) => (
            <a
              key={task.id}
              href={`/record?task=${encodeURIComponent(task.label)}&task_id=${encodeURIComponent(
                task.id
              )}`}
              style={{
                display: "block",
                background: "#fff",
                border: "1px solid #eee",
                borderRadius: "12px",
                padding: "12px 10px",
                textDecoration: "none",
                color: "#333",
                boxShadow: "0 1px 2px rgba(0,0,0,0.03)",
              }}
            >
              <div style={{ fontSize: "20px", marginBottom: "4px" }}>
                {task.icon || "ğŸµ"}
              </div>
              <div style={{ fontSize: "13px", fontWeight: 600 }}>
                {task.label}
              </div>
              <div style={{ fontSize: "11px", color: "#777", marginTop: "4px" }}>
                {t("tapToRecord", lang)}
              </div>
            </a>
          ))}
        </div>
      </section>

      {/* ä¸‹ã®å›ºå®šã‚¿ãƒ–ã¯ layout.js å´ã«ã‚ã‚‹ã®ã§ã“ã“ã§ã¯ä½•ã‚‚ã—ãªãã¦OK */}
    </main>
  );
}
