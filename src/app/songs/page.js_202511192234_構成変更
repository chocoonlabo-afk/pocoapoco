// src/app/songs/page.js
"use client";

import { useState } from "react";

// 仮の子どもデータ（実アプリでは既存データから取得）
const initialChildren = [
  { id: "child1", name: "ゆくも" },
  { id: "child2", name: "あまね" },
];

const escapeCSV = (value) => {
  const v = value ?? "";
  return `"${v.replace(/"/g, '""')}"`;
};

const parseCSVLine = (line) => {
  const result = [];
  let current = "";
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];

    if (char === '"') {
      const nextChar = line[i + 1];
      if (inQuotes && nextChar === '"') {
        current += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (char === "," && !inQuotes) {
      result.push(current);
      current = "";
    } else {
      current += char;
    }
  }
  result.push(current);
  return result.map((v) => v.trim());
};

export default function SongListPage() {
  const [children] = useState(initialChildren);
  const [selectedChildId, setSelectedChildId] = useState("child1");
  const [songsByChild, setSongsByChild] = useState({});

  const currentSongs = songsByChild[selectedChildId] ?? [];

  const [title, setTitle] = useState("");
  const [composer, setComposer] = useState("");
  const [performanceDate, setPerformanceDate] = useState("");
  const [venue, setVenue] = useState("");
  const [memo, setMemo] = useState("");

  const handleAddSong = (e) => {
    e.preventDefault();

    if (!selectedChildId) {
      alert("子どもを選択してください。");
      return;
    }
    if (!title.trim()) {
      alert("曲名を入力してください。");
      return;
    }

    const newSong = {
      id: Date.now(),
      childId: selectedChildId,
      title: title.trim(),
      composer: composer.trim(),
      performanceDate,
      venue: venue.trim(),
      memo: memo.trim(),
    };

    setSongsByChild((prev) => {
      const list = prev[selectedChildId] ?? [];
      return {
        ...prev,
        [selectedChildId]: [newSong, ...list],
      };
    });

    setTitle("");
    setComposer("");
    setPerformanceDate("");
    setVenue("");
    setMemo("");
  };

  const handleExportCSV = () => {
    if (!selectedChildId) {
      alert("子どもを選択してください。");
      return;
    }
    if (currentSongs.length === 0) {
      alert("この子どもの曲リストが空です。");
      return;
    }

    const header = ["曲名", "作曲者名", "発表日", "発表場所", "メモ"].join(
      ","
    );

    const lines = currentSongs.map((song) => {
      return [
        escapeCSV(song.title),
        escapeCSV(song.composer),
        escapeCSV(song.performanceDate),
        escapeCSV(song.venue),
        escapeCSV(song.memo),
      ].join(",");
    });

    const csvContent = [header, ...lines].join("\r\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    const childName =
      children.find((c) => c.id === selectedChildId)?.name ?? "unknown";

    a.href = url;
    a.download = `pocoapoco_songs_${childName}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const handleImportCSV = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (!selectedChildId) {
      alert("子どもを選択してください。");
      return;
    }

    const text = await file.text();
    const lines = text.split(/\r?\n/).filter((line) => line.trim() !== "");
    if (lines.length <= 1) {
      alert("有効なデータ行がありません。");
      e.target.value = "";
      return;
    }

    const header = parseCSVLine(lines[0]);
    if (header.length < 5) {
      alert("ヘッダー行の形式が想定と異なります。");
      e.target.value = "";
      return;
    }

    const importedSongs = [];

    for (let i = 1; i < lines.length; i++) {
      const cols = parseCSVLine(lines[i]);
      if (cols.length < 5) continue;

      const [t, c, d, v, m] = cols;
      if (!t.trim()) continue;

      importedSongs.push({
        id: Date.now() + i,
        childId: selectedChildId,
        title: t.trim(),
        composer: c.trim(),
        performanceDate: d.trim(),
        venue: v.trim(),
        memo: m.trim(),
      });
    }

    if (importedSongs.length === 0) {
      alert("取り込める曲データがありませんでした。");
      e.target.value = "";
      return;
    }

    setSongsByChild((prev) => {
      const list = prev[selectedChildId] ?? [];
      return {
        ...prev,
        [selectedChildId]: [...importedSongs, ...list],
      };
    });

    e.target.value = "";
    alert(`曲データを ${importedSongs.length} 件インポートしました。`);
  };

  const sectionCard = {
    backgroundColor: "#ffffff",
    borderRadius: "16px",
    padding: "16px",
    marginBottom: "16px",
    boxShadow: "0 4px 10px rgba(0,0,0,0.03)",
  };

  const labelStyle = {
    display: "block",
    fontSize: "12px",
    fontWeight: 600,
    marginBottom: "4px",
    color: "#555",
  };

  const inputStyle = {
    width: "100%",
    borderRadius: "10px",
    border: "1px solid #ddd",
    padding: "8px 10px",
    fontSize: "13px",
    boxSizing: "border-box",
  };

  const buttonPrimary = {
    borderRadius: "999px",
    border: "none",
    padding: "8px 16px",
    fontSize: "13px",
    fontWeight: 600,
    background:
      "linear-gradient(135deg, rgba(186,104,200,1), rgba(103,58,183,1))",
    color: "#fff",
    cursor: "pointer",
  };

  const buttonSecondary = {
    borderRadius: "999px",
    border: "1px solid #ccc",
    padding: "8px 16px",
    fontSize: "13px",
    fontWeight: 500,
    background: "#fafafa",
    color: "#555",
    cursor: "pointer",
  };

  return (
    <div style={{ padding: "16px 16px 24px" }}>
      <h1
        style={{
          fontSize: "18px",
          fontWeight: 700,
          marginBottom: "4px",
        }}
      >
        曲名リスト
      </h1>
      <p
        style={{
          fontSize: "12px",
          color: "#777",
          marginBottom: "16px",
        }}
      >
        発表会やコンクールで弾いた曲を、子どもごとに記録できます。
      </p>

      {/* 子ども選択＋CSV */}
      <div style={{ ...sectionCard }}>
        <div
          style={{
            display: "flex",
            flexWrap: "wrap",
            gap: "12px",
            alignItems: "center",
            marginBottom: "12px",
          }}
        >
          <div>
            <span style={labelStyle}>表示する子ども</span>
            <select
              value={selectedChildId}
              onChange={(e) => setSelectedChildId(e.target.value)}
              style={inputStyle}
            >
              {children.map((child) => (
                <option key={child.id} value={child.id}>
                  {child.name}
                </option>
              ))}
            </select>
          </div>

          <div
            style={{
              display: "flex",
              gap: "8px",
              flexWrap: "wrap",
              marginLeft: "auto",
            }}
          >
            <button type="button" onClick={handleExportCSV} style={buttonSecondary}>
              CSVエクスポート
            </button>

            <label
              style={{
                ...buttonSecondary,
                display: "inline-flex",
                alignItems: "center",
                gap: "6px",
              }}
            >
              <span>CSVインポート</span>
              <input
                type="file"
                accept=".csv,text/csv"
                onChange={handleImportCSV}
                style={{ display: "none" }}
              />
            </label>
          </div>
        </div>

        <p style={{ fontSize: "11px", color: "#999" }}>
          ※ CSVのヘッダー例：曲名, 作曲者名, 発表日, 発表場所, メモ
        </p>
      </div>

      {/* 登録フォーム */}
      <div style={sectionCard}>
        <h2
          style={{
            fontSize: "14px",
            fontWeight: 700,
            marginBottom: "8px",
          }}
        >
          曲を追加
        </h2>

        <form onSubmit={handleAddSong}>
          <div style={{ marginBottom: "10px" }}>
            <label style={labelStyle}>
              曲名 <span style={{ color: "#e11d48" }}>*</span>
            </label>
            <input
              type="text"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              placeholder="例：ヴィヴァルディ 協奏曲 RV.399 第1楽章"
              style={inputStyle}
            />
          </div>

          <div style={{ marginBottom: "10px" }}>
            <label style={labelStyle}>作曲者名</label>
            <input
              type="text"
              value={composer}
              onChange={(e) => setComposer(e.target.value)}
              placeholder="例：ヴィヴァルディ"
              style={inputStyle}
            />
          </div>

          <div
            style={{
              display: "grid",
              gridTemplateColumns: "1.1fr 1.2fr",
              gap: "10px",
              marginBottom: "10px",
            }}
          >
            <div>
              <label style={labelStyle}>発表日</label>
              <input
                type="date"
                value={performanceDate}
                onChange={(e) => setPerformanceDate(e.target.value)}
                style={inputStyle}
              />
            </div>

            <div>
              <label style={labelStyle}>発表場所</label>
              <input
                type="text"
                value={venue}
                onChange={(e) => setVenue(e.target.value)}
                placeholder="例：○○ホール、○○コンクール"
                style={inputStyle}
              />
            </div>
          </div>

          <div style={{ marginBottom: "12px" }}>
            <label style={labelStyle}>メモ</label>
            <textarea
              value={memo}
              onChange={(e) => setMemo(e.target.value)}
              placeholder="例：初めての本選、テンポ速めで弾いた など"
              rows={3}
              style={{ ...inputStyle, resize: "vertical" }}
            />
          </div>

          <div style={{ textAlign: "right" }}>
            <button type="submit" style={buttonPrimary}>
              リストに追加
            </button>
          </div>
        </form>
      </div>

      {/* 一覧 */}
      <div style={sectionCard}>
        <h2
          style={{
            fontSize: "14px",
            fontWeight: 700,
            marginBottom: "8px",
          }}
        >
          登録済みの曲（
          {children.find((c) => c.id === selectedChildId)?.name ?? "選択なし"}
          ）
        </h2>

        {currentSongs.length === 0 ? (
          <p style={{ fontSize: "12px", color: "#888" }}>
            まだ曲が登録されていません。上のフォームから追加してください。
          </p>
        ) : (
          <div style={{ overflowX: "auto" }}>
            <table
              style={{
                width: "100%",
                borderCollapse: "collapse",
                fontSize: "12px",
              }}
            >
              <thead>
                <tr style={{ backgroundColor: "#faf5ff" }}>
                  <th
                    style={{
                      borderBottom: "1px solid #eee",
                      padding: "6px 4px",
                      textAlign: "left",
                    }}
                  >
                    曲名
                  </th>
                  <th
                    style={{
                      borderBottom: "1px solid #eee",
                      padding: "6px 4px",
                      textAlign: "left",
                    }}
                  >
                    作曲者名
                  </th>
                  <th
                    style={{
                      borderBottom: "1px solid #eee",
                      padding: "6px 4px",
                      textAlign: "left",
                    }}
                  >
                    発表日
                  </th>
                  <th
                    style={{
                      borderBottom: "1px solid #eee",
                      padding: "6px 4px",
                      textAlign: "left",
                    }}
                  >
                    発表場所
                  </th>
                  <th
                    style={{
                      borderBottom: "1px solid #eee",
                      padding: "6px 4px",
                      textAlign: "left",
                    }}
                  >
                    メモ
                  </th>
                </tr>
              </thead>
              <tbody>
                {currentSongs.map((song) => (
                  <tr key={song.id}>
                    <td
                      style={{
                        borderBottom: "1px solid #f2f2f2",
                        padding: "6px 4px",
                        verticalAlign: "top",
                        fontWeight: 500,
                      }}
                    >
                      {song.title}
                    </td>
                    <td
                      style={{
                        borderBottom: "1px solid #f2f2f2",
                        padding: "6px 4px",
                        verticalAlign: "top",
                      }}
                    >
                      {song.composer}
                    </td>
                    <td
                      style={{
                        borderBottom: "1px solid #f2f2f2",
                        padding: "6px 4px",
                        verticalAlign: "top",
                      }}
                    >
                      {song.performanceDate
                        ? new Date(
                            song.performanceDate
                          ).toLocaleDateString("ja-JP")
                        : ""}
                    </td>
                    <td
                      style={{
                        borderBottom: "1px solid #f2f2f2",
                        padding: "6px 4px",
                        verticalAlign: "top",
                      }}
                    >
                      {song.venue}
                    </td>
                    <td
                      style={{
                        borderBottom: "1px solid #f2f2f2",
                        padding: "6px 4px",
                        verticalAlign: "top",
                        whiteSpace: "pre-wrap",
                      }}
                    >
                      {song.memo}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
}
