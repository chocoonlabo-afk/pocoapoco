"use client";

import { useEffect, useRef, useState } from "react";

const HISTORY_STORAGE_KEY = "pocopoco_history";

export default function SongListPage() {
  // 子ども関連
  const [children, setChildren] = useState([]);
  const [currentChildId, setCurrentChildId] = useState("");

  // 子モード判定
  const [isChildMode, setIsChildMode] = useState(false);

  // 曲データ（childId -> songs[]）
  const [songsByChild, setSongsByChild] = useState({});

  // 曲ごとの合計練習時間（秒）
  const [songTotalMap, setSongTotalMap] = useState({});

  // ソート状態
  const [sortKey, setSortKey] = useState("date"); // "date" | "title" | "composer" | "place"
  const [sortOrder, setSortOrder] = useState("asc"); // "asc" | "desc"

  // CSV取込
  const fileInputRef = useRef(null);

  // 初期ロード
  useEffect(() => {
    let childIdFromQuery = "";
    let modeFromQuery = "";

    if (typeof window !== "undefined") {
      const params = new URLSearchParams(window.location.search);
      childIdFromQuery = params.get("childId") || "";
      modeFromQuery = params.get("mode") || "";
    }

    if (modeFromQuery === "child") {
      setIsChildMode(true);
    }

    // 子ども一覧
    try {
      const rawChildren = localStorage.getItem("pocopoco_children");
      if (rawChildren) {
        const arr = JSON.parse(rawChildren);
        if (Array.isArray(arr)) {
          setChildren(arr);

          // 表示子ども
          const savedCurrent = localStorage.getItem(
            "pocopoco_current_child_id"
          );

          let initialId = "";
          if (
            childIdFromQuery &&
            arr.find((c) => c.id === childIdFromQuery)
          ) {
            // ① URL指定 childId を最優先
            initialId = childIdFromQuery;
          } else if (
            savedCurrent &&
            arr.find((c) => c.id === savedCurrent)
          ) {
            // ② 保存済み childId
            initialId = savedCurrent;
          } else if (arr.length > 0) {
            // ③ 先頭
            initialId = arr[0].id;
          }

          if (initialId) {
            setCurrentChildId(initialId);
            try {
              localStorage.setItem("pocopoco_current_child_id", initialId);
            } catch {
              // ignore
            }
          }
        }
      }
    } catch (e) {
      console.warn("children load error", e);
    }

    // 曲データ
    try {
      const rawSongs = localStorage.getItem("pocopoco_songs");
      if (rawSongs) {
        const obj = JSON.parse(rawSongs);
        if (obj && typeof obj === "object") {
          setSongsByChild(obj);
        }
      }
    } catch (e) {
      console.warn("songs load error", e);
    }
  }, []);

  // 現在の子ども
  const currentChild =
    children.find((c) => c.id === currentChildId) || null;

  // 現在の子の曲一覧
  const currentSongs = Array.isArray(songsByChild[currentChildId])
    ? [...songsByChild[currentChildId]]
    : [];

  // ── 曲ごとの合計練習時間を履歴から集計 ─────────────────
  useEffect(() => {
    if (!currentChildId) {
      setSongTotalMap({});
      return;
    }

    try {
      const raw = localStorage.getItem(HISTORY_STORAGE_KEY);
      if (!raw) {
        setSongTotalMap({});
        return;
      }
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) {
        setSongTotalMap({});
        return;
      }

      const totals = {};

      arr.forEach((r) => {
        if (!r) return;
        if ((r.child_id || "") !== currentChildId) return;

        const seconds = Number(r.seconds) || 0;
        if (seconds <= 0) return;

        // ★ 曲タイトルで集計（song_id に依存しない）
        const songTitle = r.song_title || "";
        if (!songTitle) return;

        const key = songTitle;
        totals[key] = (totals[key] || 0) + seconds;
      });

      setSongTotalMap(totals);
    } catch (e) {
      console.warn("history load error", e);
      setSongTotalMap({});
    }
  }, [currentChildId, songsByChild]);

  // 合計時間表示用（秒→ H:MM）
  const formatTotalTime = (seconds) => {
    const sec = Number(seconds) || 0;
    if (sec <= 0) return "";
    const totalMin = Math.floor(sec / 60);
    const hours = Math.floor(totalMin / 60);
    const minutes = totalMin % 60;
    const h = String(hours);
    const m = String(minutes).padStart(2, "0");
    return `${h}:${m}`;
  };

  // ソート処理
  const sortedSongs = currentSongs.sort((a, b) => {
    const va = a || {};
    const vb = b || {};
    let x = "";
    let y = "";

    switch (sortKey) {
      case "title":
        x = va.title || "";
        y = vb.title || "";
        return sortOrder === "asc"
          ? x.localeCompare(y)
          : y.localeCompare(x);
      case "composer":
        x = va.composer || "";
        y = vb.composer || "";
        return sortOrder === "asc"
          ? x.localeCompare(y)
          : y.localeCompare(x);
      case "place":
        x = va.place || "";
        y = vb.place || "";
        return sortOrder === "asc"
          ? x.localeCompare(y)
          : y.localeCompare(x);
      case "date":
      default: {
        const da = va.date ? new Date(va.date).getTime() : 0;
        const db = vb.date ? new Date(vb.date).getTime() : 0;
        return sortOrder === "asc" ? da - db : db - da;
      }
    }
  });

  // ソート切替
  const toggleSort = (key) => {
    if (sortKey === key) {
      setSortOrder((prev) => (prev === "asc" ? "desc" : "asc"));
    } else {
      setSortKey(key);
      setSortOrder("asc");
    }
  };

  const sortHeaderStyle = (key) => ({
    cursor: "pointer",
    whiteSpace: "nowrap",
    padding: "6px 8px",
    borderBottom: "1px solid #eee",
    fontWeight: sortKey === key ? "600" : "500",
    color: sortKey === key ? "#6a1b9a" : "#555",
    fontSize: "11px",
    textAlign: "left",
  });

  const headerCellStyle = {
    padding: "6px 8px",
    borderBottom: "1px solid #eee",
    whiteSpace: "nowrap",
    fontSize: "11px",
    textAlign: "left",
    color: "#555",
  };

  const sortIcon = (key) => {
    if (sortKey !== key) return "▽";
    return sortOrder === "asc" ? "▲" : "▼";
  };

  // 「リストに追加」ボタン
  const handleAddClick = () => {
    if (!currentChildId) {
      alert("まず 子どもを 1人以上 登録してください。");
      return;
    }
    window.location.href = `/songs/new?childId=${currentChildId}`;
  };

  // 編集ボタン
  const handleEditClick = (index) => {
    if (!currentChildId) return;
    window.location.href = `/songs/edit?childId=${currentChildId}&index=${index}`;
  };

  // CSV出力
  const handleExportCsv = () => {
    if (!currentChildId) {
      alert("子どもを選択してください。");
      return;
    }
    if (sortedSongs.length === 0) {
      alert("この子の曲は まだ登録されていません。");
      return;
    }

    const header = ["composer", "title", "date", "place", "memo"];
    const lines = [header.join(",")];

    sortedSongs.forEach((s) => {
      const row = [
        (s.composer || "").replace(/,/g, " "),
        (s.title || "").replace(/,/g, " "),
        s.date || "",
        (s.place || "").replace(/,/g, " "),
        (s.memo || "").replace(/[\r\n,]/g, " "),
      ];
      lines.push(row.join(","));
    });

    // ★ UTF-8 BOM を付けて、日本語環境の Excel でも文字化けしにくくする
    const csv = "\uFEFF" + lines.join("\n");
    const blob = new Blob([csv], {
      type: "text/csv;charset=utf-8;",
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `songs_${currentChild?.name || "child"}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  // CSV取込
  const handleImportClick = () => {
    if (!currentChildId) {
      alert("子どもを選択してください。");
      return;
    }
    if (fileInputRef.current) {
      fileInputRef.current.value = "";
      fileInputRef.current.click();
    }
  };

  const handleFileChange = (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      const text = event.target?.result;
      if (typeof text !== "string") return;

      const imported = parseSongsCsv(text);
      if (imported.length === 0) {
        alert("読み込める曲データが 見つかりませんでした。");
        return;
      }

      const updated = { ...songsByChild };
      const existing = Array.isArray(updated[currentChildId])
        ? updated[currentChildId]
        : [];
      updated[currentChildId] = [...existing, ...imported];

      setSongsByChild(updated);
      try {
        localStorage.setItem(
          "pocopoco_songs",
          JSON.stringify(updated)
        );
      } catch (err) {
        console.error("failed to save songs", err);
      }

      alert(`曲を ${imported.length} 件 追加しました。`);
    };
    reader.readAsText(file, "utf-8");
  };

  return (
    <main
      style={{
        fontFamily:
          "system-ui, -apple-system, BlinkMacSystemFont, sans-serif",
        padding: "24px 16px 80px",
        maxWidth: "540px",
        margin: "0 auto",
      }}
    >
      {/* 上部カード（子ども選択 + CSV + 追加） */}
      <section
        style={{
          borderRadius: "16px",
          background: "#fbf7ff",
          border: "1px solid #eadfff",
          padding: "12px 14px",
          marginBottom: "16px",
        }}
      >
        <div
          style={{
            display: "flex",
            gap: "8px",
            alignItems: "center",
            flexWrap: "wrap",
          }}
        >
          {/* 子どもセレクト */}
          {isChildMode ? (
            // ★子モード：セレクトは出さず、現在の子ども名だけ表示
            <div
              style={{
                flex: "1 1 0",
                minWidth: "140px",
                fontSize: "13px",
                padding: "6px 12px",
              }}
            >
              {currentChild?.name || "子ども未登録"}
            </div>
          ) : (
            <select
              value={currentChildId}
              onChange={(e) => setCurrentChildId(e.target.value)}
              style={{
                flex: "1 1 0",
                minWidth: "140px",
                borderRadius: "999px",
                border: "1px solid #ccc",
                padding: "6px 12px",
                fontSize: "13px",
                background: "#fff",
              }}
            >
              {children.length === 0 && (
                <option value="">子ども未登録</option>
              )}
              {children.map((c) => (
                <option key={c.id} value={c.id}>
                  {c.name}
                </option>
              ))}
            </select>
          )}

          {/* CSV出力／取込／追加 */}
          <div
            style={{
              display: "flex",
              gap: "6px",
              flexWrap: "wrap",
              justifyContent: "flex-end",
            }}
          >
            <button
              type="button"
              onClick={handleExportCsv}
              style={{
                borderRadius: "999px",
                border: "1px solid #ccc",
                padding: "5px 10px",
                fontSize: "11px",
                background: "#fff",
                whiteSpace: "nowrap",
              }}
            >
              CSV出力
            </button>
            <button
              type="button"
              onClick={handleImportClick}
              style={{
                borderRadius: "999px",
                border: "1px solid #ccc",
                padding: "5px 10px",
                fontSize: "11px",
                background: "#fff",
                whiteSpace: "nowrap",
              }}
            >
              CSV取込
            </button>
            <button
              type="button"
              onClick={handleAddClick}
              style={{
                borderRadius: "999px",
                border: "none",
                padding: "5px 14px",
                fontSize: "12px",
                background:
                  "linear-gradient(135deg, #a855f7, #ec4899)",
                color: "#fff",
                fontWeight: "600",
                whiteSpace: "nowrap",
              }}
            >
              リストに追加
            </button>
          </div>
        </div>
      </section>

      {/* 曲リスト */}
      <section>
        <h2
          style={{
            fontSize: "14px",
            marginBottom: "4px",
            color: "#4a148c",
          }}
        >
          登録済みの曲（{currentChild?.name || "―"}）
        </h2>
        {/* 注意書き */}
        <p
          style={{
            fontSize: "11px",
            color: "#666",
            marginBottom: "8px",
            lineHeight: 1.4,
          }}
        >
          1曲に対して発表日が複数日ある場合や、練習開始日などを記載したい場合には、メモ欄をご活用ください。
        </p>

        {sortedSongs.length === 0 ? (
          <p
            style={{
              fontSize: "13px",
              color: "#777",
              marginTop: "6px",
            }}
          >
            この子の曲が まだ登録されていません。
            「リストに追加」ボタンから 追加してください。
          </p>
        ) : (
          <div style={{ overflowX: "auto" }}>
            <table
              style={{
                width: "100%",
                borderCollapse: "collapse",
                fontSize: "12px",
              }}
            >
              <thead>
                <tr style={{ backgroundColor: "#faf5ff" }}>
                  <th
                    onClick={() => toggleSort("composer")}
                    style={sortHeaderStyle("composer")}
                  >
                    作曲者名 {sortIcon("composer")}
                  </th>
                  <th
                    onClick={() => toggleSort("title")}
                    style={sortHeaderStyle("title")}
                  >
                    曲名 {sortIcon("title")}
                  </th>
                  <th
                    onClick={() => toggleSort("date")}
                    style={sortHeaderStyle("date")}
                  >
                    発表日 {sortIcon("date")}
                  </th>
                  <th
                    onClick={() => toggleSort("place")}
                    style={sortHeaderStyle("place")}
                  >
                    発表場所 {sortIcon("place")}
                  </th>
                  <th style={headerCellStyle}>練習合計</th>
                  <th style={headerCellStyle}>メモ</th>
                  <th style={headerCellStyle}>操作</th>
                </tr>
              </thead>
              <tbody>
                {sortedSongs.map((song, index) => {
                  // ★ 曲タイトルをキーに合計時間を取得
                  const titleKey = song.title || "";
                  const totalLabel = titleKey
                    ? formatTotalTime(songTotalMap[titleKey] || 0)
                    : "";

                  return (
                    <tr key={index}>
                      <td
                        style={{
                          padding: "6px 8px",
                          borderBottom: "1px solid #f2f2f2",
                        }}
                      >
                        {song.composer || ""}
                      </td>
                      <td
                        style={{
                          padding: "6px 8px",
                          borderBottom: "1px solid #f2f2f2",
                        }}
                      >
                        {song.title || ""}
                      </td>
                      <td
                        style={{
                          padding: "6px 8px",
                          borderBottom: "1px solid #f2f2f2",
                          whiteSpace: "nowrap",
                        }}
                      >
                        {song.date || ""}
                      </td>
                      <td
                        style={{
                          padding: "6px 8px",
                          borderBottom: "1px solid #f2f2f2",
                        }}
                      >
                        {song.place || ""}
                      </td>
                      <td
                        style={{
                          padding: "6px 8px",
                          borderBottom: "1px solid #f2f2f2",
                          whiteSpace: "nowrap",
                        }}
                      >
                        {totalLabel}
                      </td>
                      {/* メモは4行まで表示、ホバーで全文 */}
                      <td
                        style={{
                          padding: "6px 8px",
                          borderBottom: "1px solid #f2f2f2",
                          maxWidth: "160px",
                        }}
                        title={song.memo || ""}
                      >
                        <div
                          style={{
                            whiteSpace: "pre-wrap",
                            wordBreak: "break-word",
                            overflow: "hidden",
                            display: "-webkit-box",
                            WebkitLineClamp: 4,
                            WebkitBoxOrient: "vertical",
                          }}
                        >
                          {song.memo || ""}
                        </div>
                      </td>
                      <td
                        style={{
                          padding: "6px 8px",
                          borderBottom: "1px solid #f2f2f2",
                          textAlign: "center",
                        }}
                      >
                        <button
                          type="button"
                          onClick={() => handleEditClick(index)}
                          style={{
                            borderRadius: "999px",
                            border: "none",
                            padding: "4px 10px",
                            fontSize: "11px",
                            background:
                              "linear-gradient(135deg, #a855f7, #ec4899)",
                            color: "#fff",
                            fontWeight: "600",
                          }}
                        >
                          編集
                        </button>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}
      </section>

      {/* CSV入力用 hidden input */}
      <input
        ref={fileInputRef}
        type="file"
        accept=".csv,text/csv"
        style={{ display: "none" }}
        onChange={handleFileChange}
      />
    </main>
  );
}

// CSV文字列 → 曲データ配列
function parseSongsCsv(text) {
  const lines = text.split(/\r?\n/).filter((l) => l.trim() !== "");
  if (lines.length === 0) return [];

  const [headerLine, ...rows] = lines;
  const headers = headerLine.split(",").map((h) => h.trim());

  const idxComposer = headers.indexOf("composer");
  const idxTitle = headers.indexOf("title");
  const idxDate = headers.indexOf("date");
  const idxPlace = headers.indexOf("place");
  const idxMemo = headers.indexOf("memo");

  // ヘッダありパターン
  if (idxTitle !== -1 || idxComposer !== -1) {
    return rows.map((line) => {
      const cols = line.split(",");
      return {
        composer: idxComposer >= 0 ? cols[idxComposer] || "" : "",
        title: idxTitle >= 0 ? cols[idxTitle] || "" : "",
        date: idxDate >= 0 ? cols[idxDate] || "" : "",
        place: idxPlace >= 0 ? cols[idxPlace] || "" : "",
        memo: idxMemo >= 0 ? cols[idxMemo] || "" : "",
      };
    });
  }

  // 旧形式（作曲者名, 曲名, 発表日, 発表場所, メモ）として解釈
  return rows.map((line) => {
    const cols = line.split(",");
    return {
      composer: cols[0] || "",
      title: cols[1] || "",
      date: cols[2] || "",
      place: cols[3] || "",
      memo: cols[4] || "",
    };
  });
}
