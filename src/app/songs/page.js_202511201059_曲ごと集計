// src/app/songs/page.js
"use client";

import { useState, useEffect } from "react";
import { useRouter, useSearchParams } from "next/navigation";

// 仮の子どもデータ（実アプリでは既存の子ども一覧に差し替え）
const initialChildren = [
  { id: "child1", name: "ゆくも" },
  { id: "child2", name: "あまね" },
];

const STORAGE_KEY = "pocoapoco_songs_by_child";

// localStorage から読み込み
function loadSongsFromStorage() {
  if (typeof window === "undefined") return {};
  const raw = window.localStorage.getItem(STORAGE_KEY);
  if (!raw) return {};
  try {
    const parsed = JSON.parse(raw);
    if (parsed && typeof parsed === "object") return parsed;
  } catch (e) {
    console.error("Failed to parse songs from storage", e);
  }
  return {};
}

const escapeCSV = (value) => {
  const v = value ?? "";
  return `"${v.replace(/"/g, '""')}"`;
};

const parseCSVLine = (line) => {
  const result = [];
  let current = "";
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];

    if (char === '"') {
      const nextChar = line[i + 1];
      if (inQuotes && nextChar === '"') {
        current += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (char === "," && !inQuotes) {
      result.push(current);
      current = "";
    } else {
      current += char;
    }
  }
  result.push(current);
  return result.map((v) => v.trim());
};

export default function SongListPage() {
  const router = useRouter();
  const searchParams = useSearchParams();

  const [children] = useState(initialChildren);

  // クエリから初期子どもIDを取得
  const initialChildIdFromQuery = searchParams.get("childId") || "child1";
  const [selectedChildId, setSelectedChildId] = useState(
    initialChildIdFromQuery
  );

  // 曲データ：初期値は必ず {} にしておく（Hydration 対策）
  const [songsByChild, setSongsByChild] = useState({});

  // 並べ替え状態
  const [sortKey, setSortKey] = useState("date"); // 'date' | 'title' | 'composer' | 'venue'
  const [sortOrder, setSortOrder] = useState("asc"); // 'asc' | 'desc'

  // マウント時に localStorage を読み込む
  useEffect(() => {
    setSongsByChild(loadSongsFromStorage());
  }, []);

  const currentSongs = songsByChild[selectedChildId] ?? [];

  // 並べ替え後の配列
  const sortedSongs = (() => {
    const list = [...currentSongs];

    const compare = (a, b, key) => {
      let av = "";
      let bv = "";

      if (key === "date") {
        av = a.performanceDate || "";
        bv = b.performanceDate || "";
      } else if (key === "title") {
        av = a.title || "";
        bv = b.title || "";
      } else if (key === "composer") {
        av = a.composer || "";
        bv = b.composer || "";
      } else if (key === "venue") {
        av = a.venue || "";
        bv = b.venue || "";
      }

      // 日付は "YYYY-MM-DD" なので文字列比較でOK（空は最後へ）
      if (key === "date") {
        if (!av && !bv) return 0;
        if (!av) return 1;
        if (!bv) return -1;
      }

      const an = av.toString().toLowerCase();
      const bn = bv.toString().toLowerCase();

      if (an < bn) return sortOrder === "asc" ? -1 : 1;
      if (an > bn) return sortOrder === "asc" ? 1 : -1;
      return 0;
    };

    list.sort((a, b) => compare(a, b, sortKey));
    return list;
  })();

  const toggleSort = (key) => {
    if (sortKey === key) {
      setSortOrder((prev) => (prev === "asc" ? "desc" : "asc"));
    } else {
      setSortKey(key);
      setSortOrder("asc");
    }
  };

  const handleExportCSV = () => {
    if (!selectedChildId) {
      alert("子どもを選択してください。");
      return;
    }
    if (sortedSongs.length === 0) {
      alert("この子どもの曲リストが空です。");
      return;
    }

    // 作曲者 → 曲名 の順
    const header = [
      "作曲者名",
      "曲名",
      "発表日",
      "発表場所",
      "メモ",
    ].join(",");

    const lines = sortedSongs.map((song) => {
      return [
        escapeCSV(song.composer),
        escapeCSV(song.title),
        escapeCSV(song.performanceDate),
        escapeCSV(song.venue),
        escapeCSV(song.memo),
      ].join(",");
    });

    const csvContent = [header, ...lines].join("\r\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    const childName =
      children.find((c) => c.id === selectedChildId)?.name ?? "unknown";

    a.href = url;
    a.download = `pocoapoco_songs_${childName}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const handleImportCSV = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (!selectedChildId) {
      alert("子どもを選択してください。");
      return;
    }

    const text = await file.text();
    const lines = text.split(/\r?\n/).filter((line) => line.trim() !== "");
    if (lines.length <= 1) {
      alert("有効なデータ行がありません。");
      e.target.value = "";
      return;
    }

    const header = parseCSVLine(lines[0]);
    if (header.length < 5) {
      alert("ヘッダー行の形式が想定と異なります。");
      e.target.value = "";
      return;
    }

    const importedSongs = [];

    for (let i = 1; i < lines.length; i++) {
      const cols = parseCSVLine(lines[i]);
      if (cols.length < 5) continue;

      // 作曲者, 曲名, 発表日, 発表場所, メモ
      const [c, t, d, v, m] = cols;
      if (!t.trim() && !c.trim()) continue;

      importedSongs.push({
        id: Date.now() + i,
        childId: selectedChildId,
        title: t.trim(),
        composer: c.trim(),
        performanceDate: d.trim(),
        venue: v.trim(),
        memo: m.trim(),
      });
    }

    if (importedSongs.length === 0) {
      alert("取り込める曲データがありませんでした。");
      e.target.value = "";
      return;
    }

    const newSongsByChild = { ...songsByChild };
    const list = newSongsByChild[selectedChildId] ?? [];
    newSongsByChild[selectedChildId] = [...importedSongs, ...list];

    setSongsByChild(newSongsByChild);
    if (typeof window !== "undefined") {
      window.localStorage.setItem(
        STORAGE_KEY,
        JSON.stringify(newSongsByChild)
      );
    }

    e.target.value = "";
    alert(`曲データを ${importedSongs.length} 件インポートしました。`);
  };

  const handleGoToNew = () => {
    router.push(`/songs/new?childId=${encodeURIComponent(selectedChildId)}`);
  };

  const handleEdit = (song) => {
    router.push(
      `/songs/edit?id=${encodeURIComponent(
        song.id
      )}&childId=${encodeURIComponent(selectedChildId)}`
    );
  };

  const card = {
    backgroundColor: "#ffffff",
    borderRadius: "16px",
    padding: "16px",
    marginBottom: "16px",
    boxShadow: "0 4px 10px rgba(0,0,0,0.03)",
  };

  const controlButton = {
    borderRadius: "999px",
    border: "1px solid #ddd",
    padding: "8px 14px",
    fontSize: "13px",
    fontWeight: 500,
    background: "#fafafa",
    color: "#555",
    cursor: "pointer",
    whiteSpace: "nowrap",
  };

  const primaryButton = {
    ...controlButton,
    border: "none",
    background:
      "linear-gradient(135deg, rgba(186,104,200,1), rgba(103,58,183,1))",
    color: "#fff",
    fontWeight: 600,
  };

  const sortHeaderStyle = (key) => ({
    background: "transparent",
    border: "none",
    padding: 0,
    margin: 0,
    fontSize: "12px",
    fontWeight: 600,
    cursor: "pointer",
    color: "#555",
    display: "inline-flex",
    alignItems: "center",
    gap: "2px",
  });

  const sortArrow = (key) => {
    if (sortKey !== key) return "";
    return sortOrder === "asc" ? "▲" : "▼";
  };

  return (
    <div style={{ padding: "16px 16px 24px" }}>
      {/* 上部カード：名前選択＋操作ボタン */}
      <div style={card}>
        <div
          style={{
            display: "flex",
            flexWrap: "wrap",
            gap: "8px",
            alignItems: "center",
          }}
        >
          <select
            value={selectedChildId}
            onChange={(e) => setSelectedChildId(e.target.value)}
            style={{
              borderRadius: "999px",
              border: "1px solid #ddd",
              padding: "8px 14px",
              fontSize: "13px",
              background: "#fff",
              minWidth: "120px",
            }}
          >
            {children.map((child) => (
              <option key={child.id} value={child.id}>
                {child.name}
              </option>
            ))}
          </select>

          <button type="button" onClick={handleExportCSV} style={controlButton}>
            CSV出力
          </button>

          <label
            style={{
              ...controlButton,
              display: "inline-flex",
              alignItems: "center",
              gap: "6px",
            }}
          >
            <span>CSV取込</span>
            <input
              type="file"
              accept=".csv,text/csv"
              onChange={handleImportCSV}
              style={{ display: "none" }}
            />
          </label>

          <button type="button" onClick={handleGoToNew} style={primaryButton}>
            リスト追加
          </button>
        </div>
      </div>

      {/* 一覧 */}
      <div style={card}>
        <h2
          style={{
            fontSize: "14px",
            fontWeight: 700,
            marginBottom: "8px",
          }}
        >
          登録済みの曲（
          {children.find((c) => c.id === selectedChildId)?.name ?? "選択なし"}
          ）
        </h2>

        {sortedSongs.length === 0 ? (
          <p style={{ fontSize: "12px", color: "#888" }}>
            まだ曲が登録されていません。「リスト追加」から新しい曲を登録できます。
          </p>
        ) : (
          <div style={{ overflowX: "auto" }}>
            <table
              style={{
                width: "100%",
                borderCollapse: "collapse",
                fontSize: "12px",
              }}
            >
              <thead>
                <tr style={{ backgroundColor: "#faf5ff" }}>
                  <th
                    style={{
                      borderBottom: "1px solid #eee",
                      padding: "6px 4px",
                      textAlign: "left",
                    }}
                  >
                    <button
                      type="button"
                      style={sortHeaderStyle("composer")}
                      onClick={() => toggleSort("composer")}
                    >
                      <span>作曲者名</span>
                      <span>{sortArrow("composer")}</span>
                    </button>
                  </th>
                  <th
                    style={{
                      borderBottom: "1px solid #eee",
                      padding: "6px 4px",
                      textAlign: "left",
                    }}
                  >
                    <button
                      type="button"
                      style={sortHeaderStyle("title")}
                      onClick={() => toggleSort("title")}
                    >
                      <span>曲名</span>
                      <span>{sortArrow("title")}</span>
                    </button>
                  </th>
                  <th
                    style={{
                      borderBottom: "1px solid #eee",
                      padding: "6px 4px",
                      textAlign: "left",
                    }}
                  >
                    <button
                      type="button"
                      style={sortHeaderStyle("date")}
                      onClick={() => toggleSort("date")}
                    >
                      <span>発表日</span>
                      <span>{sortArrow("date")}</span>
                    </button>
                  </th>
                  <th
                    style={{
                      borderBottom: "1px solid #eee",
                      padding: "6px 4px",
                      textAlign: "left",
                    }}
                  >
                    <button
                      type="button"
                      style={sortHeaderStyle("venue")}
                      onClick={() => toggleSort("venue")}
                    >
                      <span>発表場所</span>
                      <span>{sortArrow("venue")}</span>
                    </button>
                  </th>
                  <th
                    style={{
                      borderBottom: "1px solid #eee",
                      padding: "6px 4px",
                      textAlign: "left",
                    }}
                  >
                    メモ
                  </th>
                  <th
                    style={{
                      borderBottom: "1px solid #eee",
                      padding: "6px 4px",
                      textAlign: "center",
                      width: "70px",
                    }}
                  >
                    操作
                  </th>
                </tr>
              </thead>
              <tbody>
                {sortedSongs.map((song) => (
                  <tr key={song.id}>
                    <td
                      style={{
                        borderBottom: "1px solid #f2f2f2",
                        padding: "6px 4px",
                        verticalAlign: "top",
                      }}
                    >
                      {song.composer}
                    </td>
                    <td
                      style={{
                        borderBottom: "1px solid #f2f2f2",
                        padding: "6px 4px",
                        verticalAlign: "top",
                        fontWeight: 500,
                      }}
                    >
                      {song.title}
                    </td>
                    <td
                      style={{
                        borderBottom: "1px solid #f2f2f2",
                        padding: "6px 4px",
                        verticalAlign: "top",
                      }}
                    >
                      {song.performanceDate
                        ? new Date(
                            song.performanceDate
                          ).toLocaleDateString("ja-JP")
                        : ""}
                    </td>
                    <td
                      style={{
                        borderBottom: "1px solid #f2f2f2",
                        padding: "6px 4px",
                        verticalAlign: "top",
                      }}
                    >
                      {song.venue}
                    </td>
                    <td
                      style={{
                        borderBottom: "1px solid #f2f2f2",
                        padding: "6px 4px",
                        verticalAlign: "top",
                        whiteSpace: "pre-wrap",
                      }}
                    >
                      {song.memo}
                    </td>
                    <td
                      style={{
                        borderBottom: "1px solid #f2f2f2",
                        padding: "6px 4px",
                        verticalAlign: "top",
                        textAlign: "center",
                      }}
                    >
                      <button
                        type="button"
                        onClick={() => handleEdit(song)}
                        style={{
                          borderRadius: "999px",
                          border: "1px solid #c4b5fd",
                          padding: "4px 10px",
                          fontSize: "11px",
                          background: "#f5f3ff",
                          cursor: "pointer",
                        }}
                      >
                        編集
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
}
