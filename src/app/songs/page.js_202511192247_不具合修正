// src/app/songs/page.js
"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";

// 仮の子どもデータ（実アプリでは既存データから取得）
const initialChildren = [
  { id: "child1", name: "ゆくも" },
  { id: "child2", name: "あまね" },
];

const STORAGE_KEY = "pocoapoco_songs_by_child";

const escapeCSV = (value) => {
  const v = value ?? "";
  return `"${v.replace(/"/g, '""')}"`;
};

const parseCSVLine = (line) => {
  const result = [];
  let current = "";
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];

    if (char === '"') {
      const nextChar = line[i + 1];
      if (inQuotes && nextChar === '"') {
        current += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (char === "," && !inQuotes) {
      result.push(current);
      current = "";
    } else {
      current += char;
    }
  }
  result.push(current);
  return result.map((v) => v.trim());
};

export default function SongListPage() {
  const router = useRouter();
  const [children] = useState(initialChildren);
  const [selectedChildId, setSelectedChildId] = useState("child1");
  const [songsByChild, setSongsByChild] = useState({});

  // localStorage から読み込み
  useEffect(() => {
    if (typeof window === "undefined") return;
    const raw = window.localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try {
      const parsed = JSON.parse(raw);
      if (parsed && typeof parsed === "object") {
        setSongsByChild(parsed);
      }
    } catch (e) {
      console.error("Failed to parse songs from storage", e);
    }
  }, []);

  // 変更を保存
  useEffect(() => {
    if (typeof window === "undefined") return;
    window.localStorage.setItem(STORAGE_KEY, JSON.stringify(songsByChild));
  }, [songsByChild]);

  const currentSongs = songsByChild[selectedChildId] ?? [];

  const handleExportCSV = () => {
    if (!selectedChildId) {
      alert("子どもを選択してください。");
      return;
    }
    if (currentSongs.length === 0) {
      alert("この子どもの曲リストが空です。");
      return;
    }

    const header = ["曲名", "作曲者名", "発表日", "発表場所", "メモ"].join(
      ","
    );

    const lines = currentSongs.map((song) => {
      return [
        escapeCSV(song.title),
        escapeCSV(song.composer),
        escapeCSV(song.performanceDate),
        escapeCSV(song.venue),
        escapeCSV(song.memo),
      ].join(",");
    });

    const csvContent = [header, ...lines].join("\r\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    const childName =
      children.find((c) => c.id === selectedChildId)?.name ?? "unknown";

    a.href = url;
    a.download = `pocoapoco_songs_${childName}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const handleImportCSV = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (!selectedChildId) {
      alert("子どもを選択してください。");
      return;
    }

    const text = await file.text();
    const lines = text.split(/\r?\n/).filter((line) => line.trim() !== "");
    if (lines.length <= 1) {
      alert("有効なデータ行がありません。");
      e.target.value = "";
      return;
    }

    const header = parseCSVLine(lines[0]);
    if (header.length < 5) {
      alert("ヘッダー行の形式が想定と異なります。");
      e.target.value = "";
      return;
    }

    const importedSongs = [];

    for (let i = 1; i < lines.length; i++) {
      const cols = parseCSVLine(lines[i]);
      if (cols.length < 5) continue;

      const [t, c, d, v, m] = cols;
      if (!t.trim()) continue;

      importedSongs.push({
        id: Date.now() + i,
        childId: selectedChildId,
        title: t.trim(),
        composer: c.trim(),
        performanceDate: d.trim(),
        venue: v.trim(),
        memo: m.trim(),
      });
    }

    if (importedSongs.length === 0) {
      alert("取り込める曲データがありませんでした。");
      e.target.value = "";
      return;
    }

    setSongsByChild((prev) => {
      const list = prev[selectedChildId] ?? [];
      return {
        ...prev,
        [selectedChildId]: [...importedSongs, ...list],
      };
    });

    e.target.value = "";
    alert(`曲データを ${importedSongs.length} 件インポートしました。`);
  };

  const handleGoToNew = () => {
    router.push(`/songs/new?childId=${selectedChildId}`);
  };

  const sectionCard = {
    backgroundColor: "#ffffff",
    borderRadius: "16px",
    padding: "16px",
    marginBottom: "16px",
    boxShadow: "0 4px 10px rgba(0,0,0,0.03)",
  };

  const labelStyle = {
    display: "block",
    fontSize: "12px",
    fontWeight: 600,
    marginBottom: "4px",
    color: "#555",
  };

  const buttonPrimary = {
    borderRadius: "999px",
    border: "none",
    padding: "8px 16px",
    fontSize: "13px",
    fontWeight: 600,
    background:
      "linear-gradient(135deg, rgba(186,104,200,1), rgba(103,58,183,1))",
    color: "#fff",
    cursor: "pointer",
  };

  const buttonSecondary = {
    borderRadius: "999px",
    border: "1px solid #ccc",
    padding: "8px 16px",
    fontSize: "13px",
    fontWeight: 500,
    background: "#fafafa",
    color: "#555",
    cursor: "pointer",
  };

  return (
    <div style={{ padding: "16px 16px 24px" }}>
      <h1
        style={{
          fontSize: "18px",
          fontWeight: 700,
          marginBottom: "4px",
        }}
      >
        曲名リスト
      </h1>
      <p
        style={{
          fontSize: "12px",
          color: "#777",
          marginBottom: "16px",
        }}
      >
        発表会やコンクールで弾いた曲を、子どもごとに記録できます。
      </p>

      {/* 子ども選択＋CSV＋リストを追加 */}
      <div style={{ ...sectionCard }}>
        <div
          style={{
            display: "flex",
            flexWrap: "wrap",
            gap: "12px",
            alignItems: "center",
            marginBottom: "12px",
          }}
        >
          <div>
            <span style={labelStyle}>表示する子ども</span>
            <select
              value={selectedChildId}
              onChange={(e) => setSelectedChildId(e.target.value)}
              style={{
                width: "160px",
                borderRadius: "10px",
                border: "1px solid #ddd",
                padding: "8px 10px",
                fontSize: "13px",
              }}
            >
              {children.map((child) => (
                <option key={child.id} value={child.id}>
                  {child.name}
                </option>
              ))}
            </select>
          </div>

          <div
            style={{
              display: "flex",
              gap: "8px",
              flexWrap: "wrap",
              marginLeft: "auto",
            }}
          >
            <button
              type="button"
              onClick={handleExportCSV}
              style={buttonSecondary}
            >
              CSVエクスポート
            </button>

            <label
              style={{
                ...buttonSecondary,
                display: "inline-flex",
                alignItems: "center",
                gap: "6px",
              }}
            >
              <span>CSVインポート</span>
              <input
                type="file"
                accept=".csv,text/csv"
                onChange={handleImportCSV}
                style={{ display: "none" }}
              />
            </label>

            {/* ここが新しい「リストを追加」ボタン */}
            <button type="button" onClick={handleGoToNew} style={buttonPrimary}>
              リストを追加
            </button>
          </div>
        </div>

        <p style={{ fontSize: "11px", color: "#999" }}>
          ※ CSVのヘッダー例：曲名, 作曲者名, 発表日, 発表場所, メモ
        </p>
      </div>

      {/* 一覧 */}
      <div style={sectionCard}>
        <h2
          style={{
            fontSize: "14px",
            fontWeight: 700,
            marginBottom: "8px",
          }}
        >
          登録済みの曲（
          {children.find((c) => c.id === selectedChildId)?.name ?? "選択なし"}
          ）
        </h2>

        {currentSongs.length === 0 ? (
          <p style={{ fontSize: "12px", color: "#888" }}>
            まだ曲が登録されていません。「リストを追加」から新しい曲を登録できます。
          </p>
        ) : (
          <div style={{ overflowX: "auto" }}>
            <table
              style={{
                width: "100%",
                borderCollapse: "collapse",
                fontSize: "12px",
              }}
            >
              <thead>
                <tr style={{ backgroundColor: "#faf5ff" }}>
                  <th
                    style={{
                      borderBottom: "1px solid #eee",
                      padding: "6px 4px",
                      textAlign: "left",
                    }}
                  >
                    曲名
                  </th>
                  <th
                    style={{
                      borderBottom: "1px solid #eee",
                      padding: "6px 4px",
                      textAlign: "left",
                    }}
                  >
                    作曲者名
                  </th>
                  <th
                    style={{
                      borderBottom: "1px solid #eee",
                      padding: "6px 4px",
                      textAlign: "left",
                    }}
                  >
                    発表日
                  </th>
                  <th
                    style={{
                      borderBottom: "1px solid #eee",
                      padding: "6px 4px",
                      textAlign: "left",
                    }}
                  >
                    発表場所
                  </th>
                  <th
                    style={{
                      borderBottom: "1px solid #eee",
                      padding: "6px 4px",
                      textAlign: "left",
                    }}
                  >
                    メモ
                  </th>
                </tr>
              </thead>
              <tbody>
                {currentSongs.map((song) => (
                  <tr key={song.id}>
                    <td
                      style={{
                        borderBottom: "1px solid #f2f2f2",
                        padding: "6px 4px",
                        verticalAlign: "top",
                        fontWeight: 500,
                      }}
                    >
                      {song.title}
                    </td>
                    <td
                      style={{
                        borderBottom: "1px solid #f2f2f2",
                        padding: "6px 4px",
                        verticalAlign: "top",
                      }}
                    >
                      {song.composer}
                    </td>
                    <td
                      style={{
                        borderBottom: "1px solid #f2f2f2",
                        padding: "6px 4px",
                        verticalAlign: "top",
                      }}
                    >
                      {song.performanceDate
                        ? new Date(
                            song.performanceDate
                          ).toLocaleDateString("ja-JP")
                        : ""}
                    </td>
                    <td
                      style={{
                        borderBottom: "1px solid #f2f2f2",
                        padding: "6px 4px",
                        verticalAlign: "top",
                      }}
                    >
                      {song.venue}
                    </td>
                    <td
                      style={{
                        borderBottom: "1px solid #f2f2f2",
                        padding: "6px 4px",
                        verticalAlign: "top",
                        whiteSpace: "pre-wrap",
                      }}
                    >
                      {song.memo}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
}
