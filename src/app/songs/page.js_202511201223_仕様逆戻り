"use client";

import { useEffect, useRef, useState } from "react";

export default function SongListPage() {
  // 子ども関連
  const [children, setChildren] = useState([]);
  const [currentChildId, setCurrentChildId] = useState("");

  // 曲データ（childId -> songs[]）
  const [songsByChild, setSongsByChild] = useState({});

  // ソート状態
  const [sortKey, setSortKey] = useState("date"); // "date" | "title" | "composer" | "place"
  const [sortOrder, setSortOrder] = useState("asc"); // "asc" | "desc"

  // CSV取込
  const fileInputRef = useRef(null);

  // 初期ロード
  useEffect(() => {
    // 子ども一覧
    try {
      const rawChildren = localStorage.getItem("pocopoco_children");
      if (rawChildren) {
        const arr = JSON.parse(rawChildren);
        if (Array.isArray(arr)) {
          setChildren(arr);
          // 表示子ども
          const savedCurrent = localStorage.getItem("pocopoco_current_child_id");
          if (savedCurrent && arr.find((c) => c.id === savedCurrent)) {
            setCurrentChildId(savedCurrent);
          } else if (arr.length > 0) {
            setCurrentChildId(arr[0].id);
          }
        }
      }
    } catch (e) {
      console.warn("children load error", e);
    }

    // 曲データ
    try {
      const rawSongs = localStorage.getItem("pocopoco_songs");
      if (rawSongs) {
        const obj = JSON.parse(rawSongs);
        if (obj && typeof obj === "object") {
          setSongsByChild(obj);
        }
      }
    } catch (e) {
      console.warn("songs load error", e);
    }
  }, []);

  // 現在の子ども
  const currentChild = children.find((c) => c.id === currentChildId) || null;

  // 現在の子の曲一覧
  const currentSongs = Array.isArray(songsByChild[currentChildId])
    ? [...songsByChild[currentChildId]]
    : [];

  // ソート処理
  const sortedSongs = currentSongs.sort((a, b) => {
    const va = a || {};
    const vb = b || {};
    let x = "";
    let y = "";

    switch (sortKey) {
      case "title":
        x = va.title || "";
        y = vb.title || "";
        return sortOrder === "asc"
          ? x.localeCompare(y)
          : y.localeCompare(x);
      case "composer":
        x = va.composer || "";
        y = vb.composer || "";
        return sortOrder === "asc"
          ? x.localeCompare(y)
          : y.localeCompare(x);
      case "place":
        x = va.place || "";
        y = vb.place || "";
        return sortOrder === "asc"
          ? x.localeCompare(y)
          : y.localeCompare(x);
      case "date":
      default: {
        const da = va.date ? new Date(va.date).getTime() : 0;
        const db = vb.date ? new Date(vb.date).getTime() : 0;
        return sortOrder === "asc" ? da - db : db - da;
      }
    }
  });

  // ソート切替
  const toggleSort = (key) => {
    if (sortKey === key) {
      setSortOrder((prev) => (prev === "asc" ? "desc" : "asc"));
    } else {
      setSortKey(key);
      setSortOrder("asc");
    }
  };

  const sortHeaderStyle = (key) => ({
    cursor: "pointer",
    whiteSpace: "nowrap",
    padding: "6px 8px",
    borderBottom: "1px solid #eee",
    fontWeight: sortKey === key ? "600" : "500",
    color: sortKey === key ? "#6a1b9a" : "#555",
    fontSize: "11px",
  });

  const sortIcon = (key) => {
    if (sortKey !== key) return "▽";
    return sortOrder === "asc" ? "▲" : "▼";
  };

  // 「リストに追加」ボタン
  const handleAddClick = () => {
    if (!currentChildId) {
      alert("まず 子どもを 1人以上 登録してください。");
      return;
    }
    // 既存の追加ページに合わせてパスを変えてください
    window.location.href = `/songs/new?childId=${currentChildId}`;
  };

  // 編集ボタン
  const handleEditClick = (index) => {
    if (!currentChildId) return;
    window.location.href = `/songs/edit?childId=${currentChildId}&index=${index}`;
  };

  // CSV出力
  const handleExportCsv = () => {
    if (!currentChildId) {
      alert("子どもを選択してください。");
      return;
    }
    if (sortedSongs.length === 0) {
      alert("この子の曲は まだ登録されていません。");
      return;
    }

    const header = ["composer", "title", "date", "place", "memo"];
    const lines = [header.join(",")];

    sortedSongs.forEach((s) => {
      const row = [
        (s.composer || "").replace(/,/g, " "),
        (s.title || "").replace(/,/g, " "),
        s.date || "",
        (s.place || "").replace(/,/g, " "),
        (s.memo || "").replace(/[\r\n,]/g, " "),
      ];
      lines.push(row.join(","));
    });

    const csv = lines.join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `songs_${currentChild?.name || "child"}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  // CSV取込
  const handleImportClick = () => {
    if (!currentChildId) {
      alert("子どもを選択してください。");
      return;
    }
    if (fileInputRef.current) {
      fileInputRef.current.value = "";
      fileInputRef.current.click();
    }
  };

  const handleFileChange = (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      const text = event.target?.result;
      if (typeof text !== "string") return;

      const imported = parseSongsCsv(text);
      if (imported.length === 0) {
        alert("読み込める曲データが 見つかりませんでした。");
        return;
      }

      const updated = { ...songsByChild };
      const existing = Array.isArray(updated[currentChildId])
        ? updated[currentChildId]
        : [];
      updated[currentChildId] = [...existing, ...imported];

      setSongsByChild(updated);
      try {
        localStorage.setItem("pocopoco_songs", JSON.stringify(updated));
      } catch (err) {
        console.error("failed to save songs", err);
      }

      alert(`曲を ${imported.length} 件 追加しました。`);
    };
    reader.readAsText(file, "utf-8");
  };

  return (
    <main
      style={{
        fontFamily: "system-ui, -apple-system, BlinkMacSystemFont, sans-serif",
        padding: "24px 16px 80px",
        maxWidth: "540px",
        margin: "0 auto",
      }}
    >
      {/* タイトル */}
      <header style={{ marginBottom: "16px" }}>
        <h1
          style={{
            fontSize: "20px",
            fontWeight: "600",
            color: "#4a148c",
            marginBottom: "4px",
          }}
        >
          曲リスト
        </h1>
      </header>

      {/* 上部カード（子ども選択 + CSV + 追加） */}
      <section
        style={{
          borderRadius: "16px",
          background: "#fbf7ff",
          border: "1px solid #eadfff",
          padding: "12px 14px",
          marginBottom: "16px",
        }}
      >
        {/* 1行目：子ども選択 */}
        <div
          style={{
            display: "flex",
            gap: "8px",
            alignItems: "center",
            marginBottom: "10px",
            flexWrap: "wrap",
          }}
        >
          <label
            style={{
              fontSize: "12px",
              color: "#555",
              marginRight: "4px",
            }}
          >
            子ども
          </label>
          <select
            value={currentChildId}
            onChange={(e) => setCurrentChildId(e.target.value)}
            style={{
              flex: "1",
              minWidth: "120px",
              borderRadius: "999px",
              border: "1px solid #ccc",
              padding: "6px 12px",
              fontSize: "13px",
              background: "#fff",
            }}
          >
            {children.length === 0 && (
              <option value="">子ども未登録</option>
            )}
            {children.map((c) => (
              <option key={c.id} value={c.id}>
                {c.name}
              </option>
            ))}
          </select>

          {/* CSV出力／取込／追加 */}
          <div
            style={{
              display: "flex",
              gap: "6px",
              flexWrap: "wrap",
              justifyContent: "flex-end",
            }}
          >
            <button
              type="button"
              onClick={handleExportCsv}
              style={{
                borderRadius: "999px",
                border: "1px solid #ccc",
                padding: "5px 10px",
                fontSize: "11px",
                background: "#fff",
                whiteSpace: "nowrap",
              }}
            >
              CSV出力
            </button>
            <button
              type="button"
              onClick={handleImportClick}
              style={{
                borderRadius: "999px",
                border: "1px solid #ccc",
                padding: "5px 10px",
                fontSize: "11px",
                background: "#fff",
                whiteSpace: "nowrap",
              }}
            >
              CSV取込
            </button>
            <button
              type="button"
              onClick={handleAddClick}
              style={{
                borderRadius: "999px",
                border: "none",
                padding: "5px 14px",
                fontSize: "12px",
                background: "linear-gradient(135deg, #a855f7, #ec4899)",
                color: "#fff",
                fontWeight: "600",
                whiteSpace: "nowrap",
              }}
            >
              リストに追加
            </button>
          </div>
        </div>
      </section>

      {/* 曲リスト */}
      <section>
        <h2
          style={{
            fontSize: "14px",
            marginBottom: "8px",
            color: "#4a148c",
          }}
        >
          登録済みの曲（{currentChild?.name || "―"}）
        </h2>

        {sortedSongs.length === 0 ? (
          <p
            style={{
              fontSize: "13px",
              color: "#777",
              marginTop: "6px",
            }}
          >
            この子の曲が まだ登録されていません。
            「リストに追加」ボタンから 追加してください。
          </p>
        ) : (
          <div style={{ overflowX: "auto" }}>
            <table
              style={{
                width: "100%",
                borderCollapse: "collapse",
                fontSize: "12px",
              }}
            >
              <thead>
                <tr style={{ backgroundColor: "#faf5ff" }}>
                  <th style={sortHeaderStyle("composer")}>
                    <button
                      type="button"
                      style={sortHeaderStyle("composer")}
                      onClick={() => toggleSort("composer")}
                    >
                      作曲者名 {sortIcon("composer")}
                    </button>
                  </th>
                  <th style={sortHeaderStyle("title")}>
                    <button
                      type="button"
                      style={sortHeaderStyle("title")}
                      onClick={() => toggleSort("title")}
                    >
                      曲名 {sortIcon("title")}
                    </button>
                  </th>
                  <th style={sortHeaderStyle("date")}>
                    <button
                      type="button"
                      style={sortHeaderStyle("date")}
                      onClick={() => toggleSort("date")}
                    >
                      発表日 {sortIcon("date")}
                    </button>
                  </th>
                  <th style={sortHeaderStyle("place")}>
                    <button
                      type="button"
                      style={sortHeaderStyle("place")}
                      onClick={() => toggleSort("place")}
                    >
                      発表場所
                      {sortIcon("place")}
                    </button>
                  </th>
                  <th
                    style={{
                      padding: "6px 8px",
                      borderBottom: "1px solid #eee",
                      whiteSpace: "nowrap",
                    }}
                  >
                    メモ
                  </th>
                  <th
                    style={{
                      padding: "6px 8px",
                      borderBottom: "1px solid #eee",
                      whiteSpace: "nowrap",
                    }}
                  >
                    操作
                  </th>
                </tr>
              </thead>
              <tbody>
                {sortedSongs.map((song, index) => (
                  <tr key={index}>
                    <td
                      style={{
                        padding: "6px 8px",
                        borderBottom: "1px solid #f2f2f2",
                      }}
                    >
                      {song.composer || ""}
                    </td>
                    <td
                      style={{
                        padding: "6px 8px",
                        borderBottom: "1px solid #f2f2f2",
                      }}
                    >
                      {song.title || ""}
                    </td>
                    <td
                      style={{
                        padding: "6px 8px",
                        borderBottom: "1px solid #f2f2f2",
                        whiteSpace: "nowrap",
                      }}
                    >
                      {song.date || ""}
                    </td>
                    <td
                      style={{
                        padding: "6px 8px",
                        borderBottom: "1px solid #f2f2f2",
                      }}
                    >
                      {song.place || ""}
                    </td>
                    <td
                      style={{
                        padding: "6px 8px",
                        borderBottom: "1px solid #f2f2f2",
                        maxWidth: "160px",
                        whiteSpace: "pre-wrap",
                        wordBreak: "break-word",
                      }}
                    >
                      {song.memo || ""}
                    </td>
                    <td
                      style={{
                        padding: "6px 8px",
                        borderBottom: "1px solid #f2f2f2",
                        textAlign: "center",
                      }}
                    >
                      <button
                        type="button"
                        onClick={() => handleEditClick(index)}
                        style={{
                          borderRadius: "999px",
                          border: "none",
                          padding: "4px 10px",
                          fontSize: "11px",
                          background:
                            "linear-gradient(135deg, #a855f7, #ec4899)",
                          color: "#fff",
                          fontWeight: "600",
                        }}
                      >
                        編集
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </section>

      {/* CSV入力用 hidden input */}
      <input
        ref={fileInputRef}
        type="file"
        accept=".csv,text/csv"
        style={{ display: "none" }}
        onChange={handleFileChange}
      />
    </main>
  );
}

// CSV文字列 → 曲データ配列
function parseSongsCsv(text) {
  const lines = text.split(/\r?\n/).filter((l) => l.trim() !== "");
  if (lines.length === 0) return [];

  const [headerLine, ...rows] = lines;
  const headers = headerLine.split(",").map((h) => h.trim());

  const idxComposer = headers.indexOf("composer");
  const idxTitle = headers.indexOf("title");
  const idxDate = headers.indexOf("date");
  const idxPlace = headers.indexOf("place");
  const idxMemo = headers.indexOf("memo");

  // ヘッダありパターン
  if (idxTitle !== -1 || idxComposer !== -1) {
    return rows.map((line) => {
      const cols = line.split(",");
      return {
        composer: idxComposer >= 0 ? cols[idxComposer] || "" : "",
        title: idxTitle >= 0 ? cols[idxTitle] || "" : "",
        date: idxDate >= 0 ? cols[idxDate] || "" : "",
        place: idxPlace >= 0 ? cols[idxPlace] || "" : "",
        memo: idxMemo >= 0 ? cols[idxMemo] || "" : "",
      };
    });
  }

  // 旧形式（作曲者名, 曲名, 発表日, 発表場所, メモ）として解釈
  return rows.map((line) => {
    const cols = line.split(",");
    return {
      composer: cols[0] || "",
      title: cols[1] || "",
      date: cols[2] || "",
      place: cols[3] || "",
      memo: cols[4] || "",
    };
  });
}
