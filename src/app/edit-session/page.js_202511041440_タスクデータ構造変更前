"use client";

import { useEffect, useState } from "react";
import { useSearchParams } from "next/navigation";

/**
 * /edit-session?i=3
 * i = pocopoco_history ã®é…åˆ—index
 *
 * è¦ªãƒ­ãƒƒã‚¯:
 *   - localStorage.pocopoco_parentCode ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
 *   - ãªã‘ã‚Œã° "1234" ã‚’ä»®ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã—ã¦ä½¿ã†
 */

export default function EditSessionPage() {
  const searchParams = useSearchParams();
  const indexStr = searchParams.get("i");
  const index = indexStr ? parseInt(indexStr, 10) : null;

  // ç·¨é›†å¯¾è±¡ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  const [task, setTask] = useState("");
  const [minutes, setMinutes] = useState(""); // åˆ†
  const [count, setCount] = useState("");
  const [memo, setMemo] = useState("");
  const [startedAt, setStartedAt] = useState("");

  // è¦ªã‚³ãƒ¼ãƒ‰ã®å…¥åŠ›æ¬„
  const [adminCodeInput, setAdminCodeInput] = useState("");

  // å®Ÿéš›ã«ãƒã‚§ãƒƒã‚¯ã™ã¹ãè¦ªã‚³ãƒ¼ãƒ‰ï¼ˆè¨­å®šç”»é¢ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ï¼‰
  const [requiredCode, setRequiredCode] = useState("1234");

  const [loaded, setLoaded] = useState(false);

  // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  useEffect(() => {
    // 1) è¦ªã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚€
    try {
      const stored = window.localStorage.getItem("pocopoco_parentCode");
      if (stored && /^[0-9]{4}$/.test(stored)) {
        setRequiredCode(stored);
      } else {
        setRequiredCode("1234"); // fallback
      }
    } catch (e) {
      console.error("parentCode load error", e);
      setRequiredCode("1234");
    }

    // 2) è©²å½“ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã‚€
    if (index === null || isNaN(index)) {
      setLoaded(true);
      return;
    }
    const raw = window.localStorage.getItem("pocopoco_history");
    if (!raw) {
      setLoaded(true);
      return;
    }

    try {
      const arr = JSON.parse(raw);
      const rec = arr[index];
      if (!rec) {
        setLoaded(true);
        return;
      }

      setTask(rec.task || "");
      setMinutes(String(Math.floor((rec.seconds || 0) / 60)));
      setCount(String(rec.count ?? 0));
      setMemo(rec.memo || "");
      setStartedAt(rec.startedAt || "");
    } catch (e) {
      console.error("edit load error", e);
    } finally {
      setLoaded(true);
    }
  }, [index]);

  // ä¿å­˜
  function handleSave() {
    if (adminCodeInput !== requiredCode) {
      alert("ã²ã¿ã¤ã‚³ãƒ¼ãƒ‰ãŒã¡ãŒã„ã¾ã™ã€‚");
      return;
    }

    const raw = window.localStorage.getItem("pocopoco_history");
    if (!raw) {
      alert("å…ƒãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    let arr;
    try {
      arr = JSON.parse(raw);
    } catch (e) {
      alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      return;
    }

    if (index == null || isNaN(index) || !arr[index]) {
      alert("ã“ã®è¨˜éŒ²ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
      return;
    }

    const minsNum = parseInt(minutes || "0", 10);
    const secs = minsNum * 60;
    const countNum = parseInt(count || "0", 10);

    arr[index] = {
      ...arr[index],
      task: task,
      seconds: secs,
      count: countNum,
      memo: memo,
      startedAt: startedAt || arr[index].startedAt,
    };

    window.localStorage.setItem(
      "pocopoco_history",
      JSON.stringify(arr)
    );

    alert("æ›´æ–°ã—ã¾ã—ãŸã€‚");
    window.location.href = "/history";
  }

  // å‰Šé™¤
  function handleDelete() {
    if (adminCodeInput !== requiredCode) {
      alert("ã²ã¿ã¤ã‚³ãƒ¼ãƒ‰ãŒã¡ãŒã„ã¾ã™ã€‚");
      return;
    }

    const raw = window.localStorage.getItem("pocopoco_history");
    if (!raw) {
      alert("å…ƒãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    let arr;
    try {
      arr = JSON.parse(raw);
    } catch (e) {
      alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      return;
    }

    if (index == null || isNaN(index) || !arr[index]) {
      alert("ã“ã®è¨˜éŒ²ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
      return;
    }

    arr.splice(index, 1);

    window.localStorage.setItem(
      "pocopoco_history",
      JSON.stringify(arr)
    );

    alert("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    window.location.href = "/history";
  }

  return (
    <main
      style={{
        fontFamily: "system-ui, sans-serif",
        padding: "24px 16px 80px",
        maxWidth: "480px",
        margin: "0 auto",
      }}
    >
      <h1
        style={{
          fontSize: "20px",
          fontWeight: "600",
          marginBottom: "4px",
        }}
      >
        è¨˜éŒ²ã®ç·¨é›†
      </h1>
      <div
        style={{
          fontSize: "12px",
          color: "#666",
          marginBottom: "16px",
          lineHeight: 1.5,
        }}
      >
        ãŠã†ã¡ã®ã²ã¨ ãŒ ã¤ã‹ã† ãƒšãƒ¼ã‚¸ã§ã™ã€‚
        {"\n"}
        ã“ã©ã‚‚ã¯ ã•ã‚ã‚‰ãªã„ã§ã­ã€‚
      </div>

      {!loaded && (
        <p style={{ fontSize: "14px", color: "#666" }}>èª­ã¿è¾¼ã¿ä¸­â€¦</p>
      )}

      {loaded && (index === null || isNaN(index)) && (
        <p style={{ fontSize: "14px", color: "#c00" }}>
          è¨˜éŒ²ãŒã¿ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ï¼ˆURLã« ?i=æ•°å­— ãŒå¿…è¦ã§ã™ï¼‰
        </p>
      )}

      {loaded && index !== null && !isNaN(index) && (
        <>
          {/* ã‚¿ã‚¹ã‚¯å */}
          <section
            style={{
              border: "1px solid #ddd",
              borderRadius: "10px",
              padding: "12px",
              marginBottom: "12px",
              backgroundColor: "#fff",
              boxShadow: "0 1px 2px rgba(0,0,0,0.03)",
            }}
          >
            <label
              style={{
                display: "block",
                fontSize: "14px",
                fontWeight: "600",
                marginBottom: "4px",
              }}
            >
              ã‚¿ã‚¹ã‚¯åï¼ˆä¾‹ï¼šãƒã‚¤ã‚ªãƒªãƒ³ï¼‰
            </label>
            <input
              value={task}
              onChange={(e) => setTask(e.target.value)}
              style={{
                width: "100%",
                border: "1px solid #bbb",
                borderRadius: "8px",
                fontSize: "14px",
                padding: "8px 10px",
              }}
            />
          </section>

          {/* æ™‚é–“ï¼ˆåˆ†ï¼‰ */}
          <section
            style={{
              border: "1px solid #ddd",
              borderRadius: "10px",
              padding: "12px",
              marginBottom: "12px",
              backgroundColor: "#fff",
              boxShadow: "0 1px 2px rgba(0,0,0,0.03)",
            }}
          >
            <label
              style={{
                display: "block",
                fontSize: "14px",
                fontWeight: "600",
                marginBottom: "4px",
              }}
            >
              æ™‚é–“ï¼ˆåˆ†ï¼‰
            </label>
            <input
              type="number"
              min={0}
              value={minutes}
              onChange={(e) => setMinutes(e.target.value)}
              style={{
                width: "100%",
                border: "1px solid #bbb",
                borderRadius: "8px",
                fontSize: "14px",
                padding: "8px 10px",
              }}
            />
          </section>

          {/* å›æ•° */}
          <section
            style={{
              border: "1px solid #ddd",
              borderRadius: "10px",
              padding: "12px",
              marginBottom: "12px",
              backgroundColor: "#fff",
              boxShadow: "0 1px 2px rgba(0,0,0,0.03)",
            }}
          >
            <label
              style={{
                display: "block",
                fontSize: "14px",
                fontWeight: "600",
                marginBottom: "4px",
              }}
            >
              å›æ•°
            </label>
            <input
              type="number"
              min={0}
              value={count}
              onChange={(e) => setCount(e.target.value)}
              style={{
                width: "100%",
                border: "1px solid #bbb",
                borderRadius: "8px",
                fontSize: "14px",
                padding: "8px 10px",
              }}
            />
          </section>

          {/* ãƒ¡ãƒ¢ */}
          <section
            style={{
              border: "1px solid #ddd",
              borderRadius: "10px",
              padding: "12px",
              marginBottom: "12px",
              backgroundColor: "#fff",
              boxShadow: "0 1px 2px rgba(0,0,0,0.03)",
            }}
          >
            <label
              style={{
                display: "block",
                fontSize: "14px",
                fontWeight: "600",
                marginBottom: "4px",
              }}
            >
              ãƒ¡ãƒ¢
            </label>
            <textarea
              rows={3}
              value={memo}
              onChange={(e) => setMemo(e.target.value)}
              style={{
                width: "100%",
                border: "1px solid #bbb",
                borderRadius: "8px",
                fontSize: "14px",
                padding: "8px 10px",
                lineHeight: 1.4,
                resize: "vertical",
                fontFamily: "system-ui, sans-serif",
              }}
            />
          </section>

          {/* è¦ªã‚³ãƒ¼ãƒ‰ã®å…¥åŠ›æ¬„ */}
          <section
            style={{
              border: "1px solid #ddd",
              borderRadius: "10px",
              padding: "12px",
              marginBottom: "20px",
              backgroundColor: "#fff",
              boxShadow: "0 1px 2px rgba(0,0,0,0.03)",
            }}
          >
            <label
              style={{
                display: "block",
                fontSize: "14px",
                fontWeight: "600",
                marginBottom: "4px",
                color: "#c00",
              }}
            >
              ãŠã¨ãªã® ã²ã¿ã¤ã‚³ãƒ¼ãƒ‰ï¼ˆ4ã‘ãŸï¼‰
            </label>
            <input
              type="password"
              value={adminCodeInput}
              onChange={(e) => setAdminCodeInput(e.target.value)}
              placeholder="****"
              style={{
                width: "100%",
                border: "1px solid #bbb",
                borderRadius: "8px",
                fontSize: "16px",
                padding: "8px 10px",
                letterSpacing: "0.2em",
              }}
            />
            <div
              style={{
                fontSize: "11px",
                color: "#999",
                marginTop: "4px",
                lineHeight: 1.4,
              }}
            >
              ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ã—ã£ã¦ã„ã‚‹ã²ã¨ã ã‘
              ãã‚ãã‚’ ãªãŠã—ãŸã‚Š ã‘ã—ãŸã‚Š ã§ãã¾ã™ã€‚
            </div>
          </section>

          {/* ãƒœã‚¿ãƒ³è¡Œ */}
          <div
            style={{
              display: "grid",
              gridTemplateColumns: "1fr 1fr",
              gap: "12px",
              marginBottom: "24px",
            }}
          >
            <button
              onClick={handleSave}
              style={{
                background:
                  "linear-gradient(90deg, rgb(204,0,255), rgb(255,102,153))",
                color: "#fff",
                border: "none",
                borderRadius: "10px",
                fontSize: "15px",
                fontWeight: "600",
                padding: "12px",
                boxShadow: "0 4px 8px rgba(0,0,0,0.15)",
              }}
            >
              ğŸ’¾ ã»ãã‚“
            </button>

            <button
              onClick={handleDelete}
              style={{
                backgroundColor: "#aaa",
                color: "#fff",
                border: "none",
                borderRadius: "10px",
                fontSize: "15px",
                fontWeight: "600",
                padding: "12px",
              }}
            >
              ğŸ—‘ ã“ã®è¨˜éŒ²ã‚’ã‘ã™
            </button>
          </div>

          <div style={{ textAlign: "center" }}>
            <button
              onClick={() => {
                window.location.href = "/history";
              }}
              style={{
                background: "none",
                border: "none",
                color: "#666",
                fontSize: "14px",
                textDecoration: "underline",
                padding: "8px 12px",
              }}
            >
              â† å±¥æ­´ã«ã‚‚ã©ã‚‹
            </button>
          </div>
        </>
      )}
    </main>
  );
}
