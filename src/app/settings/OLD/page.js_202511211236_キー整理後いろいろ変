// src/app/settings/page.js
"use client";

import { useState, useEffect, useRef } from "react";
import { t, getLangFromStorage, setLangToStorage } from "@/app/lib/i18n";
import {
  LS_ROLE,
  LS_PARENT_CODE,
  LS_PARENT_AUTHED,
  LS_HISTORY,
  LS_TASKS,
  LS_CHILDREN,
  LS_CURRENT_CHILD_ID,
  LS_EVENTS,
  LS_EVENT_LEGACY,
  LS_CALENDAR_TASK_FILTER,
  LS_CALENDAR_SETTINGS,
  MAX_CHILDREN,
  ROUTE_LOGIN,
} from "@/app/constants";

const DEFAULT_TASKS = [
  { id: "task_violin", label: "ãƒã‚¤ã‚ªãƒªãƒ³", icon: "ğŸ»" },
  { id: "task_piano", label: "ãƒ”ã‚¢ãƒ", icon: "ğŸ¹" },
  { id: "task_solfege", label: "ã‚½ãƒ«ãƒ•ã‚§ãƒ¼ã‚¸ãƒ¥", icon: "ğŸ“" },
  { id: "task_japanese", label: "å›½èª", icon: "ğŸ“–" },
  { id: "task_math", label: "ç®—æ•°", icon: "ğŸ”¢" },
  { id: "task_english", label: "è‹±èª", icon: "ğŸ‡¬ğŸ‡§" },
  { id: "task_science", label: "ç†ç§‘", icon: "ğŸ”¬" },
  { id: "task_social", label: "ç¤¾ä¼š", icon: "ğŸŒ" },
];

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨­å®šï¼ˆãƒãƒƒã‚¸ï¼‰
// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨­å®šã‚­ãƒ¼ã¯ constants ã‹ã‚‰åˆ©ç”¨
// ï¼ˆå†…éƒ¨çš„ãªæ–‡å­—åˆ—ã¯ LS_CALENDAR_SETTINGS ã§ä¸€å…ƒç®¡ç†ï¼‰

const DEFAULT_BADGES = [
  { id: "level1", name: "å°‘ã—ã§ã‚‚ç·´ç¿’ã—ãŸæ—¥", minMinutes: 1, icon: "ğŸŒ¸" },
  { id: "level2", name: "ãŸãã•ã‚“ç·´ç¿’ï¼ˆéŠ…ï¼‰", minMinutes: 30, icon: "ğŸ¥‰" },
  { id: "level3", name: "ã‚‚ã£ã¨ãŸãã•ã‚“ï¼ˆéŠ€ï¼‰", minMinutes: 60, icon: "ğŸ¥ˆ" },
  { id: "level4", name: "ã™ã”ããŒã‚“ã°ã£ãŸï¼ˆé‡‘ï¼‰", minMinutes: 90, icon: "ğŸ¥‡" },
];

function loadCalendarSettingsFromStorage() {
  let badges = DEFAULT_BADGES;
  let firstDayOfWeek = "sun";

  try {
    const raw = localStorage.getItem(LS_CALENDAR_SETTINGS);
    if (raw) {
      const data = JSON.parse(raw);
      if (data && typeof data === "object") {
        if (data.firstDayOfWeek === "mon") {
          firstDayOfWeek = "mon";
        }
        if (Array.isArray(data.badges) && data.badges.length > 0) {
          badges = DEFAULT_BADGES.map((def) => {
            const found = data.badges.find((b) => b.id === def.id);
            return found ? { ...def, ...found } : def;
          });
        }
      }
    }
  } catch (e) {
    console.warn("calendar settings parse error", e);
  }

  return { firstDayOfWeek, badges };
}

export default function SettingsPage() {
  const [role, setRole] = useState("parent"); // "parent" | "child"
  const [parentCode, setParentCode] = useState("");
  const [parentAuthed, setParentAuthed] = useState(false);

  const [lang, setLang] = useState(getLangFromStorage());

  const [tasks, setTasks] = useState([]);
  const [children, setChildren] = useState([]);
  const [historyCount, setHistoryCount] = useState(0);

  const [calendarTaskFilter, setCalendarTaskFilter] = useState([]);
  const [calendarBadges, setCalendarBadges] = useState(DEFAULT_BADGES);

  const [firstDayOfWeek, setFirstDayOfWeek] = useState("sun");

  const [statusMsg, setStatusMsg] = useState("");
  const statusTimerRef = useRef(null);

  useEffect(() => {
    try {
      const savedRole = localStorage.getItem(LS_ROLE);
      if (savedRole === "parent" || savedRole === "child") {
        setRole(savedRole);
      }

      const savedCode = localStorage.getItem(LS_PARENT_CODE);
      if (savedCode) setParentCode(savedCode);

      // history
      const rawHistory = localStorage.getItem(LS_HISTORY);
      if (rawHistory) {
        try {
          const arr = JSON.parse(rawHistory);
          if (Array.isArray(arr)) {
            setHistoryCount(arr.length);
          }
        } catch {}
      }

      // tasks
      const rawTasks = localStorage.getItem(LS_TASKS);
      if (rawTasks) {
        try {
          const arr = JSON.parse(rawTasks);
          if (Array.isArray(arr) && arr.length > 0) {
            setTasks(arr);
          } else {
            setTasks(DEFAULT_TASKS);
          }
        } catch {
          setTasks(DEFAULT_TASKS);
        }
      } else {
        setTasks(DEFAULT_TASKS);
      }

      // children
      const rawChildren = localStorage.getItem(LS_CHILDREN);
      if (rawChildren) {
        try {
          const arr = JSON.parse(rawChildren);
          if (Array.isArray(arr)) setChildren(arr);
        } catch {}
      }

      // calendar task filter
      const rawCalTaskFilter = localStorage.getItem(
        LS_CALENDAR_TASK_FILTER
      );
      if (rawCalTaskFilter) {
        const arr = JSON.parse(rawCalTaskFilter);
        if (Array.isArray(arr)) {
          setCalendarTaskFilter(arr);
        }
      }

      // calendar settingsï¼ˆãƒãƒƒã‚¸ + é€±ã®å§‹ã¾ã‚Šï¼‰
      const { firstDayOfWeek: fd, badges } =
        loadCalendarSettingsFromStorage();
      setFirstDayOfWeek(fd);
      setCalendarBadges(badges);

      // è¦ªèªè¨¼ãƒ•ãƒ©ã‚°ï¼ˆå­ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ä½¿ç”¨ï¼‰
      const savedAuthed = localStorage.getItem(LS_PARENT_AUTHED);
      setParentAuthed(savedAuthed === "1");
    } catch (e) {
      console.warn("settings init error", e);
    }
  }, []);

  useEffect(() => {
    if (!statusMsg) return;
    if (statusTimerRef.current) {
      clearTimeout(statusTimerRef.current);
    }
    statusTimerRef.current = setTimeout(() => {
      setStatusMsg("");
    }, 3000);
  }, [statusMsg]);

  const handleRoleChange = (newRole) => {
    setRole(newRole);
    localStorage.setItem(LS_ROLE, newRole);
    if (newRole === "parent") {
      setParentAuthed(true);
      localStorage.setItem(LS_PARENT_AUTHED, "1");
    } else {
      setParentAuthed(false);
      localStorage.setItem(LS_PARENT_AUTHED, "0");
    }
    setStatusMsg("ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ");
  };

  const handleParentCodeSave = () => {
    localStorage.setItem(LS_PARENT_CODE, parentCode);
    setStatusMsg("å¤§äººã®ã²ã¿ã¤ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
  };

  const handleLangChange = (next) => {
    setLang(next);
    setLangToStorage(next);
    setStatusMsg("è¡¨ç¤ºè¨€èªã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
  };

  const handleAddTask = () => {
    const id = "task_" + Date.now().toString(36);
    const newTask = { id, label: "æ–°ã—ã„ã‚¿ã‚¹ã‚¯", icon: "â­" };
    const next = [...tasks, newTask];
    setTasks(next);
    localStorage.setItem(LS_TASKS, JSON.stringify(next));
    setStatusMsg("ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸ");
  };

  const handleTaskChange = (id, field, value) => {
    const next = tasks.map((task) =>
      task.id === id ? { ...task, [field]: value } : task
    );
    setTasks(next);
    localStorage.setItem(LS_TASKS, JSON.stringify(next));
  };

  const handleTaskDelete = (id) => {
    if (!window.confirm("ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    const next = tasks.filter((task) => task.id !== id);
    setTasks(next);
    localStorage.setItem(LS_TASKS, JSON.stringify(next));
    setStatusMsg("ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
  };

  const handleAddChild = () => {
    if (children.length >= MAX_CHILDREN) {
      setStatusMsg("ã“ã©ã‚‚ã¯5äººã¾ã§ç™»éŒ²ã§ãã¾ã™");
      return;
    }
    const id = "child_" + Date.now().toString(36);
    const newChild = {
      id,
      name: `ãŠå­ã•ã¾${children.length + 1}`,
      color: "#6366f1",
      instrument: "ğŸ»",
    };
    const next = [...children, newChild];
    setChildren(next);
    localStorage.setItem(LS_CHILDREN, JSON.stringify(next));
    setStatusMsg("ãŠå­ã•ã¾ã‚’è¿½åŠ ã—ã¾ã—ãŸ");
  };

  const handleChildChange = (id, field, value) => {
    const next = children.map((child) =>
      child.id === id ? { ...child, [field]: value } : child
    );
    setChildren(next);
    localStorage.setItem(LS_CHILDREN, JSON.stringify(next));
  };

  const handleChildDelete = (id) => {
    if (!window.confirm("ã“ã®ãŠå­ã•ã¾ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    const next = children.filter((child) => child.id !== id);
    setChildren(next);
    localStorage.setItem(LS_CHILDREN, JSON.stringify(next));

    const currentId = localStorage.getItem(LS_CURRENT_CHILD_ID);
    if (currentId && currentId === id) {
      localStorage.removeItem(LS_CURRENT_CHILD_ID);
    }

    setStatusMsg("ãŠå­ã•ã¾ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
  };

  const handleDownloadHistory = () => {
    try {
      const raw = localStorage.getItem(LS_HISTORY);
      if (!raw) {
        alert("è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
        return;
      }
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr) || arr.length === 0) {
        alert("è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
        return;
      }

      const header = [
        "childId",
        "childName",
        "taskId",
        "taskLabel",
        "songTitle",
        "minutes",
        "memo",
        "date",
        "datetime",
      ];
      const lines = [header.join(",")];

      arr.forEach((h) => {
        const row = [
          h.childId ?? "",
          (h.childName ?? "").replace(/"/g, '""'),
          h.taskId ?? "",
          (h.taskLabel ?? "").replace(/"/g, '""'),
          (h.songTitle ?? "").replace(/"/g, '""'),
          h.minutes ?? "",
          (h.memo ?? "").replace(/"/g, '""'),
          h.date ?? "",
          h.datetime ?? "",
        ];
        lines.push(
          row
            .map((v) => {
              const s = String(v ?? "");
              if (s.includes(",") || s.includes('"') || s.includes("\n")) {
                return `"${s.replace(/"/g, '""')}"`;
              }
              return s;
            })
            .join(",")
        );
      });

      const csv = "\uFEFF" + lines.join("\r\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const today = new Date().toISOString().slice(0, 10);
      a.href = url;
      a.download = `pocopoco_history_${today}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      setStatusMsg("è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ");
    } catch (e) {
      console.error(e);
      alert("CSVã®ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    }
  };

  const handleClearHistory = () => {
    if (!window.confirm("ã™ã¹ã¦ã®è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚"))
      return;
    localStorage.removeItem(LS_HISTORY);
    setHistoryCount(0);
    setStatusMsg("è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
  };

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¡¨ç¤ºã™ã‚‹ã‚¿ã‚¹ã‚¯
  const handleToggleCalendarTask = (id) => {
    if (id === "all") {
      const next =
        calendarTaskFilter.length === tasks.length
          ? []
          : tasks.map((t) => t.id);
      setCalendarTaskFilter(next);
      localStorage.setItem(
        LS_CALENDAR_TASK_FILTER,
        JSON.stringify(next)
      );
      setStatusMsg("ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¿ã‚¹ã‚¯ã‚’è¨­å®šã—ã¾ã—ãŸ");
      return;
    }
    const exists = calendarTaskFilter.includes(id);
    let next;
    if (exists) {
      next = calendarTaskFilter.filter((x) => x !== id);
    } else {
      next = [...calendarTaskFilter, id];
    }
    setCalendarTaskFilter(next);
    localStorage.setItem(LS_CALENDAR_TASK_FILTER, JSON.stringify(next));
    setStatusMsg("ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¿ã‚¹ã‚¯ã‚’è¨­å®šã—ã¾ã—ãŸ");
  };

  const handleClearCalendarTaskFilter = () => {
    setCalendarTaskFilter([]);
    localStorage.removeItem(LS_CALENDAR_TASK_FILTER);
    setStatusMsg("ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¿ã‚¹ã‚¯è¡¨ç¤ºè¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ");
  };

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ãƒãƒƒã‚¸è¨­å®šä¿å­˜
  function handleChangeBadge(id, field, value) {
    setCalendarBadges((prev) =>
      prev.map((b) =>
        b.id === id
          ? {
              ...b,
              [field]:
                field === "minMinutes"
                  ? Number(value || 0)
                  : String(value || ""),
            }
          : b
      )
    );
  }

  function handleSaveCalendarBadges() {
    const cleaned = calendarBadges.map((b) => ({
      id: b.id,
      name: b.name,
      minMinutes: Math.max(0, Number(b.minMinutes) || 0),
      icon: b.icon || "",
    }));

    let firstDayOfWeek = "sun";
    try {
      const raw = localStorage.getItem(LS_CALENDAR_SETTINGS);
      if (raw) {
        const data = JSON.parse(raw);
        if (
          data &&
          typeof data === "object" &&
          (data.firstDayOfWeek === "sun" || data.firstDayOfWeek === "mon")
        ) {
          firstDayOfWeek = data.firstDayOfWeek;
        }
      }
    } catch {
      // ignore
    }

    const toSave = { firstDayOfWeek, badges: cleaned };
    localStorage.setItem(LS_CALENDAR_SETTINGS, JSON.stringify(toSave));
    setStatusMsg("ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ãƒãƒƒã‚¸è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
  }

  function handleFirstDayChange(value) {
    setFirstDayOfWeek(value);
    try {
      const { badges } = loadCalendarSettingsFromStorage();
      const toSave = { firstDayOfWeek: value, badges };
      localStorage.setItem(LS_CALENDAR_SETTINGS, JSON.stringify(toSave));
    } catch (e) {
      console.warn("firstDayOfWeek save error", e);
    }
    setStatusMsg("ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®é€±ã®å§‹ã¾ã‚Šã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚");
  }

  function handleGoLogin() {
    localStorage.removeItem(LS_ROLE);
    localStorage.removeItem(LS_PARENT_AUTHED);
    localStorage.removeItem(LS_CURRENT_CHILD_ID);
    window.location.href = ROUTE_LOGIN;
  }

  return (
    <main
      style={{
        fontFamily: "system-ui, sans-serif",
        padding: "16px",
        maxWidth: "960px",
        margin: "0 auto",
      }}
    >
      <h1 style={{ fontSize: "20px", fontWeight: 700, marginBottom: "12px" }}>
        è¨­å®š
      </h1>

      {statusMsg && (
        <div
          style={{
            marginBottom: "12px",
            padding: "8px 12px",
            borderRadius: "999px",
            backgroundColor: "#eef2ff",
            color: "#3730a3",
            fontSize: "13px",
          }}
        >
          {statusMsg}
        </div>
      )}

      {/* ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆï¼‹ãƒ­ã‚°ã‚¤ãƒ³ã«æˆ»ã‚‹ */}
      <section
        style={{
          marginBottom: "16px",
          padding: "12px",
          borderRadius: "12px",
          border: "1px solid #e5e7eb",
          backgroundColor: "#fff",
          display: "flex",
          alignItems: "center",
          gap: "12px",
          justifyContent: "space-between",
        }}
      >
        <div>
          <div style={{ fontSize: "13px", marginBottom: "4px" }}>
            ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
          </div>
          <div>
            <button
              type="button"
              onClick={() => handleRoleChange("parent")}
              style={{
                padding: "6px 12px",
                borderRadius: "999px",
                border: "1px solid #e5e7eb",
                marginRight: "8px",
                backgroundColor: role === "parent" ? "#4f46e5" : "#fff",
                color: role === "parent" ? "#fff" : "#111827",
                fontSize: "13px",
              }}
            >
              ãŠã¨ãªãƒ¢ãƒ¼ãƒ‰
            </button>
            <button
              type="button"
              onClick={() => handleRoleChange("child")}
              style={{
                padding: "6px 12px",
                borderRadius: "999px",
                border: "1px solid #e5e7eb",
                backgroundColor: role === "child" ? "#4f46e5" : "#fff",
                color: role === "child" ? "#fff" : "#111827",
                fontSize: "13px",
              }}
            >
              ã“ã©ã‚‚ãƒ¢ãƒ¼ãƒ‰
            </button>
          </div>
        </div>

        <div>
          <button
            type="button"
            onClick={handleGoLogin}
            style={{
              padding: "6px 12px",
              borderRadius: "999px",
              border: "1px solid #e5e7eb",
              backgroundColor: "#fff",
              fontSize: "13px",
            }}
          >
            ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ã‚‚ã©ã‚‹
          </button>
        </div>
      </section>

      {/* è¡¨ç¤ºè¨€èªï¼‹å¤§äººã®ç§˜å¯†ã‚³ãƒ¼ãƒ‰ */}
      <section
        style={{
          marginBottom: "16px",
          padding: "12px",
          borderRadius: "12px",
          border: "1px solid #e5e7eb",
          backgroundColor: "#fff",
          display: "grid",
          gridTemplateColumns: "1fr 1fr",
          gap: "12px",
        }}
      >
        <div>
          <div style={{ fontSize: "13px", marginBottom: "4px" }}>
            è¡¨ç¤ºè¨€èª
          </div>
          <select
            value={lang}
            onChange={(e) => handleLangChange(e.target.value)}
            style={{
              width: "100%",
              padding: "6px 8px",
              borderRadius: "8px",
              border: "1px solid #d1d5db",
              fontSize: "13px",
            }}
          >
            <option value="jp">æ—¥æœ¬èª</option>
            <option value="hiragana">ã«ã»ã‚“ã”ï¼ˆã²ã‚‰ãŒãªï¼‰</option>
            <option value="en">English</option>
          </select>
        </div>

        <div>
          <div style={{ fontSize: "13px", marginBottom: "4px" }}>
            å¤§äººã®ã²ã¿ã¤ã‚³ãƒ¼ãƒ‰
          </div>
          <div style={{ display: "flex", gap: "8px" }}>
            <input
              type="password"
              value={parentCode}
              onChange={(e) => setParentCode(e.target.value)}
              style={{
                flex: 1,
                padding: "6px 8px",
                borderRadius: "8px",
                border: "1px solid #d1d5db",
                fontSize: "13px",
              }}
            />
            <button
              type="button"
              onClick={handleParentCodeSave}
              style={{
                padding: "6px 10px",
                borderRadius: "999px",
                border: "none",
                backgroundColor: "#6366f1",
                color: "#fff",
                fontSize: "13px",
              }}
            >
              ä¿å­˜
            </button>
          </div>
          <div style={{ fontSize: "11px", color: "#6b7280", marginTop: "4px" }}>
            â€» ã“ã©ã‚‚ãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰ãŠã¨ãªãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚‹ã¨ãã«ä½¿ã„ã¾ã™
          </div>
        </div>
      </section>

      {/* ã‚¿ã‚¹ã‚¯è¨­å®š */}
      <section
        style={{
          marginBottom: "16px",
          padding: "12px",
          borderRadius: "12px",
          border: "1px solid #e5e7eb",
          backgroundColor: "#fff",
        }}
      >
        <div style={{ display: "flex", justifyContent: "space-between" }}>
          <h2
            style={{
              fontSize: "14px",
              fontWeight: 600,
              marginBottom: "8px",
            }}
          >
            ã‚¿ã‚¹ã‚¯ã®è¨­å®š
          </h2>
          <button
            type="button"
            onClick={handleAddTask}
            style={{
              padding: "4px 10px",
              borderRadius: "999px",
              border: "1px solid #e5e7eb",
              backgroundColor: "#fff",
              fontSize: "12px",
            }}
          >
            ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
          </button>
        </div>

        <table
          style={{
            width: "100%",
            borderCollapse: "collapse",
            fontSize: "12px",
            marginTop: "4px",
          }}
        >
          <thead>
            <tr>
              <th
                style={{
                  textAlign: "left",
                  padding: "4px",
                  borderBottom: "1px solid #e5e7eb",
                }}
              >
                ã‚¢ã‚¤ã‚³ãƒ³
              </th>
              <th
                style={{
                  textAlign: "left",
                  padding: "4px",
                  borderBottom: "1px solid #e5e7eb",
                }}
              >
                åå‰
              </th>
              <th
                style={{
                  width: "60px",
                  textAlign: "center",
                  padding: "4px",
                  borderBottom: "1px solid #e5e7eb",
                }}
              >
                å‰Šé™¤
              </th>
            </tr>
          </thead>
          <tbody>
            {tasks.map((task) => (
              <tr key={task.id}>
                <td style={{ padding: "4px" }}>
                  <input
                    type="text"
                    value={task.icon}
                    onChange={(e) =>
                      handleTaskChange(task.id, "icon", e.target.value)
                    }
                    style={{
                      width: "40px",
                      textAlign: "center",
                      fontSize: "18px",
                    }}
                  />
                </td>
                <td style={{ padding: "4px" }}>
                  <input
                    type="text"
                    value={task.label}
                    onChange={(e) =>
                      handleTaskChange(task.id, "label", e.target.value)
                    }
                    style={{
                      width: "100%",
                      padding: "4px 6px",
                      borderRadius: "6px",
                      border: "1px solid #d1d5db",
                    }}
                  />
                </td>
                <td style={{ textAlign: "center", padding: "4px" }}>
                  <button
                    type="button"
                    onClick={() => handleTaskDelete(task.id)}
                    style={{
                      padding: "2px 8px",
                      borderRadius: "999px",
                      border: "none",
                      backgroundColor: "#fee2e2",
                      color: "#b91c1c",
                      fontSize: "11px",
                    }}
                  >
                    å‰Šé™¤
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>

        <div
          style={{ fontSize: "11px", color: "#6b7280", marginTop: "4px" }}
        >
          â€» è¡¨ç¤ºé †ã¯ã“ã“ã§ä¸¦ã‚“ã§ã„ã‚‹é †ã«ãªã‚Šã¾ã™
        </div>
      </section>

      {/* ãŠå­ã•ã¾è¨­å®š */}
      <section
        style={{
          marginBottom: "16px",
          padding: "12px",
          borderRadius: "12px",
          border: "1px solid #e5e7eb",
          backgroundColor: "#fff",
        }}
      >
        <div style={{ display: "flex", justifyContent: "space-between" }}>
          <h2
            style={{
              fontSize: "14px",
              fontWeight: 600,
              marginBottom: "8px",
            }}
          >
            ãŠå­ã•ã¾ã®è¨­å®š
          </h2>
          <button
            type="button"
            onClick={handleAddChild}
            style={{
              padding: "4px 10px",
              borderRadius: "999px",
              border: "1px solid #e5e7eb",
              backgroundColor: "#fff",
              fontSize: "12px",
            }}
          >
            ãŠå­ã•ã¾ã‚’è¿½åŠ 
          </button>
        </div>

        {children.length === 0 && (
          <div style={{ fontSize: "12px", color: "#6b7280" }}>
            ã¾ãšã¯ãŠå­ã•ã¾ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„
          </div>
        )}

        {children.map((child) => (
          <div
            key={child.id}
            style={{
              display: "flex",
              alignItems: "center",
              gap: "8px",
              marginBottom: "6px",
            }}
          >
            <input
              type="text"
              value={child.name}
              onChange={(e) =>
                handleChildChange(child.id, "name", e.target.value)
              }
              style={{
                flex: 1,
                padding: "4px 6px",
                borderRadius: "6px",
                border: "1px solid #d1d5db",
                fontSize: "13px",
              }}
            />
            <input
              type="text"
              value={child.instrument || "ğŸ»"}
              onChange={(e) =>
                handleChildChange(child.id, "instrument", e.target.value)
              }
              style={{
                width: "40px",
                textAlign: "center",
                fontSize: "18px",
              }}
            />
            <input
              type="color"
              value={child.color || "#6366f1"}
              onChange={(e) =>
                handleChildChange(child.id, "color", e.target.value)
              }
              style={{ width: "40px", height: "24px" }}
            />
            <button
              type="button"
              onClick={() => handleChildDelete(child.id)}
              style={{
                padding: "2px 8px",
                borderRadius: "999px",
                border: "none",
                backgroundColor: "#fee2e2",
                color: "#b91c1c",
                fontSize: "11px",
              }}
            >
              å‰Šé™¤
            </button>
          </div>
        ))}

        <div
          style={{ fontSize: "11px", color: "#6b7280", marginTop: "4px" }}
        >
          â€» ã“ã©ã‚‚ã¯æœ€å¤§5äººã¾ã§ç™»éŒ²ã§ãã¾ã™
        </div>
      </section>

      {/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¡¨ç¤ºã™ã‚‹ã‚¿ã‚¹ã‚¯ */}
      <section
        style={{
          marginBottom: "16px",
          padding: "12px",
          borderRadius: "12px",
          border: "1px solid #e5e7eb",
          backgroundColor: "#fff",
        }}
      >
        <h2
          style={{
            fontSize: "14px",
            fontWeight: 600,
            marginBottom: "8px",
          }}
        >
          ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¡¨ç¤ºã™ã‚‹ã‚¿ã‚¹ã‚¯
        </h2>

        <div
          style={{
            display: "flex",
            flexWrap: "wrap",
            gap: "6px",
            fontSize: "12px",
          }}
        >
          <button
            type="button"
            onClick={() => handleToggleCalendarTask("all")}
            style={{
              padding: "4px 10px",
              borderRadius: "999px",
              border: "1px solid #e5e7eb",
              backgroundColor:
                calendarTaskFilter.length === tasks.length
                  ? "#4f46e5"
                  : "#fff",
              color:
                calendarTaskFilter.length === tasks.length
                  ? "#fff"
                  : "#111827",
            }}
          >
            ã™ã¹ã¦
          </button>

          {tasks.map((task) => {
            const active = calendarTaskFilter.includes(task.id);
            return (
              <button
                key={task.id}
                type="button"
                onClick={() => handleToggleCalendarTask(task.id)}
                style={{
                  padding: "4px 10px",
                  borderRadius: "999px",
                  border: "1px solid #e5e7eb",
                  backgroundColor: active ? "#4f46e5" : "#fff",
                  color: active ? "#fff" : "#111827",
                }}
              >
                {task.icon} {task.label}
              </button>
            );
          })}
        </div>

        <div style={{ marginTop: "8px" }}>
          <button
            type="button"
            onClick={handleClearCalendarTaskFilter}
            style={{
              padding: "4px 10px",
              borderRadius: "999px",
              border: "none",
              backgroundColor: "#f3f4f6",
              fontSize: "12px",
            }}
          >
            è¨­å®šã‚’ã‚¯ãƒªã‚¢
          </button>
        </div>
      </section>

      {/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ãƒãƒƒã‚¸ï¼‹é€±ã®å§‹ã¾ã‚Š */}
      <section
        style={{
          marginBottom: "16px",
          padding: "12px",
          borderRadius: "12px",
          border: "1px solid #e5e7eb",
          backgroundColor: "#fff",
        }}
      >
        <h2
          style={{
            fontSize: "14px",
            fontWeight: 600,
            marginBottom: "8px",
          }}
        >
          ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨­å®š
        </h2>

        <div style={{ marginBottom: "12px", fontSize: "13px" }}>
          <div style={{ marginBottom: "4px" }}>é€±ã®å§‹ã¾ã‚Š</div>
          <label style={{ marginRight: "12px" }}>
            <input
              type="radio"
              name="firstDayOfWeek"
              value="sun"
              checked={firstDayOfWeek === "sun"}
              onChange={() => handleFirstDayChange("sun")}
            />{" "}
            æ—¥æ›œã¯ã˜ã¾ã‚Š
          </label>
          <label>
            <input
              type="radio"
              name="firstDayOfWeek"
              value="mon"
              checked={firstDayOfWeek === "mon"}
              onChange={() => handleFirstDayChange("mon")}
            />{" "}
            æœˆæ›œã¯ã˜ã¾ã‚Š
          </label>
        </div>

        <div style={{ fontSize: "13px" }}>
          <div style={{ marginBottom: "4px" }}>
            æ—¥ã”ã¨ã®åˆè¨ˆç·´ç¿’æ™‚é–“ã«å¿œã˜ã¦è¡¨ç¤ºã™ã‚‹ãƒãƒ¼ã‚¯
          </div>
          <table
            style={{
              width: "100%",
              borderCollapse: "collapse",
              marginTop: "4px",
              fontSize: "12px",
            }}
          >
            <thead>
              <tr>
                <th
                  style={{
                    textAlign: "left",
                    padding: "4px",
                    borderBottom: "1px solid #e5e7eb",
                  }}
                >
                  åå‰
                </th>
                <th
                  style={{
                    textAlign: "right",
                    padding: "4px",
                    borderBottom: "1px solid #e5e7eb",
                    width: "80px",
                  }}
                >
                  ä½•åˆ†ä»¥ä¸Š
                </th>
                <th
                  style={{
                    textAlign: "left",
                    padding: "4px",
                    borderBottom: "1px solid #e5e7eb",
                    width: "70px",
                  }}
                >
                  ãƒãƒ¼ã‚¯
                </th>
              </tr>
            </thead>
            <tbody>
              {calendarBadges.map((b) => (
                <tr key={b.id}>
                  <td style={{ padding: "4px" }}>{b.name}</td>
                  <td style={{ padding: "4px", textAlign: "right" }}>
                    <input
                      type="number"
                      min={0}
                      value={b.minMinutes}
                      onChange={(e) =>
                        handleChangeBadge(b.id, "minMinutes", e.target.value)
                      }
                      style={{
                        width: "60px",
                        fontSize: "12px",
                        padding: "2px 4px",
                      }}
                    />{" "}
                    åˆ†
                  </td>
                  <td style={{ padding: "4px" }}>
                    <input
                      type="text"
                      value={b.icon}
                      onChange={(e) =>
                        handleChangeBadge(b.id, "icon", e.target.value)
                      }
                      style={{
                        width: "50px",
                        fontSize: "16px",
                        textAlign: "center",
                      }}
                    />
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
          <div
            style={{
              fontSize: "11px",
              color: "#6b7280",
              marginTop: "4px",
            }}
          >
            â€» ã‚‚ã£ã¨ã‚‚å¤§ãã„ã€Œä½•åˆ†ä»¥ä¸Šã€ã‚’æº€ãŸã—ãŸãƒãƒ¼ã‚¯ã ã‘è¡¨ç¤ºã•ã‚Œã¾ã™
          </div>
        </div>

        <button
          type="button"
          onClick={handleSaveCalendarBadges}
          style={{
            marginTop: "12px",
            padding: "8px 16px",
            borderRadius: "999px",
            backgroundColor: "#6366f1",
            color: "#fff",
            border: "none",
            fontSize: "13px",
            fontWeight: 600,
          }}
        >
          ãƒãƒƒã‚¸è¨­å®šã‚’ä¿å­˜
        </button>
      </section>

      {/* è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ */}
      <section
        style={{
          marginBottom: "16px",
          padding: "12px",
          borderRadius: "12px",
          border: "1px solid #e5e7eb",
          backgroundColor: "#fff",
        }}
      >
        <h2
          style={{
            fontSize: "14px",
            fontWeight: 600,
            marginBottom: "8px",
          }}
        >
          è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿
        </h2>

        <div style={{ fontSize: "13px", marginBottom: "4px" }}>
          ç¾åœ¨ã®è¨˜éŒ²ä»¶æ•°ï¼š{historyCount} ä»¶
        </div>

        <div style={{ display: "flex", gap: "8px", flexWrap: "wrap" }}>
          <button
            type="button"
            onClick={handleDownloadHistory}
            style={{
              padding: "6px 12px",
              borderRadius: "999px",
              border: "1px solid #e5e7eb",
              backgroundColor: "#fff",
              fontSize: "12px",
            }}
          >
            CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          </button>

          <button
            type="button"
            onClick={handleClearHistory}
            style={{
              padding: "6px 12px",
              borderRadius: "999px",
              border: "none",
              backgroundColor: "#fee2e2",
              color: "#b91c1c",
              fontSize: "12px",
            }}
          >
            ã™ã¹ã¦å‰Šé™¤
          </button>
        </div>
      </section>
    </main>
  );
}
