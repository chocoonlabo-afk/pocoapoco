// src/app/settings/page.js
"use client";

import { useState, useEffect, useRef } from "react";
import {
  t,
  getLangFromStorage,
  setLangToStorage,
} from "../lib/i18n";

// åˆæœŸã‚¿ã‚¹ã‚¯
const DEFAULT_TASKS = [
  { id: "task_violin", label: "ãƒã‚¤ã‚ªãƒªãƒ³", icon: "ğŸ»" },
  { id: "task_piano", label: "ãƒ”ã‚¢ãƒ", icon: "ğŸ¹" },
  { id: "task_solfege", label: "ã‚½ãƒ«ãƒ•ã‚§ãƒ¼ã‚¸ãƒ¥", icon: "ğŸ“" },
  { id: "task_japanese", label: "å›½èª", icon: "ğŸ“–" },
  { id: "task_math", label: "ç®—æ•°", icon: "ğŸ”¢" },
  { id: "task_english", label: "è‹±èª", icon: "ğŸ‡¬ğŸ‡§" },
  { id: "task_science", label: "ç†ç§‘", icon: "ğŸ”¬" },
  { id: "task_social", label: "ç¤¾ä¼š", icon: "ğŸŒ" },
];

// ã‚¿ã‚¹ã‚¯ã®IDãŒæ¬ ã‘ã¦ã„ã‚‹å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’ãªã‚‰ã™
function normalizeTasksForSettings(tasksLike) {
  if (!Array.isArray(tasksLike)) return [];
  return tasksLike.map((t, index) => {
    if (t.id) return t;
    const base =
      typeof t.label === "string" && t.label.length > 0
        ? t.label
        : `task_${index}`;
    const normalizedId =
      "task_" +
      base
        .toString()
        .trim()
        .replace(/\s+/g, "_")
        .replace(/[^\w_ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¥]/g, "") +
      "_" +
      index;
    return {
      id: normalizedId,
      label: t.label ?? `ã‚¿ã‚¹ã‚¯${index + 1}`,
      icon: t.icon ?? "ğŸµ",
    };
  });
}

// CSVæ›¸ãå‡ºã—
function exportToCSV(records) {
  if (!records || records.length === 0) {
    alert("ãã‚ããŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }
  const header = ["date", "task", "minutes", "count", "memo"];
  const rows = records.map((r) => {
    const dateStr = r.startedAt
      ? new Date(r.startedAt).toLocaleString("ja-JP")
      : "";
    const minutes = Math.floor((r.seconds || 0) / 60);
    const count = r.count || 0;
    const memo = r.memo || "";
    const task = r.task || r.task_title || "";
    return [
      `"${dateStr}"`,
      `"${task.replace(/"/g, '""')}"`,
      `"${minutes}"`,
      `"${count}"`,
      `"${memo.replace(/"/g, '""')}"`,
    ].join(",");
  });
  const csv = [header.join(","), ...rows].join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const today = new Date().toISOString().slice(0, 10);
  a.href = url;
  a.download = `pocopoco_history_${today}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// CSVèª­ã¿è¾¼ã¿
function parseCSV(csvText) {
  const lines = csvText
    .split(/\r?\n/)
    .map((line) => line.trim())
    .filter((line) => line.length > 0);
  if (lines.length < 2) throw new Error("CSVãŒã¿ã˜ã‹ã™ãã¾ã™ã€‚");

  const header = lines[0].split(",").map((h) => h.replace(/^"|"$/g, ""));
  if (
    header[0] !== "date" ||
    header[1] !== "task" ||
    header[2] !== "minutes" ||
    header[3] !== "count" ||
    header[4] !== "memo"
  ) {
    throw new Error("CSVã®ãƒ˜ãƒƒãƒ€ãƒ¼ãŒã¡ãŒã„ã¾ã™ã€‚");
  }

  const records = [];
  for (let i = 1; i < lines.length; i++) {
    const rawCells = lines[i].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/);
    const cells = rawCells.map((c) => c.replace(/^"|"$/g, ""));
    const [dateStr, task, minutesStr, countStr, memo] = cells;
    const startedDate = new Date(dateStr);
    if (isNaN(startedDate.getTime())) continue;
    const seconds = parseInt(minutesStr, 10) * 60 || 0;
    const count = parseInt(countStr, 10) || 0;
    records.push({
      task,
      seconds,
      count,
      memo,
      startedAt: startedDate.toISOString(),
    });
  }
  return records;
}

function mergeHistory(oldArr, newArr) {
  const result = [...oldArr];
  for (const rec of newArr) {
    const exists = result.some(
      (r) =>
        r.startedAt === rec.startedAt &&
        (r.task || r.task_title) === (rec.task || rec.task_title) &&
        (r.seconds || 0) === (rec.seconds || 0) &&
        (r.count || 0) === (rec.count || 0)
    );
    if (!exists) result.push(rec);
  }
  return result;
}

export default function SettingsPage() {
  const [role, setRole] = useState("parent");
  const [lang, setLang] = useState("jp");
  const [parentCode, setParentCode] = useState("");
  const [eventTitle, setEventTitle] = useState("");
  const [eventDate, setEventDate] = useState("");
  const [birthday, setBirthday] = useState("");
  const [records, setRecords] = useState([]);
  const [tasks, setTasks] = useState([]);
  const [newTaskLabel, setNewTaskLabel] = useState("");
  const [newTaskIcon, setNewTaskIcon] = useState("");
  const [statusMsg, setStatusMsg] = useState("");
  const fileInputRef = useRef(null);
  const [calendarEvents, setCalendarEvents] = useState([]);
  const [newCalEventTitle, setNewCalEventTitle] = useState("");
  const [newCalEventDate, setNewCalEventDate] = useState("");
  const [newCalEventMark, setNewCalEventMark] = useState("");
  const [calendarTaskFilter, setCalendarTaskFilter] = useState(null);

  // å­ã©ã‚‚ç®¡ç†
  const [children, setChildren] = useState([]);
  const [newChildName, setNewChildName] = useState("");
  const [newChildBirthday, setNewChildBirthday] = useState("");
  const [currentChildId, setCurrentChildId] = useState("");

  useEffect(() => {
    try {
      const savedRole = localStorage.getItem("pocopoco_role");
      if (savedRole === "parent" || savedRole === "child") {
        setRole(savedRole);
      }

      const savedLang = getLangFromStorage();
      setLang(savedLang);

      const savedCode = localStorage.getItem("pocopoco_parentCode");
      if (savedCode) setParentCode(savedCode);

      const rawEvent = localStorage.getItem("pocopoco_event");
      if (rawEvent) {
        const evt = JSON.parse(rawEvent);
        setEventTitle(evt.title || "");
        setEventDate(evt.date || "");
      }

      const savedBirthday = localStorage.getItem("pocopoco_birthday");
      if (savedBirthday) setBirthday(savedBirthday);

      const rawHistory = localStorage.getItem("pocopoco_history");
      if (rawHistory) {
        const parsed = JSON.parse(rawHistory);
        if (Array.isArray(parsed)) setRecords(parsed);
      }

      const rawTasks = localStorage.getItem("pocopoco_tasks");
      if (rawTasks) {
        const parsedTasks = JSON.parse(rawTasks);
        const normalized = normalizeTasksForSettings(parsedTasks);
        setTasks(normalized);
        localStorage.setItem("pocopoco_tasks", JSON.stringify(normalized));
      } else {
        setTasks(DEFAULT_TASKS);
        localStorage.setItem("pocopoco_tasks", JSON.stringify(DEFAULT_TASKS));
      }

      const rawCalEvents = localStorage.getItem("pocopoco_events");
      if (rawCalEvents) {
        const arr = JSON.parse(rawCalEvents);
        if (Array.isArray(arr)) setCalendarEvents(arr);
      }

      const rawCalTaskFilter = localStorage.getItem(
        "pocopoco_calendar_task_filter"
      );
      if (rawCalTaskFilter) {
        const arr = JSON.parse(rawCalTaskFilter);
        if (Array.isArray(arr)) setCalendarTaskFilter(arr);
      }

      const rawChildren = localStorage.getItem("pocopoco_children");
      if (rawChildren) {
        const arr = JSON.parse(rawChildren);
        if (Array.isArray(arr)) setChildren(arr);
      }
      const savedCurrentChild = localStorage.getItem(
        "pocopoco_current_child_id"
      );
      if (savedCurrentChild) setCurrentChildId(savedCurrentChild);
    } catch (e) {
      console.error("settings load error", e);
    }
  }, []);

  // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
  function switchToParent() {
    const savedCode = localStorage.getItem("pocopoco_parentCode") || "";
    if (!savedCode) {
      localStorage.setItem("pocopoco_role", "parent");
      setRole("parent");
      setStatusMsg("è¦ªãƒ¢ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã—ãŸ");
      return;
    }
    const input = window.prompt("ãŠã¨ãªã®4ã‘ãŸã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    if (input === savedCode) {
      localStorage.setItem("pocopoco_role", "parent");
      localStorage.setItem("pocopoco_parentAuthed", "yes");
      setRole("parent");
      setStatusMsg("è¦ªãƒ¢ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã—ãŸ");
    } else if (input !== null) {
      alert("ã‚³ãƒ¼ãƒ‰ãŒã¡ãŒã„ã¾ã™");
    }
  }

  function switchToChild() {
    localStorage.setItem("pocopoco_role", "child");
    setRole("child");
    setStatusMsg("å­ãƒ¢ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã—ãŸ");
  }

  // å­ã©ã‚‚ç®¡ç†
  function handleAddChild() {
    const name = newChildName.trim();
    if (!name) {
      setStatusMsg("ãªã¾ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }
    if (children.length >= 5) {
      setStatusMsg("ã“ã©ã‚‚ã¯5äººã¾ã§ç™»éŒ²ã§ãã¾ã™");
      return;
    }
    const id = "child_" + Date.now().toString(36);
    const newC = { id, name, birthday: newChildBirthday || "" };
    const next = [...children, newC];
    setChildren(next);
    localStorage.setItem("pocopoco_children", JSON.stringify(next));
    setNewChildName("");
    setNewChildBirthday("");
    setStatusMsg(`${name} ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`);
  }

  function handleDeleteChild(id) {
    if (!window.confirm("ã“ã®ã“ã©ã‚‚ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    const next = children.filter((c) => c.id !== id);
    setChildren(next);
    localStorage.setItem("pocopoco_children", JSON.stringify(next));
    if (currentChildId === id) {
      localStorage.removeItem("pocopoco_current_child_id");
      setCurrentChildId("");
    }
    setStatusMsg("å‰Šé™¤ã—ã¾ã—ãŸ");
  }

  function handleSetCurrentChild(id) {
    setCurrentChildId(id);
    localStorage.setItem("pocopoco_current_child_id", id);
    const found = children.find((c) => c.id === id);
    setStatusMsg(`${found?.name || "ã“ã®å­"} ã‚’è¡¨ç¤ºå¯¾è±¡ã«ã—ã¾ã—ãŸ`);
  }

  // è¨€èªä¿å­˜
  function handleSaveLang() {
    setLangToStorage(lang);
    setStatusMsg("è¡¨ç¤ºè¨€èªã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
  }

  function handleSaveParentCode() {
    if (!/^[0-9]{4}$/.test(parentCode)) {
      setStatusMsg("4ã‘ãŸã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    localStorage.setItem("pocopoco_parentCode", parentCode);
    setStatusMsg("ç§˜å¯†ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
  }

  function handleSaveEvent() {
    const data = { title: eventTitle, date: eventDate };
    localStorage.setItem("pocopoco_event", JSON.stringify(data));
    setStatusMsg("ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
  }

  function handleSaveBirthday() {
    localStorage.setItem("pocopoco_birthday", birthday);
    setStatusMsg("ãŠãŸã‚“ã˜ã‚‡ã†ã³ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
  }

  function persistTasks(nextTasks) {
    setTasks(nextTasks);
    localStorage.setItem("pocopoco_tasks", JSON.stringify(nextTasks));
  }

  function handleAddTask() {
    const label = newTaskLabel.trim();
    const icon = newTaskIcon.trim();
    if (!label || !icon) {
      setStatusMsg("ã‚¢ã‚¤ã‚³ãƒ³ã¨ã‚¿ã‚¹ã‚¯åã‚’å…¥ã‚Œã¦ãã ã•ã„");
      return;
    }
    const safeId =
      "task_" +
      label
        .toString()
        .trim()
        .replace(/\s+/g, "_")
        .replace(/[^\w_ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¥]/g, "") +
      "_" +
      Date.now().toString().slice(-5);
    const next = [...tasks, { id: safeId, label, icon }];
    persistTasks(next);
    setNewTaskLabel("");
    setNewTaskIcon("");
    setStatusMsg(`ã€Œ${label}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
  }

  function handleDeleteTask(idx) {
    if (!window.confirm("ã“ã®ã‚¿ã‚¹ã‚¯ã‚’æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) return;
    const next = tasks.filter((_, i) => i !== idx);
    persistTasks(next);
    setStatusMsg("ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
  }

  function handleExportCSV() {
    exportToCSV(records);
    setStatusMsg("CSVã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ");
  }

  function handleImportClick() {
    if (fileInputRef.current) {
      fileInputRef.current.value = "";
      fileInputRef.current.click();
    }
  }

  function handleFileSelected(e) {
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const imported = parseCSV(ev.target.result);
        const merged = mergeHistory(records, imported);
        localStorage.setItem("pocopoco_history", JSON.stringify(merged));
        setRecords(merged);
        setStatusMsg(`CSVã‹ã‚‰${imported.length}ä»¶ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
      } catch (err) {
        console.error(err);
        setStatusMsg("CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
    };
    reader.readAsText(file, "utf-8");
  }

  function handleAddCalendarEvent() {
    if (!newCalEventDate) {
      setStatusMsg("æ—¥ä»˜ã‚’å…¥ã‚Œã¦ãã ã•ã„");
      return;
    }
    const ev = {
      id: "ev_" + Date.now().toString(36),
      title: newCalEventTitle || "ã‚¤ãƒ™ãƒ³ãƒˆ",
      date: newCalEventDate,
      mark: newCalEventMark || "EV",
    };
    const next = [...calendarEvents, ev];
    setCalendarEvents(next);
    localStorage.setItem("pocopoco_events", JSON.stringify(next));
    setNewCalEventTitle("");
    setNewCalEventDate("");
    setNewCalEventMark("");
    setStatusMsg("ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ");
  }

  function handleDeleteCalendarEvent(id) {
    const next = calendarEvents.filter((ev) => ev.id !== id);
    setCalendarEvents(next);
    localStorage.setItem("pocopoco_events", JSON.stringify(next));
    setStatusMsg("ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
  }

  function handleToggleCalendarTask(id) {
    if (!calendarTaskFilter) {
      const next = [id];
      setCalendarTaskFilter(next);
      localStorage.setItem(
        "pocopoco_calendar_task_filter",
        JSON.stringify(next)
      );
      setStatusMsg("ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¿ã‚¹ã‚¯ã‚’è¨­å®šã—ã¾ã—ãŸ");
      return;
    }
    const exists = calendarTaskFilter.includes(id);
    let next;
    if (exists) {
      next = calendarTaskFilter.filter((x) => x !== id);
    } else {
      next = [...calendarTaskFilter, id];
    }
    const finalVal = next.length === 0 ? null : next;
    setCalendarTaskFilter(finalVal);
    if (finalVal) {
      localStorage.setItem(
        "pocopoco_calendar_task_filter",
        JSON.stringify(finalVal)
      );
    } else {
      localStorage.removeItem("pocopoco_calendar_task_filter");
    }
    setStatusMsg("ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¿ã‚¹ã‚¯ã—ã¼ã‚Šã“ã¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
  }

  function isCalendarTaskChecked(id) {
    if (!calendarTaskFilter) return false;
    return calendarTaskFilter.includes(id);
  }

  function handleGoLogin() {
    localStorage.removeItem("pocopoco_role");
    localStorage.removeItem("pocopoco_parentAuthed");
    localStorage.removeItem("pocopoco_current_child_id");
    window.location.href = "/login";
  }

  return (
    <main
      style={{
        fontFamily: "system-ui, sans-serif",
        padding: "24px 16px 80px",
        maxWidth: "520px",
        margin: "0 auto",
      }}
    >
      <h1 style={{ fontSize: "20px", fontWeight: 600, marginBottom: "8px" }}>
        {t("settingsTitle", lang)}
      </h1>

      {/* ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º */}
      <section
        style={{
          border: "1px solid #ddd",
          borderRadius: "10px",
          padding: "10px",
          marginBottom: "16px",
          background: role === "parent" ? "#f5ecff" : "#f0f9ff",
        }}
      >
        <div style={{ fontSize: "13px", marginBottom: "4px" }}>
          ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ï¼š{" "}
          <strong>{role === "parent" ? "ğŸ‘¤ è¦ªãƒ¢ãƒ¼ãƒ‰" : "ğŸ§’ å­ãƒ¢ãƒ¼ãƒ‰"}</strong>
        </div>
        {role === "parent" ? (
          <button onClick={switchToChild} style={btnMini}>
            å­ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹
          </button>
        ) : (
          <button onClick={switchToParent} style={btnMini}>
            è¦ªãƒ¢ãƒ¼ãƒ‰ã«ã‚‚ã©ã‚‹
          </button>
        )}
      </section>

      {/* å­ã©ã‚‚ç®¡ç†ï¼ˆè¦ªã ã‘ï¼‰ */}
      {role === "parent" && (
        <section style={cardStyle}>
          <h2 style={sectionTitleStyle}>{t("childrenSectionTitle", lang)}</h2>
          {children.length === 0 ? (
            <div style={{ fontSize: "12px", color: "#777" }}>
              ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“
            </div>
          ) : (
            children.map((ch) => (
              <div
                key={ch.id}
                style={{
                  display: "flex",
                  justifyContent: "space-between",
                  alignItems: "center",
                  borderBottom: "1px solid #eee",
                  padding: "4px 0",
                }}
              >
                <div>
                  <div style={{ fontWeight: 600 }}>{ch.name}</div>
                  {ch.birthday && (
                    <div style={{ fontSize: "12px", color: "#666" }}>
                      ğŸ‚ {ch.birthday}
                    </div>
                  )}
                  {currentChildId === ch.id && (
                    <div style={chipStyle}>è¡¨ç¤ºä¸­</div>
                  )}
                </div>
                <div style={{ display: "flex", gap: "4px" }}>
                  <button
                    onClick={() => handleSetCurrentChild(ch.id)}
                    style={btnMini}
                  >
                    ã“ã®å­ã‚’è¡¨ç¤º
                  </button>
                  <button
                    onClick={() => handleDeleteChild(ch.id)}
                    style={{ ...btnMini, color: "#a00" }}
                  >
                    å‰Šé™¤
                  </button>
                </div>
              </div>
            ))
          )}

          <div style={{ marginTop: "10px" }}>
            <input
              type="text"
              placeholder="ãªã¾ãˆ"
              value={newChildName}
              onChange={(e) => setNewChildName(e.target.value)}
              style={inputStyle}
            />
            <input
              type="date"
              value={newChildBirthday}
              onChange={(e) => setNewChildBirthday(e.target.value)}
              style={inputStyle}
            />
            <button style={btnPurple} onClick={handleAddChild}>
              {t("addButton", lang)}
            </button>
          </div>
        </section>
      )}

      {/* è¨€èªè¨­å®š */}
      <section style={cardStyle}>
        <div style={sectionTitleStyle}>{t("settingsLang", lang)}</div>
        <select
          value={lang}
          onChange={(e) => setLang(e.target.value)}
          disabled={role === "child"}
          style={inputStyle}
        >
          <option value="jp">ã«ã»ã‚“ã”ï¼ˆãµã¤ã†ï¼‰</option>
          <option value="hiragana">ã«ã»ã‚“ã”ï¼ˆã²ã‚‰ãŒãªï¼‰</option>
          <option value="en">English</option>
        </select>
        {role === "parent" && (
          <button style={purpleButtonStyle} onClick={handleSaveLang}>
            {t("settingsSave", lang)}
          </button>
        )}
      </section>

      {/* ãƒ›ãƒ¼ãƒ ã«1ã¤å‡ºã™ã‚¤ãƒ™ãƒ³ãƒˆ */}
      <section style={cardStyle}>
        <div style={sectionTitleStyle}>ã‚¤ãƒ™ãƒ³ãƒˆ / æœ¬ç•ªã®æ—¥ï¼ˆãƒ›ãƒ¼ãƒ ã«1ã¤ï¼‰</div>
        <input
          type="text"
          value={eventTitle}
          onChange={(e) => setEventTitle(e.target.value)}
          disabled={role === "child"}
          style={inputStyle}
          placeholder="ã¯ã£ã´ã‚‡ã†ã‹ã„ ãªã©"
        />
        <input
          type="date"
          value={eventDate}
          onChange={(e) => setEventDate(e.target.value)}
          disabled={role === "child"}
          style={inputStyle}
        />
        {role === "parent" && (
          <button style={deepPurpleButtonStyle} onClick={handleSaveEvent}>
            ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿å­˜
          </button>
        )}
      </section>

      {/* èª•ç”Ÿæ—¥ */}
      <section style={cardStyle}>
        <div style={sectionTitleStyle}>ãŠãŸã‚“ã˜ã‚‡ã†ã³</div>
        <input
          type="date"
          value={birthday}
          onChange={(e) => setBirthday(e.target.value)}
          disabled={role === "child"}
          style={inputStyle}
        />
        {role === "parent" && (
          <button style={pinkButtonStyle} onClick={handleSaveBirthday}>
            ãŠãŸã‚“ã˜ã‚‡ã†ã³ã‚’ä¿å­˜
          </button>
        )}
      </section>

      {/* è¦ªã ã‘è¦‹ãˆã‚‹è¨­å®š */}
      {role === "parent" && (
        <>
          {/* è¦ªã‚³ãƒ¼ãƒ‰ */}
          <section style={cardStyle}>
            <div style={sectionTitleStyle}>
              {t("parentSecretCode", lang)}
            </div>
            <input
              type="password"
              value={parentCode}
              onChange={(e) => setParentCode(e.target.value)}
              style={{ ...inputStyle, letterSpacing: "0.3em" }}
              placeholder="1234"
            />
            <button style={gradientButtonStyle} onClick={handleSaveParentCode}>
              ç§˜å¯†ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜
            </button>
          </section>

          {/* ã‚¿ã‚¹ã‚¯ */}
          <section style={cardStyle}>
            <div style={sectionTitleStyle}>
              {t("tasksSectionTitle", lang)}
            </div>
            <div style={listBoxStyle}>
              {tasks.map((tTask, idx) => (
                <div key={tTask.id} style={listItemStyle}>
                  <span>
                    {tTask.icon} {tTask.label}
                  </span>
                  <button onClick={() => handleDeleteTask(idx)} style={btnMini}>
                    ã‘ã™
                  </button>
                </div>
              ))}
            </div>
            <input
              type="text"
              value={newTaskIcon}
              onChange={(e) => setNewTaskIcon(e.target.value)}
              style={inputStyle}
              placeholder="ğŸ»"
            />
            <input
              type="text"
              value={newTaskLabel}
              onChange={(e) => setNewTaskLabel(e.target.value)}
              style={inputStyle}
              placeholder="ãƒã‚¤ã‚ªãƒªãƒ³"
            />
            <button style={purpleButtonStyle} onClick={handleAddTask}>
              ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
            </button>
          </section>

          {/* CSV */}
          <section style={cardStyle}>
            <div style={sectionTitleStyle}>{t("dataBackupTitle", lang)}</div>
            <button style={purpleButtonStyle} onClick={handleExportCSV}>
              ğŸ“¤ CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </button>
            <button style={greenButtonStyle} onClick={handleImportClick}>
              ğŸ“¥ CSVã‹ã‚‰èª­ã¿è¾¼ã‚€
            </button>
            <input
              ref={fileInputRef}
              type="file"
              accept=".csv,text/csv"
              style={{ display: "none" }}
              onChange={handleFileSelected}
            />
          </section>

          {/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«å‡ºã™ã‚¤ãƒ™ãƒ³ãƒˆ */}
          <section style={cardStyle}>
            <div style={sectionTitleStyle}>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«å‡ºã™ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè¤‡æ•°ï¼‰</div>
            <div style={listBoxStyle}>
              {calendarEvents.length === 0 ? (
                <div style={{ fontSize: "12px", color: "#777" }}>
                  ï¼ˆã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰
                </div>
              ) : (
                calendarEvents.map((ev) => (
                  <div key={ev.id} style={listItemStyle}>
                    <div>
                      {ev.mark || "EV"} {ev.title} ({ev.date})
                    </div>
                    <button
                      onClick={() => handleDeleteCalendarEvent(ev.id)}
                      style={btnMini}
                    >
                      ã‘ã™
                    </button>
                  </div>
                ))
              )}
            </div>
            <input
              type="text"
              value={newCalEventTitle}
              onChange={(e) => setNewCalEventTitle(e.target.value)}
              style={inputStyle}
              placeholder="ã‚¤ãƒ™ãƒ³ãƒˆå"
            />
            <input
              type="date"
              value={newCalEventDate}
              onChange={(e) => setNewCalEventDate(e.target.value)}
              style={inputStyle}
            />
            <input
              type="text"
              value={newCalEventMark}
              onChange={(e) => setNewCalEventMark(e.target.value)}
              style={inputStyle}
              placeholder="ğŸµ"
            />
            <button style={purpleButtonStyle} onClick={handleAddCalendarEvent}>
              è¿½åŠ 
            </button>
          </section>

          {/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«åæ˜ ã™ã‚‹ã‚¿ã‚¹ã‚¯ */}
          <section style={cardStyle}>
            <div style={sectionTitleStyle}>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«åæ˜ ã™ã‚‹ã‚¿ã‚¹ã‚¯</div>
            {tasks.map((tTask) => (
              <label
                key={tTask.id}
                style={{ display: "flex", gap: "6px", alignItems: "center" }}
              >
                <input
                  type="checkbox"
                  checked={isCalendarTaskChecked(tTask.id)}
                  onChange={() => handleToggleCalendarTask(tTask.id)}
                />
                <span>
                  {tTask.icon} {tTask.label}
                </span>
              </label>
            ))}
          </section>
        </>
      )}

      {/* ãƒ­ã‚°ã‚¤ãƒ³ã¸ */}
      <section style={cardStyle}>
        <div style={sectionTitleStyle}>ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚„ã‚ŠãªãŠã™</div>
        <p style={{ fontSize: "12px", color: "#666", marginBottom: "8px" }}>
          ã„ã¡ã©ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ã‚‚ã©ã£ã¦ã€ã‚‚ã†ã„ã¡ã© è¦ª / å­ ã‚’ãˆã‚‰ã³ãªãŠã—ã¾ã™ã€‚
        </p>
        <button
          onClick={handleGoLogin}
          style={{
            width: "100%",
            background: "#eee",
            border: "1px solid #ccc",
            borderRadius: "8px",
            padding: "8px 12px",
            fontSize: "13px",
          }}
        >
          ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ã‚‚ã©ã‚‹
        </button>
      </section>

      {/* æ³•å‹™ãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ± */}
      <section style={cardStyle}>
        <div style={sectionTitleStyle}>â„¹ï¸ ã‚¢ãƒ—ãƒªæƒ…å ±</div>
        <div style={{ fontSize: "13px", color: "#333", marginBottom: "4px" }}>
          <strong>pocoapoco</strong> v1.0.3ï¼ˆæ›´æ–°æ—¥ï¼š2025-11-04ï¼‰
        </div>
        <div style={{ fontSize: "12px", color: "#666", marginBottom: "12px" }}>
          Â© 2025 Hardy Inc. All rights reserved.
        </div>

        <div style={sectionTitleStyle}>ğŸ“œ æ³•å¾‹ä¸Šã®è¡¨ç¤º</div>
        <ul style={{ fontSize: "13px", lineHeight: 1.6, marginBottom: "12px" }}>
          <li>
            <a
              href="https://example.com/terms"
              target="_blank"
              rel="noopener noreferrer"
              style={{ color: "#6a1b9a", textDecoration: "underline" }}
            >
              åˆ©ç”¨è¦ç´„
            </a>
          </li>
          <li>
            <a
              href="https://example.com/privacy"
              target="_blank"
              rel="noopener noreferrer"
              style={{ color: "#6a1b9a", textDecoration: "underline" }}
            >
              ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼
            </a>
          </li>
          <li>
            <a
              href="https://example.com/law"
              target="_blank"
              rel="noopener noreferrer"
              style={{ color: "#6a1b9a", textDecoration: "underline" }}
            >
              ç‰¹å®šå•†å–å¼•æ³•ã«åŸºã¥ãè¡¨è¨˜
            </a>
          </li>
        </ul>

        <div style={sectionTitleStyle}>ğŸ’¬ ã¤ã‹ã„ã‹ãŸã‚¬ã‚¤ãƒ‰</div>
        <p style={{ fontSize: "13px", color: "#444", lineHeight: 1.6 }}>
          ãã‚ã—ã„ä½¿ã„æ–¹ã‚„æœ€æ–°æƒ…å ±ã¯{" "}
          <a
            href="https://www.instagram.com/chocoonlabo"
            target="_blank"
            rel="noopener noreferrer"
            style={{ color: "#6a1b9a", fontWeight: "600" }}
          >
            Instagram @chocoonlabo
          </a>{" "}
          ã§ç™ºä¿¡ã—ã¦ã„ã¾ã™ã€‚
        </p>
      </section>

      {statusMsg && <div style={statusBoxStyle}>{statusMsg}</div>}
    </main>
  );
}

/* ---- style ---- */
const inputStyle = {
  width: "100%",
  padding: "6px 8px",
  border: "1px solid #ccc",
  borderRadius: "6px",
  fontSize: "13px",
  marginBottom: "6px",
};

const cardStyle = {
  border: "1px solid #ddd",
  borderRadius: "12px",
  padding: "16px",
  marginBottom: "16px",
  background: "#fff",
};

const sectionTitleStyle = {
  fontSize: "14px",
  fontWeight: 600,
  marginBottom: "8px",
};

const btnMini = {
  border: "1px solid #ccc",
  borderRadius: "6px",
  background: "#fff",
  fontSize: "12px",
  padding: "2px 8px",
  cursor: "pointer",
};

const btnPurple = {
  background: "#6a1b9a",
  color: "#fff",
  border: "none",
  borderRadius: "8px",
  padding: "6px 10px",
  fontWeight: "600",
  fontSize: "13px",
  cursor: "pointer",
};

const purpleButtonStyle = {
  width: "100%",
  backgroundColor: "#4a148c",
  color: "#fff",
  border: "none",
  borderRadius: "10px",
  fontSize: "14px",
  fontWeight: "600",
  padding: "10px 12px",
  marginTop: "4px",
};

const deepPurpleButtonStyle = {
  width: "100%",
  backgroundColor: "#6a1b9a",
  color: "#fff",
  border: "none",
  borderRadius: "10px",
  fontSize: "14px",
  fontWeight: "600",
  padding: "10px 12px",
};

const pinkButtonStyle = {
  width: "100%",
  backgroundColor: "#d81b60",
  color: "#fff",
  border: "none",
  borderRadius: "10px",
  fontSize: "14px",
  fontWeight: "600",
  padding: "10px 12px",
};

const gradientButtonStyle = {
  width: "100%",
  background: "linear-gradient(90deg, rgb(204,0,255), rgb(255,102,153))",
  color: "#fff",
  border: "none",
  borderRadius: "10px",
  fontSize: "14px",
  fontWeight: "600",
  padding: "10px 12px",
};

const greenButtonStyle = {
  width: "100%",
  backgroundColor: "#00695c",
  color: "#fff",
  border: "none",
  borderRadius: "10px",
  fontSize: "14px",
  fontWeight: "600",
  padding: "10px 12px",
};

const listBoxStyle = {
  border: "1px solid #eee",
  borderRadius: "8px",
  padding: "8px",
  marginBottom: "12px",
};

const listItemStyle = {
  display: "flex",
  justifyContent: "space-between",
  alignItems: "center",
  padding: "4px 0",
};

const chipStyle = {
  display: "inline-block",
  fontSize: "11px",
  color: "#6a1b9a",
  background: "#e0ccff",
  borderRadius: "999px",
  padding: "1px 6px",
  marginTop: "2px",
};

const statusBoxStyle = {
  background: "#f5ecff",
  border: "1px solid #e0ccff",
  borderRadius: "8px",
  padding: "8px 12px",
  marginTop: "12px",
  fontSize: "13px",
};
