"use client";

import { useState, useEffect } from "react";

export default function SettingsPage() {
  const [children, setChildren] = useState([]);
  const [newChildName, setNewChildName] = useState("");
  const [newChildBirthday, setNewChildBirthday] = useState("");
  const [currentChildId, setCurrentChildId] = useState("");
  const [statusMsg, setStatusMsg] = useState("");

  // ãã®ä»–ã®æ—¢å­˜è¨­å®šé …ç›®
  const [language, setLanguage] = useState("jp");
  const [birthday, setBirthday] = useState("");
  const [eventList, setEventList] = useState([]);
  const [newEventTitle, setNewEventTitle] = useState("");
  const [newEventDate, setNewEventDate] = useState("");
  const [newEventMark, setNewEventMark] = useState("ğŸ“Œ");

  useEffect(() => {
    // å­ã©ã‚‚æƒ…å ±ã‚’èª­ã¿è¾¼ã‚€
    try {
      const raw = localStorage.getItem("pocopoco_children");
      if (raw) {
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) setChildren(arr);
      }
      const cur = localStorage.getItem("pocopoco_current_child_id");
      if (cur) setCurrentChildId(cur);
    } catch (e) {
      console.warn("child load error", e);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆèª­ã¿è¾¼ã¿
    try {
      const ev = localStorage.getItem("pocopoco_events");
      if (ev) {
        const arr = JSON.parse(ev);
        if (Array.isArray(arr)) setEventList(arr);
      }
    } catch {}

    // ãã®ä»–è¨­å®š
    setLanguage(localStorage.getItem("pocopoco_language") || "jp");
    setBirthday(localStorage.getItem("pocopoco_birthday") || "");
  }, []);

  /** ---------------------------
   * å­ã©ã‚‚ç®¡ç†
   * --------------------------- */
  function handleAddChild() {
    const name = newChildName.trim();
    if (!name) {
      setStatusMsg("ãªã¾ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }
    if (children.length >= 5) {
      setStatusMsg("ã“ã©ã‚‚ã¯5äººã¾ã§ç™»éŒ²ã§ãã¾ã™");
      return;
    }
    const id = "child_" + Date.now().toString(36);
    const newC = { id, name, birthday: newChildBirthday || "" };
    const next = [...children, newC];
    setChildren(next);
    localStorage.setItem("pocopoco_children", JSON.stringify(next));
    setNewChildName("");
    setNewChildBirthday("");
    setStatusMsg(`${name} ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`);
  }

  function handleDeleteChild(id) {
    if (!window.confirm("ã“ã®ã“ã©ã‚‚ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    const next = children.filter((c) => c.id !== id);
    setChildren(next);
    localStorage.setItem("pocopoco_children", JSON.stringify(next));
    if (currentChildId === id) {
      localStorage.removeItem("pocopoco_current_child_id");
      setCurrentChildId("");
    }
    setStatusMsg("å‰Šé™¤ã—ã¾ã—ãŸ");
  }

  function handleSetCurrentChild(id) {
    setCurrentChildId(id);
    localStorage.setItem("pocopoco_current_child_id", id);
    const found = children.find((c) => c.id === id);
    setStatusMsg(`${found?.name || "ã“ã®å­"} ã‚’è¡¨ç¤ºå¯¾è±¡ã«ã—ã¾ã—ãŸ`);
  }

  /** ---------------------------
   * ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†
   * --------------------------- */
  function addEvent() {
    if (!newEventTitle || !newEventDate) {
      setStatusMsg("ã‚¤ãƒ™ãƒ³ãƒˆåã¨æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }
    const next = [
      ...eventList,
      {
        id: "ev_" + Date.now().toString(36),
        title: newEventTitle,
        date: newEventDate,
        mark: newEventMark || "ğŸ“Œ",
      },
    ];
    setEventList(next);
    localStorage.setItem("pocopoco_events", JSON.stringify(next));
    setNewEventTitle("");
    setNewEventDate("");
    setNewEventMark("ğŸ“Œ");
    setStatusMsg("ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²ã—ã¾ã—ãŸ");
  }

  function deleteEvent(id) {
    if (!window.confirm("ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    const next = eventList.filter((e) => e.id !== id);
    setEventList(next);
    localStorage.setItem("pocopoco_events", JSON.stringify(next));
  }

  /** ---------------------------
   * ãã®ä»–ä¿å­˜
   * --------------------------- */
  function saveLanguage(l) {
    setLanguage(l);
    localStorage.setItem("pocopoco_language", l);
    setStatusMsg("è¨€èªè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
  }

  function saveBirthday(b) {
    setBirthday(b);
    localStorage.setItem("pocopoco_birthday", b);
    setStatusMsg("èª•ç”Ÿæ—¥ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
  }

  return (
    <main
      style={{
        fontFamily: "system-ui, sans-serif",
        padding: "20px 16px 80px",
        maxWidth: "520px",
        margin: "0 auto",
      }}
    >
      <h1 style={{ fontSize: "20px", fontWeight: 700, marginBottom: "12px" }}>
        âš™ï¸ è¨­å®š
      </h1>

      {statusMsg && (
        <div
          style={{
            backgroundColor: "#f5ecff",
            border: "1px solid #e0ccff",
            borderRadius: "8px",
            padding: "6px 10px",
            fontSize: "13px",
            color: "#4a148c",
            marginBottom: "16px",
          }}
        >
          {statusMsg}
        </div>
      )}

      {/* å­ã©ã‚‚ç™»éŒ² */}
      <section
        style={{
          border: "1px solid #ddd",
          borderRadius: "10px",
          padding: "12px",
          marginBottom: "20px",
          background: "#faf8ff",
        }}
      >
        <h2 style={{ fontSize: "16px", fontWeight: 600, marginBottom: "8px" }}>
          ğŸ‘¶ ã“ã©ã‚‚ã®ã¨ã†ã‚ãï¼ˆ5äººã¾ã§ï¼‰
        </h2>

        {/* ä¸€è¦§ */}
        {children.length === 0 ? (
          <div style={{ fontSize: "12px", color: "#777" }}>ç™»éŒ²ãªã—</div>
        ) : (
          children.map((ch) => (
            <div
              key={ch.id}
              style={{
                display: "flex",
                justifyContent: "space-between",
                alignItems: "center",
                borderBottom: "1px solid #eee",
                padding: "4px 0",
              }}
            >
              <div>
                <div style={{ fontWeight: 600 }}>{ch.name}</div>
                {ch.birthday && (
                  <div style={{ fontSize: "12px", color: "#666" }}>
                    ğŸ‚ {ch.birthday}
                  </div>
                )}
                {currentChildId === ch.id && (
                  <div
                    style={{
                      display: "inline-block",
                      fontSize: "11px",
                      color: "#6a1b9a",
                      background: "#e0ccff",
                      borderRadius: "999px",
                      padding: "1px 6px",
                      marginTop: "2px",
                    }}
                  >
                    è¡¨ç¤ºä¸­
                  </div>
                )}
              </div>
              <div style={{ display: "flex", gap: "4px" }}>
                <button
                  onClick={() => handleSetCurrentChild(ch.id)}
                  style={btnMini}
                >
                  ã“ã®å­ã‚’è¡¨ç¤º
                </button>
                <button
                  onClick={() => handleDeleteChild(ch.id)}
                  style={{ ...btnMini, color: "#a00" }}
                >
                  å‰Šé™¤
                </button>
              </div>
            </div>
          ))
        )}

        {/* è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  */}
        <div style={{ marginTop: "10px" }}>
          <input
            type="text"
            placeholder="ãªã¾ãˆ"
            value={newChildName}
            onChange={(e) => setNewChildName(e.target.value)}
            style={inputStyle}
          />
          <input
            type="date"
            value={newChildBirthday}
            onChange={(e) => setNewChildBirthday(e.target.value)}
            style={inputStyle}
          />
          <button style={btnPurple} onClick={handleAddChild}>
            ã¤ã„ã‹
          </button>
        </div>
      </section>

      {/* ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š */}
      <section
        style={{
          border: "1px solid #ffdca3",
          borderRadius: "10px",
          padding: "12px",
          marginBottom: "20px",
          background: "#fffaf0",
        }}
      >
        <h2 style={{ fontSize: "16px", fontWeight: 600, marginBottom: "8px" }}>
          ğŸ“… ã‚¤ãƒ™ãƒ³ãƒˆ
        </h2>
        {eventList.map((ev) => (
          <div
            key={ev.id}
            style={{
              borderBottom: "1px solid #eee",
              padding: "4px 0",
              display: "flex",
              justifyContent: "space-between",
            }}
          >
            <div>
              <div style={{ fontWeight: 600 }}>
                {ev.mark || "ğŸ“Œ"} {ev.title}
              </div>
              <div style={{ fontSize: "12px", color: "#555" }}>{ev.date}</div>
            </div>
            <button onClick={() => deleteEvent(ev.id)} style={btnMini}>
              å‰Šé™¤
            </button>
          </div>
        ))}
        <div style={{ marginTop: "8px" }}>
          <input
            type="text"
            placeholder="ã‚¤ãƒ™ãƒ³ãƒˆå"
            value={newEventTitle}
            onChange={(e) => setNewEventTitle(e.target.value)}
            style={inputStyle}
          />
          <input
            type="date"
            value={newEventDate}
            onChange={(e) => setNewEventDate(e.target.value)}
            style={inputStyle}
          />
          <input
            type="text"
            placeholder="ãƒãƒ¼ã‚¯ (ä¾‹: ğŸµ)"
            value={newEventMark}
            onChange={(e) => setNewEventMark(e.target.value)}
            style={inputStyle}
          />
          <button onClick={addEvent} style={btnYellow}>
            è¿½åŠ 
          </button>
        </div>
      </section>

      {/* è¨€èªãƒ»èª•ç”Ÿæ—¥ */}
      <section
        style={{
          border: "1px solid #ccc",
          borderRadius: "10px",
          padding: "12px",
          background: "#fafafa",
        }}
      >
        <h2 style={{ fontSize: "16px", fontWeight: 600, marginBottom: "8px" }}>
          ğŸŒ ãã®ã»ã‹
        </h2>

        <div style={{ marginBottom: "8px" }}>
          <label style={{ fontSize: "13px", marginRight: "8px" }}>è¨€èªï¼š</label>
          <select
            value={language}
            onChange={(e) => saveLanguage(e.target.value)}
            style={inputStyle}
          >
            <option value="jp">æ—¥æœ¬èª</option>
            <option value="en">English</option>
          </select>
        </div>

        <div>
          <label style={{ fontSize: "13px", marginRight: "8px" }}>èª•ç”Ÿæ—¥ï¼š</label>
          <input
            type="date"
            value={birthday}
            onChange={(e) => saveBirthday(e.target.value)}
            style={inputStyle}
          />
        </div>
      </section>

      <div style={{ marginTop: "40px", textAlign: "center", color: "#888" }}>
        v1.0 / {new Date().toLocaleDateString("ja-JP")}
      </div>
    </main>
  );
}

// ã‚¹ã‚¿ã‚¤ãƒ«
const inputStyle = {
  width: "100%",
  padding: "6px 8px",
  border: "1px solid #ccc",
  borderRadius: "6px",
  fontSize: "13px",
  marginBottom: "6px",
};

const btnMini = {
  border: "1px solid #ccc",
  borderRadius: "6px",
  background: "#fff",
  fontSize: "12px",
  padding: "2px 8px",
  cursor: "pointer",
};

const btnPurple = {
  background: "#6a1b9a",
  color: "#fff",
  border: "none",
  borderRadius: "8px",
  padding: "6px 10px",
  fontWeight: "600",
  fontSize: "13px",
  cursor: "pointer",
};

const btnYellow = {
  background: "#ffb300",
  color: "#fff",
  border: "none",
  borderRadius: "8px",
  padding: "6px 10px",
  fontWeight: "600",
  fontSize: "13px",
  cursor: "pointer",
};
