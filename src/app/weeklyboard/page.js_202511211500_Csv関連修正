// src/app/weeklyboard/page.js  （もともとの timetable/page.js をベースに改造）
"use client";

import { useState, useEffect } from "react";
import { useSearchParams } from "next/navigation";
import {
  LS_CHILDREN,
  LS_CURRENT_CHILD_ID,
  LS_ROLE,
  LS_TIMETABLE_BY_CHILD,
} from "../constants";

const STORAGE_KEY = LS_TIMETABLE_BY_CHILD;
const CHILDREN_KEY = LS_CHILDREN;
const CURRENT_CHILD_KEY = LS_CURRENT_CHILD_ID;
const ROLE_KEY = LS_ROLE;

const DAY_KEYS = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];
const DAY_LABELS = {
  sun: "日",
  mon: "月",
  tue: "火",
  wed: "水",
  thu: "木",
  fri: "金",
  sat: "土",
};

const PERIOD_COUNT = 15;

// からの時間割（7日×15コマ）
function createEmptyCells() {
  const cells = {};
  DAY_KEYS.forEach((d) => {
    cells[d] = Array(PERIOD_COUNT).fill("");
  });
  return cells;
}

// localStorage から読み込み
function loadTimetablesFromStorage() {
  if (typeof window === "undefined") return {};
  const raw = window.localStorage.getItem(STORAGE_KEY);
  if (!raw) return {};
  try {
    const parsed = JSON.parse(raw);
    if (parsed && typeof parsed === "object") return parsed;
  } catch (e) {
    console.error("Failed to parse timetable from storage", e);
  }
  return {};
}

// 曜日並び
function getDayOrder(weekStart) {
  // weekStart: 'mon' or 'sun'
  if (weekStart === "sun") {
    return ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];
  }
  // 月曜はじまり（デフォルト）
  return ["mon", "tue", "wed", "thu", "fri", "sat", "sun"];
}

// CSV 1セル用
const escapeCSV = (value) => {
  const v = value ?? "";
  return `"${v.replace(/"/g, '""')}"`;
};

const parseCSVLine = (line) => {
  const result = [];
  let current = "";
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];

    if (char === '"') {
      const nextChar = line[i + 1];
      if (inQuotes && nextChar === '"') {
        current += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (char === "," && !inQuotes) {
      result.push(current);
      current = "";
    } else {
      current += char;
    }
  }
  result.push(current);
  return result.map((v) => v.trim());
};

export default function WeeklyBoardPage() {
  const searchParams = useSearchParams();

  // 設定画面と共通の子ども情報 / 表示中の子 / ロール
  const [children, setChildren] = useState([]);
  const [currentChildId, setCurrentChildId] = useState("");
  const [role, setRole] = useState("parent"); // parent / child

  // URLクエリからの childId（なければ null）
  const queryChildId = searchParams.get("childId");

  const [selectedChildId, setSelectedChildId] = useState("");

  // childId => { weekStart: 'mon' | 'sun', cells: { [dayKey]: string[] } }
  const [timetablesByChild, setTimetablesByChild] = useState({});

  // UI用の weekStart（その子の設定があればそちらを優先）
  const [uiWeekStart, setUiWeekStart] = useState("mon");

  // マウント時：設定と同じ localStorage から子ども情報・ロールを取得
  useEffect(() => {
    try {
      const rawChildren = localStorage.getItem(CHILDREN_KEY);
      if (rawChildren) {
        const arr = JSON.parse(rawChildren);
        if (Array.isArray(arr)) setChildren(arr);
      }

      const savedCurrentChild = localStorage.getItem(CURRENT_CHILD_KEY);
      if (savedCurrentChild) {
        setCurrentChildId(savedCurrentChild);
      }

      const savedRole = localStorage.getItem(ROLE_KEY);
      if (savedRole === "parent" || savedRole === "child") {
        setRole(savedRole);
      }
    } catch (e) {
      console.error("weeklyboard: children/role load error", e);
    }
  }, []);

  // マウント時：時間割データ読み込み
  useEffect(() => {
    const data = loadTimetablesFromStorage();
    setTimetablesByChild(data);

    // 初期 weekStart（ざっくりでOK。選択子変更時に再反映される）
    if (queryChildId && data[queryChildId]) {
      const childCfg = data[queryChildId];
      if (
        childCfg &&
        (childCfg.weekStart === "mon" || childCfg.weekStart === "sun")
      ) {
        setUiWeekStart(childCfg.weekStart);
      }
    }
  }, [queryChildId]);

  // 子ども情報が揃ったら「どの子を表示するか」を決める
  useEffect(() => {
    // 1. クエリに childId があれば最優先
    if (queryChildId) {
      setSelectedChildId(queryChildId);
      return;
    }

    // 2. 子モードのときは currentChildId で固定
    if (role === "child" && currentChildId) {
      setSelectedChildId(currentChildId);
      return;
    }

    // 3. 親モード：currentChildId があればそれ、なければ先頭の子
    if (role === "parent") {
      if (currentChildId) {
        setSelectedChildId(currentChildId);
      } else if (!selectedChildId && children.length > 0) {
        setSelectedChildId(children[0].id);
      }
    }
  }, [queryChildId, role, currentChildId, children, selectedChildId]);

  // 選択子ども変更時に、その子の weekStart を反映
  useEffect(() => {
    if (!selectedChildId) return;
    const cfg = timetablesByChild[selectedChildId];
    if (cfg && (cfg.weekStart === "mon" || cfg.weekStart === "sun")) {
      setUiWeekStart(cfg.weekStart);
    }
  }, [selectedChildId, timetablesByChild]);

  const currentConfig =
    (selectedChildId && timetablesByChild[selectedChildId]) || {
      weekStart: uiWeekStart,
      cells: createEmptyCells(),
    };

  const weekStart = currentConfig.weekStart || uiWeekStart;
  const dayOrder = getDayOrder(weekStart);
  const cells = currentConfig.cells || createEmptyCells();

  const saveTimetables = (updater) => {
    setTimetablesByChild((prev) => {
      const next = updater(prev);
      if (typeof window !== "undefined") {
        window.localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
      }
      return next;
    });
  };

  const handleWeekStartChange = (start) => {
    setUiWeekStart(start);
    if (!selectedChildId) return;
    saveTimetables((prev) => {
      const prevCfg = prev[selectedChildId] || {
        weekStart: start,
        cells: createEmptyCells(),
      };
      return {
        ...prev,
        [selectedChildId]: {
          ...prevCfg,
          weekStart: start,
        },
      };
    });
  };

  const handleHeaderClick = (dayKey) => {
    if (dayKey === "mon") {
      handleWeekStartChange("mon");
    } else if (dayKey === "sun") {
      handleWeekStartChange("sun");
    }
  };

  const handleCellChange = (dayKey, periodIndex, value) => {
    if (!selectedChildId) return;
    saveTimetables((prev) => {
      const prevCfg = prev[selectedChildId] || {
        weekStart: uiWeekStart,
        cells: createEmptyCells(),
      };
      const prevCells = prevCfg.cells || createEmptyCells();
      const dayRow = [...(prevCells[dayKey] || Array(PERIOD_COUNT).fill(""))];
      dayRow[periodIndex] = value;

      return {
        ...prev,
        [selectedChildId]: {
          weekStart: prevCfg.weekStart || uiWeekStart,
          cells: {
            ...prevCells,
            [dayKey]: dayRow,
          },
        },
      };
    });
  };

  // CSV 出力：1列目に「コマ番号」、以降は曜日（現在の並び）
  const handleExportCSV = () => {
    if (!selectedChildId) {
      alert("子どもが選択されていません。");
      return;
    }

    const cfg = timetablesByChild[selectedChildId];
    if (!cfg) {
      alert("時間割がまだ入力されていません。");
      return;
    }

    const dayKeys = getDayOrder(cfg.weekStart || "mon");
    const header =
      ["コマ"].concat(dayKeys.map((d) => DAY_LABELS[d])).join(",");

    const lines = [];
    for (let i = 0; i < PERIOD_COUNT; i++) {
      const row = [];
      row.push(String(i + 1)); // コマ番号
      dayKeys.forEach((d) => {
        const value = (cfg.cells?.[d] || [])[i] ?? "";
        row.push(escapeCSV(value));
      });
      lines.push(row.join(","));
    }

    const csvContent = [header, ...lines].join("\r\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    const childName =
      children.find((c) => c.id === selectedChildId)?.name ?? "unknown";

    a.href = url;
    a.download = `pocoapoco_timetable_${childName}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  // CSV 取込：上記と同じ形式を想定
  const handleImportCSV = async (e) => {
    if (!selectedChildId) {
      alert("子どもが選択されていません。");
      e.target.value = "";
      return;
    }

    const file = e.target.files?.[0];
    if (!file) return;

    const text = await file.text();
    const lines = text.split(/\r?\n/).filter((line) => line.trim() !== "");
    if (lines.length <= 1) {
      alert("有効なデータ行がありません。");
      e.target.value = "";
      return;
    }

    const header = parseCSVLine(lines[0]);
    if (header.length < 2) {
      alert("ヘッダー行の形式が想定と異なります。");
      e.target.value = "";
      return;
    }

    // 「コマ, 曜日...」 なので 2列目以降を曜日とみなす
    const dayCols = header.slice(1);
    // 現在の weekStart に合わせて並べ直す
    const expectedOrder = getDayOrder(uiWeekStart);
    const colToDayKey = dayCols.map((label) => {
      const clean = label.replace(/["']/g, "");
      const found = expectedOrder.find((d) => DAY_LABELS[d] === clean);
      return found || null;
    });

    const newCells = createEmptyCells();

    for (let i = 1; i < lines.length && i <= PERIOD_COUNT; i++) {
      const cols = parseCSVLine(lines[i]);
      if (cols.length < 2) continue; // 少なくとも「コマ + 1曜日」

      const periodIndex = i - 1;
      for (let col = 1; col < cols.length; col++) {
        const dayKey = colToDayKey[col - 1];
        if (!dayKey) continue;
        newCells[dayKey][periodIndex] = cols[col];
      }
    }

    saveTimetables((prev) => ({
      ...prev,
      [selectedChildId]: {
        weekStart: uiWeekStart,
        cells: newCells,
      },
    }));

    e.target.value = "";
    alert("時間割を読み込みました。");
  };

  const card = {
    backgroundColor: "#ffffff",
    borderRadius: "16px",
    padding: "16px",
    marginBottom: "16px",
    boxShadow: "0 4px 10px rgba(0, 0, 0, 0.03)",
  };

  const controlButton = {
    borderRadius: "999px",
    border: "1px solid #ddd",
    padding: "6px 10px",
    fontSize: "12px",
    fontWeight: 500,
    background: "#fafafa",
    color: "#555",
    cursor: "pointer",
    whiteSpace: "nowrap",
  };

  // 3コマごとのグループ＋土日専用色
  const groupColors = [
    { weekday: "#ffffff", sat: "#e0f2fe", sun: "#ffe4e6" },
    { weekday: "#faf5ff", sat: "#e5f0ff", sun: "#ffe9f2" },
    { weekday: "#fef9c3", sat: "#fdf3c4", sun: "#ffe9d5" },
    { weekday: "#e0f2fe", sat: "#dbeafe", sun: "#e5e7ff" },
    { weekday: "#fce7f3", sat: "#f9d7eb", sun: "#ffd6e7" },
  ];

  const getCellBackground = (dayKey, rowIndex) => {
    const groupIndex = Math.min(
      Math.floor(rowIndex / 3),
      groupColors.length - 1
    );
    const group = groupColors[groupIndex];

    if (dayKey === "sat") return group.sat;
    if (dayKey === "sun") return group.sun;
    return group.weekday;
  };

  const dayHeaderStyle = (dayKey) => {
    const clickable = dayKey === "mon" || dayKey === "sun";
    const isActive =
      (weekStart === "mon" && dayKey === "mon") ||
      (weekStart === "sun" && dayKey === "sun");

    return {
      borderBottom: isActive ? "2px solid #a855f7" : "1px solid #eee",
      padding: "6px 4px",
      textAlign: "center",
      minWidth: "70px",
      cursor: clickable ? "pointer" : "default",
      color: clickable ? "#4b5563" : "#6b7280",
      fontWeight: 600,
      backgroundColor: "#faf5ff",
      userSelect: "none",
    };
  };

  const selectedChild = children.find((c) => c.id === selectedChildId);

  return (
    <div style={{ padding: "16px 16px 24px" }}>
      {/* カード全体 */}
      <div style={card}>
        {/* 上部：子ども選択＋CSVボタン */}
        <div
          style={{
            display: "flex",
            flexWrap: "wrap",
            gap: "8px",
            alignItems: "center",
            marginBottom: "12px",
          }}
        >
          {/* 親モードのときだけ子どもセレクトを表示 */}
          {role === "parent" ? (
            <select
              value={selectedChildId}
              onChange={(e) => setSelectedChildId(e.target.value)}
              style={{
                borderRadius: "999px",
                border: "1px solid #ddd",
                padding: "8px 14px",
                fontSize: "13px",
                background: "#fff",
                minWidth: "120px",
              }}
            >
              {children.length === 0 && (
                <option value="">子ども未登録</option>
              )}
              {children.map((child) => (
                <option key={child.id} value={child.id}>
                  {child.name}
                </option>
              ))}
            </select>
          ) : (
            // 子モード：セレクト非表示・選択中の子の名前だけ表示
            <div
              style={{
                padding: "6px 10px",
                borderRadius: "999px",
                border: "1px solid #ddd",
                fontSize: "13px",
                background: "#f5ecff",
              }}
            >
              🧒 {selectedChild?.name || "この子"} の週間ボード
            </div>
          )}

          <button type="button" onClick={handleExportCSV} style={controlButton}>
            CSV出力
          </button>

          <label
            style={{
              ...controlButton,
              display: "inline-flex",
              alignItems: "center",
              gap: "6px",
            }}
          >
            <span>CSV取込</span>
            <input
              type="file"
              accept=".csv,text/csv"
              onChange={handleImportCSV}
              style={{ display: "none" }}
            />
          </label>
        </div>

        {/* 時間割テーブル */}
        <div style={{ overflowX: "auto" }}>
          <table
            style={{
              width: "100%",
              borderCollapse: "collapse",
              fontSize: "12px",
              minWidth: 70 * 7,
            }}
          >
            <thead>
              <tr>
                {dayOrder.map((dayKey) => (
                  <th
                    key={dayKey}
                    style={dayHeaderStyle(dayKey)}
                    onClick={() => handleHeaderClick(dayKey)}
                  >
                    {DAY_LABELS[dayKey]}
                  </th>
                ))}
              </tr>
            </thead>
            <tbody>
              {Array.from({ length: PERIOD_COUNT }).map((_, rowIndex) => (
                <tr key={rowIndex}>
                  {dayOrder.map((dayKey) => (
                    <td
                      key={dayKey}
                      style={{
                        borderBottom: "1px solid #f2f2f2",
                        padding: "4px 4px",
                        backgroundColor: getCellBackground(dayKey, rowIndex),
                      }}
                    >
                      <input
                        type="text"
                        value={cells[dayKey]?.[rowIndex] ?? ""}
                        onChange={(e) =>
                          handleCellChange(dayKey, rowIndex, e.target.value)
                        }
                        style={{
                          width: "100%",
                          borderRadius: "8px",
                          border: "1px solid #e5e7eb",
                          padding: "4px 6px",
                          fontSize: "11px",
                          boxSizing: "border-box",
                          backgroundColor: "rgba(255,255,255,0.8)",
                        }}
                      />
                    </td>
                  ))}
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        <p
          style={{
            marginTop: "8px",
            fontSize: "11px",
            color: "#9ca3af",
            lineHeight: 1.5,
          }}
        >
          ※ 3コマごとに背景色を変えています（朝・午前・午後・放課後などの目安）。<br />
          ※ 授業や習い事の時間割として、ToDoリストとして、持ち物リストとしてなどさまざまに活用していただけます。
        </p>
      </div>
    </div>
  );
}
