// src/app/timetable/page.js
"use client";

import { useState, useEffect } from "react";
import { useSearchParams } from "next/navigation";

// 仮の子どもデータ（実アプリでは既存の子ども一覧に差し替え）
const initialChildren = [
  { id: "child1", name: "ゆくも" },
  { id: "child2", name: "あまね" },
];

const STORAGE_KEY = "pocoapoco_timetable_by_child";

const DAY_KEYS = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];
const DAY_LABELS = {
  sun: "日",
  mon: "月",
  tue: "火",
  wed: "水",
  thu: "木",
  fri: "金",
  sat: "土",
};

const PERIOD_COUNT = 15;

// からの時間割（7日×15コマ）
function createEmptyCells() {
  const cells = {};
  DAY_KEYS.forEach((d) => {
    cells[d] = Array(PERIOD_COUNT).fill("");
  });
  return cells;
}

// localStorage から読み込み
function loadTimetablesFromStorage() {
  if (typeof window === "undefined") return {};
  const raw = window.localStorage.getItem(STORAGE_KEY);
  if (!raw) return {};
  try {
    const parsed = JSON.parse(raw);
    if (parsed && typeof parsed === "object") return parsed;
  } catch (e) {
    console.error("Failed to parse timetable from storage", e);
  }
  return {};
}

// 曜日並び
function getDayOrder(weekStart) {
  // weekStart: 'mon' or 'sun'
  if (weekStart === "sun") {
    return ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];
  }
  // 月曜はじまり（デフォルト）
  return ["mon", "tue", "wed", "thu", "fri", "sat", "sun"];
}

// CSV 1セル用
const escapeCSV = (value) => {
  const v = value ?? "";
  return `"${v.replace(/"/g, '""')}"`;
};

const parseCSVLine = (line) => {
  const result = [];
  let current = "";
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];

    if (char === '"') {
      const nextChar = line[i + 1];
      if (inQuotes && nextChar === '"') {
        current += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (char === "," && !inQuotes) {
      result.push(current);
      current = "";
    } else {
      current += char;
    }
  }
  result.push(current);
  return result.map((v) => v.trim());
};

export default function TimetablePage() {
  const searchParams = useSearchParams();

  const [children] = useState(initialChildren);

  const initialChildIdFromQuery = searchParams.get("childId") || "child1";
  const [selectedChildId, setSelectedChildId] = useState(
    initialChildIdFromQuery
  );

  // childId => { weekStart: 'mon' | 'sun', cells: { [dayKey]: string[] } }
  const [timetablesByChild, setTimetablesByChild] = useState({});

  // UI用の weekStart（その子の設定があればそちらを優先）
  const [uiWeekStart, setUiWeekStart] = useState("mon");

  // マウント時に localStorage から読み込み
  useEffect(() => {
    const data = loadTimetablesFromStorage();
    setTimetablesByChild(data);

    const childCfg = data[initialChildIdFromQuery];
    if (childCfg && (childCfg.weekStart === "mon" || childCfg.weekStart === "sun")) {
      setUiWeekStart(childCfg.weekStart);
    }
  }, [initialChildIdFromQuery]);

  // 選択子ども変更時に、その子の weekStart を反映
  useEffect(() => {
    const cfg = timetablesByChild[selectedChildId];
    if (cfg && (cfg.weekStart === "mon" || cfg.weekStart === "sun")) {
      setUiWeekStart(cfg.weekStart);
    }
  }, [selectedChildId, timetablesByChild]);

  const currentConfig =
    timetablesByChild[selectedChildId] || {
      weekStart: uiWeekStart,
      cells: createEmptyCells(),
    };

  const dayOrder = getDayOrder(currentConfig.weekStart || uiWeekStart);
  const cells = currentConfig.cells || createEmptyCells();

  const saveTimetables = (updater) => {
    setTimetablesByChild((prev) => {
      const next = updater(prev);
      if (typeof window !== "undefined") {
        window.localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
      }
      return next;
    });
  };

  const handleWeekStartChange = (start) => {
    setUiWeekStart(start);
    saveTimetables((prev) => {
      const prevCfg = prev[selectedChildId] || {
        weekStart: start,
        cells: createEmptyCells(),
      };
      return {
        ...prev,
        [selectedChildId]: {
          ...prevCfg,
          weekStart: start,
        },
      };
    });
  };

  const handleCellChange = (dayKey, periodIndex, value) => {
    saveTimetables((prev) => {
      const prevCfg = prev[selectedChildId] || {
        weekStart: uiWeekStart,
        cells: createEmptyCells(),
      };
      const prevCells = prevCfg.cells || createEmptyCells();
      const dayRow = [...(prevCells[dayKey] || Array(PERIOD_COUNT).fill(""))];
      dayRow[periodIndex] = value;

      return {
        ...prev,
        [selectedChildId]: {
          weekStart: prevCfg.weekStart || uiWeekStart,
          cells: {
            ...prevCells,
            [dayKey]: dayRow,
          },
        },
      };
    });
  };

  // CSV 出力：1列目に「コマ番号」、以降は曜日（現在の並び）
  const handleExportCSV = () => {
    const cfg = timetablesByChild[selectedChildId];
    if (!cfg) {
      alert("時間割がまだ入力されていません。");
      return;
    }

    const dayKeys = getDayOrder(cfg.weekStart || "mon");
    const header =
      ["コマ"].concat(dayKeys.map((d) => DAY_LABELS[d])).join(",");

    const lines = [];
    for (let i = 0; i < PERIOD_COUNT; i++) {
      const row = [];
      row.push(String(i + 1)); // コマ番号
      dayKeys.forEach((d) => {
        const value = (cfg.cells?.[d] || [])[i] ?? "";
        row.push(escapeCSV(value));
      });
      lines.push(row.join(","));
    }

    const csvContent = [header, ...lines].join("\r\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    const childName =
      children.find((c) => c.id === selectedChildId)?.name ?? "unknown";

    a.href = url;
    a.download = `pocoapoco_timetable_${childName}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  // CSV 取込：上記と同じ形式を想定
  const handleImportCSV = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const text = await file.text();
    const lines = text.split(/\r?\n/).filter((line) => line.trim() !== "");
    if (lines.length <= 1) {
      alert("有効なデータ行がありません。");
      e.target.value = "";
      return;
    }

    const header = parseCSVLine(lines[0]);
    if (header.length < 2) {
      alert("ヘッダー行の形式が想定と異なります。");
      e.target.value = "";
      return;
    }

    // 「コマ, 曜日...」 なので 2列目以降を曜日とみなす
    const dayCols = header.slice(1);
    // 現在の weekStart に合わせて並べ直す
    const expectedOrder = getDayOrder(uiWeekStart);
    const colToDayKey = dayCols.map((label) => {
      const clean = label.replace(/["']/g, "");
      const found = expectedOrder.find((d) => DAY_LABELS[d] === clean);
      return found || null;
    });

    const newCells = createEmptyCells();

    for (let i = 1; i < lines.length && i <= PERIOD_COUNT; i++) {
      const cols = parseCSVLine(lines[i]);
      if (cols.length < 2) continue; // 少なくとも「コマ + 1曜日」

      const periodIndex = i - 1;
      for (let col = 1; col < cols.length; col++) {
        const dayKey = colToDayKey[col - 1];
        if (!dayKey) continue;
        newCells[dayKey][periodIndex] = cols[col];
      }
    }

    saveTimetables((prev) => ({
      ...prev,
      [selectedChildId]: {
        weekStart: uiWeekStart,
        cells: newCells,
      },
    }));

    e.target.value = "";
    alert("時間割を読み込みました。");
  };

  const card = {
    backgroundColor: "#ffffff",
    borderRadius: "16px",
    padding: "16px",
    marginBottom: "16px",
    boxShadow: "0 4px 10px rgba(0, 0, 0, 0.03)",
  };

  const controlButton = {
    borderRadius: "999px",
    border: "1px solid #ddd",
    padding: "6px 10px",
    fontSize: "12px",
    fontWeight: 500,
    background: "#fafafa",
    color: "#555",
    cursor: "pointer",
    whiteSpace: "nowrap",
  };

  const weekStartButton = (mode) => ({
    ...controlButton,
    border:
      (currentConfig.weekStart || uiWeekStart) === mode
        ? "1px solid #c4b5fd"
        : "1px solid #ddd",
    background:
      (currentConfig.weekStart || uiWeekStart) === mode ? "#f5f3ff" : "#fafafa",
  });

  const getRowBackground = (index) => {
    const group = Math.floor(index / 3); // 0〜4
    const colors = ["#fff", "#faf5ff", "#fef9c3", "#e0f2fe", "#fce7f3"];
    return colors[group] || "#fff";
  };

  const getCellBackground = (dayKey, rowIndex) => {
    // 土日を優先して色分け
    if (dayKey === "sat") return "#e0f2fe";
    if (dayKey === "sun") return "#ffe4e6";
    // 平日は 3コマごとのベース色
    return getRowBackground(rowIndex);
  };

  return (
    <div style={{ padding: "16px 16px 24px" }}>
      {/* 上部＋時間割本体をまとめたカード */}
      <div style={card}>
        {/* 名前選択＋小さめボタン4つ */}
        <div
          style={{
            display: "flex",
            flexWrap: "wrap",
            gap: "8px",
            alignItems: "center",
            marginBottom: "12px",
          }}
        >
          <select
            value={selectedChildId}
            onChange={(e) => setSelectedChildId(e.target.value)}
            style={{
              borderRadius: "999px",
              border: "1px solid #ddd",
              padding: "8px 14px",
              fontSize: "13px",
              background: "#fff",
              minWidth: "120px",
            }}
          >
            {children.map((child) => (
              <option key={child.id} value={child.id}>
                {child.name}
              </option>
            ))}
          </select>

          <button
            type="button"
            onClick={() => handleWeekStartChange("mon")}
            style={weekStartButton("mon")}
          >
            月曜はじまり
          </button>
          <button
            type="button"
            onClick={() => handleWeekStartChange("sun")}
            style={weekStartButton("sun")}
          >
            日曜はじまり
          </button>

          <button type="button" onClick={handleExportCSV} style={controlButton}>
            CSV出力
          </button>

          <label
            style={{
              ...controlButton,
              display: "inline-flex",
              alignItems: "center",
              gap: "6px",
            }}
          >
            <span>CSV取込</span>
            <input
              type="file"
              accept=".csv,text/csv"
              onChange={handleImportCSV}
              style={{ display: "none" }}
            />
          </label>
        </div>

        {/* 時間割テーブル */}
        <div style={{ overflowX: "auto" }}>
          <table
            style={{
              width: "100%",
              borderCollapse: "collapse",
              fontSize: "12px",
              minWidth: "630px", // 90px * 7col
            }}
          >
            <thead>
              <tr style={{ backgroundColor: "#faf5ff" }}>
                {dayOrder.map((dayKey) => (
                  <th
                    key={dayKey}
                    style={{
                      borderBottom: "1px solid #eee",
                      padding: "6px 4px",
                      textAlign: "center",
                      minWidth: "90px",
                    }}
                  >
                    {DAY_LABELS[dayKey]}
                  </th>
                ))}
              </tr>
            </thead>
            <tbody>
              {Array.from({ length: PERIOD_COUNT }).map((_, rowIndex) => (
                <tr key={rowIndex}>
                  {dayOrder.map((dayKey) => (
                    <td
                      key={dayKey}
                      style={{
                        borderBottom: "1px solid #f2f2f2",
                        padding: "4px 4px",
                        backgroundColor: getCellBackground(dayKey, rowIndex),
                      }}
                    >
                      <input
                        type="text"
                        value={cells[dayKey]?.[rowIndex] ?? ""}
                        onChange={(e) =>
                          handleCellChange(dayKey, rowIndex, e.target.value)
                        }
                        style={{
                          width: "100%",
                          borderRadius: "8px",
                          border: "1px solid #e5e7eb",
                          padding: "4px 6px",
                          fontSize: "11px",
                          boxSizing: "border-box",
                          backgroundColor: "rgba(255,255,255,0.8)",
                        }}
                      />
                    </td>
                  ))}
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        <p
          style={{
            marginTop: "8px",
            fontSize: "11px",
            color: "#9ca3af",
            lineHeight: 1.5,
          }}
        >
          ※ 3コマごとに背景色を変えています（朝・午前・午後・放課後などの目安）。<br />
          ※ 授業や習い事の時間割として、ToDoリストとして、持ち物リストとしてなどさまざまに活用していただけます。
        </p>
      </div>
    </div>
  );
}
